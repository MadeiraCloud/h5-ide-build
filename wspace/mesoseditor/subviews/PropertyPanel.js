define(["../template/TplRightPanel","../property/base/main","StateEditor","constant","Design","OpsModel","event","CloudResources","backbone","../property/app/main","../property/group/main","../property/dependency/main","../property/deployment/main"],function(e,t,n,r,i,s,o,u){var a;return o.onLongListen(o.REFRESH_PROPERTY,function(){$("#OEPanelRight").trigger("REFRESH")}),o.onLongListen(o.FORCE_OPEN_PROPERTY,function(){$("#OEPanelRight").trigger("FORCE_SHOW"),$("#OEPanelRight").trigger("SHOW_PROPERTY")}),o.onLongListen(o.SHOW_STATE_EDITOR,function(e){$("#OEPanelRight").trigger("SHOW_STATEEDITOR",[e])}),o.onLongListen(o.OPEN_PROPERTY,function(e,t){$("#OEPanelRight").trigger("OPEN",[e,t])}),a=function(e){return function(){var t;return t=Array.prototype.slice.call(arguments,0),t.shift(),this[e].apply(this,t)}},Backbone.View.extend({events:{"click .HideSecondPanel":"hideSecondPanel","click .option-group-head":"updateRightPanelOption",OPEN_SUBPANEL:a("showSecondPanel"),HIDE_SUBPANEL:a("immHideSecondPanel"),OPEN_SUBPANEL_IMM:a("immShowSecondPanel"),OPEN:a("openPanel"),SHOW_STATEEDITOR:"showStateEditor",FORCE_SHOW:"forceShow",REFRESH:"refresh",SHOW_PROPERTY:"switchToProperty","click #btn-switch-property":"switchToProperty","click #btn-switch-state":"showStateEditor"},initialize:function(e){return _.extend(this,e),this.render()},render:function(){this.setElement(this.parent.$el.find(".OEPanelRight").html(e())),this.$el.toggleClass("hidden",this.__rightPanelHidden||!1),this.__backup?(t.restore(this.__backup),this.restoreAccordion(this.__backup.activeModuleType,this.__backup.activeModuleId)):this.openPanel(),this.__showingState&&this.showStateEditor(),typeof testInit=="function"&&testInit()},backup:function(){this.$el.empty().attr("id",""),this.__backup=t.snapshot()},recover:function(){this.$el.attr("id","OEPanelRight"),this.render()},toggleRightPanel:function(){return this.__rightPanelHidden=this.$el.toggleClass("hidden").hasClass("hidden"),null},showSecondPanel:function(e,t){return this.$el.find(".HideSecondPanel").data("tooltip","Back to "+this.$el.find(".property-title").text()),this.$el.find(".property-second-panel").show().animate({left:"0%"},200),this.$el.find(".property-first-panel").animate({left:"-30%"},200,function(){}),this.$el.find(".property-first-panel").hide()},immShowSecondPanel:function(e,t){return this.$el.find(".HideSecondPanel").data("tooltip","Back to "+this.$el.find(".property-title").text()),this.$el.find(".property-second-panel").show().css({left:"0%"}),this.$el.find(".property-first-panel").css({left:"-30%",display:"none"}),null},immHideSecondPanel:function(){return this.$el.find(".property-second-panel").css({display:"none",left:"100%"}).children(".scroll-wrap").children(".property-content").empty(),this.$el.find(".property-first-panel").css({display:"block",left:"0px"}),null},hideSecondPanel:function(){var e;return e=this.$el.find(".property-second-panel"),e.animate({left:"100%"},200,function(e){return function(){return e.$el.find(".property-second-panel").hide()}}(this)),this.$el.find(".property-first-panel").show().animate({left:"0%"},200),t.onUnloadSubPanel(),!1},updateRightPanelOption:function(e){var n,r,i,s,o;r=$(e.currentTarget);if(r.is("button")||r.is("a"))return;s=r.hasClass("expand"),n=r.next(),s?n.css("display","block").slideUp(200):n.slideDown(200),r.toggleClass("expand");if(!r.parents(".property-first-panel").length)return;return this.__optionStates=this.__optionStates||{},i=t.activeModule().uid||"Stack",o=_.map(this.$el.find(".property-first-panel").find(".option-group-head"),function(e){return $(e).hasClass("expand")}),this.__optionStates[i]=o,i=this.workspace.design.component(i),i&&(this.__optionStates[i.type]=o),!1},openPanel:function(e,n){var r,i,s,o;if(this.__lastOpenType===e&&this.__lastOpenId===n&&this.__showingState)return;this.__lastOpenType=e,this.__lastOpenId=n,$(document.activeElement).filter("input, textarea").blur(),this.immHideSecondPanel(),i=this.workspace.design;if(!i)return;n?(r=i.component(n),r&&r.type===e&&i.modeIsApp()&&r.get("appId")&&!r.hasAppResource()&&(e=r.type||"Missing_Resource")):e="Stack",i.modeIsApp()||i.modeIsAppView()?o=t.TYPE.App:i.modeIsStack()?o=t.TYPE.Stack:o=t.TYPE.AppEdit;try{t.load(e,n,o)}catch(u){s=u,void 0}this.restoreAccordion(e,n),this.updateStateSwitcher(e,n),this.$el.toggleClass("state",!1),this.__showingState=!1},restoreAccordion:function(e,t){var n,r,i,s,o,u,a;if(!this.__optionStates)return;i=this.__optionStates[t],i||(i=this.__optionStates[e]);if(i){u=this.$el.find(".property-first-panel").find(".option-group-head");for(r=s=0,o=u.length;s<o;r=++s)n=u[r],$(n).toggleClass("expand",i[r]);a=this.__optionStates;for(t in a){i=a[t];if(!t||this.workspace.design.component(t)||t.indexOf("i-")===0||t==="Stack")continue;delete this.__optionStates[t]}}},updateStateSwitcher:function(e,n){var o,u,a,f;a=!1,u=this.workspace.design;if(e==="component_server_group"||e===r.RESTYPE.LC||e===r.RESTYPE.INSTANCE)i.instance().attributes.agent.enabled?(a=!0,$("#state-editor-body").trigger("SAVE_STATE")):a=!1,u.modeIsApp()&&(e==="component_server_group"&&(a=!1),e===r.RESTYPE.LC&&(a=this.workspace.opsModel.testState(s.State.Stopped)));return this.$el.toggleClass("no-state",!a),a&&(o=u.component(n)||u.component(t.activeModule().model.attributes.uid),o=(o!=null?(f=o.get("state"))!=null?f.length:void 0:void 0)||0,$("#btn-switch-state").find("b").text("("+o+")")),a},forceShow:function(){var e;this.__rightPanelHidden&&(this.__rightPanelHidden=!1,this.$el.toggleClass("no-transition",!0).removeClass("hidden"),e=this,setTimeout(function(){return e.$el.removeClass("no-transition")},100))},refresh:function(){var e;e=t.activeModule()||{},this.openPanel(e.handle,e.uid)},switchToProperty:function(){this.__showingState=!1,this.$el.toggleClass("state",!1),this.refresh()},showStateEditor:function(e,s){var o,a,f,l,c,h;if((e!=null?e.type:void 0)==="SHOW_STATEEDITOR"&&this.__showingState)return!1;s||(s=t.activeModule().uid),l=this.workspace.design,a=l.component(s)||((h=u(i.instance().credentialId(),r.RESTYPE.INSTANCE,i.instance().get("region")).findWhere({id:s}))!=null?h.toJSON():void 0);if(!a)return;a.type||(a.type=r.RESTYPE.INSTANCE);if(!this.updateStateSwitcher(a.type,s)){this.openPanel(a.type,s);return}this.__showingState=!0,this.$el.toggleClass("state",!0),l.modeIsApp()&&(s=i.modelClassForType(r.RESTYPE.INSTANCE).getEffectiveId(s).uid),o=l.serialize().component,f=o[s],a&&a.id.indexOf("i-")===0&&(c=a.id),n.loadModule(o,s,c),this.forceShow()}})});