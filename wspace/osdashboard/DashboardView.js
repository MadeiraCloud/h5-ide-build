var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define(["./DashboardTpl","./DashboardTplData","./ImportAppTpl","constant","i18n!/nls/lang.js","CloudResources","UI.modalplus","AppAction","backbone","UI.tooltip","UI.table","UI.bubble","UI.scrollbar","UI.nanoscroller"],function(e,t,n,r,i,s,o,u){return Backbone.View.extend({events:{"click #OsReloadResource":"reloadResource","click .icon-new-stack":"createStack","click .ops-list-switcher":"switchAppStack","click .dash-ops-list > li":"openItem","click .dash-ops-list .delete-stack":"deleteStack","click .dash-ops-list .duplicate-stack":"duplicateStack","click .dash-ops-list .start-app":"startApp","click .dash-ops-list .stop-app":"stopApp","click .dash-ops-list .terminate-app":"terminateApp","click .resource-tab":"switchResource","click #ImportStack":"importStack","click #VisualizeApp":"importApp"},resourcesTab:"OSSERVER",initialize:function(){var t;this.opsListTab="stack",this.lastUpdate=+(new Date),this.appAction=new u({workspace:this.workspace}),this.setElement($(e.frame()).eq(0).appendTo("#main")),this.updateOpsList(),this.updateResList(),this.updateRegionResources(!0),t=this,setInterval(function(){$("#OsReloadResource").hasClass("reloading")||$("#OsReloadResource").text(MC.intervalDate(t.lastUpdate/1e3))},6e4),MC.template.osDashboardBubble=_.bind(this.osDashboardBubble,this)},awake:function(){this.$el.show().children(".nano").nanoScroller()},sleep:function(){return this.$el.hide()},osDashboardBubble:function(e){var n,i;return n={id:e.id,data:(i=this.model.getOsResDataById(r.RESTYPE[e.type],e.id))!=null?i.toJSON():void 0},n.data=n.data.system_metadata,_.each(n.data,function(e,t){_.isBoolean(e)&&(n.data[t]=e.toString()),e===""&&(n.data[t]="None"),_.isArray(e)&&e.length===0&&(n.data[t]=["None"]);if(_.isObject(e)&&!_.isArray(e))return delete n.data[t]}),t.bubbleResourceInfo(n)},updateOpsList:function(){var t,n,r,i,s,o,u,a;t=this.$el.find(".dash-ops-list-wrapper"),a={thumbnail:!0},i=function(e){return e.isExisting()},o=function(e){return e.toJSON(a)},u=App.model.stackList().filter(i),r=App.model.appList().filter(i),n=t.children("nav"),n.find(".count").text(r.length),n.find(".stack").find(".count").text(u.length),this.opsListTab==="stack"?s=e.stackList(u.map(o)):s=e.appList(r.map(o)),t.children("ul").html(s)},updateResList:function(){return this.$(".dash-ops-resource-list").html(e.resourceList({}))},updateAppProgress:function(e){var t;if(e.get("region")===this.model.region&&this.regionOpsTab==="app"){void 0,t=$el.find(".dash-ops-list").children("[data-id='"+e.id+"']");if(!t.length)return;t.children(".region-resource-progess").show().css({width:e.get("progress")+"%"})}},switchAppStack:function(e){var t;t=$(e.currentTarget);if(t.hasClass("on"))return;t.addClass("on").siblings().removeClass("on"),this.opsListTab=t.hasClass("stack")?"stack":"app",this.updateOpsList()},switchResource:function(e){this.$(".resource-list-nav").children().removeClass("on"),this.resourcesTab=$(e.currentTarget).addClass("on").attr("data-type"),this.updateRegionResources()},updateResourceCount:function(e){var t,n,r,i,s,o,u,a,f;f=this,i=App.user.get("default_provider"),s=App.model.getOpenstackQuotas(i),t=$(".resource-list-nav"),a={elbs:"Neutron::port",fips:"Neutron::floatingip",rts:"Neutron::router",servers:"Nova::instances",snaps:"Cinder::snapshots",volumes:"Cinder::volumes"},e===!0&&s&&_.each(a,function(e,n){var r,i;return r=t.children("."+n),i=s[e],f.animateUsage(r,0,i),r.find(".count-usage").text("-")}),u=this.model.getResourcesCount();for(o in u)r=u[o],n=t.children("."+o),typeof r=="number"&&s&&this.animateUsage(n,r,s[a[o]])},animateUsage:function(e,t,n){var r;return r=e.find(".quota-path.usage"),r.attr("stroke-dashoffset",(r[0].getTotalLength()*(1-t/n)).toFixed(2)),e.find(".count-usage").text(t),e.find(".count-quota").text("/"+n)},updateRegionResources:function(e){var n,i;this.updateResourceCount(e);if(e&&(i=this.resourcesTab,__indexOf.call(e,i)<0))return;return e=r.RESTYPE[this.resourcesTab],this.model.isOsResReady(e)?n=t["resource_"+this.resourcesTab](this.model.getOsResData(e)):n='<div class="dashboard-loading"><div class="loading-spinner"></div></div>',$(".resource-list-body").html(n)},openItem:function(e){return App.openOps($(e.currentTarget).attr("data-id"))},createStack:function(e){return App.createOps(this.model.region,this.model.provider)},markUpdated:function(){this.lastUpdate=+(new Date)},reloadResource:function(){if($("#OsReloadResource").hasClass("reloading"))return;$("#OsReloadResource").addClass("reloading").text(""),App.discardAwsCache().done(function(){return $("#OsReloadResource").removeClass("reloading").text(i.IDE.DASH_TPL_JUST_NOW)})},deleteStack:function(e){return this.appAction.deleteStack($(e.currentTarget).closest("li").attr("data-id")),!1},duplicateStack:function(e){return this.appAction.duplicateStack($(e.currentTarget).closest("li").attr("data-id")),!1},startApp:function(e){return this.appAction.startApp($(e.currentTarget).closest("li").attr("data-id")),!1},stopApp:function(e){return this.appAction.stopApp($(e.currentTarget).closest("li").attr("data-id")),!1},terminateApp:function(e){return this.appAction.terminateApp($(e.currentTarget).closest("li").attr("data-id")),!1},importStack:function(){var t,n,r,s;return n=new o({title:i.IDE.POP_IMPORT_JSON_TIT,template:e.importJSON(),width:"470",disableFooter:!0}),r=new FileReader,r.onload=function(e){var t;return t=App.importJson(r.result),_.isString(t)?$("#import-json-error").html(t):(n.close(),r=null),null},r.onerror=function(){return $("#import-json-error").html(i.IDE.POP_IMPORT_ERROR),null},t=function(e){var t;e.stopPropagation(),e.preventDefault(),$("#modal-import-json-dropzone").removeClass("dragover"),$("#import-json-error").html(""),e=e.originalEvent,t=(e.dataTransfer||e.target).files;if(!t||!t.length)return;return r.readAsText(t[0]),null},$("#modal-import-json-file").on("change",t),s=$("#modal-import-json-dropzone").on("drop",t),s.on("dragenter",function(){return $(this).closest("#modal-import-json-dropzone").toggleClass("dragover",!0)}),s.on("dragleave",function(){return $(this).closest("#modal-import-json-dropzone").toggleClass("dragover",!1)}),s.on("dragover",function(e){var t;return t=e.originalEvent.dataTransfer,t&&(t.dropEffect="copy"),e.stopPropagation(),e.preventDefault(),null}),null},importApp:function(){var e;e=this,this.visModal||(this.visModal=new o({title:i.IDE.DASH_IMPORT_APP,width:"770",template:n({}),disableFooter:!0,compact:!0,onClose:function(){e.visModal=null}}),this.visModal.tpl.on("click","#VisualizeReload",function(){return e.importApp(),e.visModal.tpl.find(".unmanaged-vpc-empty").hide(),e.visModal.tpl.find(".loading-spinner").show(),!1}),this.visModal.tpl.on("click",".visualize-vpc-btn",function(t){return e.doImportApp(t)})),this.model.importApp().then(function(t){return e.visModal.tpl.find(".modal-body").html(n({ready:!0,data:t}))},function(){return e.visModal.tpl.find(".modal-body").html(n({fail:!0}))})},doImportApp:function(e){var t,n,r;return t=$(e.currentTarget),n=t.attr("data-id"),r=t.closest("ul").attr("data-region"),this.visModal.close(),App.openOps(App.model.createImportOps(r,this.model.provider,n)),!1}})});