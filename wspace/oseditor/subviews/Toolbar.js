var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define(["OpsModel","../template/TplToolbar","ThumbnailUtil","JsonExporter","ApiRequest","i18n!/nls/lang.js","UI.modalplus","kp_dropdown","ResDiff","constant","event","TaGui","CloudResources","AppAction","UI.notification","backbone"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){return Backbone.View.extend({events:{"click .icon-save":"saveStack","click .icon-delete":"deleteStack","click .icon-duplicate":"duplicateStack","click .icon-new-stack":"createStack","click .icon-zoom-in":"zoomIn","click .icon-zoom-out":"zoomOut","click .icon-export-png":"exportPNG","click .icon-export-json":"exportJson","click .runApp":"runStack","click .icon-stop":"stopApp","click .startApp":"startApp","click .icon-terminate":"terminateApp","click .icon-forget-app":"forgetApp","click .icon-refresh":"refreshResource","click .icon-update-app":"switchToAppEdit","click .icon-apply-app":"applyAppEdit","click .icon-cancel-update-app":"cancelAppEdit","click .toolbar-visual-ops-switch":"opsOptionChanged","click .reload-states":"reloadState","click .icon-save-app":"appToStack","click .sidebar-title a":"openOrHidePanel"},initialize:function(e){var n,r,i,s,o,u,a;_.extend(this,e),this.appAction=new p({workspace:this.workspace}),s=this.workspace.opsModel,s.isStack()?i=["BtnRunStack","BtnStackOps","BtnZoom","BtnExport","PanelHeaderStack","BtnSwitchStates"]:i=["BtnEditApp","BtnAppOps","BtnZoom","BtnPng","BtnReloadRes","PanelHeaderApp"],o="";for(u=0,a=i.length;u<a;u++)r=i[u],n={stateOn:this.workspace.design.get("agent").enabled},o+=t[r](n);this.workspace.opsModel.isApp()&&this.workspace.design.get("agent").enabled&&(o+=t.BtnReloadStates()),this.setElement(this.parent.$el.find(".OEPanelTop").html(o)),this.updateZoomButtons(),this.updateTbBtns()},openOrHidePanel:function(e){return this.parent.propertyPanel.__openOrHidePanel.call(this.parent.propertyPanel,e)},updateTbBtns:function(){var t,n,r,i,s,o;i=this.workspace.opsModel,i.isApp()&&(void 0,r=this.workspace.isAppEditMode&&this.workspace.isAppEditMode(),this.$el.children(".icon-update-app").toggle(!r),this.$el.children(".icon-apply-app, .icon-cancel-update-app").toggle(r),r?(this.$el.children(".icon-terminate, .icon-forget-app, .icon-stop, .icon-play, .icon-refresh, .icon-save-app, .icon-reload").hide(),this.$el.find(".icon-refresh").hide(),this.$(".sidebar-title").attr("data-mode","stack")):(s=i.testState(e.State.Running),o=i.testState(e.State.Stopped),this.$(".sidebar-title").attr("data-mode","app"),this.$el.children(".icon-terminate, .icon-forget-app, .icon-refresh, .icon-save-app, .icon-reload").show(),this.$el.children(".icon-stop").toggle(i.get("stoppable")&&s),this.$el.children(".icon-play").toggle(o).toggleClass("toolbar-btn-primary seperator",i.testState(e.State.Stopped)).find("span").toggle(o),this.$el.children(".icon-update-app").toggle(!o),this.$el.find(".icon-refresh").toggle(s),t=[].concat(this.workspace.design.componentsOfType(f.RESTYPE.INSTANCE),this.workspace.design.componentsOfType(f.RESTYPE.LC)),n=_.find(t,function(e){var t;return e&&((t=e.attributes.state)!=null?t.length:void 0)>0}),this.$el.find(".reload-states").toggle(!!n))),this.__saving?this.$el.children(".icon-save").attr("disabled","disabled"):this.$el.children(".icon-save").removeAttr("disabled"),this.updateZoomButtons()},saveStack:function(e){var t,r;return $(e.currentTarget).attr("disabled","disabled"),r=this,this.__saving=!0,t=this.workspace.design.serialize(),n.generate(this.parent.getSvgElement())["catch"](function(){return null}).then(function(n){r.workspace.opsModel.save(t,n).then(function(){return r.__saving=!1,$(e.currentTarget).removeAttr("disabled"),notification("info",sprintf(s.NOTIFY.ERR_SAVE_SUCCESS,t.name))},function(){return r.__saving=!1,$(e.currentTarget).removeAttr("disabled"),notification("error",sprintf(s.NOTIFY.ERR_SAVE_FAILED,t.name))})})},deleteStack:function(){return this.appAction.deleteStack(this.workspace.opsModel.cid,this.workspace.design.get("name"))},duplicateStack:function(){var e;e=App.model.createStackByJson(this.workspace.design.serialize()),App.loadUrl(e.url())},zoomIn:function(){return this.parent.canvas.zoomIn(),this.updateZoomButtons()},zoomOut:function(){return this.parent.canvas.zoomOut(),this.updateZoomButtons()},updateZoomButtons:function(){var e;e=this.parent.canvas?this.parent.canvas.scale():1,e<=1?this.$el.find(".icon-zoom-in").attr("disabled","disabled"):this.$el.find(".icon-zoom-in").removeAttr("disabled"),e>=1.6?this.$el.find(".icon-zoom-out").attr("disabled","disabled"):this.$el.find(".icon-zoom-out").removeAttr("disabled")},exportPNG:function(){var e,i,s;i=new o({title:"Export PNG",template:t["export"].PNG(),width:"470",disableFooter:!0,compact:!0,onClose:function(){i=null}}),e=this.workspace.design,s=e.get("name"),n.exportPNG(this.parent.getSvgElement(),{isExport:!0,createBlob:!0,name:s,id:e.get("id"),onFinish:function(e){var t;if(!i)return;i.tpl.find(".loading-spinner").remove(),i.tpl.find("section").show().prepend("<img style='max-height:100%;display:inline-block;' src='"+e.image+"' />"),t=i.tpl.find("a.btn-blue").click(function(){return i.close()}),e.blob?t.click(function(){return r.download(e.blob,""+s+".png"),!1}):t.attr({href:e.image,download:""+s+".png"}),i.resize()}})},exportJson:function(){var e,n,i,u,a;i=this.workspace.design,a=App.user.get("username"),n=MC.dateFormat(new Date,"yyyy-MM-dd"),u=[i.get("name"),a,n].join("-"),e=r.exportJson(i.serialize(),""+u+".json");if(e)return new o({title:s.TOOLBAR.EXPORT_AS_JSON,template:t["export"].JSON(e),width:"470",disableFooter:!0,compact:!0})},reloadState:function(e){var t,n,r;return t=$(e.currentTarget),t.hasClass("disabled")?!1:(t.toggleClass("disabled").html(t.attr("data-disabled")),n=Design.instance().get("id"),r={encoded_user:App.user.get("usercode"),token:App.user.get("defaultToken")},$.ajax({url:API_URL+n,method:"POST",data:JSON.stringify(r),dataType:"json",statusCode:{200:function(){return notification("info",s.NOTIFY.RELOAD_STATE_SUCCESS),l.trigger(l.REFRESH_PROPERTY)},401:function(){return notification("error",s.NOTIFY.RELOAD_STATE_INVALID_REQUEST)},404:function(){return notification("error",s.NOTIFY.RELOAD_STATE_NETWORKERROR)},429:function(){return notification("error",s.NOTIFY.RELOAD_STATE_NOT_READY)},500:function(){return notification("error",s.NOTIFY.RELOAD_STATE_INTERNAL_SERVER_ERROR)}},error:function(){return void 0},success:function(){return void 0}}).always(function(){return window.setTimeout(function(){return t.removeClass("disabled").html(t.attr("data-original"))})}))},runStack:function(e){return this.appAction.runStack(e),!1},appToStack:function(){var e,n,r,i,u,a;return n=this.workspace.design.attributes.name,r=this.getStackNameFromApp(n),a=this.workspace.opsModel.project().stacks().get(this.workspace.design.attributes.stack_id),i=function(t){return function(){var n,r,i;MC.Analytics.increase("app_to_stack"),n=e.tpl.find("input[name='save-stack-type']:checked").val()!=="replace";if(!n)return r=Design.instance().serializeAsStack(),r.id=t.workspace.design.attributes.stack_id,e.close(),r.name=a.get("name"),a.save(r).then(function(){return notification("info",sprintf(s.NOTIFY.INFO_HDL_SUCCESS,s.IDE.TOOLBAR_HANDLE_SAVE_STACK,r.name)),App.loadUrl(a.url())},function(){return notification("error",sprintf(s.NOTIFY.ERR_SAVE_FAILED,r.name))});i=App.model.createStackByJson(t.workspace.design.serializeAsStack(e.tpl.find("#modal-input-value").val())),e.close(),App.loadUrl(i.url())}}(this),u=!!a,e=new o({title:s.TOOLBAR.POP_TIT_APP_TO_STACK,template:t.saveAppToStack({input:n,stackName:r,originStackExist:u}),confirm:{text:s.TOOLBAR.POP_BTN_SAVE_TO_STACK},onConfirm:i}),e.tpl.find("input[name='save-stack-type']").change(function(){return e.tpl.find(".radio-instruction").toggleClass("hide")})},getStackNameFromApp:function(e){var t,n,r,i,s,o;e||(e="untitled"),n=0,s=/.*-\d+$/,s.test(e)?(i=e.substr(0,e.lastIndexOf("-")),n=Number(e.substr(e.lastIndexOf("-")+1)),t=i):e.charAt(e.length-1)==="-"?t=e.substr(0,e.length-1):t=e,o=/.-stack+$/,o.test(t)?t=t:t+="-stack",r=this.workspace.opsModel.project().stacks().pluck("name")||[],n++;while(n<=r.length){if($.inArray(t+"-"+n,r)===-1)break;n++}return t+"-"+n},checkAppNameRepeat:function(e){return this.workspace.opsModel.project().apps().findWhere({name:e})?(this.showError("appname",s.PROP.MSG_WARN_REPEATED_APP_NAME),!0):e?(this.hideError("appname"),!1):(this.showError("appname",s.PROP.MSG_WARN_NO_APP_NAME),!0)},renderKpDropdown:function(e){var t,n;if(u.hasResourceWithDefaultKp()){n=new u;if(!e)return!1;e.tpl.find("#kp-runtime-placeholder").html(n.render().el),t=this.hideError.bind(this),n.dropdown.on("change",function(){return t("kp")}),e.tpl.find(".default-kp-group").show(),this.modal&&this.modal.on("close",function(){return n.remove()}),this.updateModal&&this.updateModal.on("close",function(){return n.remove()})}return null},hideDefaultKpError:function(e){return e.hideError("kp")},hideError:function(e){var t;return t=e?$("#runtime-error-"+e):$(".runtime-error"),t.hide()},showError:function(e,t){return $("#runtime-error-"+e).text(t).show()},defaultKpIsSet:function(){var e,t;return u.hasResourceWithDefaultKp()?(t=Design.modelClassForType(f.RESTYPE.KP),e=t.getDefaultKP(),!e.get("isSet")||!this.modal&&!this.updateModal||!(this.modal||this.updateModal).tpl.find("#kp-runtime-placeholder .item.selected").size()?(this.showError("kp",s.IDE.RUN_STACK_MODAL_KP_WARNNING),!1):!0):!0},startApp:function(){return this.appAction.startApp(this.workspace.opsModel.id),!1},stopApp:function(){return this.appAction.stopApp(this.workspace.opsModel.id),!1},terminateApp:function(){return this.appAction.terminateApp(this.workspace.opsModel.id),!1},forgetApp:function(){return this.appAction.forgetApp(this.workspace.opsModel.id),!1},refreshResource:function(){return this.workspace.reloadAppData(),!1},switchToAppEdit:function(){return this.workspace.switchToEditMode(),!1},checkDBinstance:function(e){var t,n;return n=new Q.defer,e.length?(t=h(f.RESTYPE.DBINSTANCE,Design.instance().get("region")),t.fetchForce().then(function(){return n.resolve(t)})):n.resolve([]),n.promise},applyOpenstackAppEdit:function(){var t,n,r,i,u,l,h,p,d,v,m;return m=this,d=this.workspace.opsModel.getJsonData(),h=this.workspace.design.serialize({usage:"updateApp"}),i=new a({old:d,"new":h}),v=i.getDiffInfo(),!v.compChange&&!v.layoutChange&&!v.stateChange?this.workspace.applyAppEdit():(p=[],n=[],_.each(i.modifiedComps,function(e,t){var r;if(((r=h.component[t])!=null?r.type:void 0)===f.RESTYPE.OSSERVER&&e.resource.flavor)return n.push(h.component[t].name)}),n.length&&p.push("Server "+n.join(", ")+" will be restarted to change flavor."),l=!1,_.each(i.removedComps,function(e,t){if(d.component[t])return l=!0}),!l||p.push("Note: deleted resources cannot be restored."),u=!1,_.each(i.addedComps,function(e){if(e.type===f.RESTYPE.OSSERVER)return u=!0}),this.updateModal=new o({title:s.IDE.UPDATE_APP_MODAL_TITLE,template:MC.template.updateApp({isRunning:m.workspace.opsModel.testState(e.State.Running),notification:p}),disableClose:!0,hasScroll:!0,maxHeight:"450px",cancel:"Close"}),r=m.workspace.opsModel.type,m.updateModal.tpl.find(".modal-confirm").prop("disabled",!0).text(Design.instance().credential()?s.IDE.UPDATE_APP_CONFIRM_BTN:s.IDE.UPDATE_APP_MODAL_NEED_CREDENTIAL),u&&this.appAction.renderKpDropdown(m.updateModal,r),m.updateModal.on("confirm",function(){var e;return Design.instance().credential()?m.appAction.defaultKpIsSet(r)?(h=m.workspace.design.serialize({usage:"updateApp"}),m.workspace.applyAppEdit(h,!v.compChange),(e=m.updateModal)!=null?e.close():void 0):!1:(App.showSettings(App.showSettings.TAB.Credential),!1)}),v.compChange&&(t=i.renderAppUpdateView(),$("#app-update-summary-table").html(t)),m.renderKpDropdown(m.updateModal),c.loadModule("stack").then(function(){var e;return m.updateModal&&m.updateModal.toggleConfirm(!1),(e=m.updateModal)!=null?e.resize():void 0},function(e){var t;return void 0,m.updateModal&&m.updateModal.toggleConfirm(!0),m.updateModal&&m.updateModal.tpl.find("#take-rds-snapshot").off("change"),(t=m.updateModal)!=null?t.resize():void 0}))},applyAppEdit:function(){var t,n,r,i,u,l,h,p,d;return Design.instance().type()===e.Type.OpenStack?(this.applyOpenstackAppEdit(),!1):(d=this,l=this.workspace.opsModel.getJsonData(),i=this.workspace.design.serialize({usage:"updateApp"}),r=new a({old:l,"new":i}),p=r.getDiffInfo(),!p.compChange&&!p.layoutChange&&!p.stateChange?this.workspace.applyAppEdit():(h=r.removedComps,void 0,n=[],void 0,t=i.component,_.each(t,function(e){if(e.type===f.RESTYPE.DBINSTANCE)return n.push(e.resource.DBInstanceIdentifier)}),this.updateModal=new o({title:s.IDE.HEAD_INFO_LOADING,template:MC.template.loadingSpinner,disableClose:!0,hasScroll:!0,maxHeight:"450px",cancel:"Close"}),this.updateModal.tpl.find(".modal-footer").hide(),u=[],_.each(l.component,function(e){if(e.type===f.RESTYPE.DBINSTANCE)return u.push(e.resource.DBInstanceIdentifier)}),this.checkDBinstance(u).then(function(t){var o,u,a,l;u=t.filter(function(e){var t;return(t=e.attributes.DBInstanceIdentifier,__indexOf.call(n,t)>=0)&&e.attributes.DBInstanceStatus!=="available"});if(u.length)return d.updateModal.find(".modal-footer").show().find(".modal-confirm").hide(),d.updateModal.setContent(MC.template.cantUpdateApp({data:u})),d.updateModal.setTitle(s.IDE.UPDATE_APP_MODAL_TITLE),!1;a=[],_.each(h,function(e){var n;if(e.type===f.RESTYPE.DBINSTANCE){n=t.get(e.resource.DBInstanceIdentifier);if(n)return a.push(t.get(e.resource.DBInstanceIdentifier))}}),l=_.filter(a,function(e){return e.attributes.DBInstanceStatus!=="available"}),d.updateModal.tpl.children().css("width","450px").find(".modal-footer").show(),d.updateModal.setContent(MC.template.updateApp({isRunning:d.workspace.opsModel.testState(e.State.Running),notReadyDB:l,removeList:a})),d.updateModal.setTitle(s.IDE.UPDATE_APP_MODAL_TITLE),d.updateModal.tpl.find(".modal-confirm").prop("disabled",!0).text(Design.instance().credential()?s.IDE.UPDATE_APP_CONFIRM_BTN:s.IDE.UPDATE_APP_MODAL_NEED_CREDENTIAL),d.updateModal.resize(),window.setTimeout(function(){return d.updateModal.resize()},100),(l!=null?l.length:void 0)&&d.updateModal.tpl.find("#take-rds-snapshot").attr("checked",!1).on("change",function(){return d.updateModal.tpl.find(".modal-confirm").prop("disabled",$(this).is(":checked"))}),d.updateModal.on("confirm",function(){var e;return Design.instance().credential()?d.defaultKpIsSet()?(i=d.workspace.design.serialize({usage:"updateApp"}),d.workspace.applyAppEdit(i,!p.compChange),(e=d.updateModal)!=null?e.close():void 0):!1:(App.showSettings(App.showSettings.TAB.Credential),!1)}),p.compChange&&(o=r.renderAppUpdateView(),$("#app-update-summary-table").html(o)),d.renderKpDropdown(d.updateModal),c.loadModule("stack").then(function(){var e;return d.updateModal&&d.updateModal.toggleConfirm(!1),(e=d.updateModal)!=null?e.resize():void 0},function(e){var t;return void 0,d.updateModal&&d.updateModal.toggleConfirm(!0),d.updateModal&&d.updateModal.tpl.find("#take-rds-snapshot").off("change"),(t=d.updateModal)!=null?t.resize():void 0})})))},opsOptionChanged:function(){var e,n,r,i,u,a,f;return a=this,e=this.$(".toolbar-visual-ops-switch").toggleClass("on"),u=e.hasClass("on"),n=this.workspace.design.get("agent"),u?(i=this.workspace.design.instancesNoUserData(),f=this.workspace,i?(n.enabled=!0,this.workspace.design.set("agent",n),l.trigger(l.REFRESH_PROPERTY)):(e.removeClass("on"),r=new o({title:"Confirm to Enable VisualOps",width:"420px",template:t.confirm.enableState(),confirm:{text:s.IDE.ENABLE_VISUALOPS},onConfirm:function(){return a.clearUserData(),n.enabled=!0,r.close(),e.addClass("on"),f.design.set("agent",n),l.trigger(l.FORCE_OPEN_PROPERTY)}}),null)):(n.enabled=!1,this.workspace.design.set("agent",n),l.trigger(l.FORCE_OPEN_PROPERTY))},clearUserData:function(){var e;return e=Design.modelClassForType(f.RESTYPE.OSSERVER),_.each(e.allObjects(),function(e){return e.set("userData",void 0)})},cancelAppEdit:function(){var e,n;return this.workspace.cancelEditMode()||(n=this,e=new o({title:"Changes not applied",template:t.modal.cancelUpdate(),width:"400",confirm:{text:"Discard",color:"red"},onConfirm:function(){e.close(),n.workspace.cancelEditMode(!0)}})),!1}})});