(function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define(["OpsModel","../template/TplToolbar","ThumbnailUtil","JsonExporter","ApiRequest","i18n!/nls/lang.js","UI.modalplus","kp_dropdown","ResDiff","constant","event","TaGui","CloudResources","AppAction","UI.notification","backbone"],function(t,n,r,i,s,o,u,a,f,l,c,h,p,d){return Backbone.View.extend({events:{"click .icon-save":"saveStack","click .icon-delete":"deleteStack","click .icon-duplicate":"duplicateStack","click .icon-new-stack":"createStack","click .icon-zoom-in":"zoomIn","click .icon-zoom-out":"zoomOut","click .icon-export-png":"exportPNG","click .icon-export-json":"exportJson","click .runApp":"runStack","click .icon-stop":"stopApp","click .startApp":"startApp","click .icon-terminate":"terminateApp","click .icon-forget-app":"forgetApp","click .icon-refresh":"refreshResource","click .icon-update-app":"switchToAppEdit","click .icon-apply-app":"applyAppEdit","click .icon-cancel-update-app":"cancelAppEdit","click .toolbar-visual-ops-switch":"opsOptionChanged","click .reload-states":"reloadState","click .icon-save-app":"appToStack","click .sidebar-title a":"openOrHidePanel"},initialize:function(e){var t,r,i,s,o,u,a;_.extend(this,e),this.appAction=new d({workspace:this.workspace}),s=this.workspace.opsModel,s.isStack()?i=["BtnRunStack","BtnStackOps","BtnZoom","BtnExport","PanelHeaderStack","BtnSwitchStates"]:i=["BtnEditApp","BtnAppOps","BtnZoom","BtnPng","BtnReloadRes","PanelHeaderApp"],o="";for(u=0,a=i.length;u<a;u++)r=i[u],t={stateOn:this.workspace.design.get("agent").enabled},o+=n[r](t);this.workspace.opsModel.isApp()&&this.workspace.design.get("agent").enabled&&(o+=n.BtnReloadStates()),this.setElement(this.parent.$el.find(".OEPanelTop").html(o)),this.updateZoomButtons(),this.updateTbBtns()},openOrHidePanel:function(e){return this.parent.propertyPanel.__openOrHidePanel.call(this.parent.propertyPanel,e)},updateTbBtns:function(){var e,n,r,i,s,o;i=this.workspace.opsModel,i.isApp()&&(void 0,r=this.workspace.isAppEditMode&&this.workspace.isAppEditMode(),this.$el.children(".icon-update-app").toggle(!r),this.$el.children(".icon-apply-app, .icon-cancel-update-app").toggle(r),r?(this.$el.children(".icon-terminate, .icon-forget-app, .icon-stop, .icon-play, .icon-refresh, .icon-save-app, .icon-reload").hide(),this.$el.find(".icon-refresh").hide(),this.$(".sidebar-title").attr("data-mode","stack")):(s=i.testState(t.State.Running),o=i.testState(t.State.Stopped),this.$(".sidebar-title").attr("data-mode","app"),this.$el.children(".icon-terminate, .icon-forget-app, .icon-refresh, .icon-save-app, .icon-reload").show(),this.$el.children(".icon-stop").toggle(i.get("stoppable")&&s),this.$el.children(".icon-play").toggle(o).toggleClass("toolbar-btn-primary seperator",i.testState(t.State.Stopped)).find("span").toggle(o),this.$el.children(".icon-update-app").toggle(!o),this.$el.find(".icon-refresh").toggle(s),e=[].concat(this.workspace.design.componentsOfType(l.RESTYPE.INSTANCE),this.workspace.design.componentsOfType(l.RESTYPE.LC)),n=_.find(e,function(e){var t;return e&&((t=e.attributes.state)!=null?t.length:void 0)>0}),this.$el.find(".reload-states").toggle(!!n))),this.__saving?this.$el.children(".icon-save").attr("disabled","disabled"):this.$el.children(".icon-save").removeAttr("disabled"),this.updateZoomButtons()},saveStack:function(e){var t,n;return $(e.currentTarget).attr("disabled","disabled"),n=this,this.__saving=!0,t=this.workspace.design.serialize(),r.generate(this.parent.getSvgElement())["catch"](function(){return null}).then(function(r){n.workspace.opsModel.save(t,r).then(function(){return n.__saving=!1,$(e.currentTarget).removeAttr("disabled"),notification("info",sprintf(o.NOTIFY.ERR_SAVE_SUCCESS,t.name))},function(){return n.__saving=!1,$(e.currentTarget).removeAttr("disabled"),notification("error",sprintf(o.NOTIFY.ERR_SAVE_FAILED,t.name))})})},deleteStack:function(){return this.appAction.deleteStack(this.workspace.opsModel.cid,this.workspace.design.get("name"))},duplicateStack:function(){var e;e=App.model.createStackByJson(this.workspace.design.serialize()),App.loadUrl(e.url())},zoomIn:function(){return this.parent.canvas.zoomIn(),this.updateZoomButtons()},zoomOut:function(){return this.parent.canvas.zoomOut(),this.updateZoomButtons()},updateZoomButtons:function(){var e;e=this.parent.canvas?this.parent.canvas.scale():1,e<=1?this.$el.find(".icon-zoom-in").attr("disabled","disabled"):this.$el.find(".icon-zoom-in").removeAttr("disabled"),e>=1.6?this.$el.find(".icon-zoom-out").attr("disabled","disabled"):this.$el.find(".icon-zoom-out").removeAttr("disabled")},exportPNG:function(){var e,t,s;t=new u({title:"Export PNG",template:n["export"].PNG(),width:"470",disableFooter:!0,compact:!0,onClose:function(){t=null}}),e=this.workspace.design,s=e.get("name"),r.exportPNG(this.parent.getSvgElement(),{isExport:!0,createBlob:!0,name:s,id:e.get("id"),onFinish:function(e){var n;if(!t)return;t.tpl.find(".loading-spinner").remove(),t.tpl.find("section").show().prepend("<img style='max-height:100%;display:inline-block;' src='"+e.image+"' />"),n=t.tpl.find("a.btn-blue").click(function(){return t.close()}),e.blob?n.click(function(){return i.download(e.blob,""+s+".png"),!1}):n.attr({href:e.image,download:""+s+".png"}),t.resize()}})},exportJson:function(){var e,t,r,s,a;r=this.workspace.design,a=App.user.get("username"),t=MC.dateFormat(new Date,"yyyy-MM-dd"),s=[r.get("name"),a,t].join("-"),e=i.exportJson(r.serialize(),""+s+".json");if(e)return new u({title:o.TOOLBAR.EXPORT_AS_JSON,template:n["export"].JSON(e),width:"470",disableFooter:!0,compact:!0})},reloadState:function(e){var t,n,r;return t=$(e.currentTarget),t.hasClass("disabled")?!1:(t.toggleClass("disabled").html(t.attr("data-disabled")),n=Design.instance().get("id"),r={encoded_user:App.user.get("usercode"),token:App.user.get("defaultToken")},$.ajax({url:API_URL+n,method:"POST",data:JSON.stringify(r),dataType:"json",statusCode:{200:function(){return notification("info",o.NOTIFY.RELOAD_STATE_SUCCESS),c.trigger(c.REFRESH_PROPERTY)},401:function(){return notification("error",o.NOTIFY.RELOAD_STATE_INVALID_REQUEST)},404:function(){return notification("error",o.NOTIFY.RELOAD_STATE_NETWORKERROR)},429:function(){return notification("error",o.NOTIFY.RELOAD_STATE_NOT_READY)},500:function(){return notification("error",o.NOTIFY.RELOAD_STATE_INTERNAL_SERVER_ERROR)}},error:function(){return void 0},success:function(){return void 0}}).always(function(){return window.setTimeout(function(){return t.removeClass("disabled").html(t.attr("data-original"))})}))},runStack:function(e){return this.appAction.runStack(e),!1},appToStack:function(){var e,t,r,i,s,a;return t=this.workspace.design.attributes.name,r=this.getStackNameFromApp(t),a=this.workspace.opsModel.project().stacks().get(this.workspace.design.attributes.stack_id),i=function(t){return function(){var n,r,i;MC.Analytics.increase("app_to_stack"),n=e.tpl.find("input[name='save-stack-type']:checked").val()!=="replace";if(!n)return r=Design.instance().serializeAsStack(),r.id=t.workspace.design.attributes.stack_id,e.close(),r.name=a.get("name"),a.save(r).then(function(){return notification("info",sprintf(o.NOTIFY.INFO_HDL_SUCCESS,o.IDE.TOOLBAR_HANDLE_SAVE_STACK,r.name)),App.loadUrl(a.url())},function(){return notification("error",sprintf(o.NOTIFY.ERR_SAVE_FAILED,r.name))});i=App.model.createStackByJson(t.workspace.design.serializeAsStack(e.tpl.find("#modal-input-value").val())),e.close(),App.loadUrl(i.url())}}(this),s=!!a,e=new u({title:o.TOOLBAR.POP_TIT_APP_TO_STACK,template:n.saveAppToStack({input:t,stackName:r,originStackExist:s}),confirm:{text:o.TOOLBAR.POP_BTN_SAVE_TO_STACK},onConfirm:i}),e.tpl.find("input[name='save-stack-type']").change(function(){return e.tpl.find(".radio-instruction").toggleClass("hide")})},getStackNameFromApp:function(e){var t,n,r,i,s,o;e||(e="untitled"),n=0,s=/.*-\d+$/,s.test(e)?(i=e.substr(0,e.lastIndexOf("-")),n=Number(e.substr(e.lastIndexOf("-")+1)),t=i):e.charAt(e.length-1)==="-"?t=e.substr(0,e.length-1):t=e,o=/.-stack+$/,o.test(t)?t=t:t+="-stack",r=this.workspace.opsModel.project().stacks().pluck("name")||[],n++;while(n<=r.length){if($.inArray(t+"-"+n,r)===-1)break;n++}return t+"-"+n},checkAppNameRepeat:function(e){return this.workspace.opsModel.project().apps().findWhere({name:e})?(this.showError("appname",o.PROP.MSG_WARN_REPEATED_APP_NAME),!0):e?(this.hideError("appname"),!1):(this.showError("appname",o.PROP.MSG_WARN_NO_APP_NAME),!0)},renderKpDropdown:function(e){var t,n;if(a.hasResourceWithDefaultKp()){n=new a;if(!e)return!1;e.tpl.find("#kp-runtime-placeholder").html(n.render().el),t=this.hideError.bind(this),n.dropdown.on("change",function(){return t("kp")}),e.tpl.find(".default-kp-group").show(),this.modal&&this.modal.on("close",function(){return n.remove()}),this.updateModal&&this.updateModal.on("close",function(){return n.remove()})}return null},hideDefaultKpError:function(e){return e.hideError("kp")},hideError:function(e){var t;return t=e?$("#runtime-error-"+e):$(".runtime-error"),t.hide()},showError:function(e,t){return $("#runtime-error-"+e).text(t).show()},defaultKpIsSet:function(){var e,t;return a.hasResourceWithDefaultKp()?(t=Design.modelClassForType(l.RESTYPE.KP),e=t.getDefaultKP(),!e.get("isSet")||!this.modal&&!this.updateModal||!(this.modal||this.updateModal).tpl.find("#kp-runtime-placeholder .item.selected").size()?(this.showError("kp",o.IDE.RUN_STACK_MODAL_KP_WARNNING),!1):!0):!0},startApp:function(){return this.appAction.startApp(this.workspace.opsModel.id),!1},stopApp:function(){return this.appAction.stopApp(this.workspace.opsModel.id),!1},terminateApp:function(){return this.appAction.terminateApp(this.workspace.opsModel.id),!1},forgetApp:function(){return this.appAction.forgetApp(this.workspace.opsModel.id),!1},refreshResource:function(){return this.workspace.reloadAppData(),!1},switchToAppEdit:function(){return this.workspace.switchToEditMode(),!1},checkDBinstance:function(e){var t,n;return n=new Q.defer,e.length?(t=p(l.RESTYPE.DBINSTANCE,Design.instance().get("region")),t.fetchForce().then(function(){return n.resolve(t)})):n.resolve([]),n.promise},applyOpenstackAppEdit:function(){var e,n,r,i,s,a,c,p,d,v,m;return m=this,d=this.workspace.opsModel.getJsonData(),c=this.workspace.design.serialize({usage:"updateApp"}),i=new f({old:d,"new":c}),v=i.getDiffInfo(),!v.compChange&&!v.layoutChange&&!v.stateChange?this.workspace.applyAppEdit():(p=[],n=[],_.each(i.modifiedComps,function(e,t){var r;if(((r=c.component[t])!=null?r.type:void 0)===l.RESTYPE.OSSERVER&&e.resource.flavor)return n.push(c.component[t].name)}),n.length&&p.push("Server "+n.join(", ")+" will be restarted to change flavor."),a=!1,_.each(i.removedComps,function(e,t){if(d.component[t])return a=!0}),!a||p.push("Note: deleted resources cannot be restored."),s=!1,_.each(i.addedComps,function(e){if(e.type===l.RESTYPE.OSSERVER)return s=!0}),this.updateModal=new u({title:o.IDE.UPDATE_APP_MODAL_TITLE,template:MC.template.updateApp({isRunning:m.workspace.opsModel.testState(t.State.Running),notification:p}),disableClose:!0,hasScroll:!0,maxHeight:"450px",cancel:"Close"}),r=m.workspace.opsModel.type,m.updateModal.tpl.find(".modal-confirm").prop("disabled",!0).text(Design.instance().credential()?o.IDE.UPDATE_APP_CONFIRM_BTN:o.IDE.UPDATE_APP_MODAL_NEED_CREDENTIAL),s&&this.appAction.renderKpDropdown(m.updateModal,r),m.updateModal.on("confirm",function(){var e;return Design.instance().credential()?m.appAction.defaultKpIsSet(r)?(c=m.workspace.design.serialize({usage:"updateApp"}),m.workspace.applyAppEdit(c,!v.compChange),(e=m.updateModal)!=null?e.close():void 0):!1:(App.showSettings(App.showSettings.TAB.Credential),!1)}),v.compChange&&(e=i.renderAppUpdateView(),$("#app-update-summary-table").html(e)),m.renderKpDropdown(m.updateModal),h.loadModule("stack").then(function(){var e;return m.updateModal&&m.updateModal.toggleConfirm(!1),(e=m.updateModal)!=null?e.resize():void 0},function(e){var t;return void 0,m.updateModal&&m.updateModal.toggleConfirm(!0),m.updateModal&&m.updateModal.tpl.find("#take-rds-snapshot").off("change"),(t=m.updateModal)!=null?t.resize():void 0}))},applyAppEdit:function(){var n,r,i,s,a,c,p,d,v;return Design.instance().type()===t.Type.OpenStack?(this.applyOpenstackAppEdit(),!1):(v=this,c=this.workspace.opsModel.getJsonData(),s=this.workspace.design.serialize({usage:"updateApp"}),i=new f({old:c,"new":s}),d=i.getDiffInfo(),!d.compChange&&!d.layoutChange&&!d.stateChange?this.workspace.applyAppEdit():(p=i.removedComps,void 0,r=[],void 0,n=s.component,_.each(n,function(e){if(e.type===l.RESTYPE.DBINSTANCE)return r.push(e.resource.DBInstanceIdentifier)}),this.updateModal=new u({title:o.IDE.HEAD_INFO_LOADING,template:MC.template.loadingSpinner,disableClose:!0,hasScroll:!0,maxHeight:"450px",cancel:"Close"}),this.updateModal.tpl.find(".modal-footer").hide(),a=[],_.each(c.component,function(e){if(e.type===l.RESTYPE.DBINSTANCE)return a.push(e.resource.DBInstanceIdentifier)}),this.checkDBinstance(a).then(function(n){var u,a,f,c;a=n.filter(function(t){var n;return(n=t.attributes.DBInstanceIdentifier,e.call(r,n)>=0)&&t.attributes.DBInstanceStatus!=="available"});if(a.length)return v.updateModal.find(".modal-footer").show().find(".modal-confirm").hide(),v.updateModal.setContent(MC.template.cantUpdateApp({data:a})),v.updateModal.setTitle(o.IDE.UPDATE_APP_MODAL_TITLE),!1;f=[],_.each(p,function(e){var t;if(e.type===l.RESTYPE.DBINSTANCE){t=n.get(e.resource.DBInstanceIdentifier);if(t)return f.push(n.get(e.resource.DBInstanceIdentifier))}}),c=_.filter(f,function(e){return e.attributes.DBInstanceStatus!=="available"}),v.updateModal.tpl.children().css("width","450px").find(".modal-footer").show(),v.updateModal.setContent(MC.template.updateApp({isRunning:v.workspace.opsModel.testState(t.State.Running),notReadyDB:c,removeList:f})),v.updateModal.setTitle(o.IDE.UPDATE_APP_MODAL_TITLE),v.updateModal.tpl.find(".modal-confirm").prop("disabled",!0).text(Design.instance().credential()?o.IDE.UPDATE_APP_CONFIRM_BTN:o.IDE.UPDATE_APP_MODAL_NEED_CREDENTIAL),v.updateModal.resize(),window.setTimeout(function(){return v.updateModal.resize()},100),(c!=null?c.length:void 0)&&v.updateModal.tpl.find("#take-rds-snapshot").attr("checked",!1).on("change",function(){return v.updateModal.tpl.find(".modal-confirm").prop("disabled",$(this).is(":checked"))}),v.updateModal.on("confirm",function(){var e;return Design.instance().credential()?v.defaultKpIsSet()?(s=v.workspace.design.serialize({usage:"updateApp"}),v.workspace.applyAppEdit(s,!d.compChange),(e=v.updateModal)!=null?e.close():void 0):!1:(App.showSettings(App.showSettings.TAB.Credential),!1)}),d.compChange&&(u=i.renderAppUpdateView(),$("#app-update-summary-table").html(u)),v.renderKpDropdown(v.updateModal),h.loadModule("stack").then(function(){var e;return v.updateModal&&v.updateModal.toggleConfirm(!1),(e=v.updateModal)!=null?e.resize():void 0},function(e){var t;return void 0,v.updateModal&&v.updateModal.toggleConfirm(!0),v.updateModal&&v.updateModal.tpl.find("#take-rds-snapshot").off("change"),(t=v.updateModal)!=null?t.resize():void 0})})))},opsOptionChanged:function(){var e,t,r,i,s,a,f;return a=this,e=this.$(".toolbar-visual-ops-switch").toggleClass("on"),s=e.hasClass("on"),t=this.workspace.design.get("agent"),s?(i=this.workspace.design.instancesNoUserData(),f=this.workspace,i?(t.enabled=!0,this.workspace.design.set("agent",t),c.trigger(c.REFRESH_PROPERTY)):(e.removeClass("on"),r=new u({title:"Confirm to Enable VisualOps",width:"420px",template:n.confirm.enableState(),confirm:{text:o.IDE.ENABLE_VISUALOPS},onConfirm:function(){return a.clearUserData(),t.enabled=!0,r.close(),e.addClass("on"),f.design.set("agent",t),c.trigger(c.FORCE_OPEN_PROPERTY)}}),null)):(t.enabled=!1,this.workspace.design.set("agent",t),c.trigger(c.FORCE_OPEN_PROPERTY))},clearUserData:function(){var e;return e=Design.modelClassForType(l.RESTYPE.OSSERVER),_.each(e.allObjects(),function(e){return e.set("userData",void 0)})},cancelAppEdit:function(){var e,t;return this.workspace.cancelEditMode()||(t=this,e=new u({title:"Changes not applied",template:n.modal.cancelUpdate(),width:"400",confirm:{text:"Discard",color:"red"},onConfirm:function(){e.close(),t.workspace.cancelEditMode(!0)}})),!1}})})}).call(this);