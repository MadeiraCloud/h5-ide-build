(function(){define(["constant","../OsPropertyView","./template","CloudResources","underscore","OsKp","../ossglist/view"],function(e,t,n,r,i,s,o){return t.extend({events:{"change #property-os-server-credential":"onChangeCredential","change #property-os-server-name":"updateServerAttr","change #property-os-server-image":"updateServerAttr","change #property-os-server-CPU":"updateServerAttr","change #property-os-server-RAM":"updateServerAttr","change #property-os-server-keypair":"updateServerAttr","change #property-os-server-adminPass":"updateServerAttr","change #property-os-server-userdata":"updateServerAttr","change #property-os-server-fip":"updateServerAttr","change #property-os-server-aip":"updateServerAttr","change #property-os-server-volsize":"updateServerAttr","select_initialize #property-os-server-image":"initImage","select_initialize #property-os-server-credential":"initCredential","select_initialize #property-os-server-RAM":"initRAM","select_initialize #property-os-server-CPU":"initCPU"},initialize:function(){return this.listenTo(this.model,"change:fip",this.render)},render:function(){var t,i,u,a;return this.$el.empty(),i=this.model.toJSON(),t=r(e.RESTYPE.OSIMAGE,Design.instance().region()).get(this.model.get("imageId")),this.flavorList=App.model.getOpenstackFlavors(Design.instance().get("provider"),Design.instance().region()),i.imageList=r(e.RESTYPE.OSIMAGE,Design.instance().region()).toJSON(),i.floatingIp=!!this.model.embedPort().getFloatingIp(),i.fixedIp=this.model.embedPort().get("ip"),i.isAppEdit=this.modeIsAppEdit(),i.agentEnabled=Design.instance().get("agent").enabled,i.volumeSize||(i.volumeSize=t.get("vol_size")),this.$el.html(n.stackTemplate(i)),u=new s(this.model,n.kpSelection({isAppEdit:this.modeIsAppEdit()})),this.$el.find("#property-os-server-keypair").html(u.render().$el),this.stopListening(this.workspace.design),this.listenTo(this.workspace.design,"change:agent",this.render),this.sgListView=this.reg(new o({targetModel:(a=this.model)!=null?a.embedPort():void 0})),this.$el.append(this.sgListView.render().el),this},initImage:function(e){return $(e.target)[0].selectize.setValue(this.model.get("imageId"))},initCredential:function(e){return this.checkWindowsDistro(this.model.get("imageId"))},initRAM:function(e){var t,n,r;return r=i.groupBy(this.flavorList.toJSON(),"vcpus"),n=this.flavorList.get(this.model.get("flavorId")),t=i.map(i.pluck(r[n.get("vcpus")],"ram"),function(e){return{text:e/1024+" G",value:e}}),$(e.target)[0].selectize.addOption(t),$(e.target)[0].selectize.setValue(n.get("ram"))},initCPU:function(e){var t,n,r;return r=i.groupBy(this.flavorList.toJSON(),"vcpus"),n=this.flavorList.get(this.model.get("flavorId")),t=i.map(r,function(e,t){return{text:t+" Core",value:t}}),$(e.target)[0].selectize.addOption(t),$(e.target)[0].selectize.setValue(n.get("vcpus"))},onChangeCredential:function(e,t){var n;return n=e?$(e.currentTarget).getValue():t,this.model.set("credential",n),n==="keypair"?(this.$el.find("#property-os-server-keypair").parent().show(),this.$el.find("#property-os-server-adminPass").parent().hide()):(this.$el.find("#property-os-server-keypair").parent().hide(),this.$el.find("#property-os-server-adminPass").parent().show())},checkWindowsDistro:function(t){var n,i,s,o,u,a;o=r(e.RESTYPE.OSIMAGE,Design.instance().region()).get(t),i=o.get("os_distro"),u=o.get("vol_size"),(this.model.get("volumeSize")||0)<u&&this.model.set("volumeSize",u),$("#property-os-server-volsize").val(this.model.get("volumeSize")||o.get("vol_size")),s=i==="windows",n=this.$el.find("#property-os-server-credential"),n.parents(".group").toggle(!s);if(s)return this.model.set("credential","adminPass"),(a=n[0].selectize)!=null&&a.setValue("adminPass"),this.onChangeCredential(null,"adminPass")},updateServerAttr:function(e){var t,n,r,s,o,u,a,f,l,c,h,p;h=$(e.currentTarget),t=h.data("target"),l=h[0].selectize;switch(t){case"imageId":this.checkWindowsDistro(h.val()),this.model.setImage(h.val());break;case"name":this.setTitle(h.val());break;case"CPU":o=i.groupBy(this.flavorList.models,function(e){return e.get("vcpus")}),n=o[h.val()];if(n!=null?!n.length:!void 0)return!1;a=this.$el.find("#property-os-server-RAM")[0].selectize;if(!a)return!1;return f=a.getValue(),r=i.map(i.pluck(i.map(n,function(e){return e.toJSON()}),"ram"),function(e){return{text:e/1024+" G",value:e}}),s=i.find(n,function(e){return e.get("ram")===+f}),s||(f=i.min(i.pluck(r,"value")),s=i.find(n,function(e){return e.get("ram")===+f})),this.model.set("flavorId",s.get("id")),this.updateRamOptions(r,f),!1;case"RAM":return u=this.flavorList.get(this.model.get("flavorId")),o=i.groupBy(this.flavorList.models,function(e){return e.get("vcpus")}),n=o[u.get("vcpus")],p=i.find(n,function(e){return e.get("ram")===+l.getValue()}),this.model.set("flavorId",p.get("id")),!1;case"fixedIp":return c=this.model.embedPort(),c.setIp(h.val()),!1;case"associateFip":return c=this.model.embedPort(),c.setFloatingIp(h.getValue()),!1}void 0;if(t)return this.model.set(t,h.val())},updateRamOptions:function(e,t){var n;return n=this.$el.find("#property-os-server-RAM")[0].selectize,n.clearOptions(),n.load(function(r){return r(e),n.refreshOptions(!1),n.setValue(t)})},selectTpl:{imageSelect:function(t){var i,s,o;return i=r(e.RESTYPE.OSIMAGE,Design.instance().region()),s=(o=i.get(t.value))!=null?o.toJSON():void 0,s?(s.distro=s.os_type+"."+s.architecture,n.imageListKey(s)):(t.distro="ami-unknown",n.imageListKey(t))},imageValue:function(t){var i,s,o;return i=r(e.RESTYPE.OSIMAGE,Design.instance().region()),s=(o=i.get(t.value))!=null?o.toJSON():void 0,s?(s.distro=s.os_type+"."+s.architecture,n.imageValue(s)):(t.distro="ami-unknown",t.text=t.text||"Unknow",n.imageValue(t))},kpButton:function(){return n.kpButton()}}},{handleTypes:[e.RESTYPE.OSSERVER],handleModes:["stack","appedit"]})})}).call(this);