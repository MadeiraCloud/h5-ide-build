define(["ComplexResModel","constant","Design","CloudResources"],function(e,t,n,r){var i;return i=e.extend({type:t.RESTYPE.OSSERVER,newNameTmpl:"host",defaults:function(){return{userData:"",meta:"",adminPass:"12345678",keypair:"$DefaultKeyPair",flavorId:"6",availabilityZone:"",imageId:"",credential:"keypair",state:[],volumeSize:""}},initialize:function(e,r){var i,s,o;return r=r||{},void 0,this.setImage(e.imageId),this.setCredential(e),r.createByUser&&(i=n.modelClassForType(t.RESTYPE.OSPORT),s=n.modelClassForType("OsPortUsage"),o=new i({name:this.get("name")+"-port"}),new s(this,o),n.modelClassForType(t.RESTYPE.OSSG).attachDefaultSG(o),this.assignIP()),null},assignIP:function(){var e;e=n.modelClassForType(t.RESTYPE.OSPORT).getAvailableIP(this.parent());if(this.embedPort()&&e)return this.embedPort().set("ip",e)},onParentChanged:function(e){if(e)return this.assignIP()},embedPort:function(){return this.connectionTargets("OsPortUsage")[0]},volumes:function(){return this.connectionTargets("OsVolumeUsage")},setCredential:function(e){if(e.keypair)return this.set("credential","keypair");if(e.adminPass)return this.set("credential","adminPass")},setImage:function(e){var t,n;return this.set("imageId",e),n=this.getImage(),t=this.get("cachedAmi"),n&&t&&(t.os_distro=n.os_distro,t.architecture=n.architecture),null},getImage:function(){var e;return e=r(t.RESTYPE.OSIMAGE,this.design().region()).get(this.get("imageId")),e?e.toJSON():null},getStateData:function(){return this.get("state")},setStateData:function(e){return this.set("state",e)},serialize:function(){var e,r,i;return r={name:this.get("name"),type:this.type,uid:this.id,state:this.get("state"),resource:{id:this.get("appId"),name:this.get("name"),flavor:this.get("flavorId"),image:this.get("imageId"),meta:this.get("meta"),NICS:this.connectionTargets("OsPortUsage").map(function(e){return{"port-id":e.createRef("id")}}),userdata:this.get("userData"),availabilityZone:this.get("availabilityZone"),blockDeviceMappingV2:[{bootIndex:0,sourceType:"image",volumeSize:this.get("volumeSize"),deviceName:"",uuid:this.get("imageId"),destinationType:"volume",deleteOnTermination:!0}]}},e=n.modelClassForType(t.RESTYPE.OSKP),i=_.find(e.allObjects(),function(e){return e.get("name")==="DefaultKP"}),this.get("credential")==="keypair"?(r.resource.key_name=this.get("keypair")==="$DefaultKeyPair"?MC.genResRef(i.id,"resource.keyName"):this.get("keypair"),r.resource.adminPass=""):(r.resource.key_name="",r.resource.adminPass=this.get("adminPass")),{component:r,layout:this.generateLayout()}}},{handleTypes:t.RESTYPE.OSSERVER,deserialize:function(e,t,r){var s,o,u,a,f,l,c,h;a=new i({id:e.uid,name:e.resource.name,appId:e.resource.id,flavorId:e.resource.flavor,imageId:e.resource.image||e.resource.blockDeviceMappingV2[0].uuid,adminPass:e.resource.adminPass,volumeSize:(c=e.resource.blockDeviceMappingV2)!=null?c[0].volumeSize:void 0,keypair:e.resource.key_name.split("{")[0]==="@"?"$DefaultKeyPair":e.resource.key_name,state:e.state,x:t.coordinate[0],y:t.coordinate[1]}),s=n.modelClassForType("OsPortUsage"),h=e.resource.NICS||[];for(o=f=0,l=h.length;f<l;o=++f)u=h[o],u=r(MC.extractID(u["port-id"])),o===0&&(u.parent().addChild(a),u.parent().removeChild(u)),new s(a,u)}}),i});