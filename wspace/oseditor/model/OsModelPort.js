define(["ComplexResModel","constant","Design"],function(e,t,n){var r;return r=e.extend({type:t.RESTYPE.OSPORT,newNameTmpl:"port",defaults:function(){return{ip:"",macAddress:"",deviceIndex:0}},initialize:function(e,r){if(r.createByUser)return n.modelClassForType(t.RESTYPE.OSSG).attachDefaultSG(this),this.assignIP()},assignIP:function(){var e,t;t=this.parent(),this.isEmbedded()&&(t=this.owner().parent()),e=r.getAvailableIP(t);if(e)return this.set("ip",e)},onParentChanged:function(e){if(e&&!this.isEmbedded())return this.assignIP()},owner:function(){return this.connectionTargets("OsPortUsage")[0]},isAttached:function(){return!!this.owner()},isVisual:function(){return!this.isEmbedded()},isEmbedded:function(){return this.parent()?this.owner()&&this.owner().embedPort()===this:!0},setFloatingIp:function(e){var t,r;r=this.connections("OsFloatIpUsage")[0],e?r||(t=n.modelClassForType("OsFloatIpUsage"),new t(this)):r&&r.remove(),(this.isEmbedded()?this.owner():this).trigger("change:fip")},getFloatingIp:function(){return this.connectionTargets("OsFloatIpUsage")[0]},getRouter:function(){var e,t,n;return e=this.owner()||this,t=e.parent(),t&&(n=t.connectionTargets("OsRouterAsso")[0]),n||null},serialize:function(){var e,t,n,r,i;return this.isEmbedded()?r=this.owner().parent():r=this.parent(),i=this,e=0,this.owner()&&!this.isEmbedded()&&(n=this.owner().connectionTargets("OsPortUsage"),_.each(n,function(t,n){return i===t&&(e=n),null})),t={component:{name:this.get("name"),type:this.type,uid:this.id,resource:{id:this.get("appId"),name:this.get("name"),mac_address:this.get("macAddress"),security_groups:this.connectionTargets("OsSgAsso").map(function(e){return e.createRef("id")}),network_id:r.parent().createRef("id"),device_id:this.owner()?this.owner().createRef("id"):"",device_index:e,fixed_ips:[{subnet_id:r.createRef("id"),ip_address:this.get("ip")}]}}},this.isEmbedded()||(t.layout=this.generateLayout()),t},setIp:function(e){return this.set("ip",e)}},{handleTypes:t.RESTYPE.OSPORT,deserialize:function(e,t,i){var s,o,u,a,f,l;o=new r({id:e.uid,name:e.resource.name,appId:e.resource.id,parent:i(MC.extractID(e.resource.fixed_ips[0].subnet_id)),ip:e.resource.fixed_ips[0].ip_address,macAddress:e.resource.mac_address,x:t.coordinate[0],y:t.coordinate[1]}),s=n.modelClassForType("OsSgAsso"),l=e.resource.security_groups;for(a=0,f=l.length;a<f;a++)u=l[a],new s(o,i(MC.extractID(u)))},getAvailableIP:function(e){var r,i,s,o,u,a,f;f=e.get("cidr"),o=[],i=n.modelClassForType(t.RESTYPE.OSPORT).allObjects(),r=n.modelClassForType(t.RESTYPE.OSLISTENER).allObjects(),a=i.concat(r),_.each(a,function(t){var n;return t.isEmbedded&&t.isEmbedded()?n=t.owner().parent():n=t.parent(),n===e&&o.push(t.get("ip")),null}),s=n.modelClassForType(t.RESTYPE.ENI).getAvailableIPInCIDR(f,o,0,[0,1,2]);if(s&&s[s.length-1]){u=s[s.length-1];if(u.available)return u.ip}return null}}),r});