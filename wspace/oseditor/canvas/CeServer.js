(function(){define(["CanvasElement","constant","CanvasManager","i18n!/nls/lang.js","CloudResources","./CpVolume"],function(e,t,n,r,i,s){return e.extend({type:t.RESTYPE.OSSERVER,parentType:[t.RESTYPE.OSSUBNET],defaultSize:[8,8],portPosMap:{"pool-left":[0,40,e.constant.PORT_LEFT_ANGLE],"pool-right":[80,40,e.constant.PORT_RIGHT_ANGLE],"server-left":[0,60,e.constant.PORT_LEFT_ANGLE],"server-right":[80,60,e.constant.PORT_RIGHT_ANGLE]},portDirMap:{pool:"horizontal",server:"horizontal"},events:{"mousedown .fip-status":"toggleFip","mousedown .vol-image":"showVolume","click .fip-status":"suppressEvent","click .vol-image":"suppressEvent"},suppressEvent:function(){return!1},labelWidth:function(){return 100},iconUrl:function(){var e,t,n,r;return e=this.model.getImage()||this.model.get("cachedAmi"),e?r="ide/ami-os/"+e.os_type+"."+e.architecture+"@2x.png":(t=this.model,n=i(t.type,t.design().region()).get(t.get("appId")),n?(n=n.attributes,n.platform&&n.platform==="windows"?r="ide/ami-os/windows."+n.architecture+"@2x.png":r="ide/ami-os/linux."+n.architecture+"@2x.png"):r="ide/ami-os/image-not-available.png"),r},listenModelEvents:function(){this.listenTo(this.model,"change:imageId",this.render),this.listenTo(this.model,"change:fip",this.render),this.listenTo(this.canvas,"change:externalData",this.updateState)},updateState:function(){var e,t,n,r;t=this.model,r=this.$el.children(".res-state");if(r)return e=i(t.type,t.design().region()).get(t.get("appId")),n=(e!=null?e.get("status"):void 0)||"unknown",r.data("tooltip",n).attr("data-tooltip",n).attr("class","res-state tooltip "+n)},toggleFip:function(){var e,t;return this.canvas.design.modeIsApp()?!1:(e=this.model.embedPort(),t=!!e.getFloatingIp(),e.setFloatingIp(!t),n.updateFip(this.$el.children(".fip-status"),this.model),!1)},create:function(){var e,t,n;return e=this.model,t=this.canvas.svg,n=this.createRawNode().add([t.use("os_server"),t.image(MC.IMG_URL+this.iconUrl(),30,30).move(25,10).classes("ami-image tooltip").attr({"data-tooltip":this.model.getImage().name}),t.group().move(43,50).classes("fip-status cvs-hover tooltip").add([t.image("").size(26,21).classes("normal"),t.image("").size(26,21).classes("hover")]),t.group().move(15,46).classes("vol-image cvs-hover tooltip").add([t.image("").size(22,26).classes("normal"),t.image("").size(22,26).classes("hover")]),t.plain("").move(26,60).classes("volume-number"),this.createPortElement().attr({"class":"port port-blue tooltip","data-name":"pool","data-alias":"pool-left","data-tooltip":r.IDE.PORT_TIP_O}),this.createPortElement().attr({"class":"port port-blue tooltip","data-name":"pool","data-alias":"pool-right","data-tooltip":r.IDE.PORT_TIP_O}),this.createPortElement().attr({"class":"port port-green tooltip","data-name":"server","data-alias":"server-left","data-tooltip":r.IDE.PORT_TIP_N}),this.createPortElement().attr({"class":"port port-green tooltip","data-name":"server","data-alias":"server-right","data-tooltip":r.IDE.PORT_TIP_N})]),!e.design().modeIsStack()&&e.get("appId")&&n.add(t.circle(8).move(63,11).classes("res-state unknown")),this.canvas.appendNode(n),this.initNode(n,e.x(),e.y()),this.listenTo(this.model,"change:volume",this.updateVolume),n},render:function(){var e;return e=this.model,n.setLabel(this,this.$el.children(".node-label")),n.update(this.$el.children(".ami-image"),this.iconUrl(),"href"),n.updateFip(this.$el.children(".fip-status"),e),this.updateVolume(),this.updateState(),null},updateVolume:function(){var e,t,r,i,s;i=this.model,s=i.volumes(),this.$el.children(".volume-number").text(s.length||0),s.length===0?(t="ide/icon-os/cvs-vol-e-n.png",r="ide/icon-os/cvs-vol-e-h.png"):(t="ide/icon-os/cvs-vol-ne-n.png",r="ide/icon-os/cvs-vol-ne-h.png"),e=this.$el.children(".vol-image"),n.update(e.find(".normal"),t,"href"),n.update(e.find(".hover"),r,"href")},showVolume:function(){var e,t,n,r;n=this.model,r=n.volumes()[0],e=this.$el[0],t=this.canvas,new s({attachment:e,host:n,models:n.volumes(),canvas:t,selectAtBegin:r})}})})}).call(this);