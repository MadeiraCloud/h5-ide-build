(function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define(["constant","MC"],function(t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b;return c=function(e){var t,r,i,s,o,u,a,f,l;s=n.canvas_data.component[e],o=n.aws.elb.getNewName(),n.canvas_data.component[e].resource.LoadBalancerName=o,n.canvas_data.component[e].name=o,n.canvas.update(e,"text","elb_name",o),t=n.canvas_data.component,l=s.resource.VpcId,i=!1,n.aws.aws.checkDefaultVPC()&&(i=!0),!l&&!i&&(n.canvas_data.component[e].resource.Scheme="");if(n.aws.vpc.getVPCUID()||i)u=o+"-sg",r=!0,_.each(n.canvas_data.component,function(e){return e.type==="AWS.EC2.SecurityGroup"&&u===e.name&&(r=!1),null}),r&&(a=$.extend(!0,{},n.canvas.SG_JSON.data),a.uid=n.guid(),a.name=u,a.resource.GroupDescription="Automatically created SG for load-balancer",a.resource.GroupName=a.name,l&&(a.resource.VpcId=l),n.canvas_data.component[a.uid]=a,f=n.aws.aws.genResRef(a.uid,"resource.GroupId"),n.canvas_data.component[e].resource.SecurityGroups=[f],n.aws.elb.updateRuleToElbSG(e),n.aws.sg.addSGToProperty(a));return null},f=function(){var e,t;return e=0,t="load-balancer-",_.each(n.canvas_data.component,function(n){var r,i,s;return r=n.type,r==="AWS.ELB"&&(s=n.name,s.slice(0,t.length)===t&&(i=Number(s.slice(t.length)),i>e&&(e=i))),null}),e++,t+e},r=function(e,t){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E;f=n.canvas_data.component[e],p=n.canvas_data.component[t],o=p.resource.Placement.AvailabilityZone,t=p.uid,d=n.aws.aws.genResRef(t,"resource.InstanceId"),l=f.resource.Instances,c=l.length,u=f.resource.AvailabilityZones,a=u.length,i=!0,_.each(l,function(e,t){if(e.InstanceId===d)return i=!1,null}),i&&n.canvas_data.component[e].resource.Instances.push({InstanceId:d}),r=!0,_.each(u,function(e,t){if(e===o)return r=!1,null}),r&&n.canvas_data.component[e].resource.AvailabilityZones.push(o),y=n.aws.aws.genResRef(y,"resource.SubnetId"),E=f.resource.Subnets;for(h=b=0,w=E.length;b<w;h=++b){g=E[h],m=n.extractID(g),v=n.canvas_data.component[m];if(v.resource.AvailabilityZone===o){s=!0;break}}return!s&&p.resource.SubnetId?(f.resource.Subnets.push(p.resource.SubnetId),n.extractID(p.resource.SubnetId)):null},m=function(e,t){var r,i,s,o,u,a,f;return r=n.canvas_data.component[e],u=n.canvas_data.component[t],t=u.uid,a=n.aws.aws.genResRef(t,"resource.InstanceId"),i=r.resource.Instances,s=i.length,o=n.canvas_data.component[e].resource.Instances,f=_.filter(o,function(e){return e.InstanceId===a?!1:!0}),n.canvas_data.component[e].resource.Instances=f,null},y=function(){return _.each(n.canvas_data.component,function(e,t){return e.type==="AWS.ELB"&&(n.canvas_data.component[t].resource.Scheme="internal",n.canvas.update(t,"image","elb_scheme",n.canvas.IMAGE.ELB_INTERNAL_CANVAS)),null}),null},s=function(e,t){var r,i,s,o,u,a,f,l,c,h,p;i=n.canvas_data.component[e],r={},a=n.canvas_data.component[t].resource.AvailabilityZone,t=n.aws.aws.genResRef(t,"resource.SubnetId"),p=i.resource.Subnets;for(s=c=0,h=p.length;c<h;s=++c)l=p[s],u=n.extractID(l),o=n.canvas_data.component[u],o.resource.AvailabilityZone===a&&(f=u,i.resource.Subnets[s]=t);return f||(i.resource.Subnets.push(t),i.resource.AvailabilityZones.push(a)),f},g=function(e,t){var r,i,s,o,u,a,f,l,c,h,p,d;o=n.canvas_data.component[e],p=o.resource.Subnets;for(u=f=0,c=p.length;f<c;u=++f){a=p[u];if(a.indexOf(t)!==-1){o.resource.Subnets.splice(u,1);break}}s={},i=[],d=o.resource.Subnets;for(u=l=0,h=d.length;l<h;u=++l){a=d[u],r=n.canvas_data.component[n.extractID(a)].resource.AvailabilityZone;if(s[r])continue;s[r]=!0,i.push(r)}return o.resource.AvailabilityZones=i,null},i=function(e,r){var i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T;a=n.canvas_data.component;for(p in a){u=a[p];if(u.type===t.AWS_RESOURCE_TYPE.AWS_AutoScaling_Group&&u.resource.LaunchConfigurationName.indexOf(r)!==-1){i=u;break}}if(!i)return[];i.resource.LoadBalancerNames.join(" ").indexOf(e)===-1&&i.resource.LoadBalancerNames.push(n.aws.aws.genResRef(e,"resource.LoadBalancerName")),f=a[e].resource,o={};if(n.canvas_data.platform===n.canvas.PLATFORM_TYPE.EC2_CLASSIC||n.canvas_data.platform===n.canvas.PLATFORM_TYPE.DEFAULT_VPC){S=f.AvailabilityZones;for(d=0,y=S.length;d<y;d++)s=S[d],o[s]=!0;x=i.resource.AvailabilityZones;for(v=0,b=x.length;v<b;v++)s=x[v],o[s]||f.AvailabilityZones.push(s);return[]}i.resource.VPCZoneIdentifier.length?(h=i.resource.VPCZoneIdentifier.split(","),h=_.map(h,n.extractID)):h=[];for(m=0,w=h.length;m<w;m++)c=h[m],c&&a[c]&&(o[a[c].resource.AvailabilityZone]=c);T=f.AvailabilityZones;for(g=0,E=T.length;g<E;g++)s=T[g],delete o[s];h=[],l=f.Subnets.join(" ");for(s in o)c=o[s],f.AvailabilityZones.push(s),l.indexOf(c)===-1&&(h.push(c),f.Subnets.push(n.aws.aws.genResRef(c,"resource.SubnetId")));return h},p=function(e,t){var r,i;return r=n.canvas_data.component[t],i=r.resource.LoadBalancerNames.join(" ").replace(n.aws.aws.genResRef(e,"resource.LoadBalancerName"),""),r.resource.LoadBalancerNames=i.length===0?[]:i.split(" "),null},b=function(e){var t,r,i,s,o,u;if(!n.aws.vpc.getVPCUID())return;t=n.canvas_data.component[e],o=t.resource.ListenerDescriptions,u=[],_.each(o,function(e){var t;return t=e.Listener.LoadBalancerPort,u.push({protocol:"tcp",port:t}),null}),u=_.uniq(u),r=n.aws.elb.getElbDefaultSG(e);if(r)return s=r.uid,i=r.resource.IpPermissions,_.each(u,function(e){var t,n;return t=!0,n=!0,_.each(i,function(n){var r,i;i="tcp",r=n.FromPort;if(e.protocol===i&&e.port===r){t=!1;return}return null}),t&&i.push({FromPort:e.port,ToPort:e.port,IpProtocol:e.protocol,IpRanges:"0.0.0.0/0",Groups:[{GroupId:"",GroupName:"",UserId:""}]}),null}),i=_.filter(i,function(e){var t,n,r;return r=e.IpProtocol,n=e.FromPort,t=!1,_.each(u,function(e){return e.protocol===r&&e.port===n&&(t=!0),null}),t}),n.canvas_data.component[s].resource.IpPermissions=i},a=function(e){var t,r,i,s,o,u;return i=n.canvas_data.component[e],i?(r=n.canvas.getState(),r==="stack"?s=i.resource.LoadBalancerName:s=i.name,o=s+"-sg",u="",t=n.canvas_data.component,_.each(t,function(e){e.name===o&&(u=e.uid)}),n.canvas_data.component[u]):null},u=function(){var e;return e=[],_.each(n.canvas_data.component,function(t){var r,i;return r=t.type,r==="AWS.ELB"&&(i=n.aws.elb.getElbDefaultSG(t.uid),i&&e.push(i.uid)),null}),e},v=function(e){var t;t=n.aws.elb.getElbDefaultSG(e);if(t)return delete n.canvas_data.component[t.uid]},h=function(e){var t;return t=!1,_.each(n.canvas_data.component,function(r){var i,s;return i=r.type,i==="AWS.ELB"&&(s=n.aws.elb.getElbDefaultSG(r.uid),s&&s.uid===e&&(t=!0)),null}),t},d=function(e){var t;return t=n.aws.aws.genResRef(e,"resource.InstanceId"),_.each(n.canvas_data.component,function(e){var r,i,s;return r=e.type,r==="AWS.ELB"&&(i=e.resource.Instances,s=_.filter(i,function(e){var n;return n=e.InstanceId,n===t?!1:!0}),n.canvas_data.component[e.uid].resource.Instances=s),null}),null},l=function(e,t){var r,i,s,o;return i=n.canvas_data.component[e],s=i.resource.Instances,r=i.resource.AvailabilityZones,o=!1,_.each(s,function(e){var r,i,s;s=n.extractID(e.InstanceId),i=n.canvas_data.component[s],r=i.resource.Placement.AvailabilityZone;if(r===t)return o=!0}),o},o=function(t){var r,i,s;return i=n.canvas_data.component[t],s=i.resource.Instances,r=[],_.each(s,function(t){var i,s,o;return s=t.InstanceId,o=n.extractID(s),i=n.canvas_data.component[o].resource.Placement.AvailabilityZone,e.call(r,i)>=0||r.push(i),null}),r},{init:c,addInstanceAndAZToELB:r,removeInstanceFromELB:m,setAllELBSchemeAsInternal:y,addSubnetToELB:s,removeSubnetFromELB:g,addLCToELB:i,removeASGFromELB:p,getNewName:f,getElbDefaultSG:a,updateRuleToElbSG:b,getAllElbSGUID:u,removeELBDefaultSG:v,isELBDefaultSG:h,removeAllELBForInstance:d,haveAssociateInAZ:l,getAZAryForDefaultVPC:o}})}).call(this);