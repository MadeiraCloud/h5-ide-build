(function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define(["i18n!nls/lang.js","MC","constant"],function(t,n,r){var i,s,o,u,a,f,l,c,h,p,d,v,m;return a=function(t){var r,i,s;return i=0,s=[],r=[],_.each(n.canvas_data.component,function(i){var o,u;o=i.type;if(o==="AWS.ELB"||o==="AWS.AutoScaling.LaunchConfiguration")s=i.resource.SecurityGroups,s=_.map(s,function(e){var t;return t=n.extractID(e),t}),e.call(s,t)>=0&&r.push(i);return o==="AWS.EC2.Instance"&&(s=i.resource.SecurityGroupId,s=_.map(s,function(e){var t;return t=n.extractID(e),t}),e.call(s,t)>=0&&r.push(i)),o==="AWS.VPC.NetworkInterface"&&(u=[],_.each(i.resource.GroupSet,function(e){return u.push(e.GroupId),null}),s=u,s=_.map(s,function(e){var t;return t=n.extractID(e),t}),e.call(s,t)>=0&&r.push(i)),null}),r},u=function(e){var t,r,i,s,o;return s=0,o=[],i=[],t=n.aws.sg.getDefaultSG(),r=t.uid,_.each(n.canvas_data.component,function(t){var i,s,u,a,f,l,c,h,p;i=t.type,s=t.uid;if(i==="AWS.ELB"||i==="AWS.AutoScaling.LaunchConfiguration")o=t.resource.SecurityGroups,o=_.filter(o,function(t){var r;return r=n.extractID(t),e===r?!1:!0}),o.length===0&&o.push(n.aws.aws.genResRef(r,"resource.GroupId")),n.canvas_data.component[s].resource.SecurityGroups=o,n.aws.sg.updateSGColorLabel(s);return i==="AWS.EC2.Instance"&&(u=n.aws.eni.getInstanceDefaultENI(s),u&&(a=u.resource.GroupSet,a=_.filter(a,function(t){var r;return r=n.extractID(t.GroupId),e===r?!1:!0}),a.length===0&&a.push({GroupId:n.aws.aws.genResRef(r,"resource.GroupId"),GroupName:n.aws.aws.genResRef(r,"resource.GroupName")}),n.canvas_data.component[u.uid].resource.GroupSet=a),u||(o=t.resource.SecurityGroupId,o=_.filter(o,function(t){var r;return r=n.extractID(t),e===r?!1:!0}),o.length===0&&o.push(n.aws.aws.genResRef(r,"resource.GroupId")),h=t.resource.SecurityGroup,h=_.filter(h,function(t){var r;return r=n.extractID(t),e===r?!1:!0}),h.length===0&&h.push(n.aws.aws.genResRef(r,"resource.GroupName")),n.canvas_data.component[s].resource.SecurityGroupId=o,n.canvas_data.component[s].resource.SecurityGroup=h),n.aws.sg.updateSGColorLabel(s)),i==="AWS.VPC.NetworkInterface"&&(o=t.resource.GroupSet,o=_.filter(o,function(t){var r;return r=n.extractID(t.GroupId),e===r?!1:!0}),o.length===0&&o.push({GroupId:n.aws.aws.genResRef(r,"resource.GroupId"),GroupName:n.aws.aws.genResRef(r,"resource.GroupName")}),n.canvas_data.component[s].resource.GroupSet=o,n.aws.sg.updateSGColorLabel(s)),i==="AWS.EC2.SecurityGroup"&&(n.aws.aws.genResRef(e,"resource.GroupId"),c=t.resource.IpPermissions,p=t.resource.IpPermissionsEgress,c&&(f=_.filter(c,function(e){return e.IpRanges===sgRuleRef?!1:!0}),n.canvas_data.component[s].resource.IpPermissions=f),p&&(l=_.filter(p,function(e){return e.IpRanges===sgRuleRef?!1:!0}),n.canvas_data.component[s].resource.IpPermissionsEgress=l)),null}),i},f=function(e,t){var r,i,s,o,u;return s=n.canvas.getState(),u=[],e.ipPermissionsEgress&&(u=e.ipPermissionsEgress.item),o=[],e.ipPermissions&&(o=e.ipPermissions.item),o=_.map(o,function(e){return e.direction="inbound",e}),u=_.map(u,function(e){return e.direction="outbound",e}),i=o.concat(u),r=[],_.each(i,function(e){var i,o,u,a,f,l,c,h,p,d,v,m,g,y;return f=_.clone(e),u="",l="",f.ipRanges?u=f.ipRanges.item[0].cidrIp:(c=f.groups.item[0].groupId,t||s==="app"?u=n.aws.sg.getSGNameInStackForApp(c):u=c,h=n.aws.sg.getSGUIDInStackForApp(c),l=n.aws.sg.getSGColor(h)),(p=f.ipProtocol)===-1||p==="-1"?(f.ipProtocol="all",f.fromPort=0,f.toPort=65535):(d=f.ipProtocol)!=="tcp"&&d!=="udp"&&d!=="icmp"&&d!=="all"&&d!==-1&&d!=="-1"&&(f.ipProtocol=""+f.ipProtocol),a="",f.ipProtocol==="icmp"?a="/":a="-",i=f.fromPort+a+f.toPort,Number(f.fromPort)===Number(f.toPort)&&f.ipProtocol!=="icmp"&&(i=f.toPort,Number(f.fromPort)===0&&((v=f.ipProtocol)==="tcp"||v==="udp"?i="0-65535":i="ALL")),(!f.fromPort||!f.toPort)&&(m=f.ipProtocol)!=="all"&&m!==-1&&m!=="-1"&&(i="-"),(g=f.ipProtocol)!=="tcp"&&g!=="udp"&&g!=="icmp"&&g!=="all"&&g!==-1&&g!=="-1"&&((y=f.ipProtocol)==="6"||y===6||y==="17"||y===17?i="0-65535":i="ALL"),o={fromPort:f.fromPort,toPort:f.toPort,ipProtocol:f.ipProtocol,ipRanges:u,direction:f.direction,partType:a,dispPort:i,sgColor:l},r.push(o),null}),r},v=function(e){var t,i;return t=[],i=null,$.type(e)==="string"?i=n.canvas.lineTarget(e):i=e,$.each(i,function(e,i){var s,o;switch(n.canvas_data.component[i.uid].type){case r.AWS_RESOURCE_TYPE.AWS_EC2_Instance:return n.canvas_data.platform===n.canvas.PLATFORM_TYPE.EC2_CLASSIC?(o={},o.name=n.canvas_data.component[i.uid].name,o.sg=function(){var e,t,r,o;r=n.canvas_data.component[i.uid].resource.SecurityGroupId,o=[];for(e=0,t=r.length;e<t;e++)s=r[e],o.push({uid:n.extractID(s),name:n.canvas_data.component[n.extractID(s)].name,color:n.aws.sg.getSGColor(n.extractID(s))});return o}(),t.push(o)):$.each(n.canvas_data.component,function(e,u){if(u.type===r.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface&&n.extractID(u.resource.Attachment.InstanceId)===i.uid&&u.resource.Attachment.DeviceIndex==="0")return o={},o.name=n.canvas_data.component[i.uid].name,o.sg=function(){var e,t,r,i;r=u.resource.GroupSet,i=[];for(e=0,t=r.length;e<t;e++)s=r[e],i.push({name:n.canvas_data.component[n.extractID(s)].name,uid:n.extractID(s.GroupId),color:n.aws.sg.getSGColor(n.extractID(s.GroupId))});return i}(),t.push(o),!1});case r.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface:return o={},o.name=n.canvas_data.component[i.uid].name,o.sg=function(){var e,t,r,o;r=n.canvas_data.component[i.uid].resource.GroupSet,o=[];for(e=0,t=r.length;e<t;e++)s=r[e],o.push({uid:n.extractID(s),name:n.canvas_data.component[n.extractID(s.GroupId)].name,color:n.aws.sg.getSGColor(n.extractID(s.GroupId))});return o}(),t.push(o);case r.AWS_RESOURCE_TYPE.AWS_ELB:case r.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration:return o={},o.name=n.canvas_data.component[i.uid].name,o.sg=function(){var e,t,r,o;r=n.canvas_data.component[i.uid].resource.SecurityGroups,o=[];for(e=0,t=r.length;e<t;e++)s=r[e],o.push({uid:n.extractID(s),name:n.canvas_data.component[n.extractID(s)].name,color:n.aws.sg.getSGColor(n.extractID(s))});return o}(),t.push(o)}}),t},o=function(){var e,s,o,u,a;return u=n.guid(),e=$.extend(!0,{},n.canvas.SG_JSON.data),e.uid=u,o=n.aws.aws.getNewName(r.AWS_RESOURCE_TYPE.AWS_EC2_SecurityGroup),e.name=o,e.resource.GroupName=o,a=n.aws.vpc.getVPCUID(),a&&(e.resource.VpcId=n.aws.aws.genResRef(a,"resource.VpcId")),e.resource.GroupDescription=t.ide.PROP_TEXT_CUSTOM_SG_DESC,e.resource.IpPermissions=[],e.resource.IpPermissionsEgress.push({IpProtocol:"-1",IpRanges:"0.0.0.0/0",FromPort:"0",ToPort:"65535",Groups:[]}),s=Design.instance().serialize().component,s[u]=e,n.canvas.data.set("component",s),i(e),u},i=function(e){var t,r;return t=!1,r=n.canvas_property,r?($.each(r.sg_list,function(n,r){return e.id===r.uid?(t=!0,!1):null}),t||r.sg_list.push({color:c(),member:0,name:e.name,uid:e.uid})):console.log("[addSGToProperty] no canvas_property found"),null},h=function(e){var t;t=null,n.canvas_property&&n.canvas_property.sg_list&&$.each(n.canvas_property.sg_list,function(n,r){if(r.color&&r.uid===e)return t=r.color,!1});if(!t){t=Math.floor(Math.random()*16777215).toString(16);while(t.length<6)t="0"+t}return"#"+t},c=function(){var e;e=null,n.canvas_property&&n.canvas_property.sg_list&&$.each(n.canvas.SG_COLORS,function(t,r){var i;i=!1,$.each(n.canvas_property.sg_list,function(e,t){if(t.color===r)return i=!0,!1});if(!i)return e=r,!1});if(!e){e=Math.floor(Math.random()*16777215).toString(16);while(e.length<6)e="0"+e}return e},m=function(e){return e&&n.canvas.updateSG(e),null},l=function(){var e;return e=null,_.each(n.canvas_data.component,function(t){return t.name==="DefaultSG"&&(e=t),null}),e},s=function(e){var t;return t=[],t=_.map(e,function(e){var t,r,i;return e.type==="AWS.VPC.NetworkInterface"&&e.name==="eni0"?(r=e.resource.Attachment.InstanceId,i=n.extractID(r),t=n.canvas_data.component[i],t):e}),t},p=function(e){var t;return t="",_.each(n.canvas_data.component,function(n){var r;return n.type==="AWS.EC2.SecurityGroup"&&(r=n.resource.GroupId,r===e&&(t=n.name)),null}),t},d=function(e){var t;return t="",_.each(n.canvas_data.component,function(n,r){var i;return n.type==="AWS.EC2.SecurityGroup"&&(i=n.resource.GroupId,i===e&&(t=r)),null}),t},{getAllRefComp:a,getAllRule:f,getSgRuleDetail:v,createNewSG:o,addSGToProperty:i,getSGColor:h,updateSGColorLabel:m,deleteRefInAllComp:u,getDefaultSG:l,convertMemberNameToReal:s,getSGNameInStackForApp:p,getSGUIDInStackForApp:d}})}).call(this);