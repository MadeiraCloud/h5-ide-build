define("workspaces/coreeditor/TplOpsEditor",["handlebars"],function(e){var t,n={modal:{}};return t=function(e,t,n,r,i){this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o;s+='<div id="OpsEditor" class="pos-r">\n  <aside class="OEPanelLeft"></aside>\n  <aside class="OEPanelRight" id="OEPanelRight"></aside>\n\n<div class="OEMiddleWrap">\n  <nav class="OEPanelTop"></nav>\n  <div class="OEPanelBottom"></div>\n\n  <section class="OEPanelCenter nano"> <div class="nano-content">\n    <div class="canvas-view">\n      <button class="svg_resizer icon-resize-down tooltip" data-tooltip=\'',o=n.i18n.call(t,"CANVAS.CVS_TIP_EXPAND_H",{hash:{},data:i});if(o||o===0)s+=o;s+="'></button>\n      <button class=\"svg_resizer icon-resize-up tooltip\" data-tooltip='",o=n.i18n.call(t,"CANVAS.CVS_TIP_SHRINK_H",{hash:{},data:i});if(o||o===0)s+=o;s+="'></button>\n      <button class=\"svg_resizer icon-resize-right tooltip\" data-tooltip='",o=n.i18n.call(t,"CANVAS.CVS_TIP_EXPAND_W",{hash:{},data:i});if(o||o===0)s+=o;s+="'></button>\n      <button class=\"svg_resizer icon-resize-left tooltip\" data-tooltip='",o=n.i18n.call(t,"CANVAS.CVS_TIP_SHRINK_W",{hash:{},data:i});if(o||o===0)s+=o;return s+='\'></button>\n      <svg width="100%" height="100%"></svg>\n    </div> </div>\n    <q class="canvas-message"></q>\n  </section>\n</div>\n</div>',s},n.frame=e.template(t),t=function(e,t,n,r,i){this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o=this.escapeExpression;return s+='<div class="ops-process">\n  <header class="processing">'+o(n.i18n.call(t,"TOOLBAR.LOADING_DATA",{hash:{},data:i}))+'</header>\n  <section class="loading-spinner"></section>\n</div>',s},n.loading=e.template(t),t=function(e,t,n,r,i){this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o="function",u=this.escapeExpression;return s+='<div class="modal-text-wraper">\n    <div class="modal-center-align-helper">\n        <div class="modal-text-major">'+u(typeof t===o?t.apply(t):t)+" "+u(n.i18n.call(t,"TOOLBAR.HAS_UNSAVED_CHANGES",{hash:{},data:i}))+'</div>\n        <div class="modal-text-major">'+u(n.i18n.call(t,"TOOLBAR.CLOSE_CONFIRM",{hash:{},data:i}))+"</div>\n    </div>\n</div>",s},n.modal.onClose=e.template(t),t=function(e,t,n,r,i){this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o=this.escapeExpression;return s+='<p class="modal-text-major">'+o(n.i18n.call(t,"TOOLBAR.VPC_REMOVED_OUTSIDE_VISUALOPS",{hash:{},data:i}))+'</p>\n<p class="modal-text-major">'+o(n.i18n.call(t,"TOOLBAR.CONFIRM_REMOVE_APP",{hash:{},data:i}))+"</p>",s},n.modal.confirmRemoveApp=e.template(t),t=function(e,t,n,r,i){this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u=this.escapeExpression,a="function";return s+='<p class="modal-text-major">'+u(n.i18n.call(t,"TOOLBAR.IMPORT_SUCCESSFULLY_WELL_DONE",t&&t.name,{hash:{},data:i}))+'</p>\n<p class="modal-text-major">'+u(n.i18n.call(t,"TOOLBAR.NAME_IMPORTED_APP",{hash:{},data:i}))+'</p>\n<div class="modal-control-group">\n    <label for="ImportSaveAppName">'+u(n.i18n.call(t,"TOOLBAR.APP_NAME",{hash:{},data:i}))+'</label>\n    <input id="ImportSaveAppName" class="input" value="'+u((o=t&&t.name,typeof o===a?o.apply(t):o))+'" type="string" autofocus>\n</div>\n<div class="modal-control-group app-usage-group clearfix">\n    <label for="">'+u(n.i18n.call(t,"TOOLBAR.APP_USAGE",{hash:{},data:i}))+'</label>\n    <div id="app-usage-selectbox" class="selectbox">\n        <div class="selection"><i class="icon-app-type-testing"></i>Testing</div>\n        <ul class="dropdown" tabindex="-1">\n            <li class="selected item" data-value="testing"><i class="icon-app-type-testing"></i>Testing</li>\n            <li class="item" data-value="development"><i class="icon-app-type-development"></i>Development</li>\n            <li class="item" data-value="production"><i class="icon-app-type-production"></i>Production</li>\n            <li class="item" data-value="others"><i class="icon-app-type-others" data-value="testing"></i>Others</li>\n        </ul>\n    </div>\n</div>\n\n<section style="margin:5px 5px 20px 8px;">\n  <div class="checkbox"><input id="MonitorImportApp" type="checkbox" checked="checked"><label for="MonitorImportApp"></label></div>\n  <label for="MonitorImportApp">'+u(n.i18n.call(t,"TOOLBAR.MONITOR_REPORT_EXTERNAL_RESOURCE",{hash:{},data:i}))+'</label>\n  <i class="icon-info tooltip" data-tooltip="'+u(n.i18n.call(t,"TOOLBAR.IF_RESOURCE_CHANGED_EMAIL_SENT",{hash:{},data:i}))+'" style="color:#148BE6;vertical-align:-3px;"></i>\n</section>\n\n<p>'+u(n.i18n.call(t,"TOOLBAR.YOU_CAN_MANAGE_RESOURCES_LIFECYCLE",{hash:{},data:i}))+"</p>",s},n.modal.confirmImport=e.template(t),t=function(e,t,n,r,i){function l(e,t){return"has-progess"}function c(e,t){var n;return a((n=e&&e.title,typeof n===u?n.apply(e):n))}function h(e,t){return a(n.i18n.call(e,"PROC_TITLE",{hash:{},data:t}))}this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u="function",a=this.escapeExpression,f=this;s+="<div class='ops-process ",o=n["if"].call(t,t&&t.progress,{hash:{},inverse:f.noop,fn:f.program(1,l,i),data:i});if(o||o===0)s+=o;s+='\'>\n  <section class="processing-wrap">\n    <header class="processing">',o=n["if"].call(t,t&&t.title,{hash:{},inverse:f.program(5,h,i),fn:f.program(3,c,i),data:i});if(o||o===0)s+=o;return s+='<span class="process-info">'+a((o=t&&t.progress,typeof o===u?o.apply(t):o))+'%</span></header>\n    <header class="processing rolling-back-content">'+a(n.i18n.call(t,"PROP.ROLLING_BACK",{hash:{},data:i}))+'</header>\n    <section class="loading-spinner"></section>\n    <section class="progress">\n        <div class="bar" style="width:'+a((o=t&&t.progress,typeof o===u?o.apply(t):o))+'%;"></div>\n    </section>\n  </section>\n\n  <section class="success hide">\n    <p class="title">'+a(n.i18n.call(t,"PROC_RLT_DONE_TITLE",{hash:{},data:i}))+'</p>\n    <p class="sub-title">'+a(n.i18n.call(t,"PROC_RLT_DONE_SUB_TITLE",{hash:{},data:i}))+'</p>\n  </section>\n\n  <section class="fail hide error-info-block">\n    <header>'+a(n.i18n.call(t,"PROC_FAILED_TITLE",{hash:{},data:i}))+'</header>\n    <p class="sub-title">'+a(n.i18n.call(t,"PROC_RLT_FAILED_SUB_TITLE",{hash:{},data:i}))+'</p>\n    <div class="result-error-info">\n      <p class="title">'+a(n.i18n.call(t,"PROC_ERR_INFO",{hash:{},data:i}))+'</p>\n      <p class="detail"></p>\n    </div>\n    <button class="btn btn-silver btn-close-process right">'+a(n.i18n.call(t,"PROC_CLOSE_TAB",{hash:{},data:i}))+"</button>\n  </section>\n</div>",s},n.progressView=e.template(t),t=function(e,t,n,r,i){this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o="function",u=this.escapeExpression;return s+='<div class="ops-process">\n    <header class="processing">'+u(typeof t===o?t.apply(t):t)+'<span class="process-info">0%</span></header>\n    <header class="processing rolling-back-content">'+u(n.i18n.call(t,"TOOLBAR.ROLLING_BACK",{hash:{},data:i}))+'</header>\n    <section class="loading-spinner"></section>\n    <section class="progress">\n        <div class="bar" style="width:0%;"></div>\n    </section>\n</div>',s},n.appProcessing=e.template(t),t=function(e,t,n,r,i){function l(e,t){var r="";return r+='\n  <header class="processing">'+u(n.i18n.call(e,"TOOLBAR.RELOADING_DATA",{hash:{},data:t}))+'</header>\n  <section class="loading-spinner"></section>\n',r}function c(e,t){var r="",i;r+='\n  <header class="processing">',i=n.unless.call(e,e&&e.error,{hash:{},inverse:f.program(6,p,t),fn:f.program(4,h,t),data:t});if(i||i===0)r+=i;r+="</header>\n  ",i=n["if"].call(e,e&&e.error,{hash:{},inverse:f.noop,fn:f.program(8,d,t),data:t});if(i||i===0)r+=i;return r+='\n  <button class="btn btn-silver" id="processDoneBtn">'+u(n.i18n.call(e,"TOOLBAR.LBL_DONE",{hash:{},data:t}))+"</button>\n",r}function h(e,t){return u(n.i18n.call(e,"TOOLBAR.APP_UPDATE_SUCCESSFULLY_TITLE",{hash:{},data:t}))}function p(e,t){return u(n.i18n.call(e,"TOOLBAR.APP_UPDATE_FAILED_TITLE",{hash:{},data:t}))}function d(e,t){var r="",i;r+='\n  <div class="error-info-block">\n    <div class="result-sub-title">'+u(n.i18n.call(e,"PROC_RLT_FAILED_SUB_TITLE",{hash:{},data:t}))+'</div>\n    <div class="result-error-info">\n      <p class="title">'+u(n.i18n.call(e,"PROC_ERR_INFO",{hash:{},data:t}))+'</p>\n      <p class="detail">',i=(i=e&&e.error,typeof i===a?i.apply(e):i);if(i||i===0)r+=i;return r+='</p>\n    </div>\n    <div class="result-error-notice">'+u(n.i18n.call(e,"TOOLBAR.APP_ROllBACK_DESC",{hash:{},data:t}))+"</div>\n  </div>\n  ",r}this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u=this.escapeExpression,a="function",f=this;s+='<div class="ops-process">\n',o=n["if"].call(t,t&&t.loading,{hash:{},inverse:f.program(3,c,i),fn:f.program(1,l,i),data:i});if(o||o===0)s+=o;return s+="\n</div>",s},n.appUpdateStatus=e.template(t),n}),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("ProgressViewer",["OpsModel","Workspace","workspaces/coreeditor/TplOpsEditor","backbone"],function(e,n,r){var i,s;return s=Backbone.View.extend({events:{"click .btn-close-process":"close"},initialize:function(){var t;this.listenTo(this.model,"destroy",this.updateState),this.listenTo(this.model,"change:state",this.updateState),this.listenTo(this.model,"change:progress",this.updateProgress),t={progress:this.model.get("progress")},this.model.testState(e.State.Initializing)||(t.title=this.model.getStateDesc()+" your app..."),this.setElement($(r.progressView(t)).appendTo("#main")),this.__progress=0},switchToDone:function(){var e;this.$el.find(".success").show(),e=this,setTimeout(function(){e.$el.find(".processing-wrap").addClass("fadeout"),e.$el.find(".success").addClass("fadein")},10),setTimeout(function(){return e.trigger("done")},2e3)},updateState:function(){switch(this.model.get("state")){case e.State.Running:case e.State.Stopped:this.__awake?this.switchToDone():this.done=!0;break;case e.State.Destroyed:if(this.done){this.close();return}this.$el.children().hide(),this.$el.find(".fail").show(),this.$el.find(".detail").html(this.model.get("opsActionError").replace(/\n/g,"<br/>"));break;default:void 0}},updateProgress:function(){var e,t;e=this.model.get("progress"),this.$el.toggleClass("has-progess",!0),this.__progress>e&&this.$el.toggleClass("rolling-back",!0),this.__progress=e,t=""+e+"%",this.$el.find(".process-info").text(t),this.$el.find(".bar").css({width:t})},close:function(){return this.trigger("close")},awake:function(){this.$el.show(),this.__awake=!0,this.done&&(this.done=!1,this.switchToDone())},sleep:function(){this.$el.hide(),this.__awake=!1}}),i=function(r){function i(t){if(!t)throw this.remove(),new Error("Cannot find opsmodel while openning workspace.");if(t.testState(e.State.Saving)||t.testState(e.State.Terminating)){void 0,this.remove();return}return this.opsModel=t,n.apply(this,arguments)}return t(i,r),i.prototype.isWorkingOn=function(e){return this.opsModel===e},i.prototype.tabClass=function(){return"icon-app-pending"},i.prototype.title=function(){return this.opsModel.get("name")+" - app"},i.prototype.url=function(){return this.opsModel.url()},i.prototype.initialize=function(){var e;this.view=new s({model:this.opsModel}),this.view.workspace=this,this.listenTo(this.opsModel,"change:id",function(){this.updateUrl()}),e=this,this.view.on("close",function(){return e.remove()}),this.view.on("done",function(){var t,n;t=e.index(),e.remove(),n=App.openOps(e.opsModel),n.setIndex(t)})},i.prototype.awake=function(){return this.view.awake()},i.prototype.sleep=function(){return this.view.sleep()},i}(n),i})}.call(this),function(){define("Design",["constant","OpsModel","CloudResources"],function(e,t,n){var r,i,s,o,u,a;return i=function(){return i.o||(i.o={check:function(){}})},s=function(){},u={},a={},o=null,r=Backbone.Model.extend({constructor:function(e){var t;this.__opsModel=e,Backbone.Model.call(this),this.use(),t=e.getJsonData(),this.deserialize($.extend(!0,{},t.component),$.extend(!0,{},t.layout))},initialize:function(){var e,n,i;return this.__componentMap={},this.__classCache={},this.__usedUidCache={},this.__initializing=!1,e=this.__opsModel.getJsonData(),this.__opsModel.testState(t.State.UnRun)?this.__mode=r.MODE.Stack:this.__mode=r.MODE.App,n=e.component,i=e.layout,delete e.component,delete e.layout,this.attributes=$.extend(!0,{canvasSize:i.size},e),e.component=n,e.layout=i,null},deserialize:function(e,t){var n,u,f,l,c,h,p,d,v,m,g,y,b;void 0,void 0,v=this.get("version"),b=this.constructor.__deserializeVisitors||[];for(m=0,g=b.length;m<g;m++)l=b[m],l(e,t,v);this.trigger=s,this.__initializing=!0,f={coordinate:[0,0],size:[0,0]},p=this,h=function(n){var i,s,u;if(!n)return null;u=p.__componentMap[n];if(u)return u;c.check(n),s=e[n];if(!s){void 0;return}i=r.modelClassForType(s.type);if(!i){void 0;return}return i.deserialize(s,t[n]||f,h),o.__componentMap[n]},y=this.component,this.component=null;for(d in e){u=e[d],this.__usedUidCache[d]=!0;if(a[u.type]===!0){n=r.modelClassForType(u.type);if(!n){void 0;continue}if(!n.preDeserialize){void 0;continue}n.preDeserialize(u,t[d]||f)}}this.component=h;for(d in e)u=e[d],a[u.type]===!0?(c=i(d),r.modelClassForType(u.type).deserialize(u,t[d]||f,h)):(c=i(),h(d));this.component=y;for(d in e)u=e[d],n=r.modelClassForType(u.type),n&&n.postDeserialize&&n.postDeserialize(u,t[d]||f);return this.__initializing=!1,Backbone.Events.trigger.call(this,r.EVENT.Deserialized),this.trigger=Backbone.Events.trigger,null},reload:function(){var e,t;t=r.instance(),this.use(),this.initialize(),e=this.__opsModel.getJsonData(),this.deserialize($.extend(!0,{},e.component),$.extend(!0,{},e.layout)),t&&t.use()},classCacheForCid:function(e){var t;return this.__classCache[e]?this.__classCache[e]:(t=this.__classCache[e]=[],t)},cacheComponent:function(e,t){return t?this.__componentMap[e]=t:(t=this.__componentMap,delete this.__componentMap[e],this.modeIsAppEdit()&&this.reclaimGuid(e)),null},reclaimGuid:function(e){return delete this.__usedUidCache[e]},guid:function(){var e;e=MC.guid();while(this.__usedUidCache[e])void 0,e=MC.guid();return this.__usedUidCache[e]=!0,e},set:function(e,t){this.attributes[e]=t,this.trigger("change:"+e),this.trigger("change")},get:function(e){return e==="id"?this.__opsModel.get("id"):e==="state"?this.__opsModel.getStateDesc():this.attributes[e]},type:function(){return this.__opsModel.type},region:function(){return this.attributes.region},modeIsStack:function(){return this.__mode===r.MODE.Stack},modeIsApp:function(){return this.__mode===r.MODE.App},modeIsAppView:function(){return!1},modeIsAppEdit:function(){return this.__mode===r.MODE.AppEdit},mode:function(){return this.__mode},setMode:function(e){if(this.__mode===e)return;this.__mode=e,this.preserveName(),this.trigger("change:mode",e)},initializing:function(){return this.__initializing},use:function(){return o=this,this},unuse:function(){o===this&&(o=null)},component:function(e){return this.__componentMap[e]},componentsOfType:function(e){return this.classCacheForCid(r.modelClassForType(e).prototype.classId).slice(0)},eachComponent:function(e,t){var n,r,i;void 0,t=t||this,i=this.__componentMap;for(r in i){n=i[r];if(e.call(t,n)===!1)break}return null},isModified:function(){var e,t;return this.modeIsApp()?(void 0,!1):(e=this.__opsModel.getJsonData(),this.attributes.name!==e.name?!0:(t=this.serialize(),_.isEqual(e.component,t.component)&&_.isEqual(e.layout,t.layout)?!1:!0))},serialize:function(e){var n,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N;u=r.instance(),this.use(),void 0,s={},h={},o=[],p=[],T=this.__componentMap;for(m in T){i=T[m];if(i.isRemoved()){void 0;continue}if(i.node_line){o.push(i);continue}try{c=i.serialize(e)}catch(C){f=C,void 0}finally{}if(!c)continue;_.isArray(c)||(p[0]=c,c=p);for(y=0,E=c.length;y<E;y++)l=c[y],l.component&&(void 0,void 0,s[l.component.uid]=l.component),l.layout&&(h[l.layout.uid]=l.layout)}for(b=0,S=o.length;b<S;b++){n=o[b],d=n.port1Comp(),v=n.port2Comp();if(d&&v&&!d.isRemoved()&&!v.isRemoved())try{n.serialize(s,h)}catch(C){f=C,void 0}finally{}else void 0}a=$.extend(!0,{},this.attributes),a.component=s,a.layout=h,N=this.constructor.__serializeVisitors||[];for(w=0,x=N.length;w<x;w++)g=N[w],g(s,h,e);a.layout.size=a.canvasSize,delete a.canvasSize,a.property=this.attributes.property||{},a.state=this.__opsModel.getStateDesc()||"Enabled",a.id=this.__opsModel.get("id");if(e&&e.toStack||this.modeIsStack())a.version=t.LatestVersion;return u&&u.use(),a},serializeAsStack:function(e){var t;return t=this.serialize({toStack:!0}),t.name=e||t.name,t.state="Enabled",t.id="",t.owner="",t.usage="",delete t.history,delete t.stack_id,delete t.owner,delete t.usage,t},preserveName:function(){var e,t,n,r;if(!this.modeIsAppEdit())return;this.__preservedNames={},r=this.__componentMap;for(n in r)e=r[n],t=this.__preservedNames[e.type]||(this.__preservedNames[e.type]={}),t[e.get("name")]=!0},isPreservedName:function(e,t){var n;return this.modeIsAppEdit()?this.__preservedNames?(n=this.__preservedNames[e],n&&n[t]):!1:!1},getCost:function(e){return{costList:[],totalFee:0}}},{TYPE:{Vpc:"ec2-vpc"},MODE:{Stack:"stack",App:"app",AppEdit:"appedit"},EVENT:{ChangeResource:"CHANGE_RESOURCE",AddResource:"ADD_RESOURCE",RemoveResource:"REMOVE_RESOURCE",Deserialized:"DESERIALIZED"},registerModelClass:function(e,t,n){return u[e]=t,n&&(a[e]=n),null},registerSerializeVisitor:function(e){return this.__serializeVisitors||(this.__serializeVisitors=[]),this.__serializeVisitors.push(e),null},registerDeserializeVisitor:function(e){return this.__deserializeVisitors||(this.__deserializeVisitors=[]),this.__deserializeVisitors.push(e),null},instance:function(){return o},modelClassForType:function(e){return u[e]},modelClassForPorts:function(e,t){var n;return e<t?n=e+">"+t:n=t+">"+e,u[n]},lineModelClasses:function(){var e,t,n;if(this.__lineModelClasses)return this.__lineModelClasses;this.__lineModelClasses=e=[];for(n in u)t=u[n],t.__isLineClass&&n.indexOf(">")===-1&&e.push(t);return this.__lineModelClasses}}),r})}.call(this),function(){define("ResourceModel",["Design","CloudResources","constant","backbone"],function(e,t,n){var r,i,s,o;return i=function(e){var t,n,r,s,o,u,a;if(e===null||!_.isObject(e))return e;if(_.isArray(e)){s=[];for(n=u=0,a=e.length;u<a;n=++u)t=e[n],s[n]=i(t);return s}s={};for(r in e)o=e[r],o!==null&&_.isObject(o)?s[r]=i(o):s[r]=o;return s},s=Backbone.Model.extend,o={},r=Backbone.Model.extend({classId:_.uniqueId("dfc_"),type:"Framework_R",constructor:function(t,n){var r;r=e.instance(),this.__design=r,t||(t={}),t.id||(t.id=r.guid());if(!t.name||!this.isNameAvailable(t.name))t.name=this.getNewName(void 0,t.name),t.name||delete t.name;return r.classCacheForCid(this.classId).push(this),r.cacheComponent(t.id,this),Backbone.Model.call(this,t,n||o),this.attributes.name||(this.attributes.name=""),this.attributes.appId||(this.attributes.appId=""),this.attributes.description||(this.attributes.description=""),r.trigger(e.EVENT.AddResource,this),this.listenTo(this,"change",this.__triggerChangeInDesign),this},__triggerChangeInDesign:function(){this.design().trigger(e.EVENT.ChangeResource,this)},isNameAvailable:function(e){var t,n,r,i;if(this.design().isPreservedName(this.type,e))return!1;i=this.getAllObjects();for(n=0,r=i.length;n<r;n++){t=i[n];if(t.get("name")===e)return!1}return!0},getNewName:function(e,t){var n,r;t=t||this.newNameTmpl;if(!t)return r=this.defaults?this.defaults.name:void 0,r||"";e===void 0&&(e=this.getAllObjects().length),n={},this.design().eachComponent(function(e){return e.get("name")&&(n[e.get("name")]=!0),null});for(;;){r=t+e;if(!n[r]&&!this.design().isPreservedName(this.type,r))break;e+=1}return r},hasAppResource:function(){return!e.instance().modeIsStack()&&this.get("appId")?!!this.get("appId")&&t(this.type,this.design().region()).get(this.get("appId")):!0},isDesignAwake:function(){return e.instance()===this.__design},design:function(){return this.__design},getAllObjects:function(t){return this.design().classCacheForCid(e.modelClassForType(t||this.type).prototype.classId).slice(0)},markAsRemoved:function(e){return e===void 0?this.__isRemoved=!0:this.__isRemoved=!!e,null},isVisual:function(){return!1},isRemoved:function(){return this.__isRemoved===!0},isRemovable:function(){return!0},isReparentable:function(){return!0},serialize:function(){return void 0,null},destroy:function(){return this.remove()},remove:function(){var t,n;if(this.isRemoved()){void 0;return}return this.__isRemoved=!0,void 0,n=e.instance(),t=n.classCacheForCid(this.classId),t.splice(t.indexOf(this),1),n.cacheComponent(this.id),this.stopListening(),this.trigger("destroy",this),this.trigger("__remove"),this.off(),this.__design=null,n.trigger(e.EVENT.RemoveResource,this),null},createRef:function(e,t,n){return _.isString(t)&&(n=t,t=!0),n=n||this.id,n?t!==!1?MC.genResRef(n,"resource."+e):MC.genResRef(n,""+e):""},listenTo:function(t,n,r){var i,s;return i=e.modelClassForType(t.type),i&&(!this._listeners||!this._listeners[t._listenerId])&&(s=this,t.once("__remove",function(){return s.stopListening(this)})),Backbone.Events.listenTo.call(this,t,n,r)},clone:null,cloneAttributes:function(t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,m;void 0,n=n||{},u=n.reserve||"",a="id|appId|x|y|width|height|name",o=n.copyConnection||[],v=t.attributes;for(i in v){l=v[i];if(i.indexOf("__")===0||a.indexOf(i)!==-1||u.indexOf(i)!==-1)continue;l!==null&&_.isObject(l)&&(l=this.cloneObjectAttributes(i,l)),this.attributes[i]=l}for(c=0,p=o.length;c<p;c++){s=o[c],r=e.modelClassForType(s),m=t.connectionTargets(s);for(h=0,d=m.length;h<d;h++)f=m[h],new r(f,this)}return null},cloneObjectAttributes:function(e,t){return i(t)}},{allObjects:function(t){var n;return n=e.instance(),t&&t.prototype===n.prototype&&(n=t),n.classCacheForCid(this.prototype.classId).slice(0)},deserialize:function(){return void 0,null},extend:function(t,n){var r,i,o,u,a,f;void 0,n&&(r=n.handleTypes,i=n.resolveFirst,delete n.handleTypes,delete n.resolveFirst),t.classId=_.uniqueId("dfc_"),o=s.call(this,t,n),r||(r=t.type);if(r){_.isString(r)&&(r=[r]);for(a=0,f=r.length;a<f;a++)u=r[a],e.registerModelClass(u,o,i)}return o}}),e.registerModelClass(r.prototype.type,r),_.each(["forEach","each","map","reduce","find","filter","reject","every","some","contains","invoke","max","min","size","first","without","isEmpty","chain","sample"],function(e){return r[e]=function(){var t;return t=[].slice.call(arguments),t.unshift(this.allObjects()),_[e].apply(_,t)}}),r.where=function(e,t){return _.isEmpty(e)?t!=null?t:{"null":[]}:this[t&&"find"||"filter"](function(t){var n;for(n in e)if(e[n]!==t.get(n))return!1;return!0})},r.findWhere=function(e){return this.where(e,!0)},r})}.call(this),function(){define("ComplexResModel",["Design","ResourceModel","constant"],function(e,t,n){var r,i;return i=[],r=t.extend({type:"Framework_CR",constructor:function(e,n){return e&&e.parent&&(e.__parent=e.parent,delete e.parent),t.call(this,e,n),e&&e.__parent&&(this.set("__parent",null),e.__parent.addChild(this)),null},setName:function(e){if(this.get("name")===e)return;return this.set("name",e),null},setDesc:function(e){return this.set("description",e)},remove:function(){var e,n;this.markAsRemoved(),e=this.attributes.__connections;if(e){n=e.length;while(n)--n,e[n].remove()}return this.markAsRemoved(!1),t.prototype.remove.call(this),null},attach_connection:function(e,t){var n,r;return n=this.get("__connections")||[],r=n.indexOf(e),t?r!==-1&&n.splice(r,1):r===-1&&(n.push(e),this.attributes.__connections=n),this.trigger("change:connections",e),null},connect_base:function(e){return this.attach_connection(e),this.connect&&this.connect(e),null},disconnect_base:function(e,t){return this.attach_connection(e,!0),this.disconnect&&this.disconnect(e,t),null},isVisual:function(){return!0},draw:function(){return void 0},connections:function(e){var t;return t=this.get("__connections"),t&&_.isString(e)&&(t=_.filter(t,function(t){return t.type===e})),t||i},connectionTargets:function(e){var t,n,r,i,s;r=[],n=this.get("__connections");if(n)for(i=0,s=n.length;i<s;i++)t=n[i],(!e||t.type===e)&&r.push(t.getOtherTarget(this));return r},getSubnetRef:function(){var e;e=this;while(e){if(e.type===n.RESTYPE.SUBNET)break;e=e.parent()}return e?e.createRef("SubnetId"):""},getVpcRef:function(){var t,r;r=this;while(r){if(r.type===n.RESTYPE.VPC)break;r=r.parent()}return r||(t=e.modelClassForType(n.RESTYPE.VPC),r=t.theVPC()),r?r.createRef("VpcId"):""},generateLayout:function(){var e;return e={coordinate:[this.x(),this.y()],uid:this.id},this.parent()&&(e.groupUId=this.parent().id),e},parent:function(){return this.get("__parent")||null},x:function(){return this.get("x")||0},y:function(){return this.get("y")||0},width:function(){return this.get("width")||0},height:function(){return this.get("height")||0}}),r})}.call(this),function(){define("ConnectionModel",["ResourceModel","Design"],function(e,t){var n;return n=e.extend({node_line:!0,type:"Framework_CN",constructor:function(n,r,i,s){var o,u,a,f,l,c;if(!n||!r){void 0;return}if(!s||s.detectDuplicate!==!1){u=t.modelClassForType(this.type).allObjects(),o=t.modelClassForType(this.type).findExisting(n,r);if(o)return void 0,i&&o.set(i),o}if(!this.assignCompsToPorts(n,r)){void 0;return}e.call(this,i,s);if(this.__destroyAfterInit)return this.remove(this),this.id="",this;this.__port1Comp.connect_base(this),this.__port1Comp!==this.__port2Comp&&this.__port2Comp.connect_base(this);if(this.oneToMany){void 0,a=this.getOtherTarget(this.oneToMany),c=a.connections(this.type);for(f=0,l=c.length;f<l;f++)o=c[f],o!==this&&o.remove(this)}return this},setDestroyAfterInit:function(){return this.__destroyAfterInit=!0,null},assignCompsToPorts:function(e,t){var n,r,i,s;if(this.portDefs){s=this.portDefs;for(r=0,i=s.length;r<i;r++){n=s[r];if(n.port1.type===e.type&&n.port2.type===t.type){this.__portDef=n,this.__port1Comp=e,this.__port2Comp=t;break}if(n.port1.type===t.type&&n.port2.type===e.type){this.__portDef=n,this.__port1Comp=t,this.__port2Comp=e;break}}return!!this.__portDef}return this.__port1Comp=e,this.__port2Comp=t,!0},port:function(e,t){return this.__portDef?this.__port1Comp===e||this.__port1Comp.id===e?this.__portDef.port1[t]:this.__port2Comp===e||this.__port2Comp.id===e?this.__portDef.port2[t]:"":""},port1:function(e){return this.__portDef?this.__portDef.port1[e]:""},port2:function(e){return this.__portDef?this.__portDef.port2[e]:""},connectsTo:function(e){return this.__port1Comp&&this.__port1Comp.id===e||this.__port2Comp&&this.__port2Comp.id===e},port1Comp:function(){return this.__port1Comp},port2Comp:function(){return this.__port2Comp},getOtherTarget:function(e){return _.isString(e)?this.__port1Comp.type===e?this.__port2Comp:this.__port1Comp:this.__port1Comp===e?this.__port2Comp:this.__port1Comp},getTarget:function(e){return this.__port1Comp.type===e?this.__port1Comp:this.__port2Comp.type===e?this.__port2Comp:null},remove:function(t){var n,r;return void 0,n=!this.__port1Comp.isRemoved(),r=!this.__port2Comp.isRemoved(),n&&this.__port1Comp.attach_connection(this,!0),r&&this.__port2Comp.attach_connection(this,!0),n&&this.__port1Comp.disconnect_base(this,t),r&&this.__port2Comp.disconnect_base(this,t),e.prototype.remove.call(this),null},serialize:function(){return null},isVisual:function(){return!!this.portDefs},draw:function(){return void 0}},{findExisting:function(e,t){var n,r,i,s;s=this.allObjects();for(r=0,i=s.length;r<i;r++){n=s[r];if(n.port1Comp()===e&&n.port2Comp()===t&&!n.isRemoved())return n;if(n.port2Comp()===e&&n.port1Comp()===t&&!n.isRemoved())return n}return null},extend:function(n,r){var i,s,o,u,a,f,l,c,h,p;u=[];if(n.portDefs){_.isArray(n.portDefs)||(n.portDefs=[n.portDefs]),p=n.portDefs;for(f=0,c=p.length;f<c;f++)s=p[f],s.port1.name>s.port2.name&&(a=s.port1,s.port1=s.port2,s.port2=a),u.push(s.port1.name+">"+s.port2.name);n.type||(n.type=u[0])}i=e.extend.call(this,n,r);for(l=0,h=u.length;l<h;l++)o=u[l],t.registerModelClass(o,i);return t.registerModelClass(n.type,i),i.__isLineClass=!0,i},isConnectable:function(e,t){return!0},connectionData:function(e,n){var r,i,s,o,u,a,f,l,c,h,p,d;i={},p=t.lineModelClasses();for(f=0,c=p.length;f<c;f++){r=p[f];if(!r.prototype.portDefs)continue;d=r.prototype.portDefs;for(l=0,h=d.length;l<h;l++){o=d[l];if(o.port1.type===e)a=o.port1,u=o.port2;else{if(o.port2.type!==e)continue;a=o.port2,u=o.port1}if(!n||n===a.name)s=i[u.type]||(i[u.type]=[]),s.push(u.name)}}return i}}),n})}.call(this),function(){define("GroupModel",["Design","ComplexResModel"],function(e,t){var n;return n=t.extend({node_group:!0,type:"Framework_G",remove:function(){var e,n,r,i;if(this.attributes.__children){i=this.attributes.__children.splice(0);for(n=0,r=i.length;n<r;n++)e=i[n],e.off("destroy",this.removeChild,this),e.remove()}return t.prototype.remove.call(this),null},addChild:function(e){var t,n;void 0,n=e.parent();if(n===this)return;n&&n.removeChild(e),t=this.attributes.__children;if(!t)t=[];else if(t.indexOf(e)!==-1)return;return t.push(e),this.set("__children",t),e.set("__parent",this),e.once("destroy",this.removeChild,this),e.onParentChanged&&e.onParentChanged(n),null},removeChild:function(e){var t,n;t=this.get("__children");if(!t||t.length===0){void 0;return}n=t.indexOf(e);if(n===-1){void 0;return}return t.splice(n,1),this.set("__children",t),e.off("destroy",this.removeChild,this),e.attributes.__parent=null,null},children:function(){return this.get("__children")||[]},generateLayout:function(){var e;return e=t.prototype.generateLayout.call(this),e.size=[this.width(),this.height()],e}}),n})}.call(this),function(){define("CoreEditorView",["workspaces/coreeditor/TplOpsEditor","UI.modalplus","i18n!/nls/lang.js","backbone","UI.selectbox","backbone","UI.selectbox"],function(e,t,n){return $(window).on("keydown",function(e){var t,n;if($(e.target).is("input, textarea")||e.target.contentEditable==="true"){e.stopPropagation();return}t=$("#OpsEditor");if(!t.length)return;switch(e.keyCode){case 8:case 46:e.which===8&&e.preventDefault(),!e.ctrlKey&&!e.metaKey&&(n="DelSelectItem");break;case 37:case 38:case 39:case 40:n="MoveSelectItem";break;case 65:n="ShowGlobal";break;case 80:n="ShowProperty";break;case 82:!e.ctrlKey&&!e.metaKey&&(n="ShowResource");break;case 83:e.ctrlKey||e.metaKey?n="Save":n="ShowStateEditor";break;case 187:n="ZoomIn";break;case 189:n="ZoomOut";break;case 13:n="ShowStateEditor"}if(n)return t.triggerHandler(n,e.which),!1}),Backbone.View.extend({events:{Save:"saveStack",DelSelectItem:"delSelectedItem",SelectPrevItem:"selectPrevItem",SelectNextItem:"selectNextItem",MoveSelectItem:"moveSelectedItem",ZoomIn:"zoomIn",ZoomOut:"zoomOut",ShowProperty:"showProperty",ShowStateEditor:"showStateEditor",ShowGlobal:"showGlobal",ShowResource:"showResource","click .HideOEPanelLeft":"toggleLeftPanel","click .HideOEPanelRight":"toggleRightPanel"},template:e.frame,constructor:function(e){var t;_.extend(this,e),this.setElement($(this.template()).appendTo("#main").attr("data-ws",this.workspace.id).show()[0]),t={workspace:this.workspace,parent:this},this.toolbar=new(e.TopPanel||Backbone.View)(t),this.propertyPanel=new(e.RightPanel||Backbone.View)(t),this.resourcePanel=new(e.LeftPanel||Backbone.View)(t),this.statusbar=new(e.BottomPanel||Backbone.View)(t),this.canvas=new e.CanvasView(t),this.listenTo(this.canvas,"itemSelected",this.onItemSelected),this.listenTo(this.canvas,"doubleclick",this.onCanvasDoubleClick),this.initialize()},onItemSelected:function(e,t){},showProperty:function(){},showResource:function(){},showGlobal:function(){},showStateEditor:function(){},onCanvasDoubleClick:function(){},toggleLeftPanel:function(){return this.resourcePanel.toggleLeftPanel(),this.canvas.updateSize(),!1},toggleRightPanel:function(){return this.propertyPanel.toggleRightPanel(),this.canvas.updateSize(),!1},saveStack:function(){return this.toolbar.$el.find(".icon-save").trigger("click")},moveSelectedItem:function(e,t){var n,r;switch(t){case 37:n=-1;break;case 38:r=-1;break;case 39:n=1;break;case 40:r=1}return this.canvas.moveSelectedItem(n||0,r||0),!1},delSelectedItem:function(){return this.canvas.delSelectedItem(),!1},selectPrevItem:function(){return this.canvas.selectPrevItem(),!1},selectNextItem:function(){return this.canvas.selectNextItem(),!1},zoomIn:function(){return this.canvas.zoomIn(),this.toolbar.updateZoomButtons(),!1},zoomOut:function(){return this.canvas.zoomOut(),this.toolbar.updateZoomButtons(),!1},backup:function(){this.propertyPanel&&this.propertyPanel.backup&&this.propertyPanel.backup(),this.$el.attr("id","")},recover:function(){this.$el.show().attr("id","OpsEditor"),this.resourcePanel&&this.resourcePanel.recalcAccordion&&this.resourcePanel.recalcAccordion(),this.propertyPanel&&this.propertyPanel.recover&&this.propertyPanel.recover()},remove:function(){return this.toolbar&&this.toolbar.remove(),this.propertyPanel&&this.propertyPanel.remove(),this.resourcePanel&&this.resourcePanel.remove(),this.statusbar&&this.statusbar.remove(),this.canvas&&this.canvas.remove(),Backbone.View.prototype.remove.call(this)},showCloseConfirm:function(){var r,i,s;i=this.workspace.design.get("name"),s=this,r=new t({title:sprintf(n.IDE.TITLE_CONFIRM_TO_CLOSE,i),width:"420",template:e.modal.onClose(i),confirm:{text:n.TOOLBAR.TIT_CLOSE_TAB,color:"red"},onConfirm:function(){r.close(),s.workspace.remove()}})},getSvgElement:function(){var e,t;t=this.$el.children(".OEMiddleWrap").children(".OEPanelCenter").children();while(t.length){e=t.filter("svg");if(e.length)return e;t=t.children()}return null}})})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("CoreEditor",["Workspace","CoreEditorView","workspaces/coreeditor/TplOpsEditor","ThumbnailUtil","OpsModel","Design","ApiRequest","UI.modalplus","i18n!/nls/lang.js"],function(e,n,r,i,s,o,u,a,f){var l,c;return l=Backbone.View.extend({isLoadingView:!0,initialize:function(e){return this.setElement($(r.loading()).appendTo("#main").show()[0])},setText:function(e){return this.$el.find(".processing").text(e)},showVpcNotExist:function(e,t){var n,i;i=this,n=new a({title:sprintf(f.IDE.TITLE_CONFIRM_TO_REMOVE_APP,e),template:r.modal.confirmRemoveApp(),confirm:{text:f.IDE.POP_CONFIRM_TO_REMOVE,color:"red"},disableClose:!0,onConfirm:function(){return t(),n.close()}})}}),c=function(r){function a(t){var n;if(!t)throw this.remove(),new Error("Cannot find opsmodel while openning workspace.");this.opsModel=t,this.listenTo(this.opsModel,"destroy",this.onOpsModelStateChanged),this.listenTo(this.opsModel,"change:state",this.onOpsModelStateChanged),this.listenTo(this.opsModel,"change:name",this.updateTab),this.listenTo(this.opsModel,"change:id",this.onModelIdChange),n=this,this.fetchJsonData().then(function(){return n.jsonLoaded()},function(e){return n.jsonLoadFailed(e)}),e.apply(this,arguments)}return t(a,r),a.prototype.title=function(){return this.opsModel.get("name")},a.prototype.tabClass=function(){return"icon-stack-tabbar"},a.prototype.url=function(){return this.opsModel.url()},a.prototype.isWorkingOn=function(e){return this.opsModel===e},a.prototype.viewClass=n,a.prototype.designClass=o,a.prototype.fetchAdditionalData=function(){var e;return e=Q.defer(),e.resolve(),e.promise},a.prototype.isReady=function(){return!!this.__hasAdditionalData},a.prototype.getSelectedComponent=function(){return this.view.canvas?this.view.canvas.getSelectedComp():null},a.prototype.onOpsModelStateChanged=function(){if(this.opsModel.get("state")===s.State.Destroyed)return this.remove()},a.prototype.onModelIdChange=function(){this.updateUrl(),this.design&&this.design.set("id",this.opsModel.get("id"))},a.prototype.fetchJsonData=function(){var e;return e=this.opsModel,e.fetchJsonData().then(function(){if(!e.isPersisted())return e.save()})},a.prototype.jsonLoadFailed=function(e){if(this.isRemoved())return;if(e.error===u.Errors.MissingDataInServer)return;return notification("error",f.NOTIFY.FAILED_TO_LOAD_DATA),this.remove()},a.prototype.jsonLoaded=function(){var e;if(this.isRemoved())return;e=this,this.fetchAdditionalData().then(function(){return e.additionalDataLoaded()},function(){return e.additionalDataLoadFailed()})},a.prototype.additionalDataLoadFailed=function(){if(this.isRemoved())return;return notification("error",f.NOTIFY.FAILED_TO_LOAD_AWS_DATA),this.remove()},a.prototype.additionalDataLoaded=function(){if(this.isRemoved())return;this.__hasAdditionalData=!0,this.view&&this.view.isLoadingView&&(this.view.remove(),this.view=null),this.isAwake()&&!this.__inited&&this.__initEditor()},a.prototype.awake=function(){if(!this.isReady()){this.view?this.view.$el.show():this.view=new l;return}this.__inited?(this.design.use(),this.view.recover()):this.__initEditor()},a.prototype.sleep=function(){return this.view&&this.view.backup&&this.view.backup(),e.prototype.sleep.call(this)},a.prototype.cleanup=function(){this.stopListening(),this.view&&this.view.remove(),this.design&&(this.design.unuse(),this.design=null),this.opsModel.isPersisted()||this.opsModel.remove()},a.prototype.isInited=function(){return!!this.__inited},a.prototype.__initEditor=function(){this.__inited=!0,this.design=new this.designClass(this.opsModel),this.listenTo(this.design,"change:name",this.updateTab),this.view=new this.viewClass({workspace:this}),this.initEditor(),this.opsModel.getThumbnail()||this.saveThumbnail(),this.opsModel.__setJsonData(this.design.serialize())},a.prototype.initEditor=function(){this.opsModel.get("autoLayout")&&this.view.canvas.autoLayout()},a.prototype.saveThumbnail=function(){if(this.opsModel.isPersisted())return i.generate(this.view.getSvgElement()).then(function(e){return function(t){return e.opsModel.saveThumbnail(t)}}(this))},a.prototype.isRemovable=function(){return!this.__inited||!this.isModified()?!0:(this.view.showCloseConfirm(),!1)},a}(e),c})}.call(this),function(){define("CanvasManager",["CloudResources","constant"],function(e,t){var n;return n={hasClass:function(e,t){var n,r,i,s;if(!e)return!1;!e.length&&e.length!==0&&(e=[e]);for(i=0,s=e.length;i<s;i++){n=e[i],r=" "+(n.getAttribute("class")||"")+" ";if(r.indexOf(" "+t+" ")>=0)return!0}return!1},removeClass:function(e,t){var n,r,i,s,o;if(!e)return this;!e.length&&e.length!==0&&(e=[e]);for(s=0,o=e.length;s<o;s++)n=e[s],r=n.getAttribute("class")||"",i=r.replace(new RegExp("\\b"+t+"\\b","g"),""),r!==i&&n.setAttribute("class",i);return this},addClass:function(e,t){var n,r,i,s;if(!e)return this;!e.length&&e.length!==0&&(e=[e]);for(i=0,s=e.length;i<s;i++)n=e[i],r=n.getAttribute("class")||"",r.match(new RegExp("\\b"+t+"\\b"))||(r=$.trim(r)+" "+t,n.setAttribute("class",r));return this},toggle:function(e,t){e.hasOwnProperty("length")&&(e=e[0]);if(!e)return this;if(t===null||t===void 0)t=e.getAttribute("display")==="none";return t?(e.setAttribute("display",""),e.getAttribute("data-tooltip")&&this.addClass(e,"tooltip")):(e.setAttribute("display","none"),this.removeClass(e,"tooltip")),this},updateEip:function(e,n){var r,i,s,o,u;e.length&&(e=e[0]);if(n&&n.type===t.RESTYPE.ENI){if(!n.connections("EniAttachment").length){$(e).hide();return}$(e).show()}return s=n.hasPrimaryEip(),s?(o="Detach Elastic IP from primary IP",r="ide/icon/icn-eipon.png"):(o="Associate Elastic IP to primary IP",r="ide/icon/icn-eipoff.png"),n.design().modeIsApp()&&(n.getEmbedEni&&(n=n.getEmbedEni()),n?(i=(n.get("ips")||[])[0],o=(i!=null?(u=i.eipData)!=null?u.publicIp:void 0:void 0)||""):void 0),e.setAttribute("data-tooltip",o),$(e).data("tooltip",o),this.update(e,r,"href"),null},updateFip:function(e,n){var r,i,s,o;return e.size()?(n.type===t.RESTYPE.OSSERVER?s=!!n.embedPort().getFloatingIp():s=!!n.getFloatingIp(),s?(o="Deassociate Floating IP",r="ide/icon-os/cvs-fip-on-n.png",i="ide/icon-os/cvs-fip-on-h.png"):(o="Associate Floating IP",r="ide/icon-os/cvs-fip-of-n.png",i="ide/icon-os/cvs-fip-of-h.png"),e=$(e).data("tooltip",o).attr("data-tooltip",o),this.update(e.find(".normal"),r,"href"),this.update(e.find(".hover"),i,"href"),null):!1},update:function(e,t,r){var i,s,o,u,a,f,l,c;_.isString(e)&&(e=document.getElementById(e)),e=$(e);if(!r)return e.text(MC.truncate(t,17));if(r==="href"||r==="image"){t=MC.IMG_URL+t,l=[];for(o=0,a=e.length;o<a;o++)i=e[o],s=i.getAttributeNS("http://www.w3.org/1999/xlink","href"),s!==t?l.push(i.setAttributeNS("http://www.w3.org/1999/xlink","href",t)):l.push(void 0);return l}if(r==="tooltip"){e.data("tooltip",t).attr("data-tooltip",t),c=[];for(u=0,f=e.length;u<f;u++)i=e[u],t?c.push(n.addClass(i,"tooltip")):c.push(n.removeClass(i,"tooltip"));return c}return r==="color"?e.attr("style","fill:"+t):e.attr(r,t)},setLabel:function(e,t){var n,r,i,s,o,u,a,f;u=e.label(),o=e.labelWidth(),_.isString(t)&&(t=document.getElementById(t)),!t.length&&t.length!==0&&(t=[t]);if(!u.length){$(t).text(u);return}$(t[0]).text(u);try{n=t[0].getSubStringLength(0,u.length)}catch(l){r=l,n=0}if(n>o){s=u.length-1;while(s>0){if(t[0].getSubStringLength(0,s)+8<=o){u=u.substr(0,s)+"...";break}--s}}for(a=0,f=t.length;a<f;a++)i=t[a],$(i).text(u)}},n})}.call(this),define("workspaces/coreeditor/TplSvgDef",["handlebars"],function(e){var t=function(e,t,n,r,i){this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o=this.escapeExpression;return s+='<svg style="display:none;" id="svgDefs"><defs>\n  <path d="M-5 0.5l5.5 -5.5l5.5 5.5 l-5.5 5.5z" id="port_diamond"></path>\n  <path d="M8 0.5l-6 -5.5l-2 0 l0 11 l2 0z" id="port_right"></path>\n  <path d="M-8 0.5l6 -5.5l2 0 l0 11 l-2 0z" id="port_left"></path>\n  <path d="M0.5 0l5.5 0l0 -2l-5.5 -6l-5.5 6l0 2z" id="port_top"></path>\n  <path d="M0.5 0l5.5 0l0 2l-5.5 6l-5.5 -6l0 -2z" id="port_bottom"></path>\n  <path d="M0 74h90v11a5 5 0 0 1 -5 5h-80a5 5 0 0 1 -5 -5z" id="label_path" data-readonly="true"></path>\n\n  <g id="asg_frame">\n    <rect class="group-asg" rx="5" ry="5" height="129" x="1" y="1" width="129"></rect>\n    <path d="M0 21l0 -16a5 5 0 0 1 5 -5l121 0a5 5 0 0 1 5 5l0 16z" class="asg-title"></path>\n  </g>\n  <text id="asg_prompt">\n    <tspan x="25" y="47">'+o(n.i18n.call(t,"CANVAS.CVS_ASG_DROP_LC_1",{hash:{},data:i}))+'</tspan>\n    <tspan x="20" y="67">'+o(n.i18n.call(t,"CANVAS.CVS_ASG_DROP_LC_2",{hash:{},data:i}))+'</tspan>\n    <tspan x="30" y="87">'+o(n.i18n.call(t,"CANVAS.CVS_ASG_DROP_LC_3",{hash:{},data:i}))+'</tspan>\n    <tspan x="30" y="107">'+o(n.i18n.call(t,"CANVAS.CVS_ASG_DROP_LC_4",{hash:{},data:i}))+'</tspan>\n  </text>\n\n  <g id="asg_dragger">\n    <rect height="14" width="14" fill="transparent" x="114" y="3"/>\n    <path d="M114.26 11.447 c-0.44 2.83 -0.252 5.113 -0.12 5.313 c0.204 0.398 4.473 0.24 5.512 -0.133 c0.86 -0.604 -0.623 -1.15 -1.094 -1.962 c0.471 -0.611 1.976 -2.352 2.324 -2.865 c-0.28 -1.65 -1.649 -1.818 -1.78 -1.76 c -0.13 0.06 -2.809 2.411 -2.809 2.411 c0 0 -0.925 -0.997 -1.292 -1.259 c-0.465 -0.322 -0.742 0.18 -0.742 0.254 l0 0z m13.482 -2.895 c0.437 -2.83 0.25 -5.115 0.118 -5.315 c-0.204 -0.396 -4.473 -0.227 -5.514 0.135 c-0.856 0.604 0.626 1.15 1.096 1.962 c-0.47 0.611 -1.976 2.352 -2.323 2.868 c0.293 1.648 1.648 1.815 1.778 1.758 c0.13 -0.06 2.805 -2.41 2.805 -2.41 c0.004 0 0.93 0.994 1.3 1.26 c0.461 0.32 0.74 -0.184 0.74 -0.26 l0 0Z"/>\n  </g>\n\n  <g id="clone_indicator" data-readonly="true">\n    <rect fill="#000" width="23" height="23" rx="4" ry="4"></rect>\n    <path d="M8 7c0-1.112.895-2 2-2h6c1.112 0 2 .895 2 2v6c0 1.112-.895 2-2 2v-6c0-1.103-.898-2-2-2h-6zm-1 1c-1.1 0-2 .887-2 2v6c0 1.1.887 2 2 2h6c1.1 0 2-.887 2-2v-6c0-1.1-.887-2-2-2h-6zm1 2c-.547 0-1 .451 -1 1v4c0 .547.45 1 1 1h4c.547 0 1 -.45 1-1v-4c0-.547-.45-1-1-1h-4z" fill-rule="evenodd" fill="#FFF"></path>\n  </g>\n\n  <g id="replica_dragger">\n    <rect x="34" y="53" width="22" height="22" rx="3" class="replica-bg"/>\n    <path d="M44.5 57c3.038 0 5.5 1.119 5.5 2.5s-2.462 2.5-5.5 2.5-5.5-1.119-5.5-2.5 2.462-2.5 5.5-2.5zm5.5 9h-3v2h3v2l4-3-4-3v2zm-1 3h-2c-.552 0-1-.448-1-1v-2c0-.552.448-1 1-1h2c0-.552.448-1 1-1v-3h-.11c-.51 1.141-2.729 2-5.39 2-2.661 0-4.88-.859-5.39-2h-.11v8h.11c.51 1.141 2.729 2 5.39 2 2.069 0 3.859-.522 4.798-1.29-.184-.181-.298-.432-.298-.71z"/>\n  </g>\n\n  <g id="restore_dragger">\n    <rect x="34" y="0" width="22" height="22" rx="3" class="restore-bg"/>\n    <path d="M53.131,0C30.902,0,12.832,17.806,12.287,39.976H0l18.393,20.5l18.391-20.5H22.506C23.045,23.468,36.545,10.25,53.131,10.25  c16.93,0,30.652,13.767,30.652,30.75S70.061,71.75,53.131,71.75c-6.789,0-13.059-2.218-18.137-5.966l-7.029,7.521  C34.904,78.751,43.639,82,53.131,82C75.703,82,94,63.645,94,41S75.703,0,53.131,0z M49.498,19v23.45l15.027,15.024l4.949-4.949  L56.5,39.55V19H49.498z" transform="scale(0.17) translate(215,28) rotate(0 822.5 296)" stroke-width="0" style="position: relative;" />\n  </g>\n\n  <g id="sbg_info" data-readonly="true">\n    <circle cx="10" cy="10" r="6"></circle>\n    <path fill="#fff" d="M9,9 L9,14 L11,14 L11,9 L9,9 Z M10,8 C10.55,8 11,7.55 11,7 C11,6.448 10.55,6 10,6 C9.448,6 9,6.448 9,7 C9,7.55 9.448,8 10,8 Z"></path>\n  </g>\n\n  <g id="os_router" data-readonly="true">\n    <circle cx="40" cy="40" r="30" fill="#D8DAF6" stroke="#6A71BF" stroke-width="1.5"></circle>\n    <path d="M51.92 42.05l8.08 .03c1.1 0 2 -.88 2 -2 0 -1.1 -.9 -2 -2 -2l-7.82 -.03 2.3 -2.28c.78 -.78 .8 -2.04 0 -2.83 -.77 -.8 -2.04 -.8 -2.82 0L46 38.55c-.45 .43 -.65 1.02 -.6 1.6 -.05 .55 .14 1.14 .58 1.58l5.62 5.67c.78 .8 2.05 .8 2.84 .02 .8 -.78 .78 -2.05 0 -2.83l-2.52 -2.55zM28.07 37.95H20c-1.1 0 -2 .88 -2 2 0 1.1 .9 2 2 2h7.83l-2.3 2.28c-.77 .8 -.78 2.05 0 2.84 .8 .78 2.06 .77 2.84 0L34 41.4c.45 -.44 .65 -1.02 .6 -1.6 .05 -.56 -.15 -1.15 -.6 -1.6L28.38 32.6c-.78 -.8 -2.05 -.8 -2.83 -.02 -.8 .8 -.78 2.05 0 2.84l2.53 2.53zM38.12 24.54v8.07c0 1.1 .9 2 2 2s2 -.9 2 -2V24.8l2.3 2.3c.77 .77 2.04 .78 2.82 0 .78 -.8 .78 -2.06 0 -2.84L41.6 18.6c-.45 -.44 -1.03 -.64 -1.6 -.6 -.57 -.04 -1.15 .16 -1.6 .6l-5.64 5.64c-.78 .78 -.78 2.05 0 2.83 .78 .8 2.05 .78 2.83 0l2.52 -2.53zM41.88 55.46V47.4c0 -1.1 -.9 -2 -2 -2s-2 .9 -2 2v7.82l-2.3 -2.3c-.77 -.77 -2.04 -.78 -2.82 0 -.78 .8 -.78 2.06 0 2.84l5.65 5.65c.45 .44 1.03 .64 1.6 .6 .57 .04 1.15 -.16 1.6 -.6l5.64 -5.64c.78 -.78 .78 -2.05 0 -2.83 -.78 -.8 -2.05 -.78 -2.83 0l-2.52 2.53z" fill="#6a71bf"/>\n  </g>\n\n  <g id="os_pool" data-readonly="true">\n    <rect x="16" y="16" width="48" height="48" rx="6" ry="6" fill="#F8C775" stroke="#F5A623" stroke-width="2"></rect>\n    <rect x="42" y="42" width="16" height="16" rx="2" ry="2" stroke-width="2" stroke="#efaf47" fill="none"></rect>\n    <path d="M38 44c0-1.1-.9-2-2-2H24c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V44zm0-20c0-1.1-.9-2-2-2H24c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V24zm20 0c0-1.1-.9-2-2-2H44c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V24z" fill="#f0b046"/>\n  </g>\n\n  <path id="os_listener" data-readonly="data-readonly" d="M61.47 62.46c-.16.03-.3.04-.47.04-1.66 0-3-1.35-3-3v-18c0-9.94-8.06-18-18-18s-18 8.05-18 18v18c0 1.65-1.35 3-3 3-.16 0-.32 0-.47-.04-.17.03-.36.04-.54.04h-2c-2.2 0-4-1.8-4-4v-6c0-2.2 1.8-4 4-4v-7c0-13.26 10.75-24 24-24 13.26 0 24 10.74 24 24v7c2.22 0 4 1.8 4 4v6c0 2.2-1.8 4-4 4h-2c-.17 0-.36 0-.53-.04z" fill="#f8c775" stroke-width="2" stroke="#f6a623"/>\n\n  <g id="os_port" data-readonly="data-readonly">\n    <rect x="20" y="22" width="48" height="32" rx="2" ry="2" fill="#F1F6EC" stroke="#a2c29c" stroke-width="2"></rect>\n    <path d="M50 53h12v6H50v-6zm-23 0h12v6H27v-6zM14 26h-3c-.55 0-1-.45-1-1v-2c0-.56.45-1 1-1h6c.55 0 1 .45 1 1v31c0 .55-.45 1-1 1h-2c-.56 0-1-.44-1-1V26z" fill="#a2c29c"/>\n  </g>\n\n  <g id="os_server" data-readonly="data-readonly">\n    <rect x="5" y="5" width="70" height="70" rx="12" ry="12" fill="#F0F3F8" stroke="#4a90e2" stroke-width="2"></rect>\n    <path d="M5 44.5h70" stroke="#4a90e2" stroke-width="1" fill="none"/>\n  </g>\n\n</defs></svg>',s};return e.template(t)}),function(){define("CanvasElement",["Design","CanvasManager","i18n!/nls/lang.js","UI.modalplus","backbone","svg"],function(e,t,n,r){var i,s,o,u;return s=null,u=Backbone.Model.extend,o={},i=Backbone.View.extend({_ensureElement:function(){this.$el||(this.$el=$())},initialize:function(e){this.canvas=e.canvas,this.addView(this.create()),this.render(),this.listenTo(this.model,"change:name",this.render),this.listenModelEvents(),this.ensureStickyPos()},listenModelEvents:function(){},addView:function(e){return e?(this.$el=this.$el.add(e.node?e.node:e),this.delegateEvents(),this):this},removeView:function(e){return e?(e.node&&(e=e.node),this.undelegateEvents(),this.$el=this.$el.not(e),$(e).remove(),this.delegateEvents(),this):this},portDirection:function(e){return this.portDirMap?this.portDirMap[e]:null},portPosition:function(e,t){var n;return this.portPosMap?(n=this.portPosMap[e],t&&n.length>=5?[n[3],n[4],n[2]]:n):null},isPortSignificant:function(e){return!1},hover:function(e){var n,r,i,s;s=this.connections();for(r=0,i=s.length;r<i;r++)n=s[r],t.addClass(n.$el,"hover")},hoverOut:function(e){var n,r,i,s;s=this.connections();for(r=0,i=s.length;r<i;r++)n=s[r],t.removeClass(n.$el,"hover")},create:function(){},render:function(){},size:function(){var e;return this.model.width&&this.model.width()?{width:this.model.width(),height:this.model.height()}:this.defaultSize?{width:this.defaultSize[0],height:this.defaultSize[1]}:(e=this.$el[0].getBBox(),void 0,{width:e.width,height:e.height})},pos:function(e){var t,n,r,i;r=this.model.x(),i=this.model.y();if(e){e=e.parentNode;while(e){t=e.getAttribute("data-id"),n=this.canvas.getItem(t);if(!n)break;r+=n.model.x(),i+=n.model.y(),e=e.parentNode}}return{x:r,y:i}},containPoint:function(e,t,n){var r,i,s,o,u,a,f,l;s=[this.rect()];if(n){l=this.children(!0);for(o=0,a=l.length;o<a;o++)r=l[o],r.sticky&&s.push(r.rect())}for(u=0,f=s.length;u<f;u++){i=s[u];if(i.x1<=e&&i.y1<=t&&i.x2>=e&&i.y2>=t)return!0}return!1},rect:function(e){var t,n;return n=this.size(),t=this.pos(e),{x1:t.x,y1:t.y,x2:t.x+n.width,y2:t.y+n.height}},effectiveRect:function(){var e;return e=this.rect(),this.isGroup()&&(e.x1-=1,e.y1-=1,e.x2+=1,e.y2+=1),e},ensureStickyPos:function(e,t){var n,r,i,o,u;if(!this.sticky)return;i=this.size(),r=this.parent().rect(),n=function(e,t,n){return e<=t?t:e>=n?n:e},o=e||this.model.x(),u=t||this.model.y(),o<0&&(o=Math.round((r.x2-r.x1-i.width)/2)),u<0&&(u=Math.round((r.y2-r.y1-i.height)/2)),o=n(o,r.x1,r.x2-i.width),u=n(u,r.y1,r.y2-i.height);switch(this.sticky){case"left":o=r.x1-Math.round(i.width/2);break;case"right":o=r.x2-Math.round(i.width/2);break;case"top":u=r.y1-Math.round(i.height/2);break;case"bottom":u=r.y2-Math.round(i.height/2)}if(this.model.attributes.x===o&&this.model.attributes.y===u)return;this.model.attributes.x=o,this.model.attributes.y=u,this.$el[0].instance.move(o*s.GRID_WIDTH,u*s.GRID_HEIGHT),this.updateConnections()},initNode:function(e,t,n){var r,i,o,u,a,f;e.move(t*s.GRID_WIDTH,n*s.GRID_HEIGHT),f=e.children();for(u=0,a=f.length;u<a;u++){r=f[u];if((r.attr("class")||"").indexOf("port")<0)continue;i=r.attr("data-alias")||r.attr("data-name"),i&&(o=this.portPosition(i),o&&r.move(o[0],o[1]))}return null},createRawNode:function(){var e;return e=this.canvas.svg,e.group().attr({"data-id":this.cid}).classes("canvasel "+this.type.replace(/\.|:/g,"-")).add([e.rect(80,80).radius(16,16).classes("node-background"),e.text("").move(40,90).classes("node-label")])},createPortElement:function(){var e;return e=this.canvas.svg,e.group().add([e.circle(6,6).cx(0).cy(0).classes("port-border"),e.circle(6,6).cx(0).cy(0).classes("port-fill")])},createNode:function(e){var t,n,r,i,o,u,a,f;return r=this.model,i=this.size(),a=r.x(),f=r.y(),u=i.width*s.GRID_WIDTH,n=i.height*s.GRID_HEIGHT,o=this.canvas.svg,t=o.group(),t.add([o.rect(u-1,n-1).move(.5,.5).radius(5).classes("node-background"),o.image(MC.IMG_URL+e.image,e.imageW,e.imageH).move(e.imageX,e.imageY)]).attr({"data-id":this.cid}).classes("canvasel "+this.type.replace(/\.|:/g,"-")),e.labelBg&&t.add(o.use("label_path").classes("node-label-name-bg")),e.label&&t.add(o.plain(e.label).move(u/2,n-4).classes("node-label")),e.sg&&t.add(o.group().add([o.rect(7,5).move(10,6).classes("node-sg-color-border tooltip"),o.rect(7,5).move(20,6).classes("node-sg-color-border tooltip"),o.rect(7,5).move(30,6).classes("node-sg-color-border tooltip"),o.rect(7,5).move(40,6).classes("node-sg-color-border tooltip"),o.rect(7,5).move(50,6).classes("node-sg-color-border tooltip")]).classes("node-sg-color-group").move(8,63)),t},createGroup:function(){var e,t,n,r,i,o,u,a;return n=this.model,u=n.x(),a=n.y(),o=n.width()*s.GRID_WIDTH,t=n.height()*s.GRID_HEIGHT,r=10,i=this.canvas.svg,e=i.group(),e.add([i.rect(o,t).radius(5).classes("group"),i.rect(o-2*r,r).x(r).classes("group-resizer top"),i.rect(r,t-2*r).y(r).classes("group-resizer left"),i.rect(r,t-2*r).move(o-r,r).classes("group-resizer right"),i.rect(o-2*r,r).move(r,t-r).classes("group-resizer bottom"),i.rect(r,r).classes("group-resizer top-left"),i.rect(r,r).x(o-r).classes("group-resizer top-right"),i.rect(r,r).y(t-r).classes("group-resizer bottom-left"),i.rect(r,r).move(o-r,t-r).classes("group-resizer bottom-right"),i.text("").move(5,15).classes("group-label")]).attr({"data-id":this.cid}).classes("canvasel group "+this.type.replace(/\.|:/g,"-"))},label:function(){return this.model.get("name")},labelWidth:function(e){return(e||this.size().width*s.GRID_WIDTH)-8},isGroup:function(){return!!this.model.node_group},isTopLevel:function(){return this.model.parent?this.model.parent()?!1:!0:!1},parent:function(){var e;return e=this.model.parent(),e?this.canvas.getItem(e.id):this.canvas.getSvgItem()},children:function(e){var t,n,r,i,s,o,u;if(!this.model.node_group)return[];t=this.canvas,i=[],u=this.model.children();for(s=0,o=u.length;s<o;s++){n=u[s],r=t.getItem(n.id);if(!r)continue;if(r.sticky&&!e)continue;i.push(r)}return i},siblings:function(e){var t,n;return n=this.parent().children(e),t=n.indexOf(this),t>=0&&n.splice(t,1),n},connections:function(){var e,t,n,r,i;t=[],i=this.model.connections();for(n=0,r=i.length;n<r;n++)e=i[n],e=this.canvas.getItem(e.id),e&&e.node_line&&t.push(e);return t},isConnectable:function(t,n,r){var i,s,o,u,a,f,l;i=e.modelClassForPorts(t,r);if(!i)return!1;s=this.model,o=this.model.design().component(n),l=s.connectionTargets(i.prototype.type);for(a=0,f=l.length;a<f;a++){u=l[a];if(u===o)return!1}return i.isConnectable(s,o)!==!1},select:function(e){this.canvas.triggerSelected(this.type,this.model.id)},destroy:function(e){var t,i,s,o,u,a;if(this.model.isRemoved()){this.$el.remove(),this.$el=$();return}t=this.canvas,u=this.isDestroyable(),s=this.model,o=s.get("name"),u===!0&&s.node_group&&s.children().length>0&&(u=sprintf(n.CANVAS.CVS_CFM_DEL_GROUP,o)),_.isString(u)?(a=this,i=new r({title:sprintf(n.CANVAS.CVS_CFM_DEL,o),template:u,confirm:{text:n.IDE.CFM_BTN_DELETE,color:"red"},onConfirm:function(){a.doDestroyModel(),i.close()}})):u.error?notification("error",u.error):u===!0&&this.doDestroyModel()},doDestroyModel:function(){return this.model.remove()},isDestroyable:function(e){var t,n,r,i,s;n=this.model.isRemovable();if(n!==!0)return n;if(this.model.node_group){s=this.children();for(r=0,i=s.length;r<i;r++){t=s[r],n=t.isDestroyable();if(n!==!0)break}}return n},isClonable:function(){return!!this.model.clone},cloneTo:function(e,t,n){var r,s,o,u;if(!this.model.clone)return;s=this.model.get("name"),o=s.match(/(.+-copy)(\d*)$/),o?s=o[1]+((parseInt(o[2],10)||0)+1):s+="-copy",r=i.getClassByType(this.type).createResource(this.type,{parent:e.model,name:s,x:t,y:n},{cloneSource:this.model}),r&&r.id&&(u=this,_.defer(function(){return u.canvas.selectItem(r.id)}))},changeParent:function(e,t,r){var i,s;if(e===this.parent()||e===null){if(this.model.x()===t&&this.model.y()===r)return;this.moveBy(t-this.model.x(),r-this.model.y());return}if(this.model.get("appId")){notification("error",n.NOTIFY.WARN_OPERATE_NOT_SUPPORT_YET);return}if(!this.parent()&&e)return;i=e.model,s=this.model.isReparentable(i);if(_.isString(s)){notification("error",s);return}s===!0&&(i.addChild(this.model),this.moveBy(t-this.model.x(),r-this.model.y()))},moveBy:function(e,t){var n,r,i,o;if(this.isGroup()){o=this.children(!0);for(r=0,i=o.length;r<i;r++)n=o[r],n.moveBy(e,t)}e+=this.model.x(),t+=this.model.y(),this.model.set({x:e,y:t}),this.$el[0].instance.move(e*s.GRID_WIDTH,t*s.GRID_HEIGHT),this.updateConnections()},updateConnections:function(){var e,t,n,r;r=this.connections();for(t=0,n=r.length;t<n;t++)e=r[t],e.update()},applyGeometry:function(e,n,r,i,o){var u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C;o==null&&(o=!0);if(e!==void 0||n!==void 0)this.model.set({x:e,y:n}),this.$el[0].instance.move(e*s.GRID_WIDTH,n*s.GRID_HEIGHT);if(this.isGroup()&&r!==void 0&&i!==void 0){this.model.set({width:r,height:i}),T=this.children(!0);for(m=0,w=T.length;m<w;m++)u=T[m],u.sticky&&u.ensureStickyPos()}r=(r||this.model.get("width"))*s.GRID_WIDTH,i=(i||this.model.get("height"))*s.GRID_HEIGHT,h=10,p=20,d=[],N=this.$el[0].instance.children();for(g=0,E=N.length;g<E;g++)u=N[g],a=u.classes(),a.indexOf("group")>=0?u.size(r,i):a.indexOf("top")>=0?u.size(r-p,h).x(h):a.indexOf("left")>=0?u.size(h,i-p).y(h):a.indexOf("right")>=0?u.size(h,i-p).move(r-h,h):a.indexOf("bottom")>=0?u.size(r-p,h).move(h,i-h):a.indexOf("top-right")>=0?u.x(r-h):a.indexOf("bottom-left")>=0?u.y(i-h):a.indexOf("bottom-right")>=0?u.move(r-h,i-h):a.indexOf("port")>=0?d.push(u):a.indexOf("group-label")>=0&&t.setLabel(this,u.node);for(y=0,S=d.length;y<S;y++)c=d[y],l=c.attr("data-alias")||c.attr("data-name"),l&&(v=this.portPosition(l),v&&c.move(v[0],v[1]));if(o){C=this.connections();for(b=0,x=C.length;b<x;b++)f=C[b],f.update()}}},{isDirectParentType:function(e){return!0},createResource:function(t,n,r){var i;return i=e.modelClassForType(t),new i(n,r)},getClassByType:function(e){return o[e]},extend:function(e,t){var n;return void 0,t=t||{},t.type=e.type,n=u.call(this,e,t),o[e.type]=n,n}}),i.constant={PORT_4D_ANGLE:-1,PORT_2D_H_ANGLE:-2,PORT_2D_V_ANGLE:-3,PORT_RIGHT_ANGLE:0,PORT_UP_ANGLE:90,PORT_LEFT_ANGLE:180,PORT_DOWN_ANGLE:270},i.setCanvasViewClass=function(e){s=e},i})}.call(this),function(){define("CanvasView",["workspaces/coreeditor/TplSvgDef","CanvasElement","CanvasManager","Design","i18n!/nls/lang.js","UI.modalplus","event","backbone","UI.nanoscroller","svg"],function(e,t,n,r,i,s,o){var u;return $(e()).appendTo("body"),u=Backbone.View.extend({events:{"click .icon-resize-down":"expandHeight","click .icon-resize-up":"shrinkHeight","click .icon-resize-right":"expandWidth","click .icon-resize-left":"shrinkWidth","click .canvasel":"selectItemByClick","click .line":"selectItemByClick","click svg":"deselectItem",addItem_dragover:"__addItemDragOver",addItem_dragleave:"__addItemDragLeave",addItem_drop:"__addItemDrop","mousedown .canvasel":"__moveItemMouseDown","mousedown .group-label":"__moveItemMouseDown","mousedown .group-resizer":"__resizeGroupDown","mousedown .port":"__drawLineDown","mouseenter .canvasel":"__hoverEl","mouseleave .canvasel":"__hoverOutEl","mousedown svg":"__dragCanvasMouseDown",dblclick:"onDblClick"},initialize:function(e){var t;this.workspace=e.workspace,this.design=this.workspace.design,this.parent=e.parent,this.listenTo(this.design,r.EVENT.Deserialized,this.reload),this.listenTo(this.design,r.EVENT.AddResource,this.addItem),this.listenTo(this.design,r.EVENT.RemoveResource,this.removeItem),this.listenTo(this.design,"change:mode",this.switchMode),this.setElement(this.parent.$el.find(".OEPanelCenter"),!1),this.svg=SVG(this.$el.find("svg")[0]),t=this.size(),this.__getCanvasView().css({width:t[0]*u.GRID_WIDTH,height:t[1]*u.GRID_HEIGHT}),this.$el.nanoScroller(),this.__popupCache={},this.__itemMap={},this.__scale=1,this.__linestyle=parseInt(localStorage.getItem("canvas/lineStyle"))||0,this.switchMode(this.design.mode()),this.reload()},isReadOnly:function(){return!1},onDblClick:function(e){return this.trigger("doubleclick")},remove:function(){var e,t,n,r,i,s;i=this.__popupCache;for(r in i)n=i[r],n&&n.remove();s=this.__itemMap;for(e in s)t=s[e],t.remove();return Backbone.View.prototype.remove.apply(this,arguments)},updateSize:function(){var e;return e=this,setTimeout(function(){return e.$el.nanoScroller()},150)},__appendSvg:function(e,t){return e.parent&&e.parent.removeElement(e),t=$(this.svg.node).children(t),t.append(e.node),e.parent=t[0].instance,e},__getCanvasView:function(){return this.$el.children().children(".canvas-view")},appendLine:function(e){return this.__appendSvg(e,".layer_line")},appendNode:function(e){return this.__appendSvg(e,".layer_node")},switchMode:function(e){void 0,this.__getCanvasView().attr("data-mode",e),this.clearPopups(),this.trigger("switchMode",e)},registerPopup:function(e,t,n){var r;r=this.__popupCache[e],n?r===t&&delete this.__popupCache[e]:(r&&r!==t&&r.remove(),this.__popupCache[e]=t)},clearPopups:function(){var e,t,n;n=this.__popupCache;for(t in n)e=n[t],e.remove();this.__popupCache={}},canvasRect:function(){var e;return e=this.size(),{x1:3,y1:1,x2:e[0]-3,y2:e[1]-1}},isRectAvailableForItem:function(e,t){var n,r,i,s,o;t.parent()&&(i=t.parent().rect(),r=t.parent().children()),t.isTopLevel()||(i.x1+=1,i.y1+=1,i.x2-=1,i.y2-=1);if(i.x1>e.x1||i.y1>e.y1||i.x2<e.x2||i.y2<e.y2)return!1;for(s=0,o=r.length;s<o;s++){n=r[s];if(n===t)continue;t.isGroup()?i=n.rect():i=n.effectiveRect();if(!(i.x1>=e.x2||i.x2<=e.x1||i.y1>=e.y2||i.y2<=e.y1))return!1}return!0},moveSelectedItem:function(e,t){var n,r;if(this.isReadOnly())return;n=this.getSelectedItem();if(!n)return;r=n.effectiveRect(),r.x1+=e,r.y1+=t,r.x2+=e,r.y2+=t,n.sticky?n.ensureStickyPos(r.x1,r.y1):this.isRectAvailableForItem(r,n)&&n.moveBy(e,t)},getSelectedItem:function(){return this.__selected?this.getItem(this.__selected.getAttribute("data-id")):null},getSelectedComp:function(){var e;return(e=this.getSelectedItem())!=null?e.model:void 0},delSelectedItem:function(){if(this.isReadOnly()||!this.__selected)return;return this.getItem(this.__selected.getAttribute("data-id")).destroy(this.__selected)},deleteItem:function(e){_.isString(e)&&(e=this.getItem(e));if(!e)return;return e.destroy()},selectPrevItem:function(){var e,t;t=$(this.svg.node).find(".canvasel:not(.group)"),e=this.__selected?[].indexOf.call(t,this.__selected)-1:null;if(e===null||e<0)e=t.length-1;return this.selectItem(t[e])},selectNextItem:function(){var e,t;t=$(this.svg.node).find(".canvasel:not(.group)"),e=this.__selected?[].indexOf.call(t,this.__selected)+1:null;if(e===null||e>=t.length)e=0;return this.selectItem(t[e])},selectItem:function(e){var t;_.isString(e)&&(e=this.getItem(e).$el[0]);if(!e)return;this.__selected&&(n.removeClass(this.__selected,"selected"),this.__selected=null),this.__selected=e,n.addClass(this.__selected,"selected"),t=this.getItem(this.__selected.getAttribute("data-id")),t.select(this.__selected)},selectItemByClick:function(e){return this.selectItem(e.currentTarget),!1},deselectItem:function(e){this.__selected&&(n.removeClass(this.__selected,"selected"),this.__selected=null),e!==!0&&this.triggerSelected()},triggerSelected:function(e,t){this.trigger("itemSelected",e,t)},clearItems:function(){var e,t,n,r;e={},r=this.__itemMap;for(t in r)n=r[t],e[n.cid]||(n.remove(),e[n.cid]=!0);this.__itemMap={}},lineStyle:function(){return this.__linestyle},updateLineStyle:function(){var e,t,n,r;t=parseInt(localStorage.getItem("canvas/lineStyle"))||0;if(this.__linestyle===t)return;this.__linestyle=t,r=this.__itemLineMap;for(n in r)e=r[n],e.update()},toggleSgLine:function(e){return n.toggle($(this.svg.node).children(".layer_sgline"),e)},zoomOut:function(){return this.zoom(.2)},zoomIn:function(){return this.zoom(-0.2)},zoom:function(e){var t,n,r,i;r=Math.round((this.__scale+e)*10)/10;if(r<1||r>1.6)return;this.__scale=r,i=this.size(),n=i[0]*u.GRID_WIDTH,t=i[1]*u.GRID_HEIGHT,this.__getCanvasView().css({width:i[0]*u.GRID_WIDTH/r,height:i[1]*u.GRID_HEIGHT/r}).attr("data-scale",r).children("svg")[0].setAttribute("viewBox","0 0 "+n+" "+t),this.$el.nanoScroller()},size:function(){return this.design.get("canvasSize")},scale:function(){return this.__scale},expandHeight:function(){return this.resize("height",60)},shrinkHeight:function(){return this.resize("height",-60)},expandWidth:function(){return this.resize("width",60)},shrinkWidth:function(){return this.resize("width",-60)},resize:function(e,t){var n,r,i,s,o,a;o=this.size(),s=this.scale(),o[e==="width"?0:1]+=t,a=this.__getCanvasView(),i=o[0]*u.GRID_WIDTH,r=o[1]*u.GRID_HEIGHT,t>0?a.children(".icon-resize-up, .icon-resize-left").show():(n=a.children("svg")[0].getBBox(),n.width+n.x+20>=i&&(i=n.width+n.x+20,o[0]=i/u.GRID_WIDTH,a.children(".icon-resize-left").hide()),n.height+n.y+20>=r&&(r=n.height+n.y+20,o[1]=r/u.GRID_HEIGHT,a.children(".icon-resize-up").hide())),this.design.set("canvasSize",o),a.css({width:i/s,height:r/s}).children("svg")[0].setAttribute("viewBox","0 0 "+i+" "+r),this.$el.nanoScroller()},update:function(){return this.trigger("change:externalData")},reload:function(){var e,n,r,i,s,o,u;void 0,this.clearPopups(),this.clearItems(),this.addSvgItem(),this.initializing=!0,this.recreateStructure(),this.__itemLineMap={},this.__itemNodeMap={},this.__itemTopLevel=[],r=[],s={},this.design.eachComponent(function(e){e.node_line?r.push(e):this.addItem(e),s[e.type]=!0},this);for(i in s)e=t.getClassByType(i),e&&e.render&&e.render(this);for(o=0,u=r.length;o<u;o++)n=r[o],this.addItem(n,!0);this.initializing=!1},__batchAddLines:function(){var e,t,n,r,i;i=this.__toAddLines;for(n=0,r=i.length;n<r;n++){t=i[n];try{this.addItem(t,!0)}catch(s){e=s,void 0}}this.__toAddLines=null},addSvgItem:function(){var e,n;e=t.getClassByType("SVG"),n=new e({canvas:this}),this.svgItem=this.__itemMap[n.cid]=n},getSvgItem:function(){return this.svgItem},addItem:function(e,n){var r,i,s;r=t.getClassByType(e.type);if(!r)return;if(!e.isVisual())return;if(e.node_line&&!n){this.__toAddLines?this.__toAddLines.push(e):(this.__toAddLines=[e],s=this,_.defer(function(){return s.__batchAddLines()}));return}i=new r({model:e,canvas:this});if(!i.cid)return;this.__itemMap[e.id]=i,this.__itemMap[i.cid]=i,i.isTopLevel()&&this.__itemTopLevel[i.isGroup()?"push":"unshift"](i),e.node_line?this.__itemLineMap[i.cid]=i:e.node_group||(this.__itemNodeMap[i.cid]=i)},removeItem:function(e){var t,n;n=this.getItem(e.id);if(!n)return;this.getSelectedItem()===n&&this.deselectItem(),delete this.__itemMap[e.id],delete this.__itemMap[n.cid],delete this.__itemLineMap[n.cid],delete this.__itemNodeMap[n.cid],t=this.__itemTopLevel.indexOf(n),t>=0&&this.__itemTopLevel.splice(t,1),n.remove(),n.canvas=null},getItem:function(e){return this.__itemMap[e]},autoLayout:function(e){return this.autoLayoutFully()},__hoverEl:function(e){var t;return(t=this.getItem(e.currentTarget.getAttribute("data-id")))!=null?t.hover(e):void 0},__hoverOutEl:function(e){var t;return(t=this.getItem(e.currentTarget.getAttribute("data-id")))!=null?t.hoverOut(e):void 0},__localToCanvasCoor:function(e,t){var n;return n=this.$el.children(":first-child")[0],{x:Math.round((e+n.scrollLeft)/u.GRID_WIDTH*this.__scale),y:Math.round((t+n.scrollTop)/u.GRID_HEIGHT*this.__scale)}},__itemAtPos:function(e){var t,n,r,i,s,o;n=this.__itemTopLevel,i=null;while(n){r=n,n=null;for(s=0,o=r.length;s<o;s++){t=r[s];if(!t.containPoint(e.x,e.y,!0))continue;if(!t.isGroup())return t;i=t,n=t.children(!0);break}}return i},__groupAtCoor:function(e,t){var n,r,i,s,o,u;r=this.__itemTopLevel,s=null;while(r){i=r,r=null;for(o=0,u=i.length;o<u;o++){n=i[o];if(!n.isGroup())continue;if(n===t)continue;if(!n.containPoint(e.x,e.y))continue;s=n,r=n.children();break}}return s},__clearDragScroll:function(){this.__dragScrollInt&&(void 0,clearInterval(this.__dragScrollInt),this.__dragScrollInt=null)},__scrollOnDrag:function(e){var t,n,r,i,s,o,u,a,f,l;i=e.zoneDimension;if(!i)return;s=this.$el.children(":first-child")[0],o=s.scrollLeft,u=s.scrollTop,t=50,n=10,e.pageX-i.x1<=t?o>n?(r=!0,a=o-n):o>0&&(a="0"):i.x2-e.pageX<=t&&(r=!0,a=o+n),e.pageY-i.y1<=t?u>n?(r=!0,f=u-n):u>0&&(f="0"):i.y2-e.pageY<=t&&(r=!0,f=u+n),a!==void 0&&this.$el.nanoScroller({scrollLeft:a}),f!==void 0&&this.$el.nanoScroller({scrollTop:f}),r?this.__dragScrollInt||(l=this,void 0,this.__dragScrollInt=setInterval(function(){return l.__scrollOnDrag(e)},50)):this.__clearDragScroll()}},{GRID_WIDTH:10,GRID_HEIGHT:10}),t.setCanvasViewClass(u),u})}.call(this),function(){define("CanvasPopup",["backbone"],function(){return Backbone.View.extend({type:"CanvasPopup",attachType:"float",closeOnBlur:!1,className:"canvas-pp",initialize:function(e){var t,n,r,i;void 0,void 0,void 0,$.extend(this,e),this.$el.appendTo(this.canvas.__getCanvasView().parent()),this.render(),this.closeOnBlur&&(i=this,this.ac=t=function(e){return i.autoclose(e)},this.canvas.$el[0].addEventListener("mousedown",t,!0)),n=this.canvas.getItem($(this.attachment).closest(".canvasel").attr("data-id"))||this.attachment,n.__popupCache||(n.__popupCache={}),r=n.__popupCache[this.type],n.__popupCache[this.type]=this,r&&(this.migrate(r),r.remove()),this.canvas.registerPopup(this.type,this)},migrate:function(e){},autoclose:function(e){var t;return t=$(e.target).closest(".canvas-pp"),t.length&&t[0]===this.$el[0]?!1:(this.remove(),!0)},render:function(){this.$el.html(this.content()),this.attachType==="float"?this.attachFloat():this.attachOverlay()},attachFloat:function(){var e,t,n,r,i,s;e=this.attachment.getBoundingClientRect(),n=this.canvas.$el[0].getBoundingClientRect(),t=this.canvas.__getCanvasView()[0].getBoundingClientRect(),r=e.left-n.left,i=this.$el.outerWidth(!0),r>i+20?(this.$el.addClass("pp-left"),s=e.left-t.left-i):(this.$el.addClass("pp-right"),s=e.right-t.left),this.$el.css({left:s,top:e.top-t.top+(e.height-this.$el.outerHeight(!0))/2})},attachOverlay:function(){var e,t;e=this.attachment.getBoundingClientRect(),t=this.canvas.__getCanvasView()[0].getBoundingClientRect(),this.$el.css({left:e.left-t.left,top:e.top-t.top})},remove:function(){var e,t;return this.canvas.registerPopup(this.type,this,!1),e=this.canvas.getItem($(this.attachment).closest(".canvasel").attr("data-id"))||this.attachment,t=(e.__popupCache||{})[this.type],t===this&&delete e.__popupCache[this.type],this.autoclose&&this.canvas.$el[0].removeEventListener("mousedown",this.ac,!0),this.onRemove&&this.onRemove(),Backbone.View.prototype.remove.call(this)},content:function(){}})})}.call(this),function(){define("CanvasViewLayout",["CanvasView","constant"],function(e,t){var n,r,i,s,o,u,a,f,l;return s=null,o=function(){function e(e,t){this.px=e||0,this.py=t||0}return e.prototype.fit=function(e){var t,n,r,i,s,o;r=e.length,this.root={x:0,y:0,w:r>0?e[0].w+this.px:0,h:r>0?e[0].h+this.py:0},i=0;while(i<r)t=e[i],o=t.w+this.px,n=t.h+this.px,s=this.findNode(this.root,o,n),s?t.fit=this.splitNode(s,o,n):t.fit=this.growNode(o,n),i++},e.prototype.findNode=function(e,t,n){return e.used?this.findNode(e.right,t,n)||this.findNode(e.down,t,n):t<=e.w&&n<=e.h?e:null},e.prototype.splitNode=function(e,t,n){return e.used=!0,e.down={x:e.x,y:e.y+n,w:e.w,h:e.h-n},e.right={x:e.x+t,y:e.y,w:e.w-t,h:n},e},e.prototype.growNode=function(e,t){var n,r,i,s;return n=e<=this.root.w,r=t<=this.root.h,s=r&&this.root.h>=this.root.w+e,i=n&&this.root.w>=this.root.h+t,s?this.growRight(e,t):i?this.growDown(e,t):r?this.growRight(e,t):n?this.growDown(e,t):null},e.prototype.growRight=function(e,t){var n;return this.root={used:!0,x:0,y:0,w:this.root.w+e,h:this.root.h,down:this.root,right:{x:this.root.w,y:0,w:e,h:this.root.h}},n=this.findNode(this.root,e,t),n?this.splitNode(n,e,t):null},e.prototype.growDown=function(e,t){var n;return this.root={used:!0,x:0,y:0,w:this.root.w,h:this.root.h+t,down:{x:0,y:this.root.h,w:this.root.w,h:t},right:this.root},n=this.findNode(this.root,e,t),n?this.splitNode(n,e,t):null},e}(),r=function(e){var t,n,r,i;n=[],i=_.groupBy(e,"type");for(r in i)t=i[r],n.push({type:r+"_group",children:t});return n},n=function(e){var t,n,r,i,o,u,a,f,l,c;o=s[this.type]||{},a=o.space||0,f=0,u=0;for(l=0,c=e.length;l<c;l++)t=e[l],n=s[t.type]||{},i=t.width||n.width||0,r=t.height||n.height||0,t.x=f,t.y=0,i>0&&(f+=i+a),r&&r>u&&(u=r);return e.length&&(f-=a),{width:f||o.width,height:u||o.height}},i={GroupMByType:r,ArrangeHorizontal:n,ArrangeVertical:function(e){var t,n,r,i,o,u,a,f,l,c;o=s[this.type]||{},u=o.space||0,f=0,a=0;for(l=0,c=e.length;l<c;l++)t=e[l],n=s[t.type]||{},i=t.width||n.width||0,r=t.height||n.height||0,t.x=0,t.y=f,r>0&&(f+=r+u),i&&i>a&&(a=i);return e.length&&(f-=u),{width:a||o.width,height:f||o.height}},ArrangeBinPack:function(e){var t,n,r,i,u,a,f,l,c,h,p;if(e.length===0)return{width:0,height:0};if(e.length===1)return e[0].x=e[0].y=0,{width:e[0].width,height:e[0].height};n=e.map(function(e){return{w:e.width,h:e.height,item:e,sign:e.width>e.height?e.width:e.height}}),n.sort(function(e,t){return t.sign-e.sign}),r=s[this.type]||{},u=r.spaceX||r.space||0,a=r.spaceY||r.space||0,(new o(u,a)).fit(n),f=0,i=0;for(l=0,c=n.length;l<c;l++)t=n[l],t.item.x=((h=t.fit)!=null?h.x:void 0)||0,t.item.y=((p=t.fit)!=null?p.y:void 0)||0,f=Math.max(f,t.item.x+t.item.width),i=Math.max(i,t.item.y+t.item.height);return{width:f,height:i}}},l=function(e){return e?_.isFunction(e)?e:i[e]:null},a=function(e){var t,n,r,i,o,u,f,c;r={component:e,type:e.type,x:0,y:0};if(e.children){r.children=[],n=e.children(),i=l((f=s[e.type])!=null?f.sortMethod:void 0),i&&(n=i.call(e,n));for(o=0,u=n.length;o<u;o++){t=n[o];if((c=s[t.type])!=null?c.ignore:void 0)continue;r.children.push(a(t))}}return r},f=function(e){var t,n,i,o,u,a;if(e.children){u=e.children;for(i=0,o=u.length;i<o;i++)t=u[i],f(t)}return n=l((a=s[e.type])!=null?a.groupMethod:void 0)||r,e.children=n.call(e,e.children),e},u=function(e){var t,r,i,o,a,f,c,h,p,d;i=s[e.type]||{};if(e.children){p=e.children;for(a=0,c=p.length;a<c;a++)r=p[a],u(r);t=l(i.arrangeMethod)||n,o=t.call(e,e.children);if(i.margin){o.width+=i.margin*2,o.height+=i.margin*2,d=e.children;for(f=0,h=d.length;f<h;f++)r=d[f],r.x+=i.margin,r.y+=i.margin}e.width=o.width,e.height=o.height}else e.width=i.width||0,e.height=i.height||0;return e},e.prototype.applyGeometry=function(e,t,n){var r,i,o,u,a,f,l,c;o=e.x+t,u=e.y+n;if(e.children){l=e.children;for(a=0,f=l.length;a<f;a++)r=l[a],this.applyGeometry(r,o,u)}if(e.component){i=this.getItem(e.component.id);if(i){if((c=s[e.type])!=null?c.sticky:void 0)o=-1,u=-1;i.applyGeometry(o,u,e.width,e.height,!1)}}},e.prototype.autoLayoutFully=function(){var e,t,n,r,i;s=this.autoLayoutConfig,n=this.__itemTopLevel.map(function(e){return e.model}),e={type:"SVG",children:function(){return n}},e=a(e),f(e),u(e),this.applyGeometry(e,5,3),i=this.__itemLineMap;for(r in i)t=i[r],t.update()},{DefaultGroupMethod:r,DefaultArrangeMethod:n}})}.call(this),function(){define("workspaces/coreeditor/CeSvg",["CanvasElement","constant","CanvasManager","i18n!/nls/lang.js","UI.modalplus"],function(e,t,n,r,i){return e.extend({type:"SVG",initialize:function(e){this.canvas=e.canvas},hover:function(e){},hoverOut:function(e){},pos:function(e){return{x:0,y:0}},size:function(){var e;return e=this.canvas.size(),{width:e[0]-4,height:e[1]-2}},rect:function(e){var t;return t=this.canvas.size(),{x1:4,y1:2,x2:t[0],y2:t[1]}},effectiveRect:function(){var e;return e=this.canvas.size(),{x1:0,y1:0,x2:e[0],y2:e[1]}},ensureStickyPos:function(){},isGroup:function(){return!0},isTopLevel:function(){return!1},parent:function(){return null},children:function(){return this.canvas.__itemTopLevel.slice(0)},siblings:function(){return[]},connections:function(){return[]},isConnectable:function(e,t,n){return!1},select:function(e){},destroy:function(e){},doDestroyModel:function(){},isDestroyable:function(e){return!1},isClonable:function(){return!1},cloneTo:function(e,t,n){},changeParent:function(e,t,n){},moveBy:function(e,t){},updateConnections:function(){},applyGeometry:function(e,t,n,r,i){i==null&&(i=!0)}},{isDirectParentType:function(e){return!0},createResource:function(e,t,n){}})})}.call(this),function(){define("workspaces/coreeditor/CanvasViewConnect",["Design","CanvasView","CanvasManager","CanvasElement","i18n!/nls/lang.js","UI.modalplus"],function(e,t,n,r,i,s){var o,u,a,f,l,c;return o=t.prototype,u=function(e){var t,r,i,s,o;$(document).off(".drawline"),r=e.data,r.context.__clearDragScroll(),r.context.removeHightLight(),r.context.hideHintMessage();if(r.marker){r.marker.remove(),r.lineSvg.remove(),r.overlay.remove(),o=r.highlightEls;for(i=0,s=o.length;i<s;i++)t=o[i],n.removeClass(t,"connectable")}},a=function(e){var t;return t=e.data,Math.pow(e.pageX-t.startX,2)+Math.pow(e.pageY-t.startY,2)>=4&&($(document).off("mousemove.drawline").off("mouseup.drawline").on({"mousemove.drawline":l,"mouseup.drawline":c},t),f.call(t.context,t)),!1},f=function(r){var i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M;i=r.source,c=r.startItem,v=i.attr("data-name"),d=i.attr("data-alias"),y=c.pos(i.closest(".canvasel")[0]),m=c.portPosition(d||v),y.x=y.x*t.GRID_WIDTH+m[0],y.y=y.y*t.GRID_HEIGHT+m[1],A=c.connections();for(x=0,C=A.length;x<C;x++)s=A[x],n.addClass(s.$el,"hover");l=[],b=[],O=e.modelClassForType("Framework_CN").connectionData(c.type,v);for(S in O){a=O[S],M=this.design.componentsOfType(S);for(T=0,k=M.length;T<k;T++){u=M[T];for(N=0,L=a.length;N<L;N++)E=a[N],u!==c.model&&c.isConnectable(v,u.id,E)&&(w=this.getItem(u.id),w&&(g=w.$el.children("[data-name='"+E+"']"),n.addClass(g,"connectable"),l.push(g),b.push(w)))}}return p=this.svg.marker(3,3).classes(v).attr("id","draw-line-marker").add(this.svg.path("M1.5,0 L1.5,3 L3,1.5 L1.5,0")),h=this.svg.line(y.x,y.y,y.x,y.y).classes("draw-line "+v).marker("end",p),this.svg.add(h),o=this.$el.offset(),f={x1:o.left,y1:o.top,x2:o.left+this.$el.outerWidth(),y2:o.top+this.$el.outerHeight()},this.hightLightItems(b),this.showHintMessage(i.attr("data-tooltip")),$.extend(r,{marker:p,lineSvg:h,zoneDimension:f,highlightEls:l,portName:v,startPos:y,overlay:$("<div></div>").appendTo(this.$el).css({position:"absolute",left:"0",top:"0",bottom:"0",right:"0"})}),!1},o.__connect=function(e,t,n,i){var s,o,u;u=this,s=r.getClassByType(e.prototype.type),o=s.connect(e,t,n),o&&o.id&&_.defer(function(){return u.selectItem(o.id)}),this.__connectInitItem=i},o.__popLineInitiator=function(){var e;return e=this.__connectInitItem,this.__connectInitItem=null,e},o.__drawLineDown=function(e){var t,n,r,i;return e.which!==1?!1:(t=$(e.currentTarget),n=t.closest(".canvasel"),r=this.getItem(n.attr("data-id")),r?(i=this.$el.children(":first-child")[0],$(document).on({"mousemove.drawline":a,"mousedown.drawline":u,"mouseup.drawline":u,"urlroute.drawline":u},{context:this,canvasScale:this.__scale,source:t,startItem:r,scrollContent:i,pageX:e.pageX,pageY:e.pageY,startX:e.pageX+i.scrollLeft,startY:e.pageY+i.scrollTop}),!1):!1)},l=function(e){var t,n,r;return t=e.data,t.pageX=e.pageX,t.pageY=e.pageY,t.context.__scrollOnDrag(t),n=t.startPos.x+(t.pageX+t.scrollContent.scrollLeft-t.startX)*t.canvasScale,r=t.startPos.y+(t.pageY+t.scrollContent.scrollTop-t.startY)*t.canvasScale,t.lineSvg.plot(t.startPos.x,t.startPos.y,n,r),!1},c=function(t){var n,r,i,o,a,f,l,c,h,p,d,v;a=t.data,h=$(a.scrollContent).offset(),o=a.context.__localToCanvasCoor(a.pageX-h.left,a.pageY-h.top),l=a.context.__itemAtPos(o),l&&(f=a.context.fixConnection(o,a.startItem,l),f&&(v=f.toPort,l=f.target)),!v&&l&&(v=l.$el.find(".connectable").attr("data-name")),u(t);if(!l||!v||l===a.startItem)return!1;n=e.modelClassForPorts(a.portName,v),void 0,r=a.startItem.model,i=l.model,p=n.isConnectable(r,i);if(p===!1)return;return _.isString(p)?(notification("error",p),!1):p===!0?(a.context.__connect(n,r,i,a.startItem),!1):(p.confirm&&(d=this,c=new s({title:p.title,width:"420",template:p.template,confirm:{text:p.action,color:"blue"},onConfirm:function(){c.close(),a.context.__connect(n,r,i,a.startItem)}})),!1)},null})}.call(this),function(){define("workspaces/coreeditor/CanvasViewDnd",["CanvasView","CanvasElement","CanvasManager","constant","i18n!/nls/lang.js"],function(e,t,n,r,i){var s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N;return u=function(){},o=function(){},s=e.prototype,s.__addItemDragOver=function(e,r){var i,s,o;this.__scrollOnDrag(r),s=this.__groupAtCoor(this.__localToCanvasCoor(r.pageX-r.zoneDimension.x1,r.pageY-r.zoneDimension.y1));if(s){i=t.getClassByType(r.dataTransfer.type),o=i.prototype.parentType;if(!o||o.indexOf(s.type)===-1)s=null}s!==this.__dragHoverGroup&&(this.__dragHoverGroup&&n.removeClass(this.__dragHoverGroup.$el,"droppable"),s&&n.addClass(s.$el,"droppable"),this.__dragHoverGroup=s,r.shadow.toggleClass("autoparent",!!s&&!i.isDirectParentType(s.type))),u.call(this,r)},s.__addItemDragLeave=function(){this.__clearDragScroll(),this.__dragHoverGroup&&(n.removeClass(this.__dragHoverGroup.$el,"droppable"),this.__dragHoverGroup=null)},s.__handleDropData=function(e,n,r){var s,o,u,a,f,l;if(!e.zoneDimension)return"";s=t.getClassByType(e.dataTransfer.type),o=s.prototype,f=this.__groupAtCoor(this.__localToCanvasCoor(e.pageX-e.zoneDimension.x1,e.pageY-e.zoneDimension.y1),n),l=f?f.type:"SVG";if(r&&!s.isDirectParentType(l)||(o.parentType||[]).indexOf(l)===-1)return this.errorMessageForDrop(o.type)||"";u=this.__localToCanvasCoor(e.pageX-e.offsetX-e.zoneDimension.x1,e.pageY-e.offsetY-e.zoneDimension.y1),a={x1:u.x,y1:u.y,x2:u.x+e.itemWidth,y2:u.y+e.itemHeight},f&&!s.isDirectParentType(f.type)&&(a.x1-=2,a.y1-=2,a.x2+=2,a.y2+=2);if(!o.sticky){a=this.__bestFitRect(a,f,n);if(!a)return i.CANVAS.WARN_NO_ENOUGH_SPACE}return{group:f,dropRect:a}},s.__addItemDrop=function(e,n){var r,i,s,o,u,a;r=t.getClassByType(n.dataTransfer.type),i=r.prototype,n.itemWidth=i.defaultSize[0],n.itemHeight=i.defaultSize[1],u=this.__handleDropData(n);if(_.isString(u)){notification("warning",u,!1);return}s=$.extend({x:u.dropRect.x1,y:u.dropRect.y1,width:i.defaultSize[0],height:i.defaultSize[1]},n.dataTransfer),Design.modelClassForType(s.type).prototype.node_group&&(s.x+=1,s.y+=1,s.width-=2,s.height-=2),delete s.type,u.group&&(s.parent=u.group.model),o=r.createResource(i.type,s,{createByUser:!0}),o&&o.id&&(a=this,_.defer(function(){return a.selectItem(o.id)}))},x=function(e,t){var n;return n=$.extend({},e),e.x1<=t.x1?(n.x2-=e.x1-t.x1-1,n.x1=t.x1+1):e.x2>=t.x2&&(n.x1+=t.x2-1-e.x2,n.x2=t.x2-1),e.y1<=t.y1?(n.y2-=e.y1-t.y1-1,n.y1=t.y1+1):e.y2>=t.y2&&(n.y1+=t.y2-1-e.y2,n.y2=t.y2-1),n},p=function(e,t){return!(e.x1>=t.x2||e.x2<=t.x1||e.y1>=t.y2||e.y2<=t.y1)},d=function(e,t){var n,r,i;for(r=0,i=t.length;r<i;r++){n=t[r];if(!(e.x1>=n.x2||e.x2<=n.x1||e.y1>=n.y2||e.y2<=n.y1))return!1}return!0},h=function(e,t){return t.x1<=e.x1&&t.y1<=e.y1&&t.x2>=e.x2&&t.y2>=e.y2},N=function(e){return e.x2-e.x1},T=function(e){return e.y2-e.y1},l=function(e,t,n){return e.x1-=t,e.x2+=t,e.y1-=n,e.y2+=n,e},c=function(e,t,n,r){var i,s,o,u,a,f,l,c;i=[],l=n.y1;for(o=0,a=l.length;o<a;o++)s=l[o],e.y1=s,e.y2=s+t,d(e,r)&&i.push($.extend({},e));c=n.y2;for(u=0,f=c.length;u<f;u++)s=c[u],e.y2=s,e.y1=s-t,d(e,r)&&i.push($.extend({},e));return i},s.__bestFitRect=function(e,t,n){var r,i,s,u,a,f,d,v,m,g,y,b,w,E,S,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z,W,X,V;t?(a=t.children(),O=t.rect()):(a=this.__itemTopLevel.slice(0),O=this.canvasRect()),E=a.indexOf(n),E>=0&&a.splice(E,1),M="rect",n&&(n.isGroup()?(e.x1-=1,e.y1-=1,e.x2+=1,e.y2+=1):M="effectiveRect"),_=N(e),w=T(e),b=Math.round(_/2),y=Math.round(w/2),b>12&&(b=12),y>12&&(y=12),k=x(e,O),e=x(l(e,b,y),O),f=[],v=[];for(H=0,I=a.length;H<I;H++)u=a[H],i=u[M](),p(i,k)?f.push(i):p(i,e)&&v.push(i);if(!f.length)h(k,O)&&(s=k);else{f=f.concat(v),r={x1:[k.x1],x2:[k.x2],y1:[k.y1],y2:[k.y2]};for(B=0,q=f.length;B<q;B++)u=f[B],u.x1-_>=e.x1&&r.x2.push(u.x1),u.y1-w>=e.y1&&r.y2.push(u.y1),u.x2+_<=e.x2&&r.x1.push(u.x2),u.y2+w<=e.y2&&r.y1.push(u.y2);g=[],L=k.x1,A=k.y1,X=r.x1;for(j=0,R=X.length;j<R;j++)D=X[j],k.x1=D,k.x2=D+_,g=g.concat(c(k,w,r,f));V=r.x2;for(F=0,U=V.length;F<U;F++)P=V[F],k.x2=P,k.x1=P-_,g=g.concat(c(k,w,r,f));C=0;for(W=0,z=g.length;W<z;W++){m=g[W];if(!h(m,O))continue;d=Math.pow(m.x1-L,2)+Math.pow(m.y1-A,2);if(!s||S>d)s=m,S=d}}return o.call(this,s,g,f,r,e),s},s.__moveItemMouseDown=function(e){return e.metaKey||e.ctrlKey?this.__dragCanvasMouseDown(e):this.isReadOnly()||this.dragItem(e,{onDrop:m,altState:!0}),!1},s.dragItem=function(e,t){var r,i,s,o;void 0;if(e.which!==1)return!1;i=$(e.currentTarget).closest(".canvasel");if(n.hasClass(i,"fixed"))return;o=this.getItem(i.attr("data-id"));if(!o)return;s=this.$el.offset(),t=$.extend(t,{dropTargets:$("#OpsEditor .OEPanelCenter"),dataTransfer:{type:o.type},item:o,targetSvg:i[0].instance,context:this,eventPrefix:"moveItem_",noShadow:!0,lockToCenter:!1,canvasX:s.left,canvasY:s.top,onDragStart:b,onDrag:g,onDragEnd:y,onDragCancel:v,includeSource:function(e){return e.data.altState&&!!e.altKey}}),o.isClonable()||(t.altState=!1),o.sticky&&(t.onDragStart=S,t.onDrag=w,t.onDragEnd=E),o.isGroup()&&(r=i.children(".group"));if(!r||!r.length)r=i;return r.dnd(e,t),!1},b=function(t){var n,r,i;r=t.context.svg,i=t.targetSvg.attr("id","svgDragTarget"),t.cloneSvg=r.group().add(r.use("svgDragTarget",!0).move(-i.x(),-i.y())).classes("shadow").move(i.x(),i.y()),t.altState&&(n=t.item.size(),t.cloneSvg.add(r.use("clone_indicator").move(n.width*e.GRID_WIDTH-12,n.height*e.GRID_HEIGHT-12).classes("indicator").hide()))},g=function(r){var i,s,o,a,f,l;o=r.data;if(!o.zoneDimension)return;s=o.context,s.__scrollOnDrag(o),a=s.__groupAtCoor(s.__localToCanvasCoor(o.pageX-o.zoneDimension.x1,o.pageY-o.zoneDimension.y1),o.item);if(a){i=t.getClassByType(o.dataTransfer.type),l=i.prototype.parentType;if(!l||l.indexOf(a.type)===-1||!i.isDirectParentType(a.type))a=null}a!==s.__dragHoverGroup&&(s.__dragHoverGroup&&n.removeClass(s.__dragHoverGroup.$el,"droppable"),a&&n.addClass(a.$el,"droppable"),s.__dragHoverGroup=a),f=o.context.__localToCanvasCoor(o.pageX-o.canvasX-o.offsetX,o.pageY-o.canvasY-o.offsetY),o.cloneSvg.move(f.x*e.GRID_WIDTH,f.y*e.GRID_HEIGHT),o.altState&&o.cloneSvg.get(1)[r.altKey?"show":"hide"](),u.call(s,o,o.item)},y=function(e){var t,n,r,s;t=e.data,v(e),s=t.item.size(),t.itemWidth=s.width,t.itemHeight=s.height,_.isFunction(t.includeSource)&&t.includeSource(e)||t.includeSource===!0?n=null:n=t.item,r=t.context.__handleDropData(t,n,!0);if(_.isString(r)){r===i.CANVAS.WARN_NO_ENOUGH_SPACE&&notification("warning",r);return}t.dataTransfer.item=t.item,t.dataTransfer.parent=r.group,t.dataTransfer.x=r.dropRect.x1,t.dataTransfer.y=r.dropRect.y1,t.item.isGroup()&&(t.dataTransfer.x+=1,t.dataTransfer.y+=1),t.onDrop(e,t.dataTransfer)},m=function(e,t){var n;t.item.isClonable()&&e.altKey?n="cloneTo":n="changeParent",t.item[n](t.parent,t.x,t.y)},v=function(e){var t;t=e.data,t.context.__addItemDragLeave(),t.targetSvg.attr("id",""),t.cloneSvg&&t.cloneSvg.remove()},S=function(e){},w=function(e){var t,n,r;n=e.data;if(!n.zoneDimension)return;t=n.context,t.__scrollOnDrag(n),r=n.context.__localToCanvasCoor(n.pageX-n.canvasX-n.offsetX,n.pageY-n.canvasY-n.offsetY),n.item.ensureStickyPos(r.x,r.y)},E=function(e){return e.data.context.__clearDragScroll()},s.__dragCanvasMouseDown=function(e){var t;return!e.ctrlKey&&!e.metaKey||e.which!==1?!1:(t=this.$el.children(":first-child")[0],$(document).on({"mousemove.dragcanvas":f,"mousedown.dragcanvas":a,"mouseup.dragcanvas":a,"urlroute.dragcanvas":a},{context:this,startX:e.pageX,startY:e.pageY,scrollLeft:t.scrollLeft,scrollTop:t.scrollTop,overlay:$("<div id='overlayer' class='grabbing'></div>").appendTo("body")}),!1)},f=function(e){var t;return t=e.data,t.context.$el.nanoScroller({scrollLeft:t.scrollLeft-e.pageX+t.startX}),t.context.$el.nanoScroller({scrollTop:t.scrollTop-e.pageY+t.startY}),!1},a=function(e){return $(document).off(".dragcanvas"),e.data.overlay.remove(),!1},null})}.call(this),function(){define("workspaces/coreeditor/CanvasViewGResizer",["CanvasView"],function(e){var t,n,r,i,s,o,u,a,f;n=function(){},t=e.prototype,t.__resizeGroupDown=function(e){var t,i,s,a,l,c,h,p,d,v,m,g;i=$(e.currentTarget),t=i.closest("g"),c=this.getItem(t.attr("data-id")),a=i.attr("class").replace("group-resizer ","").split("-"),d=c.rect(),p=c.parent().rect(),c.isTopLevel()||(p.x1+=1,p.y1+=1,p.x2-=1,p.y2-=1),h=a.indexOf("left")>=0,v=a.indexOf("top")>=0,s={pageX:e.pageX,pageY:e.pageY,direction:a,context:this,item:c,$resizer:i,$svgel:t,sideX:h?"x1":"x2",sideY:v?"y1":"y2",move:h||v,originalBound:$.extend({},d),innerBound:r(c,d),target:d,parent:p,siblings:c.siblings().map(function(e){return e.rect()}),overlay:$("<div></div>").appendTo(this.$el).css({position:"absolute",left:"0",top:"0",bottom:"0",right:"0",cursor:i.css("cursor")})};for(m=0,g=a.length;m<g;m++)l=a[m],f(l,s);return $(document).on({"mousemove.resizegroup":o,"mouseup.resizegroup":u},s),n(s),!1},f=function(e,t){var n,r,o,u,a,f,l,c,h,p,d,v,m,g,y;c=t.target,u=e==="left",f=e==="right",h=e==="top",r=e==="down",n=[{x1:t.parent.x2,y1:t.parent.y2,x2:t.parent.x1,y2:t.parent.y1}];if(u||f){o="rangeX",g=t.siblings;for(p=0,v=g.length;p<v;p++){l=g[p];if(l.y1>=c.y2||l.y2<=c.y1)continue;if(u){if(l.x1>c.x1)continue}else if(l.x2<c.x2)continue;n.push(l)}}else{o="rangeY",y=t.siblings;for(d=0,m=y.length;d<m;d++){l=y[d];if(l.x1>=c.x2||l.x2<=c.x1)continue;if(h){if(l.y1>c.y1)continue}else if(l.y2<c.y2)continue;n.push(l)}}u?a=[i(n,"x2")+1,t.innerBound.x1]:f?a=[t.innerBound.x2,s(n,"x1")-1]:h?a=[i(n,"y2")+1,t.innerBound.y1]:a=[t.innerBound.y2,s(n,"y1")-1],t[o]=a},r=function(e,t){var n,r,i,s,o;t={x1:t.x2-10,y1:t.y2-10,x2:t.x1+10,y2:t.y1+10},o=e.children();for(i=0,s=o.length;i<s;i++)r=o[i],n=r.effectiveRect(),t.x1>n.x1&&(t.x1=n.x1),t.y1>n.y1&&(t.y1=n.y1),t.x2<n.x2&&(t.x2=n.x2),t.y2<n.y2&&(t.y2=n.y2);return t.x1-=1,t.y1-=1,t.x2+=1,t.y2+=1,t},s=function(e,t){var n,r,i,s;r=e[0][t];for(i=0,s=e.length;i<s;i++)n=e[i],n[t]<r&&(r=n[t]);return r},i=function(e,t){var n,r,i,s;r=e[0][t];for(i=0,s=e.length;i<s;i++)n=e[i],n[t]>r&&(r=n[t]);return r},o=function(t){var r,i,s,o,u;return i=t.data,u=i.context.__scale,i.rangeX&&(s=i.originalBound[i.sideX]+Math.round((t.pageX-i.pageX)*u/e.GRID_WIDTH),s<i.rangeX[0]?s=i.rangeX[0]:s>i.rangeX[1]&&(s=i.rangeX[1]),s!==i.target[i.sideX]&&(i.target[i.sideX]=s,r=!0,i.rangeY&&(f(i.direction[0],i),n(i)))),i.rangeY&&(o=i.originalBound[i.sideY]+Math.round((t.pageY-i.pageY)*u/e.GRID_HEIGHT),o<i.rangeY[0]?o=i.rangeY[0]:o>i.rangeY[1]&&(o=i.rangeY[1]),o!==i.target[i.sideY]&&(i.target[i.sideY]=o,r=!0,i.rangeX&&(f(i.direction[1],i),n(i)))),r&&a(i),!1},a=function(e){var t,n,r,i;e.move&&(r=e.target.x1,i=e.target.y1),n=e.target.x2-e.target.x1,t=e.target.y2-e.target.y1,e.item.applyGeometry(r,i,n,t)},u=function(e){var t;return t=e.data,t.overlay.remove(),$(document).off(".resizegroup"),!1}})}.call(this),function(){define("workspaces/coreeditor/CanvasViewEffect",["CanvasView","CanvasElement","CanvasManager","constant","i18n!/nls/lang.js"],function(e,t,n,r,i){var s,o,u,a,f,l,c,h,p;s=e.prototype,c=function(e,t){return e[0]<t[0]?-1:e[0]>t[0]?1:e[1]-t[1]},h=function(e,t){return e[1]<t[1]?-1:e[1]>t[1]?1:e[0]-t[0]},f=function(e){var t,n,r,i,s,o,u,a,f,l,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M;y=[],x={};for(N=0,L=e.length;N<L;N++){w=e[N],M=[""+w.x1+","+w.y1,""+w.x2+","+w.y1,""+w.x1+","+w.y2,""+w.x2+","+w.y2];for(C=0,A=M.length;C<A;C++)d=M[C],x[d]?delete x[d]:x[d]=d}for(p in x)d=x[p],d=d.split(","),y.push([parseInt(d[0],10)*10,parseInt(d[1],10)*10]);T={},o={},g=y.length,y.sort(c),f=0;while(f<g){t=y[f][0];while(f<g&&y[f][0]===t)v=y[f],m=y[f+1],r=""+v[0]+","+v[1],i=""+m[0]+","+m[1],T[r]=i,T[i]=r,f+=2}y.sort(h),f=0;while(f<g){t=y[f][1];while(f<g&&y[f][1]===t)v=y[f],m=y[f+1],r=""+v[0]+","+v[1],i=""+m[0]+","+m[1],o[r]=i,o[i]=r,f+=2}S=[],u=_.keys(o);while(u.length>0){a=u[0],s=b=o[a],u.splice(u.indexOf(b),1),E=[b],n=0;for(;;){n===0?(n=1,b=T[b]):(n=0,u.splice(u.indexOf(b),1),b=o[b],u.splice(u.indexOf(b),1)),E.push(b);if(b===s)break}for(l=k=0,O=E.length;k<O;l=++k)b=E[l],b=b.split(","),b[0]=parseInt(b[0],10),b[1]=parseInt(b[1],10),E[l]=b;S.push(E)}return S},a=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d;for(n=c=0,p=e.length;c<p;n=++c){a=e[n],u="";for(r=h=0,d=a.length;h<d;r=++h){o=a[r],r===0?(t="M",i=a[a.length-2]):(t="L",i=a[r-1]),s=a[r+1];if(i&&s){f=0,l=0;if(i[1]===o[1]&&s[0]===o[0]){f=o[0]+(i[0]>o[0]?5:-5),l=o[1]+(s[1]>o[1]?5:-5),u+=""+t+f+" "+o[1]+" Q"+o[0]+" "+o[1]+" "+o[0]+" "+l;continue}if(i[0]===o[0]&&s[1]===o[1]){f=o[0]+(s[0]>o[0]?5:-5),l=o[1]+(i[1]>o[1]?5:-5),u+=""+t+o[0]+" "+l+" Q"+o[0]+" "+o[1]+" "+f+" "+o[1];continue}}}e[n]=u+"Z"}return e.join("")},o=function(e){var t,n,r,i,s,o,u,a,f;s="";for(t=a=0,f=e.length;a<f;t=++a){i=e[t];if(t===0){s="M"+i.x+" "+i.y;continue}n=e[t-1],r=e[t+1];if(n&&r){o=0,u=0;if(n.y===i.y&&r.x===i.x){o=i.x+(n.x>i.x?5:-5),u=i.y+(r.y>i.y?5:-5),s+="L"+o+" "+i.y+" Q"+i.x+" "+i.y+" "+i.x+" "+u;continue}if(n.x===i.x&&r.y===i.y){o=i.x+(r.x>i.x?5:-5),u=i.y+(n.y>i.y?5:-5),s+="L"+i.x+" "+u+" Q"+i.x+" "+i.y+" "+o+" "+i.y;continue}}s+="L"+i.x+" "+i.y}return s},p=function(e,t){return!(e.x1>=t.x2||e.x2<=t.x1||e.y1>=t.y2||e.y2<=t.y1)},u=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,d;f=[],r=[];for(l=0,h=e.length;l<h;l++)s=e[l],s.isGroup()?r.push(s.effectiveRect()):f.push(s.rect());if(!r.length)return f;i=1,t=[r[0]];while(i<r.length){o=i,n=r[i],a=!1;for(c=0,d=t.length;c<d;c++){u=t[c];if(!p(n,u))continue;n.y1<=u.y1&&u.y2<=n.y2?(r.push({x1:n.x1,x2:n.x2,y1:n.y1,y2:u.y1}),r.push({x1:n.x1,x2:n.x2,y1:n.y2,y2:u.y2}),n.x1<=u.x1?r.push({x1:n.x1,x2:u.x1,y1:u.y1,y2:u.y2}):r.push({x1:u.x2,x2:n.x2,y1:u.y1,y2:u.y2})):n.x1<=u.x1&&u.x2<=n.x2?(r.push({x1:n.x1,x2:u.x1,y1:n.y1,y2:n.y2}),r.push({x1:u.x2,x2:n.x2,y1:n.y1,y2:n.y2}),n.y1<=u.y1?r.push({x1:u.x1,x2:u.x2,y1:n.y1,y2:u.y1}):r.push({x1:u.x1,x2:u.x2,y1:u.y2,y2:n.y2})):u.y1<=n.y1&&n.y2<=u.y2?n.x1<=u.x1?r.push({x1:n.x1,x2:u.x1,y1:n.y1,y2:n.y2}):r.push({x1:u.x2,x2:n.x2,y1:n.y1,y2:n.y2}):u.x1<=n.x1&&n.x2<=u.x2?n.y1<=u.y1?r.push({x1:n.x1,x2:n.x2,y1:n.y1,y2:u.y1}):r.push({x1:n.x1,x2:n.x2,y1:u.y2,y2:n.y2}):n.y1<=u.y1?(r.push({x1:n.x1,x2:n.x2,y1:n.y1,y2:u.y1}),n.x1<=u.x1?r.push({x1:n.x1,x2:u.x1,y1:u.y1,y2:n.y2}):r.push({x1:u.x2,x2:n.x2,y1:u.y1,y2:n.y2})):(r.push({x1:n.x1,x2:n.x2,y1:u.y2,y2:n.y2}),n.x1<=u.x1?r.push({x1:n.x1,x2:u.x1,y1:n.y1,y2:u.y2}):r.push({x1:u.x2,x2:n.x2,y1:n.y1,y2:u.y2})),a=!0;break}a||t.push(n),++i}return f.concat(t)},s.hightLightItems=function(e){var t,n,r,i,s,o,l;o=u(e),s=f(o),i=a(s),t=this.size(),l=t[0]*10,r=t[1]*10,n="M0,0L"+l+",0L"+l+","+r+"L0,"+r+"Z",this.__highLightCliper=this.svg.clip().attr("id","hlClipper").add(this.svg.path(n+i).attr("clip-rule","evenodd")),this.__highLightRect=this.svg.rect(0,0).attr({id:"hlArea",width:"100%",height:"100%"}).clipWith(this.__highLightCliper)},s.removeHightLight=function(e){this.__highLightRect&&this.__highLightRect.remove(),this.__highLightCliper&&this.__highLightCliper.remove(),this.__highLightRect=this.__highLightCliper=null},l=function(e){var t,n;n=e.offsetY>e.data.height?"top":"bottom",t=$(e.currentTarget).find(".canvas-message"),t.attr("data-type")!==n&&t.attr("data-type",n)},s.showHintMessage=function(e){var t;t=this.$el.find(".canvas-message").html(e).outerHeight()+20,this.$el.on({"mousemove.canvashint":l},{height:t})},s.hideHintMessage=function(){this.$el.find(".canvas-message").empty(),this.$el.off("mousemove.canvashint")}})}.call(this),function(){define("OpsEditor",["ProgressViewer","Design","ResourceModel","ComplexResModel","ConnectionModel","GroupModel","CoreEditor","CoreEditorView","CanvasManager","CanvasView","CanvasElement","CanvasPopup","CanvasViewLayout","workspaces/coreeditor/CeSvg","workspaces/coreeditor/CanvasViewConnect","workspaces/coreeditor/CanvasViewDnd","workspaces/coreeditor/CanvasViewGResizer","workspaces/coreeditor/CanvasViewEffect","workspaces/coreeditor/TplOpsEditor","workspaces/coreeditor/TplSvgDef"],function(e,t){var n,r;return window.Design=t,r=[],n=function(t){var n,i,s;if(!t)throw new Error("Cannot find opsmodel while openning workspace.");if(t.isProcessing())return new e(t);for(i=0,s=r.length;i<s;i++){n=r[i];if(n.handler(t))return new n.editor(t)}return void 0},n.registerEditors=function(e,t){return r.push({editor:e,handler:t})},n})}.call(this),function(){define("CoreEditorViewApp",["CoreEditorView","OpsModel","workspaces/coreeditor/TplOpsEditor","UI.modalplus","i18n!/nls/lang.js","AppAction"],function(e,t,n,r,i,s){return e.extend({initialize:function(){e.prototype.initialize.apply(this,arguments),this.$el.find(".OEPanelLeft").addClass("force-hidden").empty(),this.toggleProcessing(),this.updateProgress(),this.listenTo(this.workspace.design,"change:mode",this.switchMode)},switchMode:function(e){this.toolbar.updateTbBtns(),this.statusbar.update(),e==="appedit"?(this.$el.find(".OEPanelLeft").removeClass("force-hidden"),this.resourcePanel.render()):this.$el.find(".OEPanelLeft").addClass("force-hidden").empty(),this.propertyPanel.openPanel()},confirmImport:function(){var e,t;t=this,e=new r({title:i.TOOLBAR.APP_IMPORTED,template:n.modal.confirmImport({name:this.workspace.opsModel.get("name")}),confirm:{text:"Done"},disableClose:!0,hideClose:!0,onCancel:function(){t.workspace.remove()},onConfirm:function(){var n,r;n=e.tpl.find("#ImportSaveAppName"),n.parsley("custom",function(e){var n;if(!MC.validate("awsName",e))return i.PARSLEY.SHOULD_BE_A_VALID_STACK_NAME;n=App.model.appList().where({name:e});if(n.length===1&&n[0]===t.workspace.opsModel||n.length===0)return;return sprintf(i.PARSLEY.TYPE_NAME_CONFLICT,"App",e)});if(!n.parsley("validate"))return;return e.tpl.find(".modal-confirm").attr("disabled","disabled"),r=t.workspace.design.serialize(),r.name=n.val(),r.usage=$("#app-usage-selectbox").find(".item.selected").attr("data-value")||"testing",r.resource_diff=$("#MonitorImportApp").is(":checked"),t.workspace.opsModel.saveApp(r).then(function(){var n;return n=t.workspace.design,n.set("name",r.name),n.set("resource_diff",r.resource_diff),n.set("usage",r.usage),$("#OEPanelRight").trigger("REFRESH"),e.close()},function(t){notification("error",t.msg),e.tpl.find(".modal-confirm").removeAttr("disabled")})}})},toggleProcessing:function(){var e,r;if(!this.$el)return;this.toolbar.updateTbBtns(),this.statusbar.update(),this.$el.children(".ops-process").remove(),e=this.workspace.opsModel;if(!e.isProcessing())return;switch(e.get("state")){case t.State.Starting:r=i.IDE.STARTING_YOUR_APP;break;case t.State.Stopping:r=i.IDE.STOPPING_YOUR_APP;break;case t.State.Terminating:r=i.IDE.TERMINATING_YOUR_APP;break;case t.State.Updating:r=i.IDE.APPLYING_CHANGES_TO_YOUR_APP;break;default:void 0,r=i.IDE.PROCESSING_YOUR_REQUEST}this.__progress=0,this.$el.append(n.appProcessing(r))},updateProgress:function(){var e,t,n;t=this.workspace.opsModel.get("progress"),e=this.$el.find(".ops-process"),e.toggleClass("has-progess",!!t),this.__progress>t&&e.toggleClass("rolling-back",!0),this.__progress=t,n=""+t+"%",e.find(".process-info").text(n),e.find(".bar").css({width:n})},showUpdateStatus:function(e,t){var r;this.$el.find(".ops-process").remove(),r=this,$(n.appUpdateStatus({error:e,loading:t})).appendTo(this.$el).find("#processDoneBtn").click(function(){return r.$el.find(".ops-process").remove()})},showUnpayUI:function(){this.statusbar.remove(),this.propertyPanel.remove(),this.toolbar.remove(),this.canvas.updateSize(),s.showPayment($("<div class='ops-apppm-wrapper'></div>").appendTo(this.$el)[0]),notification("error","Your account is limited now.")},listenToPayment:function(){var e;return e=this,this.workspace.listenTo(App.user,"paymentUpdate",function(){if(!$(".ops-apppm-wrapper").size()){if(App.user.shouldPay())return e.showUnpayUI()}else if(!App.user.shouldPay())return e.reopenApp()})},reopenApp:function(){var e,t;return e=this.workspace.opsModel.get("id"),t=this.workspace.index(),this.workspace.remove(),_.defer(function(){return App.openOps(e).setIndex(t),notification("info","User payment status change detected, reloading app resource.")})}})})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("CoreEditorApp",["CoreEditor","CoreEditorViewApp","ResDiff","OpsModel","Design","CloudResources","constant"],function(e,n,r,i,s,o,u){var a;return a=function(e){function u(){return u.__super__.constructor.apply(this,arguments)}return t(u,e),u.prototype.viewClass=n,u.prototype.title=function(){return((this.design||this.opsModel).get("name")||this.opsModel.getMsrId())+" - app"},u.prototype.tabClass=function(){switch(this.opsModel.get("state")){case i.State.Running:return"icon-app-running";case i.State.Stopped:return"icon-app-stopped";default:return"icon-app-pending"}},u.prototype.isReady=function(){return!!this.__hasAdditionalData},u.prototype.isAppEditMode=function(){var e;return(e=this.design)!=null?e.modeIsAppEdit():void 0},u.prototype.isModified=function(){return this.design&&this.design.modeIsAppEdit()&&this.design.isModified()},u.prototype.fetchAdditionalData=function(){var e;return e=Q.defer(),e.resolve(),e.promise},u.prototype.initEditor=function(){if(this.opsModel.isImported()){this.updateTab(),this.view.canvas.autoLayout(),this.view.confirmImport();return}App.user.shouldPay()&&this.opsModel.isPMRestricted()?this.view.showUnpayUI():this.diff(),this.view.listenToPayment()},u.prototype.diff=function(){var e,t,n;if(!this.opsModel.testState(i.State.Running))return;return t=this.opsModel.generateJsonFromRes(),n=this,e=new r({old:this.opsModel.getJsonData(),"new":t,callback:function(r){if(r)return n.applyDiff(t,e.getChangeInfo().needUpdateLayout);n.remove()}}),e.getChangeInfo().hasResChange?(e.render(),!0):!1},u.prototype.applyDiff=function(e,t){var n;try{this.opsModel.__setJsonData(e),this.design.reload(),t&&this.view.canvas.autoLayout()}catch(r){n=r,void 0}return this.opsModel.saveApp(e)},u.prototype.reloadAppData=function(){var e,t;this.view.showUpdateStatus("",!0),e=this,(t=this.loadVpcResource())!=null&&t.then(function(){return e.__onReloadDone()},function(){return e.view.toggleProcessing()})},u.prototype.__onReloadDone=function(){if(this.isRemoved())return;this.view.toggleProcessing(),this.diff()||this.view.canvas.update()},u.prototype.loadVpcResource=function(){return o("OpsResource",this.opsModel.getMsrId()).init(this.opsModel.get("region"),this.opsModel.get("provider")).fetchForce()},u.prototype.switchToEditMode=function(){return this.design.setMode(s.MODE.AppEdit)},u.prototype.cancelEditMode=function(e){var t;return t=e||this.design.isModified(),t&&!e?!1:(this.design.setMode(s.MODE.App),t&&this.design.reload(),!0)},u.prototype.applyAppEdit=function(e,t){var n;if(!e){this.design.setMode(s.MODE.App);return}return this.__applyingUpdate=!0,t=t&&!this.opsModel.testState(i.State.Stopped),n=this,this.view.listenTo(this.opsModel,"change:progress",this.view.updateProgress),this.opsModel.update(e,t).then(function(){return t?n.__onAppEditDidDone():n.__onAppEditDone()},function(e){return n.__onAppEditFail(e)}),!0},u.prototype.__onAppEditFail=function(e){var t;if(this.isRemoved())return;this.__applyingUpdate=!1,this.view.stopListening(this.opsModel,"change:progress",this.view.updateProgress),t=e.msg,e.result&&(t+="\n"+e.result),t=t.replace(/\n/g,"<br />"),this.view.showUpdateStatus(t)},u.prototype.__onAppEditDone=function(){var e,t;if(this.isRemoved())return;e=this,this.view.showUpdateStatus("",!0),(t=this.loadVpcResource())!=null&&t.then(function(){return e.__onAppEditDidDone()})},u.prototype.__onAppEditDidDone=function(){if(this.isRemoved())return;this.__applyingUpdate=!1,this.view.stopListening(this.opsModel,"change:progress",this.view.updateProgress),this.view.showUpdateStatus(),this.design.setMode(s.MODE.App),this.design.reload(),this.saveThumbnail()},u.prototype.onOpsModelStateChanged=function(){var e,t;if(!this.isInited())return;if(this.opsModel.testState(i.State.Saving)||this.opsModel.previous("state")===i.State.Saving)return;this.updateTab(),this.opsModel.isProcessing()?this.view.toggleProcessing():this.opsModel.testState(i.State.Destroyed)?this.remove():this.__applyingUpdate||(e=this,this.view.showUpdateStatus("",!0),(t=this.loadVpcResource())!=null&&t.then(function(){return e.__onVpcResLoaded()}))},u.prototype.__onVpcResLoaded=function(){if(this.isRemoved())return;this.view.canvas.update(),this.view.toggleProcessing()},u}(e),a})}.call(this),function(){define("CanvasLine",["CanvasElement","constant","CanvasManager","i18n!/nls/lang.js"],function(e,t,n,r,i){var s,o,u,a,f,l,c,h;return o=null,l=function(e,t){var n,r,i,s,o;n=Math.PI/180*t,r=Math.cos(n),i=Math.sin(n),e.y=-e.y,s=Math.round(e.x*r-e.y*i),o=Math.round(e.x*i+e.y*r),e.x=s,e.y=-o},f=function(e,t){e.x1-=t.x,e.y1-=t.y,e.x2-=t.x,e.y2-=t.y},c=function(e,t){var n,r;n={x:e.x1,y:e.y1},r={x:e.x2,y:e.y2},l(n,t),l(r,t),e.x1=Math.min(n.x,r.x),e.x2=Math.max(n.x,r.x),e.y1=Math.min(n.y,r.y),e.y2=Math.max(n.y,r.y)},a=function(e){var t;t=e.y1,e.y1=-e.y2,e.y2=-t},h=function(t,n){var r;r=t[2],r===e.constant.PORT_4D_ANGLE&&(Math.abs(n[0]-t[0])-Math.abs(n[1]-t[1])>0?r=e.constant.PORT_2D_H_ANGLE:r=e.constant.PORT_2D_V_ANGLE),r===e.constant.PORT_2D_H_ANGLE?t[2]=n[0]>=t[0]?e.constant.PORT_RIGHT_ANGLE:e.constant.PORT_LEFT_ANGLE:r===e.constant.PORT_2D_V_ANGLE&&(t[2]=n[1]>=t[1]?e.constant.PORT_DOWN_ANGLE:e.constant.PORT_UP_ANGLE)},u=function(e,t){e[2]<0&&h(e,t),t[2]<0&&h(t,e)},s=e.extend({type:"CeLine",node_line:!0,portName:function(e){return this.model.port(e,"name")},render:function(){var e,t,n,r,i,s,o,u,a,f,l;this.$el.remove(),this.$el=$(),r=this.canvas.getItem(this.model.port1Comp().id),i=this.canvas.getItem(this.model.port2Comp().id),n=this.canvas.__popLineInitiator()||r;if(r.$el.length===1&&i.$el.length===1)this.renderConnection(r,i,void 0,void 0,n);else{f=r.$el;for(s=0,u=f.length;s<u;s++){e=f[s],l=i.$el;for(o=0,a=l.length;o<a;o++)t=l[o],this.renderConnection(r,i,e,t,n)}}},update:function(){var e,t,n,r,i,s,o,u,a,f,l,c,h;r=this.canvas.getItem(this.model.port1Comp().id),i=this.canvas.getItem(this.model.port2Comp().id);if(r.$el.length===1&&i.$el.length===1)this.$el.children().attr("d",this.generatePath(r,i,void 0,void 0));else{s=r.$el.length*i.$el.length;if(this.$el.length<s)while(this.$el.length<s)o=this.createLine("M0 0Z"),this.addView(o);else this.$el.length>s&&(this.$el.slice(s).remove(),this.$el=this.$el.slice(0,s));n=0,c=r.$el;for(u=0,f=c.length;u<f;u++){e=c[u],h=i.$el;for(a=0,l=h.length;a<l;a++)t=h[a],this.$el.eq(n).children().attr("d",this.generatePath(r,i,e,t)),++n}}},createLine:function(e){var t,n;return t=this.canvas.svg,n=t.group().add([t.path(e),t.path(e).classes("fill-line")]).attr({"data-id":this.cid}).classes("line "+this.type.replace(/\./g,"-")),this.appendLineToCanvas(n),n},appendLineToCanvas:function(e){return this.canvas.appendLine(e)},renderConnection:function(e,t,n,r,i){var o,u,a,f,l,c;f=this.generatePath(e,t,n,r),c=this.createLine(f),this.addView(c),!this.canvas.initializing&&i&&(l=this.canvas.svg,a=l.path(f),u=parseFloat(a.node.getTotalLength()).toFixed(2),o=(i===e?1:-1)*(this.__lastDir||1),a.style({"stroke-dasharray":u+" "+u,"stroke-dashoffset":u*o}),setTimeout(function(){return a.classes("mask-line")},20),s.cleanLineMask(c.maskWith(a)))},getConnectPorts:function(e,t,n,r){var i,s,o,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O;i=this.model,g=t.pos(r),m=e.pos(n),g.x*=10,m.x*=10,g.y*=10,m.y*=10,l=i.port1("name"),S=i.port2("name"),o=e.portDirection(l),a=t.portDirection(S),y=[l],b=[S],o&&(y=o==="horizontal"?[l+"-right",l+"-left"]:[l+"-top",l+"-bottom"]),a&&(b=a==="horizontal"?[S+"-right",S+"-left"]:[S+"-top",S+"-bottom"]);for(h=x=0,k=y.length;x<k;h=++x)c=y[h],y[h]={name:c,pos:e.portPosition(c,!0).slice(0)},y[h].pos[0]+=m.x,y[h].pos[1]+=m.y;for(h=T=0,L=b.length;T<L;h=++T)c=b[h],b[h]={name:c,pos:t.portPosition(c,!0).slice(0)},b[h].pos[0]+=g.x,b[h].pos[1]+=g.y;f=-1;for(N=0,A=y.length;N<A;N++){c=y[N];for(C=0,O=b.length;C<O;C++){p=b[C],s=Math.pow(c.pos[0]-p.pos[0],2)+Math.pow(c.pos[1]-p.pos[1],2);if(f===-1||f>s)f=s,d=c,v=p}}return E=t.size(),w=e.size(),u(d.pos,v.pos),{start:{x:d.pos[0],y:d.pos[1],angle:d.pos[2],type:i.port1Comp().type,name:d.name,itemCX:m.x+w.width/2*10,itemCY:m.y+w.height/2*10,item:e,closer:e.isPortSignificant(d.name),itemRect:{x1:m.x,x2:m.x+w.width*10,y1:m.y,y2:m.y+w.height*10}},end:{x:v.pos[0],y:v.pos[1],angle:v.pos[2],type:i.port2Comp().type,name:v.name,itemCX:g.x+E.width/2*10,itemCY:g.y+E.height/2*10,item:t,closer:t.isPortSignificant(v.name),itemRect:{x1:g.x,x2:g.x+E.width*10,y1:g.y,y2:g.y+E.height*10}}}},generatePath:function(e,t,n,r){var i,s,o;return s=this.getConnectPorts(e,t,n,r),o=s.start,i=s.end,this.__lastDir=1,this.lineStyle()===0?"M"+o.x+" "+o.y+" L"+i.x+" "+i.y:this.lineStyle()===2||this.lineStyle()===3?this.generateCurvePath(s.start,s.end):o.x===i.x||o.y===i.y?"M"+o.x+" "+o.y+" L"+i.x+" "+i.y:this.generateElbowPath(o,i)},lineStyle:function(){return 4},genericGenerate:function(e,t,n){var r,i,s,o,u,h,p,d,v;i={x:e.x,y:e.y},s=t.angle,e.x=e.y=0,t.x-=i.x,t.y-=i.y,f(e.itemRect,i),f(t.itemRect,i),e.angle!==0&&(l(t,-e.angle),t.angle-=e.angle,t.angle<0&&(t.angle+=360),c(e.itemRect,-e.angle),c(t.itemRect,-e.angle)),r=!1,t.y>0&&(r=!0,t.y=-t.y,t.angle===90?t.angle=270:t.angle===270&&(t.angle=90),a(e.itemRect),a(t.itemRect)),u=n[""+t.angle](e,t),u.push(t);if(r)for(h=0,d=u.length;h<d;h++)o=u[h],o.y=-o.y;for(p=0,v=u.length;p<v;p++)o=u[p],l(o,e.angle),o.x+=i.x,o.y+=i.y;return u.unshift(i),u},generateCurvePath:function(e,t){var n,r;return r=this.genericGenerate(e,t,this.curveAlgorithms),n=r.shift(),r.length===3?"M"+n.x+" "+n.y+"C"+r[0].x+" "+r[0].y+" "+r[1].x+" "+r[1].y+" "+r[2].x+" "+r[2].y:"M"+n.x+" "+n.y+"L"+r[0].x+" "+r[0].y+"C"+r[1].x+" "+r[1].y+" "+r[2].x+" "+r[2].y+" "+r[3].x+" "+r[3].y+"L"+r[4].x+" "+r[4].y},curveAlgorithms:{0:function(e,t){var n,r,i,s,o,u;return o=t.x,u=Math.abs(t.y),r=Math.sqrt(Math.pow(o,2)+Math.pow(u,2))/4,i=Math.PI/180*30,n=r*Math.cos(i),s=r*Math.sin(i),o>0?[{x:n,y:-s},{x:t.x+s,y:t.y+n}]:o===0?[{x:n,y:-s},{x:t.x+n,y:t.y+s}]:[{x:s,y:-n},{x:t.x+n,y:t.y+s}]},90:function(e,t){var n,r,i,s,o,u;return o=t.x,u=Math.abs(t.y),i=Math.sqrt(Math.pow(o,2)+Math.pow(u,2)),s=Math.PI/180*30,i/=o>0?4:2,n=i*Math.cos(s),r=i*Math.sin(s),o>0?[{x:t.x/2,y:0},{x:t.x-n,y:t.y-r}]:[{x:sin,y:-cos},{x:t.x+cos,y:t.y-sin}]},180:function(e,t){var n,r,i,s,o,u;return t.x>0?[{x:t.x/2,y:0},{x:t.x/2,y:t.y}]:(o=t.x,u=Math.abs(t.y),r=Math.sqrt(Math.pow(o,2)+Math.pow(u,2))/3,i=Math.PI/180*40,s=r*Math.sin(i),n=r*Math.cos(i),[{x:s,y:-n},{x:t.x-s,y:t.y+n}])},270:function(e,t){var n,r,i,s,o,u;o=t.x,u=Math.abs(t.y);if(o>0)return Math.abs(o-u)<10?[{x:o,y:0},{x:o,y:t.y}]:o<20?[{x:0,y:0},{x:0,y:0},{x:o,y:0},{x:o,y:-o}]:u<20?[{x:o-u,y:0},{x:o-u,y:0},{x:o,y:0},{x:o,y:t.y}]:o<u?[{x:o,y:0},{x:o,y:t.y/2}]:[{x:o/2,y:0},{x:o,y:0}];return i=Math.sqrt(Math.pow(o,2)+Math.pow(u,2))/4,s=Math.PI/180*30,n=i*Math.cos(s),r=i*Math.sin(s),[{x:n,y:-r},{x:t.x,y:t.y/2}]}},generateElbowPath:function(e,t){var n;return n=this.genericGenerate(e,t,this.elbowAlgorithms),this.getElbowPathFromPoints(n)},elbowAlgorithms:{0:function(e,t){var n;return n=Math.max(e.itemRect.x2,t.itemRect.x2)+20,[{x:n,y:e.y},{x:n,y:t.y}]},90:function(e,t){var n,r;return t.itemRect.x1>0?(n=Math.max(e.itemRect.x2,t.itemRect.x2)+20,e.closer?n=e.itemRect.x2+20:t.closer?n=t.itemRect.x1-20:n=Math.round((t.itemRect.x1-e.itemRect.x2)/2)+e.itemRect.x2):n=Math.max(e.itemRect.x2,t.itemRect.x2)+20,r=t.itemRect.y1-20,[{x:n,y:e.y},{x:n,y:r},{x:t.x,y:r}]},180:function(e,t){var n,r,i;return t.x<=0?(n=e.itemRect.x2+20,i=t.itemRect.y2+20,r=t.itemRect.x1-20,[{x:n,y:e.y},{x:n,y:i},{x:r,y:i},{x:r,y:t.y}]):(e.closer?n=e.itemRect.x2+20:t.closer?n=t.itemRect.x1-20:n=Math.round((t.itemRect.x1-e.itemRect.x2)/2)+e.itemRect.x2,[{x:n,y:e.y},{x:n,y:t.y}])},270:function(e,t){var n,r;return t.x>0?[{x:t.x,y:e.y}]:(n=e.itemRect.x2+20,r=t.itemRect.y2+20,[{x:n,y:e.y},{x:n,y:r},{x:t.x,y:r}])}},generateElbowPathAdv:function(e,t){var n,r,i;return r=this.getElbowPoints(e,t),i=this.getElbowPoints(t,e),i.failure?n=r:r.failure?n=i:n=r.length<i.length?r:i,this.getElbowPathFromPoints(n.result)},getElbowPoints:function(e,t){var n;return n=this.getElbowBounds(e,t),this.getElbowFallback(n),n.result.unshift({x:n.start.x,y:n.start.y}),n.result.unshift({x:e.x,y:e.y}),n.result.push({x:n.end.x,y:n.end.y}),n.result.push({x:t.x,y:t.y}),this.optimizeElbowPoints(n),n},getElbowFallback:function(t){var n,r;r=t.start,n=t.end,t.start.angle===e.constant.PORT_UP_ANGLE||t.start.angle===e.constant.PORT_DOWN_ANGLE?t.result=[{x:r.x,y:t.preferY},{x:t.preferX,y:t.preferY}]:t.result=[{y:r.y,x:t.preferX},{y:t.preferY,x:t.preferX}]},getNextElbowTarget:function(t){var n,r,i,s,o,u,a;if(t.current.x===t.end.x&&t.current.y===t.end.y){t.done=!0;return}r=t.areas[t.areas.length-1];if(r.x1<=(u=t.current.x)&&u<=r.x2&&r.y1<=(a=t.current.y)&&a<=r.y2){t.done=!0,t.inFinalArea=!0;return}t.target.x=t.current.x,t.target.y=t.current.y,t.start.angle===e.constant.PORT_RIGHT_ANGLE||t.start.angle===e.constant.PORT_LEFT_ANGLE?(t.start.angle===e.constant.PORT_RIGHT_ANGLE?(i=t.current.x,s=t.preferX):(i=t.preferX,s=t.current.x),i<s?t.target.x=t.preferX:t.current.y!==t.end.y?t.target.y=t.end.y:t.target.x=t.end.x):(t.start.angle===e.constant.PORT_DOWN_ANGLE?(o=t.current.y,n=t.preferY):(o=t.preferY,n=t.current.y),o<n?t.target.y=t.preferY:t.current.x!==t.end.x?t.target.x=t.end.x:t.target.y=t.end.y)},proceedElbowTarget:function(t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B;v=$.extend({},t.target),s=t.current,M=t.areas;for(a=N=0,L=M.length;N<L;a=++N){w=M[a];if(n&&n.depth<w.depth)continue;E=w.x1<s.x&&s.x<w.x2,x=w.y1<s.y&&s.y<w.y2,S=w.x1===s.x||w.x2===s.x,T=w.y1===s.y||w.y2===s.y;if(E&&x||w.endParent&&(E&&T||x&&S))n=w,d=t.areas[a+1]}d&&(d.endParent?d.x1<(_=v.x)&&_<d.x2&&d.y1<(D=v.y)&&D<d.y2&&(s.x>d.x2?v.x=d.x2:s.x<d.x1?v.x=d.x1:s.y>d.y2?v.y=d.y2:s.y<d.y1&&(v.y=d.y1)):n.x1<(P=v.x)&&P<n.x2&&n.y1<(H=v.y)&&H<n.y2||(v.x>n.x2?v.x=n.x2:v.x<n.x1?v.x=n.x1:v.y>n.y2?v.y=n.y2:v.y<n.y1&&(v.y=n.y1))),i=[],v.x<s.x?(f=v.x,l=s.x):(f=s.x,l=v.x),v.y<s.y?(c=v.y,h=s.y):(c=s.y,h=v.y),B=n.children;for(C=0,A=B.length;C<A;C++)r=B[C],r.x1>=l||r.x2<=f||r.y1>=h||r.y2<=c||i.push(r);s.x>v.x?o=e.constant.PORT_LEFT_ANGLE:s.x<v.x?o=e.constant.PORT_RIGHT_ANGLE:s.y>v.y?o=e.constant.PORT_UP_ANGLE:o=e.constant.PORT_DOWN_ANGLE,p=-1,m=null;for(k=0,O=i.length;k<O;k++){r=i[k],o===e.constant.PORT_LEFT_ANGLE||o===e.constant.PORT_RIGHT_ANGLE?u=Math.abs(r.x1-s.x):u=Math.abs(r.y1-s.y);if(u<p||p===-1)m=r,p=u}if(!m){t.addResult(v.x,v.y,n),t.current.x=v.x,t.current.y=v.y;return}o===e.constant.PORT_UP_ANGLE||o===e.constant.PORT_DOWN_ANGLE?(o===e.constant.PORT_UP_ANGLE?(b=m.y2,g=m.y1):(b=m.y1,g=m.y2),t.addResult(t.current.x,b,n),m.x2<t.end.x?y=m.x2:m.x1>t.end.x?y=m.x1:m.x2-t.current.x<=t.current.x-m.x1?y=m.x2:y=m.x1,t.addResult(y,b,n),Math.abs(g-b)>Math.abs(t.preferY-b)?t.addResult(y,t.preferY,n):t.addResult(y,g,n)):(o===e.constant.PORT_LEFT_ANGLE?(y=m.x2,g=m.x1):(y=m.x1,g=m.x2),t.addResult(y,t.current.y,n),m.y2<t.end.y?b=m.y2:m.y1>t.end.y?b=m.y1:m.y2-t.current.y<=t.current.y-m.y1?b=m.y2:b=m.y1,t.addResult(y,b,n),Math.abs(g-y)>Math.abs(t.preferX-y)?t.addResult(t.preferX,b,n):t.addResult(g,b,n)),t.current=$.extend({},t.result[t.result.length-1])},proceedElbowLastArea:function(t){var n,r,i,s,o,u,a,f,l;r=t.end,i=t.areas[t.areas.length-1],a=t.target,f=a.x,l=a.y,n=t.result[t.result.length-1],r.angle===e.constant.PORT_UP_ANGLE||r.angle===e.constant.PORT_DOWN_ANGLE?(Math.abs(r.y-i.y1)<Math.abs(r.y-i.y2)?(l=i.y1,u=i.y2):(l=i.y2,u=i.y1),n.y===u?(Math.abs(n.x-i.x1)<Math.abs(n.x-i.x2)?s=i.x1:s=i.x2,t.addResult(s,n.y,i),t.addResult(s,l,i)):t.addResult(n.x,l,i),t.addResult(f,l,i),t.addResult(t.end.x,l,i)):(Math.abs(r.x-i.x1)<Math.abs(r.x-i.x2)?(f=i.x1,u=i.x2):(f=i.x2,u=i.x1),n.x===u?(Math.abs(n.y-i.y1)<Math.abs(n.y-i.y2)?o=i.y1:o=i.y2,t.addResult(n.x,o,i),t.addResult(f,o,i)):t.addResult(f,n.y,i),t.addResult(f,l,i),t.addResult(f,t.end.y,i))},optimizeElbowPoints:function(e){var t,n,r,i,s;n=[],t=0;while(t<e.result.length){r=e.result[t],i=e.result[t+1],s=e.result[t+2];if(i&&i.y===r.y&&r.x===i.x){t+=1;continue}n.push(r);if(i&&s)if(i.x===s.x&&r.x===i.x||i.y===s.y&&r.y===i.y){t+=2;continue}++t}e.result=n},getElbowPathFromPoints:function(e){var t,n,r,i,s,o,u,a,f;s="";for(t=a=0,f=e.length;a<f;t=++a){i=e[t];if(t===0){s="M"+i.x+" "+i.y;continue}n=e[t-1],r=e[t+1];if(n&&r){o=0,u=0;if(n.y===i.y&&r.x===i.x){o=i.x+(n.x>i.x?5:-5),u=i.y+(r.y>i.y?5:-5),s+="L"+o+" "+i.y+" Q"+i.x+" "+i.y+" "+i.x+" "+u;continue}if(n.x===i.x&&r.y===i.y){o=i.x+(r.x>i.x?5:-5),u=i.y+(n.y>i.y?5:-5),s+="L"+i.x+" "+u+" Q"+i.x+" "+i.y+" "+o+" "+i.y;continue}}s+="L"+i.x+" "+i.y}return s},__fixElbowEndpoint:function(t,n){var r,i;i=$.extend({},t);if(t.angle===e.constant.PORT_2D_H_ANGLE||t.angle===e.constant.PORT_4D_ANGLE)t.x>=n.x?i.angle=e.constant.PORT_LEFT_ANGLE:i.angle=e.constant.PORT_RIGHT_ANGLE;t.angle===e.constant.PORT_2D_V_ANGLE&&(t.y>=n.y?i.angle=e.constant.PORT_UP_ANGLE:i.pointangle=e.constant.PORT_DOWN_ANGLE);if(i.angle===e.constant.PORT_LEFT_ANGLE&&i.x<n.x||i.angle===e.constant.PORT_RIGHT_ANGLE&&i.x>n.x)r=n.y>=i.y?e.constant.PORT_DOWN_ANGLE:e.constant.PORT_UP_ANGLE;else if(i.angle===e.constant.PORT_UP_ANGLE&&i.y<n.y||i.angle===e.constant.PORT_DOWN_ANGLE&&i.y>n.y)r=n.x>=i.x?e.constant.PORT_RIGHT_ANGLE:e.constant.PORT_LEFT_ANGLE;if(r){switch(i.angle){case e.constant.PORT_LEFT_ANGLE:i.x=Math.floor((i.x-1)/5)*5;break;case e.constant.PORT_RIGHT_ANGLE:i.x=Math.ceil((i.x+1)/10)*10;break;case e.constant.PORT_UP_ANGLE:i.y=Math.floor((i.y-1)/10)*10;break;case e.constant.PORT_DOWN_ANGLE:i.y=Math.ceil((i.y+1)/10)*10}i.angle=r}return i},__ensurePointInParent:function(e,t){return e.x=Math.max(e.x,t.x1*10),e.x=Math.min(e.x,t.x2*10),e.y=Math.max(e.y,t.y1*10),e.y=Math.min(e.y,t.y2*10),e},getElbowBounds:function(t,n){var r,i,s,o,u,a,f,l,c,h,p,d;s=this.__fixElbowEndpoint(t,n),i=this.__fixElbowEndpoint(n,t),r={};if((s.angle+i.angle)%180===0){t.item.sticky?o=t:n.item.sticky&&(o=n);if(s.angle===e.constant.PORT_UP_ANGLE||s.angle===e.constant.PORT_DOWN_ANGLE){r.preferX=i.x;if(o)r.preferY=o.y+(o.angle===e.constant.PORT_UP_ANGLE?-10:10);else{r.preferY=Math.round((s.y+i.y)/20)*10;if(t.itemRect.y1<(c=r.preferY)&&c<t.itemRect.y2||n.itemRect.y1<(h=r.preferY)&&h<n.itemRect.y2)f=Math.min(t.itemRect.y1,n.itemRect.y1),l=Math.max(t.itemRect.y2,n.itemRect.y2),Math.abs(f-s.y)+Math.abs(f-i.y)<Math.abs(l-s.y)+Math.abs(l-i.y)?r.preferY=f-5:r.preferY=l+5,s.angle=s.y<=r.preferY?e.constant.PORT_DOWN_ANGLE:e.constant.PORT_UP_ANGLE,i.angle=i.y<=r.preferY?e.constant.PORT_DOWN_ANGLE:e.constant.PORT_UP_ANGLE}}else{r.preferY=i.y;if(o)r.preferX=o.x+(o.angle===e.constant.PORT_LEFT_ANGLE?-10:10);else{r.preferX=Math.round((s.x+i.x)/20)*10;if(t.itemRect.x1<(p=r.preferX)&&p<t.itemRect.x2||n.itemRect.x1<(d=r.preferX)&&d<n.itemRect.x2)u=Math.min(t.itemRect.x1,n.itemRect.x1),a=Math.max(t.itemRect.x2,n.itemRect.x2),Math.abs(u-s.x)+Math.abs(u-i.x)<Math.abs(a-s.x)+Math.abs(a-i.x)?r.preferX=u-5:r.preferX=a+5,s.angle=s.x<=r.preferX?e.constant.PORT_RIGHT_ANGLE:e.constant.PORT_LEFT_ANGLE,i.angle=i.x<=r.preferX?e.constant.PORT_RIGHT_ANGLE:e.constant.PORT_LEFT_ANGLE}}}else s.angle===e.constant.PORT_UP_ANGLE||s.angle===e.constant.PORT_DOWN_ANGLE?(r.preferX=s.x,r.preferY=i.y):(r.preferX=i.x,r.preferY=s.y);return r.x1=Math.min(s.x,i.x),r.x2=Math.max(s.x,i.x),r.y1=Math.min(s.y,i.y),r.y2=Math.max(s.y,i.y),r.start=this.__ensurePointInParent(s,t.item.parent().rect()),r.end=this.__ensurePointInParent(i,n.item.parent().rect()),r},__getElbowChildRect:function(e){var t,n,r,i,s,o;n=[],o=e.children();for(i=0,s=o.length;i<s;i++)t=o[i],r=t.rect(),r.item=t,r.x1*=10,r.y1*=10,r.x2*=10,r.y2*=10,t.isGroup()&&(r.x1-=5,r.y1-=5,r.x2+=5,r.y2+=5),n.push(r);return n},__getElbowParentRect:function(e,t,n){var r,i;return i=e.rect(),i.item=e,r=e.isGroup()?5:0,i.x1=i.x1*10-r,i.y1=i.y1*10-r,i.x2=i.x2*10+r,i.y2=i.y2*10+r,i.children=this.__getElbowChildRect(e),i.depth=t,i.endParent=n,i},getElbowAreas:function(e,t){var n,r,i,s,o,u,a;s=e.item,o=t.item,a=[];while(o)a.push(o),o=o.parent();n=[],r=0;while(s){++r,u=a.indexOf(s);if(u!==-1){i=!1;while(u>=0)n.push(this.__getElbowParentRect(a[u],r,i)),i=!0,--u,--r;break}n.push(this.__getElbowParentRect(s,r)),s=s.parent()}return n}},{cleanLineMask:function(e){return o?o.push(e):(o=[e],setTimeout(function(){return s.__cleanLineMask()},340))},__cleanLineMask:function(){var e,t,n;for(t=0,n=o.length;t<n;t++)e=o[t],e.masker&&e.masker.remove();o=null},connect:function(e,t,n){return new e(t,n,void 0,{createByUser:!0})}}),s})}.call(this),define("workspaces/coreeditor/CoreEditorBundle",function(){});