(function(){define(["i18n!nls/lang.js","aws_model","ami_model","event","constant","forge_handle","UI.notification","backbone","jquery","underscore"],function(e,t,n,r,i,s){var o,u;return o=Backbone.Model.extend({defaults:{flag_list:null,current_tab_id:null,timeout_obj:{}},initialize:function(){var t;return t=this,t.set("flag_list",{is_pending:!0}),this.on("AWS_RESOURCE_RETURN",function(t){var n,s,o,u;void 0;if(t&&!t.is_error&&t.resolved_data&&t.resolved_data.length>0)return u=t.param[4][i.AWS_RESOURCE_TYPE.AWS_VPC_VPC].id[0],o=MC.common.other.setCacheMap(u,t,null,null),n=MC.forge.app.getAmis(t.resolved_data[0]),_.isEmpty(n)?this.setCacheMapDataFlg(o):(this.set("current_tab_id",o.id),this.getDescribeImages(t.param[3],n)),null;if(t)return u=t.param[4][i.AWS_RESOURCE_TYPE.AWS_VPC_VPC].id[0],o=MC.common.other.setCacheMap(u,null,"ERROR",null,null),!t.is_error&&_.isEmpty(t.resolved_data)?(MC.common.other.delUnmanaged(u),s=e.ide.NOTIFY_MSG_WARN_VPC_DOES_NOT_EXIST):t.is_error&&(s=t.error_message),o=MC.common.other.searchCacheMap({key:"origin_id",value:u}),o&&o.id&&r.trigger(r.CLOSE_DESIGN_TAB,o.id),notification("error",s,!1),null}),this.on("EC2_AMI_DESC_IMAGES_RETURN",function(e){var t,n,r,i,s,o,u;void 0;if(e&&!e.is_error){if(e.resolved_data&&e.resolved_data.length>0){n={DescribeImages:[]},u=e.resolved_data;for(s=0,o=u.length;s<o;s++)t=u[s],n.DescribeImages.push(t);MC.aws.aws.cacheResource(n,e.param[3],!1)}return r=e.param[0].src.sender.get("current_tab_id"),void 0,i=MC.common.other.getCacheMap(r),this.setCacheMapDataFlg(i),null}}),setInterval(function(){var e,n,r;if(MC.common.other.processType(MC.data.current_tab_id)!=="appview")return;e=MC.common.other.getCacheMap(MC.data.current_tab_id);if(!e)return;if(e.create_time==="overtime"||e.state==="FINISH")return;n=e.origin_time,r=new Date,MC.timestamp(n,r,"s")>10&&(MC.common.other.setCacheMap(e.origin_id,null,null,null,"timeout"),t.set("timeout_obj",{id:e.id,timeout:!0,overtime:!1}));if(MC.timestamp(n,r,"m")>10)return MC.common.other.setCacheMap(e.origin_id,null,null,null,"overtime"),t.set("timeout_obj",{id:e.id,timeout:!0,overtime:!0})},1e3)},getProcess:function(e){var t,n,i;return i=this,MC.process[e]&&(t=MC.process[e].flag_list,void 0,void 0,n=i.get("flag_list"),i.set("flag_list",t),"is_done"in t&&t.is_done?($("#progress_bar").css("width","100%"),$("#progress_num").text(n.steps),$("#progress_total").text(n.steps),r.trigger(r.SWITCH_WAITING_BAR),setTimeout(function(){var n,i,s;n=t.app_id,s=MC.process[e].region,i=MC.process[e].name;if(MC.data.current_tab_id!=="process-"+s+"-"+i)return;return setTimeout(function(){return r.trigger(r.UPDATE_DESIGN_TAB,n,i+" - app"),r.trigger(r.OPEN_DESIGN_TAB,"RELOAD_APP",i,s,n),r.trigger(r.UPDATE_APP_LIST,"RUN_STACK",[n])},800)},1e3)):"is_inprocess"in t&&t.is_inprocess?(t.dones>0&&"steps"in t&&t.steps>0?($("#progress_bar").css("width",Math.round(t.dones/t.steps*100)+"%"),$("#progress_num").text(t.dones)):($("#progress_bar").css("width","0"),$("#progress_num").text("0")),$("#progress_total").text(t.steps)):i.set("flag_list",t)),null},getTimestamp:function(e,t){var n;return void 0,e==="OPEN_PROCESS"?this.set("timeout_obj",{id:t,timeout:!1,overtime:!1}):e==="OLD_PROCESS"&&(n=MC.common.other.getCacheMap(t),n&&n.create_time==="timeout"&&this.set("timeout_obj",{id:t,timeout:!0,overtime:!1}),n&&n.create_time==="overtime"?this.set("timeout_obj",{id:t,timeout:!0,overtime:!0}):n&&n.create_time!==["timeout","overtime"]&&this.set("timeout_obj",{id:t,timeout:!1,overtime:!1})),null},getVpcResourceService:function(e,n,i){var s,o;return void 0,i==="OPEN_PROCESS"?(o=MC.common.other.getUnmanagedVpc(n),o&&o.origin&&delete o.origin,MC.session.remove("aws_resource_"+e),t.resource({sender:this},$.cookie("usercode"),$.cookie("session_id"),e,o,"vpc",1),MC.common.other.setCacheMap(n,null,"OLD",null)):i==="OLD_PROCESS"&&(s=MC.common.other.searchCacheMap({key:"origin_id",value:n}),s&&s.data&&s.state==="FINISH"?this.reloadAppView(s):s&&s.id?r.trigger(r.UPDATE_DESIGN_TAB_ICON,"visualization",s.id):void 0),null},getDescribeImages:function(e,t){var r;return void 0,r=$.extend(!0,{},this),n.DescribeImages({sender:r},$.cookie("usercode"),$.cookie("session_id"),e,t),null},setCacheMapDataFlg:function(e){var t;return void 0,t=MC.common.other.setCacheMap(e.origin_id,null,"FINISH",null),MC.common.other.isCurrentTab(t.id)&&this.reloadAppView(t),null},reloadAppView:function(e){var t;return void 0,MC.common.other.setCacheMap(e.origin_id,null,null,"appview"),t="appview-"+e.uid,r.trigger(r.UPDATE_DESIGN_TAB,t,e.origin_id+" - visualization"),r.trigger(r.OPEN_DESIGN_TAB,"RELOAD_APPVIEW",e.origin_id,e.region,t),null}}),u=new o,u})}).call(this);