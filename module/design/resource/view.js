(function(){define(["event","constant","./template","./template_data","i18n!nls/lang.js","snapshotManager","sslcert_manage","dhcp","sns_manage","kp_manage","backbone","jquery","handlebars","UI.selectbox","UI.radiobuttons","UI.modal","UI.table"],function(e,t,n,r,i,s,o,u,a,f){var l,c,h,p;return l=Backbone.View.extend({el:$("#resource-panel"),my_ami_tmpl:r.my_ami_tmpl,favorite_ami_tmpl:r.favorite_ami_tmpl,community_ami_tmpl:r.community_ami_tmpl,resource_vpc_tmpl:r.resource_vpc_tmpl,initialize:function(){return $(document).on("click","#hide-resource-panel",this.toggleResourcePanel).on("OPTION_CHANGE","#resource-select",this,this.resourceSelectEvent).on("click","#btn-browse-community-ami",this,this.openBrowseCommunityAMIsModal).on("click","#btn-snapshot-manager",this,this.openSnapshotManager).on("click","#btn-search-ami",this,this.searchCommunityAmiCurrent).on("click","#community_ami_page_preview",this,this.searchCommunityAmiPreview).on("click","#community_ami_page_next",this,this.searchCommunityAmiNext).on("click","#community_ami_table .toggle-fav",this,this.toggleFav).on("click",".favorite-ami-list .faved",this,this.removeFav).on("click",".favorite-ami-list .btn-fav-ami.deleted",this,this.addFav).on("keypress","#community-ami-input",this,this.searchCommunityAmiCurrent).on("click",".resources-dropdown-wrapper li",this,this.resourcesMenuClick).on("click",".refresh-resource-panel",this,$.proxy(this.refreshResourcePanel,this)),$(window).on("resize",_.bind(this.resizeAccordion,this)),$("#tab-content-design").on("click",".fixedaccordion-head",this.updateAccordion)},render:function(){return void 0,$("#resource-panel").html(n()),$(".resoruce-snapshot").html(r.resoruce_snapshot_new_data({})),e.trigger(e.DESIGN_SUB_COMPLETE),this.recalcAccordion(),null},reRender:function(){return void 0,$.trim(this.$el.html())==="loading..."&&$("#resource-panel").html(n()),this.recalcAccordion()},updateAccordion:function(e,t){var n,r,i,s,o,u,a,f;return u=$(e.currentTarget),n=u.closest(".accordion-group"),n.hasClass("expanded")?!1:(o=n.siblings(".expanded"),s=n.children(".accordion-body"),i=n.closest(".fixedaccordion"),r=i.parent(),a=i.children().filter(function(){return $(this).css("display")!=="none"}),f=r.outerHeight()-39-a.length*u.outerHeight(),s.outerHeight(f),t?(n.addClass("expanded"),o.removeClass("expanded"),!1):(s.slideDown(200,function(){return n.addClass("expanded")}),o.children(".accordion-body").slideUp(200,function(){return o.closest(".accordion-group").removeClass("expanded")}),!1))},recalcAccordion:function(){var e,t,n;t=$("#resource-panel").children(".fixedaccordion").children(),e=t.filter(".expanded"),e.length===0&&(e=t.filter(function(){return $(this).css("display")!=="none"}));if(e.length===0)return;return n=e.removeClass("expanded").children(".fixedaccordion-head"),this.updateAccordion({currentTarget:n[0]},!0)},resizeAccordion:function(){var e;return this.__resizeAccdTO&&clearTimeout(this.__resizeAccdTO),e=this,this.__resizeAccdTO=setTimeout(function(){return e.recalcAccordion()},150),null},listen:function(t){return this.model=t,this.listenTo(this.model,"change:availability_zone",this.availabilityZoneRender),this.listenTo(this.model,"change:resource_snapshot",this.resourceSnapshotRender),this.listenTo(this.model,"change:quickstart_ami",this.quickstartAmiRender),this.listenTo(this.model,"change:my_ami",this.myAmiRender),this.listenTo(this.model,"change:favorite_ami",this.favoriteAmiRender),this.listenTo(this.model,"change:community_ami",this.communityAmiRender),this.listenTo(e,"SWITCH_TAB",this.hideResourcePanel)},resourceSelectEvent:function(e,t){return void 0,t==="favorite-ami"?($(".favorite-ami-list").show(),$(".quickstart-ami-list").hide(),$(".my-ami-list").hide()):t==="my-ami"?($(".my-ami-list").show(),$(".favorite-ami-list").hide(),$(".quickstart-ami-list").hide()):t==="quickstart-ami"&&($(".quickstart-ami-list").show(),$(".favorite-ami-list").hide(),$(".my-ami-list").hide()),$(this).siblings(".fixedaccordion-head").click(),null},toggleFav:function(e){var t,n;return n=e.data,t=$(this),t.hasClass("faved")?(n.trigger("TOGGLE_FAV",n.region,"remove",t.data("id")),t.removeClass("faved").data("tooltip","Add to Favorite")):(n.trigger("TOGGLE_FAV",n.region,"add",t.data("id")),t.addClass("faved").data("tooltip","Remove from Favorite")),t.trigger("mouseleave",e),t.trigger("mouseenter",e)},addFav:function(e){var t,n,r,i;return r=e.data,i=$(e.currentTarget),n=i.data("id"),t=i.data("amivo"),r.trigger("TOGGLE_FAV",r.region,"add",n,t,!0)},removeFav:function(e){var t,n,r;return n=e.data,r=$(e.currentTarget),t=r.data("id"),n.trigger("TOGGLE_FAV",n.region,"remove",t)},toggleResourcePanel:function(){return void 0,$("#resource-panel").toggleClass("hidden"),$("#hide-resource-panel").toggleClass("icon-caret-left"),$("#hide-resource-panel").toggleClass("icon-caret-right"),null},hideResourcePanel:function(e){var t,n,r;void 0,this.recalcAccordion(),n=$("#hide-resource-panel"),r=$("#resource-panel"),t=$("#canvas-panel");if(e.split("_")[1]==="STACK"||Tabbar.current==="appedit"||e==="show")n.show(),r.show(),n.hasClass("icon-caret-left")&&r.removeClass("hidden"),n.hasClass("icon-caret-right")&&r.addClass("hidden"),e==="show"&&n.hasClass("icon-caret-right")&&r.hasClass("hidden")&&n.trigger("click");else if(e.split("_")[1]==="APP"||e==="hide")n.hide(),r.hide(),n.removeClass("icon-caret-left"),n.addClass("icon-caret-right"),r.addClass("hidden");return null},availabilityZoneRender:function(){void 0,void 0;if(!this.model.attributes.availability_zone)return;return $(".availability-zone").html(r.availability_zone_data(this.model.attributes)),null},openSnapshotManager:function(){return this.snapshotManager||(this.snapshotManager=new s),this.snapshotManager.off("datachange",this.refreshSnapshotRender),this.snapshotManager.on("datachange",this.refreshSnapshotRender),this.snapshotManager.render()},refreshSnapshotRender:function(){return void 0,this.resourceSnapshotRender()},resourceSnapshotRender:function(){void 0,void 0;if(!this.model.attributes.resource_snapshot)return;return $(".resoruce-snapshot").html(r.resoruce_snapshot_new_data({})),$(".resoruce-snapshot").append(r.resoruce_snapshot_data(this.model.attributes)),null},quickstartAmiRender:function(){void 0,void 0;if(!this.model.attributes.quickstart_ami){$(".quickstart-ami-list").html("");return}return $(".quickstart-ami-list").html(r.quickstart_ami_data(this.model.attributes)),null},myAmiRender:function(){void 0,void 0;if(!this.model.attributes.my_ami||_.isNumber(this.model.attributes.my_ami)){$(".my-ami-list").html("");return}return $(".my-ami-list").html(r.my_ami_data(this.model.attributes)),null},favoriteAmiRender:function(){void 0,void 0;if(!this.model.attributes.favorite_ami)return;return $(".favorite-ami-list").html(r.favorite_ami_data(this.model.attributes)),null},communityAmiBtnRender:function(){return void 0,void 0,$(".community-ami").html(r.community_ami_btn(this)),null},openBrowseCommunityAMIsModal:function(e){var t;return void 0,t=e.data,require(["component/amis/main"],function(e){return e.loadModule(),t.searchCommunityAmi()})},communityShowLoading:function(){return $("#ami-table-wrap .scroll-content").hide(),$(".show-loading").show(),$("#btn-search-ami").text(i.ide.AMI_LBL_SEARCHING).attr("disabled",""),$("#community-ami-page>div").hide(),$("#ami-count").empty().html("Total: 0")},communityShowContent:function(){return $(".show-loading").hide(),$("#ami-table-wrap .scroll-content").show(),$("#btn-search-ami").text(i.ide.AMI_LBL_SEARCH).removeAttr("disabled"),$("#community-ami-page>div").show()},communityPagerRender:function(e,t,n){var r,s,o,u,a;return a=this,o=n>50?50:n,r=(e-1)*50+1,s=r+o-1,s>n&&(s=n),$(".page-tip").text(sprintf(i.ide.AMI_LBL_PAGEINFO,r,s,n)),u=$(".pagination"),t===0?u.hide():u.show(),u.data("jqPagination")&&(u.jqPagination("destroy"),u.find("input").data("current-page",e)),u.jqPagination({current_page:e,max_page:t,page_string:"{current_page} / {max_page}",paged:function(e,t){return function(n){if(n!==e&&t>=n&&n>0)return a.searchCommunityAmi(n)}}(e,t)})},communityAmiRender:function(){var e,t,n,r,s;this.communityShowContent(),r=0;if(this.model.attributes.community_ami)return n="",_.map(this.model.attributes.community_ami.result,function(e,t){var r,s,o,u;return e["delete"]&&(e.favorite=!1),s=e.favorite?"faved":"",o=e.favorite?i.ide.RES_TIT_REMOVE_FROM_FAVORITE:i.ide.RES_TIT_ADD_TO_FAVORITE,r=e.architecture==="i386"?"32":"64",u=e.isPublic?"public":"private",n+='<tr class="item" data-id="'+t+" "+e.name+'" data-publicprivate="public" data-platform="'+e.osType+'" data-ebs="'+e.rootDeviceType+'" data-bit="'+r+'">',n+='<td class="ami-table-fav"><div class="toggle-fav tooltip '+s+'" data-tooltip="'+o+'" data-id="'+t+'"></div></td>',n+='<td class="ami-table-id">'+t+"</td>",n+='<td class="ami-table-info"><span class="ami-table-name">'+e.name+'</span><div class="ami-meta"><i class="icon-'+e.osType+' icon-ami-os"></i><span>'+u+" | "+e.architecture+" | "+e.rootDeviceType+"</span></div></td>",n+="<td class='ami-table-size'>"+e.imageSize+"</td></tr>"}),e=this.model.attributes.community_ami.curPageNum,t="<div>page "+e+"</div>",r=this.model.attributes.community_ami.totalNum,s=this.model.attributes.community_ami.totalPageNum,$("#ami-count").empty().html("Total: "+r),this.communityPagerRender(e,s,r),$("#community_ami_table").empty().html(n)},resourceVpcRender:function(e,t){var n,i;return i={},t!=="NEW_STACK"&&(i.igwIsUsed=this.model.getIgwStatus(),i.vgwIsUsed=this.model.getVgwStatus()),n=$(".resource-vpc-list").html(r.resource_vpc_select_list(i)),n.toggle(n.children().length>0)},searchCommunityAmi:function(e){var t,n,r,i,s,o,u;return r=this,e||(e=1),r.communityShowLoading(),i=$("#community-ami-input").val(),s=$("#selectbox-ami-platform").find(".selected").data("id"),n="true",t="32-bit",o="EBS",$("#filter-ami-type").find(".active").length===1?(u=radiobuttons.data($("#filter-ami-type")),n=u==="Private"?"false":"true"):$("#filter-ami-type").find(".active").length===2&&(n=null),$("#filter-ami-32bit-64bit").find(".active").length===1?t=radiobuttons.data($("#filter-ami-32bit-64bit")):$("#filter-ami-32bit-64bit").find(".active").length===2&&(t=null),$("#filter-ami-EBS-Instance").find(".active").length===1?o=radiobuttons.data($("#filter-ami-EBS-Instance")):$("#filter-ami-EBS-Instance").find(".active").length===2&&(o=null),r.trigger("LOADING_COMMUNITY_AMI",MC.common.other.canvasData.get("region"),i,s,n,t,o,null,e)},searchCommunityAmiCurrent:function(e){var t;if(e.keyCode&&e.keyCode!==13)return;return t=e.data,e.data.searchCommunityAmi(0)},searchCommunityAmiNext:function(e){var t,n;return n=e.data,t=parseInt($("#community_ami_page_current").attr("page"),10),n.searchCommunityAmi(t+1)},searchCommunityAmiPreview:function(e){var t,n;return n=e.data,t=parseInt($("#community_ami_page_current").attr("page"),10),n.searchCommunityAmi(t-1)},enableItem:function(e,t){return this.toggleItem(e,t,!0),null},disableItem:function(e,t){return this.toggleItem(e,t,!1),null},toggleItem:function(e,t,n){return $(".resource-item[data-type='"+e+"']").each(function(r,i){var s,o,u;s=$(i),o=s.data();if(t&&!t.call(s,o))return;s.data("enable",n).attr("data-enable",n).toggleClass("resource-disabled",!n);if(!n)return u=c[e],u?s.data("tooltip",u).toggleClass("tooltip",!0):s.toggleClass("tooltip",!1);u=h[e],s.toggleClass("tooltip",!0);if(u)return s.data("tooltip",u)}),null},resourcesMenuClick:function(e){var t,n;t=$(e.currentTarget),n=t.data("action");switch(n){case"keypair":return(new f).render();case"snapshot":return(new s).render();case"sns":return(new a).render();case"sslcert":return(new o).render();case"dhcp":return(new u).manageDhcp()}},refreshResourcePanel:function(e){var t,n,r;t=$(".sidebar-title .refresh-resource-panel");if(!t.hasClass("disabled"))return r=e.data,n=r.region,this.model.refreshResourceList(n),t.addClass("disabled")},stopRefreshResourcePanel:function(){return $(".sidebar-title .refresh-resource-panel").removeClass("disabled"),notification("info","Refresh resource list success")}}),p=t.RESTYPE,c={},h={},l})}).call(this);