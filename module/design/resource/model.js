(function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define(["i18n!nls/lang.js","ec2_service","ebs_model","aws_model","ami_model","favorite_model","MC","constant","event","subnet_model","Design","backbone","jquery","underscore"],function(t,n,r,i,s,o,u,a,f,l,c){var h,p,d,v;return p=null,d={},h=Backbone.Model.extend({defaults:{availability_zone:null,resource_snapshot:null,quickstart_ami:null,my_ami:null,favorite_ami:null,community_ami:null,check_required_service_count:null},service_count:0,setting:{noReset:!1},initialize:function(){var e;return e=this,e.on("EC2_EBS_DESC_SSS_RETURN",function(t){var n;return void 0,n=t.param[3],t.is_error||(e.set("resource_snapshot",t.resolved_data),u.data.config[n].snapshot_list=t.resolved_data),null}),e.on("AWS_QUICKSTART_RETURN",function(t){var n,r,i,s,o,l,c,h,d,v,m,g;c=t.param[3],void 0;if(!t.is_error){n=[],p=t.resolved_data.ami_instance_type,l=t.resolved_data.region_ami_instance_type,u.data.instance_type||(u.data.instance_type={}),u.data.instance_type[t.param[3]]=p,l&&(u.data.region_instance_type||(u.data.region_instance_type={}),u.data.region_instance_type[t.param[3]]=l),s={},i=t.resolved_data.instance_type,_.each(i,function(e,t){return _.each(e,function(e,n){var r,i,o,u,a,f;try{i=e.description,u=e.name,r=i.split(","),a=["","","",""],_.each(r,function(e,t){var n;return n=$.trim(e),t<3?a[t+1]=n:a[0]=u,null}),f=t+"."+n,s[f]=a}catch(l){o=l,void 0}return null}),null}),a.INSTANCE_TYPE=s,_.map(t.resolved_data.ami,function(e,t){var r;e.imageId=t,_.map(e,function(t,n){return t===""&&(e[n]="None"),null});if(e.kernelId===void 0||e.kernelId==="")e.kernelId="None";return e.osType=u.aws.ami.getOSType(e),e.osFamily||(e.osFamily=u.aws.aws.getOSFamily(e.osType)),r=u.aws.ami.getInstanceType(e),e.instance_type=r.join(", "),u.data.dict_ami[t]=e,n.push(e),null}),n.sort(function(e,t){return e.osType>t.osType?1:e.osType<t.osType?-1:e.architecture>=t.architecture?1:-1}),o=[];if(u.canvas_data.platform==="ec2-classic")for(h=0,v=n.length;h<v;h++)r=n[h],r.name.indexOf("ami-vpc-nat")<0&&o.push(r);else o=n;void 0,c===u.canvas_data.region&&e.set("quickstart_ami",o),u.data.config[c].ami=t.resolved_data.ami,u.data.config[c].ami_instance_type=t.resolved_data.ami_instance_type,u.data.config[c].region_instance_type=t.resolved_data.region_instance_type,t.resolved_data.region_ami_instance_type&&(u.data.config[c].region_ami_instance_type=t.resolved_data.region_ami_instance_type),u.data.config[c].instance_type=t.resolved_data.instance_type,u.data.config[c].price=t.resolved_data.price,u.data.config[c].vpc_limit=t.resolved_data.vpc_limit,u.data.config[c].zone=null;if(u.common.cookie.getCookieByName("has_cred")!=="true"){u.data.config[c].zone={item:[]},g=t.resolved_data.zone;for(d=0,m=g.length;d<m;d++)r=g[d],u.data.config[c].zone.item.push({regionName:c,zoneName:r,zoneState:"available"})}u.data.config[c].ami_list=n,u.data.config[c].favorite_ami=null,u.data.config[c].my_ami=null,e.myAmiService(c),e.favoriteAmiService(c),e.stackLoadDepend("quickstartService:NEW"),e.describeStackAmiService(c),f.trigger(f.RESOURCE_QUICKSTART_READY,c)}return null}),e.on("EC2_AMI_DESC_IMAGES_RETURN",function(t){var n,r,i,s,o;return i=t.param[3],void 0,!t.is_error&&(t.param[6]&&t.param[6][0]&&t.param[6][0]==="self"||t.param[5]&&t.param[5][0]==="self")?(((s=t.param[6])!=null?s[0]:void 0)==="self"?u.data.config[i].exec=!0:((o=t.param[5])!=null?o[0]:void 0)==="self"&&(u.data.config[i].owner=!0),void 0,r=[],t.resolved_data&&(n=[],_.map(t.resolved_data,function(t){var r,i;try{t.imageState==="available"?(t.osType=u.aws.ami.getOSType(t),t.osFamily||(t.osFamily=u.aws.aws.getOSFamily(t.osType)),i=u.aws.ami.getInstanceType(t),t.instanceType=i.join(", "),e.convertBlockDeviceMapping(t),u.data.dict_ami[t.imageId]=t,n.push(t)):void 0}catch(s){return r=s,void 0,!0}return null}),r=n,u.data.config[i].my_ami=u.data.config[i].my_ami.concat(n)),void 0,i===u.canvas_data.region&&u.data.config[i].owner&&u.data.config[i].exec&&e.set("my_ami",u.data.config[i].my_ami)):(void 0,t.resolved_data&&_.map(t.resolved_data,function(t){var n;return t.imageState==="available"?(t.osType=u.aws.ami.getOSType(t),t.osFamily||(t.osFamily=u.aws.aws.getOSFamily(t.osType)),n=u.aws.ami.getInstanceType(t),t.instanceType=n.join(", "),e.convertBlockDeviceMapping(t),u.data.dict_ami[t.imageId]=t):void 0,null}),this.stackLoadDepend("describeStackAmiService:OLD")),null}),e.on("AWS__PUBLIC_RETURN",function(n){var r,i,s,o,a,f;o=n.param[3],void 0,r={};if(!n.is_error&&n.resolved_data){r=_.extend(n.resolved_data.ami,{timestamp:(new Date).getTime()}),i=_.pluck(_.filter(e.get("favorite_ami"),function(e){return!e["delete"]}),"resource_id"),f=r.result;for(s in f)a=f[s],_.contains(i,s)&&(a.favorite=!0);void 0,o===u.canvas_data.region&&e.set("community_ami",r)}else notification("warning",t.ide.RES_MSG_WARN_GET_COMMUNITY_AMI_FAILED);return null}),e.on("FAVORITE_INFO_RETURN",function(t){var n,r;if(this.setting.noReset){this.setting.noReset=!1;return}return r=t.param[3],void 0,n=_.filter(t.resolved_data,function(e,t){return e.resource_info}),_.map(n,function(e,t){var n;return e.amiVO=e.resource_info,e.resource_info=JSON.parse(e.resource_info),_.map(e.resource_info,function(t,n){return t===""&&(e.resource_info[n]="None"),null}),e.resource_info.imageId=e.resource_id,e.resource_info.osType=u.aws.ami.getOSType(e.resource_info),e.resource_info.osFamily||(e.resource_info.osFamily=u.aws.aws.getOSFamily(e.resource_info.osType)),n=u.aws.ami.getInstanceType(e.resource_info),e.resource_info.instanceType=n.join(", "),u.data.dict_ami[e.resource_id]=e.resource_info,null}),void 0,r===u.canvas_data.region&&(e.set("favorite_ami",null),e.set("favorite_ami",n)),u.data.config[r].favorite_ami={},u.data.config[r].favorite_ami=n,null}),e.on("FAVORITE_ADD_RETURN",function(n){var r;return r=n.param[3],void 0,n.is_error?notification("error",t.ide.RES_MSG_ERR_ADD_FAVORITE_AMI_FAILED):(delete u.data.config[r].favorite_ami,e.favoriteAmiService(r),notification("info",t.ide.RES_MSG_INFO_ADD_AMI_FAVORITE_SUCCESS)),null}),e.on("FAVORITE_REMOVE_RETURN",function(e){var n;return n=e.param[3],void 0,e.is_error?notification("error",t.ide.RES_MSG_ERR_REMOVE_FAVORITE_AMI_FAILED):(delete u.data.config[n].favorite_ami,notification("info",t.ide.RES_MSG_INFO_REMVOE_FAVORITE_AMI_SUCCESS)),null}),e.on("VPC_SNET_DESC_SUBNETS_RETURN",function(e){var t,n;return n=e.param[3],t="",e.param[5]&&$.type(e.param[5])==="array"&&(t=e.param[5][0].Value[0]),void 0,e.is_error||($.type(e.resolved_data)==="array"?$.each(e.resolved_data,function(e,t){return u.data.account_attribute[n].default_subnet[t.availabilityZone]=t,u.data.resource_list[n][t.subnetId]=t,null}):void 0),null})},describeAvailableZonesService:function(e){var t,r;return t=this,t.set("availability_zone",null),u.data.config[e]&&u.data.config[e].zone?(r=$.extend(!0,{},u.data.config[e].zone),u.data.current_tab_type!=="NEW_STACK"&&$.each(r.item,function(e,t){return $.each(u.canvas_data.component,function(n,i){if(i.type===a.AWS_RESOURCE_TYPE.AWS_EC2_AvailabilityZone&&i.resource.ZoneName===t.zoneName)return r.item[e].isUsed=!0,null})}),t.stackLoadDepend("describeAvailableZonesService:OLD"),t.set("availability_zone",r)):n.DescribeAvailabilityZones({sender:t},$.cookie("usercode"),$.cookie("session_id"),e,null,null,function(n){return n.is_error?void 0:(e=n.param[3],void 0,_.map(n.resolved_data.item,function(e){return e.zoneShortName=e.zoneName.slice(-1).toUpperCase(),null}),r=$.extend(!0,{},n.resolved_data),u.data.current_tab_type!=="NEW_STACK"&&$.each(r.item,function(e,t){return $.each(u.canvas_data.component,function(n,i){if(i.type===a.AWS_RESOURCE_TYPE.AWS_EC2_AvailabilityZone&&i.resource.ZoneName===t.zoneName)return r.item[e].isUsed=!0,null})}),void 0,e===u.canvas_data.region&&t.set("availability_zone",r),u.data.config[e].zone=n.resolved_data,t.stackLoadDepend("describeAvailableZonesService:NEW"),null)})},describeSnapshotsService:function(e){var t;t=this,t.set("resource_snapshot",null);if(u.common.cookie.getCookieByName("account_id")==="demo_account")return;return u.data.config[e]&&u.data.config[e].snapshot_list?t.set("resource_snapshot",u.data.config[e].snapshot_list):r.DescribeSnapshots({sender:t},$.cookie("usercode"),$.cookie("session_id"),e,null,["self"],null,null)},quickstartService:function(e){var t,n,r,s,o,a;r=this,r.set("quickstart_ami",null);if(u.data.config[e]&&u.data.config[e].ami_list){t=u.data.config[e].ami_list,s=[];if(u.canvas_data.platform==="ec2-classic")for(o=0,a=t.length;o<a;o++)n=t[o],n.name.indexOf("ami-vpc-nat")<0&&s.push(n);else s=t;r.set("quickstart_ami",s),r.myAmiService(e),r.favoriteAmiService(e),r.stackLoadDepend("quickstartService:OLD"),r.describeStackAmiService(e),f.trigger(f.RESOURCE_QUICKSTART_READY,e)}else i.quickstart({sender:r},$.cookie("usercode"),$.cookie("session_id"),e);return null},myAmiService:function(e){var t;void 0,t=this,t.set("my_ami",Math.round(+(new Date)));if(u.common.cookie.getCookieByName("account_id")==="demo_account")return;return u.data.config[e]&&u.data.config[e].my_ami?t.set("my_ami",u.data.config[e].my_ami):(u.data.config[e].my_ami=[],s.DescribeImages({sender:t},$.cookie("usercode"),$.cookie("session_id"),e,null,null,["self"],[{Name:"is-public",Value:!1}]),s.DescribeImages({sender:t},$.cookie("usercode"),$.cookie("session_id"),e,null,["self"],null,null)),null},describeStackAmiService:function(t){var n,r,i;void 0,r=this,i=[],n=u.data.dict_ami;if(!n)return;return _.map(u.canvas_data.component,function(t){var n;if(t.type===a.AWS_RESOURCE_TYPE.AWS_EC2_Instance&&u.data.dict_ami&&!u.data.dict_ami[t.resource.ImageId])if(n=t.resource.ImageId,e.call(i,n)<0)return i.push(t.resource.ImageId)}),i.length!==0?s.DescribeImages({sender:r},$.cookie("usercode"),$.cookie("session_id"),t,_.uniq(i)):r.stackLoadDepend("describeStackAmiService:NEW")},describeCommunityAmiService:function(e,t,n,r,s,o,u,a){var f,l,c;c=this;if(u===void 0||u===null)u=50;if(a===void 0||a===null||a===0||a==="0")a=1;return l={ami:{name:t,platform:n,isPublic:r,architecture:s,rootDeviceType:o,perPageNum:parseInt(u,10),returnPage:parseInt(a,10)}},f=[],d[e]===void 0&&i.Public({sender:c},$.cookie("usercode"),$.cookie("session_id"),e,l),null},favoriteAmiService:function(e){var t;return void 0,t=this,u.data.config[e]&&u.data.config[e].favorite_ami?(t.set("favorite_ami",null),t.set("favorite_ami",u.data.config[e].favorite_ami)):o.info({sender:t},$.cookie("usercode"),$.cookie("session_id"),e),null},addFav:function(e,t,n,r){var i,s;return this.setting.noReset=r,r&&(i=_.findWhere(this.get("favorite_ami"),{resource_id:t}),delete i["delete"],this.trigger("change:favorite_ami")),n||(n=JSON.stringify(this.get("community_ami").result[t])),t={id:t,provider:"AWS",resource:"AMI",service:"EC2"},s=this,o.add({sender:s},$.cookie("usercode"),$.cookie("session_id"),e,t)},removeFav:function(e,t){var n;return t=[t],n=this,o.remove({sender:n},$.cookie("usercode"),$.cookie("session_id"),e,t),delete u.data.config[e].favorite_ami,this.resetFavData("remove",t[0])},resetFavData:function(e,t){var n,r;if(e!=="add"&&e==="remove")return n=this.get("favorite_ami"),r=_.map(n,function(e){return e.resource_id===t?_.extend({},e,{"delete":!0}):e}),this.set("favorite_ami",r)},getIgwStatus:function(){var e;return e=!1,$.each(u.canvas_data.component,function(t,n){if(n.type===a.AWS_RESOURCE_TYPE.AWS_VPC_InternetGateway)return e=!0,!1}),e},getVgwStatus:function(){var e;return e=!1,$.each(u.canvas_data.component,function(t,n){if(n.type===a.AWS_RESOURCE_TYPE.AWS_VPC_VPNGateway)return e=!0,!1}),e},describeSubnetInDefaultVpc:function(e){var t,n,r;return r=this,t=u.data.account_attribute[e].default_vpc,t?t!=="none"?(n=[{Name:"vpc-id",Value:[t]},{Name:"defaultForAz",Value:["true"]}],l.DescribeSubnets({sender:r},$.cookie("usercode"),$.cookie("session_id"),e,null,n)):void 0:void 0,null},stackLoadDepend:function(e){return void 0,this.service_count=this.service_count+1,u.data.resouceapi.push(e),this.set("check_required_service_count",this.service_count),null},convertBlockDeviceMapping:function(e){var t,n,r,i,s,o;t={};if(e&&e.blockDeviceMapping&&e.blockDeviceMapping.item){o=e.blockDeviceMapping.item;for(n=i=0,s=o.length;i<s;n=++i)r=o[n],r.ebs?t[r.deviceName]={snapshotId:r.ebs.snapshotId,volumeSize:r.ebs.volumeSize,volumeType:r.ebs.volumeType,deleteOnTermination:r.ebs.deleteOnTermination}:t[r.deviceName]={},e.blockDeviceMapping=t}else void 0;return null}}),v=new h,v})}).call(this);