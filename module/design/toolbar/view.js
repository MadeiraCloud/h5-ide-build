(function(){define(["MC","event","Design","i18n!nls/lang.js","./stack_template","./app_template","./appview_template","component/exporter/JsonExporter","constant","kp_dropdown","ApiRequest","component/stateeditor/stateeditor","UI.modalplus","backbone","jquery","handlebars","UI.selectbox","UI.notification","UI.tabbar"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){var p,d,v;return p="api.visualops.io",d="https://"+p+"/v1/apps/",v=Backbone.View.extend({el:document,events:{"click #toolbar-straight":"clickLineStyleStraight","click #toolbar-elbow":"clickLineStyleElbow","click #toolbar-bezier-q":"clickLineStyleBezierQ","click #toolbar-bezier-qt":"clickLineStyleBezierQT","click #toolbar-run":"clickRunIcon","click .icon-save":"clickSaveIcon","modal-shown #toolbar-delete":"clickDeleteIcon","modal-shown #toolbar-duplicate":"clickDuplicateIcon","modal-shown #toolbar-stop-app":"clickStopApp","modal-shown #toolbar-start-app":"clickStartApp","modal-shown #toolbar-app-to-stack":"appToStackClick","click #toolbar-new":"clickNewStackIcon","click .icon-zoom-in":"clickZoomInIcon","click .icon-zoom-out":"clickZoomOutIcon","click .icon-undo":"clickUndoIcon","click .icon-redo":"clickRedoIcon","click #toolbar-export-png":"clickExportPngIcon","click #toolbar-export-json":"clickExportJSONIcon","click #toolbar-terminate-app":"clickTerminateApp","click #btn-app-refresh":"clickRefreshApp","click #toolbar-convert-cf":"clickConvertCloudFormation","click #toolbar-save-as-app":"clickSaveAsApp","click #toolbar-edit-app":"clickEditApp","click #toolbar-save-edit-app":"clickSaveEditApp","click #toolbar-cancel-edit-app":"clickCancelEditApp","click .toolbar-visual-ops-switch":"opsOptionChanged","click .reload-states":"clickReloadStates"},render:function(n,r){var u,a;void 0,a={icon:"",is_style0:null,is_style1:null,is_style2:null,is_style3:null};switch($canvas.lineStyle()){case 0:a.is_style0=!0,a.icon="icon-straight";break;case 1:a.is_style1=!0,a.icon="icon-elbow";break;case 2:a.is_style2=!0,a.icon="icon-bezier-q";break;case 3:a.is_style3=!0,a.icon="icon-bezier-qt"}return this.model.attributes.lines=a,u=e.common.other.canvasData.data(!0),Tabbar.current==="appview"?$("#main-toolbar").html(o(this.model.attributes)):n==="app"||n==="OPEN_APP"?$("#main-toolbar").html(s(this.model.attributes)):$("#main-toolbar").html(i(this.model.attributes)),n&&r===1&&this.opsState(),t.trigger(t.DESIGN_SUB_COMPLETE),null},listen:function(){return $(document.body).on("click","#confirm-update-app",this,this.appUpdating),$(document.body).on("click","#return-app-confirm",this,this.appedit2App),$(document.body).on("click",".modal-footer #btn-confirm",this,function(){return modal.close()})},reRender:function(e){void 0;if($.trim($("#main-toolbar").html())==="loading...")return e==="stack"?$("#main-toolbar").html(i(this.model.attributes)):$("#main-toolbar").html(s(this.model.attributes))},showErr:function(e,t){return $("#runtime-error-"+e).text(t).show()},hideErr:function(e){return e?$("#runtime-error-"+e).hide():$(".runtime-error").hide()},defaultKpIsSet:function(){var e,t;return f.hasResourceWithDefaultKp()?(e=n.modelClassForType(a.RESTYPE.KP),t=e.getDefaultKP(),!t.get("isSet")||!$("#kp-runtime-placeholder .item.selected").length?(this.showErr("kp","Specify a key pair as $DefaultKeyPair for this app."),!1):!0):!0},hideDefaultKpError:function(e){return function(){return e.hideErr("kp")}},renderDefaultKpDropdown:function(){var e;return f.hasResourceWithDefaultKp()&&(e=new f,$("#kp-runtime-placeholder").html(e.render().el),e.$(".selectbox").on("OPTION_CHANGE",this.hideDefaultKpError(this)),$(".default-kp-group").show()),null},clickRunIcon:function(i){var s,o,u;return o=this,$("#toolbar-run").hasClass("disabled")?!1:(u={title:"Run Stack",template:e.template.modalRunStack,disableClose:!0,width:"450px",height:"515px",confirm:{text:"Run Stack",disabled:!0}},App.user.hasCredential()||(u.confirm.text="Set Up Credential First"),o.modalPlus=new h(u),o.renderDefaultKpDropdown(),i.preventDefault(),$(".modal-input-value").val(e.common.other.canvasData.get("name")),s=n.instance().getCost(),$("#label-total-fee").find("b").text("$"+s.totalFee),require(["component/trustedadvisor/main"],function(e){return e.loadModule("stack").then(function(){return o.modalPlus&&o.modalPlus.toggleConfirm(!1)})}),o.modalPlus.on("confirm",function(){var n,i,s,u,a,f,l;return o.hideErr(),App.user.hasCredential()?(i=$(".modal-input-value").val(),i?e.validate("awsName",i)?(a="process-"+e.common.other.canvasData.get("region")+"-"+i,u=e.common.other.getProcess(a),u&&u.flag_list&&u.flag_list.is_failed===!0&&u.flag_list.flag==="RUN_STACK"&&(e.common.other.deleteProcess(a),t.trigger(t.CLOSE_DESIGN_TAB,a)),n=!e.aws.aws.checkAppName(i)||_.contains(_.keys(e.process),a),n&&o.showErr("appname",r.ide.PROP_MSG_WARN_REPEATED_APP_NAME),!o.defaultKpIsSet()||n?!1:(o.modalPlus.toggleConfirm(!0),$(".modal-header .modal-close").hide(),$("#run-stack-cancel").attr("disabled",!0),f=e.common.other.canvasData.get("region"),s=e.common.other.canvasData.data(),l=this,o.model.syncSaveStack(f,s).then(function(t){var n,r;if(!o.modalPlus||!o.modalPlus.isOpen)return;return n=s,i=$(".modal-input-value").val(),n.name=i,n.usage="others",r=$("#app-usage-selectbox .selected").data("value"),r&&(n.usage=r),n.id=t,o.model.runStack(n),e.data.app_list[f].push(i),o.modalPlus&&o.modalPlus.close()}))):(o.showErr("appname",r.ide.PROP_MSG_WARN_INVALID_APP_NAME),!1):(o.showErr("appname",r.ide.PROP_MSG_WARN_NO_APP_NAME),!1)):(App.showSettings(App.showSettings.TAB.Credential),!1)},this),null)},clickSaveIcon:function(){var n,i,s;return void 0,i=e.common.other.canvasData.get("name"),n=e.common.other.canvasData.get("id"),i?i.indexOf(" ")>=0?notification("warning",r.ide.PROP_MSG_WARN_WHITE_SPACE):e.aws.aws.checkStackName(n,i)?(e.common.other.canvasData.set("name",i),t.trigger(t.SAVE_STACK,e.common.other.canvasData.data())):(s=e.template.modalReinputStackName({stack_name:i}),modal(s,!1),$("#rename-confirm").click(function(){var r;return r=$("#new-stack-name").val(),void 0,e.aws.aws.checkStackName(n,r)?(modal.close(),e.common.other.canvasData.set("name",r),$("#property-stack-name").length!==0&&($("#property-stack-name").val(r),$("#property-title").text("Stack - "+r)),t.trigger(t.SAVE_STACK,e.common.other.canvasData.data()),!0):$(".resource-name-label").text(r)})):notification("warning",r.ide.PROP_MSG_WARN_NO_STACK_NAME),!0},clickDuplicateIcon:function(n){var i,s;return i=e.common.other.canvasData.get("name"),s=e.aws.aws.getDuplicateName(i),$("#modal-input-value").val(s),$("#btn-confirm").on("click",{target:this},function(n){return void 0,s=$("#modal-input-value").val(),s?s.indexOf(" ")>=0?notification("warning",r.ide.PROP_MSG_WARN_WHITE_SPACE):e.aws.aws.checkStackName(null,s)?(modal.close(),t.trigger(t.SAVE_STACK,e.common.other.canvasData.data()),setTimeout(function(){var n,r;return r=e.common.other.canvasData.get("region"),n=e.common.other.canvasData.get("id"),i=e.common.other.canvasData.get("name"),t.trigger(t.DUPLICATE_STACK,r,n,s,i)},500)):notification("warning",r.ide.PROP_MSG_WARN_REPEATED_STACK_NAME):notification("warning",r.ide.PROP_MSG_WARN_NO_STACK_NAME)}),!0},appToStackClick:function(i){var s,o,u,a;return void 0,s=function(e,n,i){if(e){notification("error",sprintf(r.ide.TOOL_MSG_ERR_SAVE_FAILED,n.name));return}return n.id?(notification("info",sprintf(r.ide.TOOL_MSG_INFO_HDL_SUCCESS,r.ide.TOOLBAR_HANDLE_SAVE_STACK,n.name)),t.trigger(t.CLOSE_DESIGN_TAB,n.id)):(notification("info",sprintf(r.ide.TOOL_MSG_INFO_HDL_SUCCESS,r.ide.TOOLBAR_HANDLE_CREATE_STACK,n.name)),t.trigger(t.UPDATE_STACK_LIST,"SAVE_STACK",[i])),window.setTimeout(function(){return t.trigger(t.OPEN_DESIGN_TAB,"OPEN_STACK",n.name,n.region,n.id||i)},160)},o=e.common.other.canvasData.get("name"),u=e.aws.aws.getStackNameFromApp(o),a=n.instance().serialize().stack_id,e.aws.aws.hasStack(a),$("#modal-input-value").val(u),e.aws.aws.hasStack(a)?$("input[type=radio]").change(function(){if($(this).is(":checked"))return $(".radio-instruction").addClass("hide"),$(this).parent().parent().find(".radio-instruction").removeClass("hide")}):($("#replace_stack").hide(),$("#save_new_stack").find("div.radio,label").hide(),$("#save_new_stack").find(".radio-instruction").removeClass("hide")),$("#modal-input-value").keyup(function(){return e.aws.aws.checkStackName(null,$(this).val())?$("#stack-name-exist").addClass("hide"):$("#stack-name-exist").removeClass("hide")}),$("#btn-confirm").on("click",{target:this},function(t){var i,o;return void 0,$("#save_new_stack").find(".radio-instruction").hasClass("hide")?(modal.close(),o=n.instance().serializeAsStack(),o.id=a,l("saveStack",{region_name:o.region,data:o}).then(function(e){return s(null,o,e)},function(e){return s(e,o)}),!1):(u=$("#modal-input-value").val(),u?u.indexOf(" ")>=0?notification("warning",r.ide.PROP_MSG_WARN_WHITE_SPACE):e.aws.aws.checkStackName(null,u)?($("#stack-name-exist").addClass("hide"),modal.close(),i=n.instance().serializeAsStack(),i.name=u,l("createStack",{region_name:i.region,data:i}).then(function(e){return s(null,i,e)},function(e){return s(e,i)})):($("#stack-name-exist").addClass("error-msg").removeClass("hide"),notification("warning",r.ide.PROP_MSG_WARN_REPEATED_STACK_NAME)):notification("warning",r.ide.PROP_MSG_WARN_NO_STACK_NAME))}),null},clickReloadStates:function(e){var i,s,o,u;return s=$(e.currentTarget),i=s,s.hasClass("disabled")?!1:(void 0,s.toggleClass("disabled"),i.html(i.attr("data-disabled")),o=n.instance().serialize().id,void 0,u={encoded_user:App.user.get("usercode"),token:App.user.get("defaultToken")},$.ajax({url:d+o,method:"POST",data:JSON.stringify(u),dataType:"json",jsonp:!1,statusCode:{200:function(){return void 0,notification("info",r.ide.RELOAD_STATE_SUCCESS),t.trigger(t.REFRESH_PROPERTY)},401:function(){return void 0,notification("error",r.ide.RELOAD_STATE_INVALID_REQUEST)},404:function(){return void 0,notification("error",r.ide.RELOAD_STATE_NETWORKERROR)},429:function(){return void 0,notification("error",r.ide.RELOAD_STATE_NOT_READY)},500:function(){return void 0,notification("error",r.ide.RELOAD_STATE_INTERNAL_SERVER_ERROR)}},error:function(){return void 0,null},success:function(){return void 0}}).always(function(){return window.setTimeout(function(){return s.removeClass("disabled"),i.html(i.attr("data-original"))},2e3)}))},clickDeleteIcon:function(){var n,r;return n=this,r=$("#main-toolbar"),$("#btn-confirm").on("click",{target:this},function(n){var r,i,s;return void 0,modal.close(),s=e.common.other.canvasData.get("region"),r=e.common.other.canvasData.get("id"),i=e.common.other.canvasData.get("name"),t.trigger(t.DELETE_STACK,s,r,i)})},clickNewStackIcon:function(){return void 0,t.trigger(t.OPEN_DESIGN_TAB,"NEW_STACK",null,e.common.other.canvasData.get("region"),null)},clickZoomInIcon:function(e){return void 0,$(e.currentTarget).hasClass("disabled")?!1:this.trigger("TOOLBAR_ZOOM_IN")},clickZoomOutIcon:function(e){return void 0,$(e.currentTarget).hasClass("disabled")?!1:this.trigger("TOOLBAR_ZOOM_OUT")},clickUndoIcon:function(){return void 0},clickRedoIcon:function(){return void 0},clickExportPngIcon:function(){return modal(e.template.exportPNG({title:"Export PNG",confirm:"Download",color:"blue"},!1)),$("#modal-wrap").data("uid",e.common.other.canvasData.get("id")).find("#btn-confirm").hide(),$("#modal-wrap").find(".modal-body").css({padding:"12px 20px","max-height":"420px",overflow:"hidden",background:"none"}),this.trigger("TOOLBAR_EXPORT_PNG_CLICK"),null},clickExportJSONIcon:function(){var t,r,i,s,o;return i=n.instance(),o=App.user.get("username"),r=e.dateFormat(new Date,"yyyy-MM-dd"),s=[i.get("name"),o,r].join("-"),t=u.exportJson(n.instance().serialize(),s+".json"),t&&modal(e.template.exportJSON(t)),null},exportPNG:function(t,n,r){var i;if($("#modal-wrap").data("uid")!==n)return;return i=e.common.other.canvasData.get("name"),r?$("#modal-wrap").find("#btn-confirm").show().click(function(){return u.download(r,i+".png")}):$("#modal-wrap").find("#btn-confirm").show().attr({href:t,download:i+".png"}),$(".modal-body").html("<img style='max-height:100%;display:inline-block' src='"+t+"' />").css({background:"none","text-align":"center"}),_.delay(function(){return modal.position()},50),null},clickConvertCloudFormation:function(){return modal(e.template.exportCloudFormation()),this.trigger("CONVERT_CLOUDFORMATION"),null},saveCloudFormation:function(e){var t,i,s,o,a;a=this;try{return t=$("#tpl-download").removeClass("disabled"),i=this.model.attributes.cf_data[e],o=""+n.instance().get("name")+".json",u.genericExport(t,i,o),$("#tpl-download").on("click",function(e){return modal.close()})}catch(f){return s=f,notification("error",r.ide.TOOL_MSG_ERR_CONVERT_CLOUDFORMATION)}},notify:function(e,t){return notification(e,t)},clickStopApp:function(n){var r,i;return r=this,void 0,i=$("#main-toolbar"),$("#btn-confirm").on("click",{target:this},function(n){var r,i,s;return s=e.common.other.canvasData.get("region"),r=e.common.other.canvasData.get("id"),i=e.common.other.canvasData.get("name"),t.trigger(t.STOP_APP,s,r,i),modal.close()})},clickStartApp:function(n){var r,i;return r=this,void 0,i=$("#main-toolbar"),$("#btn-confirm").on("click",{target:this},function(n){var r,i,s;return s=e.common.other.canvasData.get("region"),r=e.common.other.canvasData.get("id"),i=e.common.other.canvasData.get("name"),t.trigger(t.START_APP,s,r,i),modal.close()})},clickTerminateApp:function(n){var r,i;return r=this,void 0,i=$("#main-toolbar"),$("#btn-confirm").on("click",{target:this},function(n){var r,i,s;return s=e.common.other.canvasData.get("region"),r=e.common.other.canvasData.get("id"),i=e.common.other.canvasData.get("name"),t.trigger(t.TERMINATE_APP,s,r,i),modal.close()})},clickLineStyleStraight:function(e){return $canvas.lineStyle(0),null},clickLineStyleElbow:function(e){return $canvas.lineStyle(1),null},clickLineStyleBezierQ:function(e){return $canvas.lineStyle(2),null},clickLineStyleBezierQT:function(e){return $canvas.lineStyle(3),null},clickRefreshApp:function(n){return void 0,t.trigger(t.UPDATE_APP_RESOURCE,e.common.other.canvasData.get("region"),e.common.other.canvasData.get("id"))},clickEditApp:function(){return void 0,t.trigger(t.UPDATE_DESIGN_TAB_TYPE,e.data.current_tab_id,"appedit"),t.trigger(t.UPDATE_RESOURCE_STATE,"show"),this.trigger("UPDATE_APP",!0),e.canvas.event.clearList(),e.common.other.canvasData.origin(e.common.other.canvasData.data()),n.instance().setMode(n.MODE.AppEdit),t.trigger(t.OPEN_PROPERTY),n.instance().refreshAppUpdate(),null},clickSaveEditApp:function(t){var n,i,s;n=this,s=this.model.diff();if(!s.isModified){this.appedit2App();return}return i={title:"Run Stack",template:e.template.updateApp(s),disableClose:!0,width:"460px",height:"515px",confirm:{text:r.ide.POP_CONFIRM_UPDATE_CONFIRM_BTN,disabled:!0}},n.modalPlus=new h(i),n.modalPlus.on("confirm",n.appUpdating,this),this.renderDefaultKpDropdown(),require(["component/trustedadvisor/main"],function(e){return e.loadModule("stack").then(function(){return n.modalPlus&&n.modalPlus.toggleConfirm(!1)})}),null},clickCancelEditApp:function(){return void 0,e.common.other.canvasData.isModified()?modal(e.template.cancelAppEdit2App(),!0):this.appedit2App(),n.instance().refreshAppUpdate(),null},appedit2App:function(r){var i;return void 0,t.trigger(t.UPDATE_DESIGN_TAB_TYPE,e.data.current_tab_id,"app"),r?i=r.data:i=this,i.trigger("UPDATE_APP",!1),r&&t.trigger(t.RESTORE_CANVAS),modal.close(),t.trigger(t.UPDATE_RESOURCE_STATE,"hide"),t.trigger(t.HIDE_STATUS_BAR),n.instance().setMode(n.MODE.App),t.trigger(t.OPEN_PROPERTY),n.instance().trigger(n.EVENT.AwsResourceUpdated),null},saveSuccess2App:function(n,r){return void 0,t.trigger(t.UPDATE_DESIGN_TAB_TYPE,e.data.current_tab_id,"app"),t.trigger(t.OPEN_DESIGN_TAB,"RELOAD_APP",null,r,n),e.common.other.deleteProcess(e.data.current_tab_id),null},appUpdating:function(t){var n;return void 0,n=this,n.defaultKpIsSet()?(this.trigger("APP_UPDATING",e.common.other.canvasData.data()),this.modalPlus&&this.modalPlus.close(),null):!1},opsState:function(){var e,t;void 0,e=$("#main-toolbar .toolbar-visual-ops-switch"),Tabbar.current==="new"?(e.addClass("on"),this.model.setAgentEnable(!0)):e.removeClass("on");if(n&&n.instance())return t=n.instance().get("agent"),t.enabled?e.addClass("on"):e.removeClass("on")},opsOptionChanged:function(n){var r,i,s,o;return s=this.model,r=$("#main-toolbar .toolbar-visual-ops-switch"),r.toggleClass("on"),o=r.hasClass("on"),o?(i=s.isAllInstanceNotHaveUserData(),i?s.setAgentEnable(!0):(r.removeClass("on"),modal(e.template.modalStackAgentEnable({})),$("#modal-stack-agent-enable-confirm").one("click",function(){return r.addClass("on"),s.setAgentEnable(!0),t.trigger(t.REFRESH_PROPERTY),modal.close()}))):s.setAgentEnable(!1),t.trigger(t.REFRESH_PROPERTY)},clickSaveAsApp:function(t){var r,i,s,o,u,f,c,h,p,d,v,m,g;p=n.instance().serialize(),h=[],r="",i="",e.data.app_info&&e.data.app_info[p.id]&&e.data.app_info[p.id].id?(v=p.id,p.id=e.data.app_info[v].id,p.name=e.data.app_info[v].name):p.id="",d=Math.round((new Date).getTime()/1e3),m=p.component;for(o in m)s=m[o],f=a.AWS_RESOURCE_KEY[s.type],u=s.resource[f],(g=s.type)!=="AWS.EC2.AvailabilityZone"&&g!=="AWS.EC2.KeyPair"&&(c={username:p.username,resource_id:u,region:p.region,app_id:p.id,version:"1.0",time:d,"new":!0,type:s.type},h.push(c));return!p||!h?(notification("error","format error, can not save app!"),null):l("app_save_info",{username:$.cookie("usercode"),session_id:$.cookie("session_id"),spec:p,resource:h}).then(function(e){return function(e){return void 0,notification("info","save as app succeed!")}}(this),function(e){throw notification("error","save as app failed!"),e})}}),v})}).call(this);