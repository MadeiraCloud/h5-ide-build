(function(){define(["MC","event","Design","i18n!nls/lang.js","./stack_template","./stack_classic_template","./app_template","./app_classic_template","./appview_template","component/exporter/JsonExporter","component/exporter/Download","constant","backbone","jquery","handlebars","UI.selectbox","UI.notification","UI.tabbar"],function(e,t,n,r,i,s,o,u,a,f,l,c){var h;return h=Backbone.View.extend({el:document,events:{"click #toolbar-straight":"clickLineStyleStraight","click #toolbar-elbow":"clickLineStyleElbow","click #toolbar-bezier-q":"clickLineStyleBezierQ","click #toolbar-bezier-qt":"clickLineStyleBezierQT","click #toolbar-run":"clickRunIcon","click .icon-save":"clickSaveIcon","click #toolbar-duplicate":"clickDuplicateIcon","click #toolbar-delete":"clickDeleteIcon","click #toolbar-new":"clickNewStackIcon","click .icon-zoom-in":"clickZoomInIcon","click .icon-zoom-out":"clickZoomOutIcon","click .icon-undo":"clickUndoIcon","click .icon-redo":"clickRedoIcon","click #toolbar-export-png":"clickExportPngIcon","click #toolbar-export-json":"clickExportJSONIcon","click #toolbar-stop-app":"clickStopApp","click #toolbar-start-app":"clickStartApp","click #toolbar-terminate-app":"clickTerminateApp","click #btn-app-refresh":"clickRefreshApp","click #toolbar-convert-cf":"clickConvertCloudFormation","click #toolbar-edit-app":"clickEditApp","click #toolbar-save-edit-app":"clickSaveEditApp","click #toolbar-cancel-edit-app":"clickCancelEditApp","click .toolbar-visual-ops-switch":"opsOptionChanged"},render:function(n,r){var f,l,c,h;void 0,l={icon:"",is_style0:null,is_style1:null,is_style2:null,is_style3:null};switch($canvas.lineStyle()){case 0:l.is_style0=!0,l.icon="icon-straight";break;case 1:l.is_style1=!0,l.icon="icon-elbow";break;case 2:l.is_style2=!0,l.icon="icon-bezier-q";break;case 3:l.is_style3=!0,l.icon="icon-bezier-qt"}return this.model.attributes.lines=l,f=e.common.other.canvasData.data(!0),Tabbar.current!=="stack"||!f||(c=f.platform)!==e.canvas.PLATFORM_TYPE.EC2_CLASSIC&&c!==e.canvas.PLATFORM_TYPE.DEFAULT_VPC?Tabbar.current!=="app"||!f||(h=f.platform)!==e.canvas.PLATFORM_TYPE.EC2_CLASSIC&&h!==e.canvas.PLATFORM_TYPE.DEFAULT_VPC?Tabbar.current==="appview"?$("#main-toolbar").html(a(this.model.attributes)):n==="app"||n==="OPEN_APP"?$("#main-toolbar").html(o(this.model.attributes)):$("#main-toolbar").html(i(this.model.attributes)):$("#main-toolbar").html(u(this.model.attributes)):$("#main-toolbar").html(s(this.model.attributes)),n&&r===1&&this.opsState(),t.trigger(t.DESIGN_SUB_COMPLETE),null},listen:function(){return $(document.body).on("click","#confirm-update-app",this,this.appUpdating),$(document.body).on("click","#return-app-confirm",this,this.appedit2App),$(document.body).on("click",".modal-footer #btn-confirm",this,function(){return modal.close()})},reRender:function(e){void 0;if($.trim($("#main-toolbar").html())==="loading...")return e==="stack"?$("#main-toolbar").html(i(this.model.attributes)):$("#main-toolbar").html(o(this.model.attributes))},clickRunIcon:function(i){var s,o;void 0;if($("#toolbar-run").hasClass("disabled")){modal.close();return}return o=this,i.preventDefault(),e.common.cookie.getCookieByName("has_cred")!=="true"?(modal.close(),void 0,require(["component/awscredential/main"],function(e){return e.loadModule()})):($(".modal-input-value").val(e.common.other.canvasData.get("name")),s=n.instance().getCost(),$("#label-total-fee").find("b").text("$"+s.totalFee),require(["component/trustedadvisor/main"],function(e){return e.loadModule("stack")}),$("#btn-confirm").on("click",this,function(n){var i,s,o;void 0,i=$(".modal-input-value").val();if(!i){notification("warning",r.ide.PROP_MSG_WARN_NO_APP_NAME);return}if(!e.validate("awsName",i)){notification("warning",r.ide.PROP_MSG_WARN_INVALID_APP_NAME);return}return o="process-"+e.common.other.canvasData.get("region")+"-"+i,s=e.common.other.getProcess(o),s&&s.flag_list&&s.flag_list.is_failed===!0&&s.flag_list.flag==="RUN_STACK"&&(e.common.other.deleteProcess(o),t.trigger(t.CLOSE_DESIGN_TAB,o)),!e.aws.aws.checkAppName(i)||_.contains(_.keys(e.process),o)?(notification("warning",r.ide.PROP_MSG_WARN_REPEATED_APP_NAME),!1):($("#btn-confirm").attr("disabled",!0),$(".modal-header .modal-close").hide(),$("#run-stack-cancel").attr("disabled",!0),n.data.model.syncSaveStack(e.common.other.canvasData.get("region"),e.common.other.canvasData.data()))})),null},clickSaveIcon:function(){var n,i,s;return void 0,i=e.common.other.canvasData.get("name"),n=e.common.other.canvasData.get("id"),i?i.indexOf(" ")>=0?notification("warning",r.ide.PROP_MSG_WARN_WHITE_SPACE):e.aws.aws.checkStackName(n,i)?(e.common.other.canvasData.set("name",i),t.trigger(t.SAVE_STACK,e.common.other.canvasData.data())):(s=e.template.modalReinputStackName({stack_name:i}),modal(s,!1),$("#rename-confirm").click(function(){var r;r=$("#new-stack-name").val(),void 0;if(e.aws.aws.checkStackName(n,r))return modal.close(),e.common.other.canvasData.set("name",r),t.trigger(t.SAVE_STACK,e.common.other.canvasData.data()),!0})):notification("warning",r.ide.PROP_MSG_WARN_NO_STACK_NAME),!0},clickDuplicateIcon:function(n){var i,s;return i=e.common.other.canvasData.get("name"),s=e.aws.aws.getDuplicateName(i),$("#modal-input-value").val(s),$("#btn-confirm").on("click",{target:this},function(n){return void 0,s=$("#modal-input-value").val(),s?s.indexOf(" ")>=0?notification("warning",r.ide.PROP_MSG_WARN_WHITE_SPACE):e.aws.aws.checkStackName(null,s)?(modal.close(),t.trigger(t.SAVE_STACK,e.common.other.canvasData.data()),setTimeout(function(){var n,r;return r=e.common.other.canvasData.get("region"),n=e.common.other.canvasData.get("id"),i=e.common.other.canvasData.get("name"),t.trigger(t.DUPLICATE_STACK,r,n,s,i)},500)):notification("warning",r.ide.PROP_MSG_WARN_REPEATED_STACK_NAME):notification("warning",r.ide.PROP_MSG_WARN_NO_STACK_NAME)}),!0},clickDeleteIcon:function(){var n,r;return n=this,r=$("#main-toolbar"),$("#btn-confirm").on("click",{target:this},function(n){var r,i,s;return void 0,modal.close(),s=e.common.other.canvasData.get("region"),r=e.common.other.canvasData.get("id"),i=e.common.other.canvasData.get("name"),t.trigger(t.DELETE_STACK,s,r,i)})},clickNewStackIcon:function(){return void 0,t.trigger(t.OPEN_DESIGN_TAB,"NEW_STACK",null,e.common.other.canvasData.get("region"),null)},clickZoomInIcon:function(e){return void 0,$(e.currentTarget).hasClass("disabled")?!1:this.trigger("TOOLBAR_ZOOM_IN")},clickZoomOutIcon:function(e){return void 0,$(e.currentTarget).hasClass("disabled")?!1:this.trigger("TOOLBAR_ZOOM_OUT")},clickUndoIcon:function(){return void 0},clickRedoIcon:function(){return void 0},clickExportPngIcon:function(){return modal(e.template.exportPNG({title:"Export PNG",confirm:"Download",color:"blue"},!1)),$("#modal-wrap").data("uid",e.common.other.canvasData.get("id")).find("#btn-confirm").hide(),$("#modal-wrap").find(".modal-body").css({padding:"12px 20px","max-height":"420px",overflow:"hidden",background:"none"}),this.trigger("TOOLBAR_EXPORT_PNG_CLICK"),null},clickExportJSONIcon:function(){var t,r,i,s,o;return i=n.instance(),o=$.cookie("username"),r=e.dateFormat(new Date,"yyyy-MM-dd"),s=[i.get("name"),o,r].join("-"),t=f.exportJson(n.instance().serialize(),s+".json"),t&&modal(e.template.exportJSON(t)),null},exportPNG:function(t,n,r){var i;if($("#modal-wrap").data("uid")!==n)return;return i=e.common.other.canvasData.get("name"),r?$("#modal-wrap").find("#btn-confirm").show().click(function(){return l(r,i+".png")}):$("#modal-wrap").find("#btn-confirm").show().attr({href:t,download:i+".png"}),$(".modal-body").html("<img style='max-height:100%;display:inline-block' src='"+t+"' />").css({background:"none","text-align":"center"}),_.delay(function(){return modal.position()},50),null},clickConvertCloudFormation:function(){return modal(e.template.exportCloudFormation()),this.trigger("CONVERT_CLOUDFORMATION"),null},saveCloudFormation:function(e){var t,i,s,o,u;u=this;try{return t=$("#tpl-download").removeClass("disabled"),i=this.model.attributes.cf_data[e],o=""+n.instance().get("name")+".json",f.genericExport(t,i,o),$("#tpl-download").on("click",function(e){return modal.close()})}catch(a){return s=a,notification("error",r.ide.TOOL_MSG_ERR_CONVERT_CLOUDFORMATION)}},notify:function(e,t){return notification(e,t)},clickStopApp:function(n){var r,i;return r=this,void 0,e.common.cookie.getCookieByName("has_cred")!=="true"?(modal.close(),void 0,require(["component/awscredential/main"],function(e){return e.loadModule()})):(i=$("#main-toolbar"),$("#btn-confirm").on("click",{target:this},function(n){var r,i,s;return s=e.common.other.canvasData.get("region"),r=e.common.other.canvasData.get("id"),i=e.common.other.canvasData.get("name"),t.trigger(t.STOP_APP,s,r,i),modal.close()}))},clickStartApp:function(n){var r,i;return r=this,void 0,e.common.cookie.getCookieByName("has_cred")!=="true"?(modal.close(),void 0,require(["component/awscredential/main"],function(e){return e.loadModule()})):(i=$("#main-toolbar"),$("#btn-confirm").on("click",{target:this},function(n){var r,i,s;return s=e.common.other.canvasData.get("region"),r=e.common.other.canvasData.get("id"),i=e.common.other.canvasData.get("name"),t.trigger(t.START_APP,s,r,i),modal.close()}))},clickTerminateApp:function(n){var r,i;return r=this,void 0,e.common.cookie.getCookieByName("has_cred")!=="true"?(modal.close(),void 0,require(["component/awscredential/main"],function(e){return e.loadModule()})):(i=$("#main-toolbar"),$("#btn-confirm").on("click",{target:this},function(n){var r,i,s;return s=e.common.other.canvasData.get("region"),r=e.common.other.canvasData.get("id"),i=e.common.other.canvasData.get("name"),t.trigger(t.TERMINATE_APP,s,r,i),modal.close()}))},clickLineStyleStraight:function(e){return $canvas.lineStyle(0),null},clickLineStyleElbow:function(e){return $canvas.lineStyle(1),null},clickLineStyleBezierQ:function(e){return $canvas.lineStyle(2),null},clickLineStyleBezierQT:function(e){return $canvas.lineStyle(3),null},clickRefreshApp:function(n){return void 0,t.trigger(t.UPDATE_APP_RESOURCE,e.common.other.canvasData.get("region"),e.common.other.canvasData.get("id"))},clickEditApp:function(){return void 0,t.trigger(t.UPDATE_DESIGN_TAB_TYPE,e.data.current_tab_id,"appedit"),t.trigger(t.UPDATE_RESOURCE_STATE,"show"),this.trigger("UPDATE_APP",!0),e.canvas.event.clearList(),e.common.other.canvasData.origin(e.common.other.canvasData.data()),n.instance().setMode(n.MODE.AppEdit),t.trigger(t.OPEN_PROPERTY),n.instance().refreshAppUpdate(),null},clickSaveEditApp:function(t){var n;if(e.common.cookie.getCookieByName("has_cred")!=="true")modal.close(),void 0,require(["component/awscredential/main"],function(e){return e.loadModule()});else{n=this.model.diff();if(!n.isModified){this.appedit2App();return}modal(e.template.updateApp(n)),require(["component/trustedadvisor/main"],function(e){return e.loadModule("stack")})}return null},clickCancelEditApp:function(){return void 0,e.common.other.canvasData.isModified()?modal(e.template.cancelAppEdit2App(),!0):this.appedit2App(),n.instance().refreshAppUpdate(),null},appedit2App:function(r){var i;return void 0,t.trigger(t.UPDATE_DESIGN_TAB_TYPE,e.data.current_tab_id,"app"),r?i=r.data:i=this,i.trigger("UPDATE_APP",!1),r&&t.trigger(t.RESTORE_CANVAS),modal.close(),t.trigger(t.UPDATE_RESOURCE_STATE,"hide"),t.trigger(t.HIDE_STATUS_BAR),n.instance().setMode(n.MODE.App),t.trigger(t.OPEN_PROPERTY),n.instance().trigger(n.EVENT.AwsResourceUpdated),null},saveSuccess2App:function(n,r){return void 0,t.trigger(t.UPDATE_DESIGN_TAB_TYPE,e.data.current_tab_id,"app"),t.trigger(t.OPEN_DESIGN_TAB,"RELOAD_APP",null,r,n),e.common.other.deleteProcess(e.data.current_tab_id),null},appUpdating:function(t){return void 0,t.data.trigger("APP_UPDATING",e.common.other.canvasData.data()),modal.close(),null},opsState:function(){var e,t,r;void 0,t=$("#main-toolbar .toolbar-visual-ops-switch"),e=$("#apply-visops"),Tabbar.current==="new"?(t.addClass("on"),this.model.setAgentEnable(!0)):t.removeClass("on");if(n&&n.instance())return r=n.instance().get("agent"),r.enabled?t.addClass("on"):t.removeClass("on")},opsOptionChanged:function(n){var r,i,s,o;return s=this.model,r=$("#main-toolbar .toolbar-visual-ops-switch"),r.toggleClass("on"),o=r.hasClass("on"),o?(i=s.isAllInstanceNotHaveUserData(),i?s.setAgentEnable(!0):(r.removeClass("on"),modal(e.template.modalStackAgentEnable({})),$("#modal-stack-agent-enable-confirm").one("click",function(){return r.addClass("on"),s.setAgentEnable(!0),t.trigger(t.REFRESH_PROPERTY),modal.close()}))):s.setAgentEnable(!1),t.trigger(t.REFRESH_PROPERTY)}}),h})}).call(this);