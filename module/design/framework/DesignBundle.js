(function(){define("CanvasManager",[],function(){var e;return e={removeClass:function(e,t){var n,r;return e.length&&(e=e[0]),e?(n=e.getAttribute("class")||"",r=n.replace(new RegExp("\\b"+t+"\\b","g"),""),n!==r&&e.setAttribute("class",r),this):this},addClass:function(e,t){var n;return e.length&&(e=e[0]),e?(n=e.getAttribute("class")||"",n.match(new RegExp("\\b"+t+"\\b"))||(n=$.trim(n)+" "+t,e.setAttribute("class",n)),this):this},toggle:function(e,t){e.hasOwnProperty("length")&&(e=e[0]);if(!e)return this;if(t===null||t===void 0)t=e.getAttribute("display")==="none";return t?(e.setAttribute("display","inline"),e.setAttribute("style",""),e.getAttribute("data-tooltip")&&this.addClass(e,"tooltip")):(e.setAttribute("display","none"),e.setAttribute("style","opacity:0"),this.removeClass(e,"tooltip")),this},updateEip:function(e,t){var n,r,i,s,o;e.length&&(e=e[0]),s=t.hasPrimaryEip(),s?(o="Detach Elastic IP from primary IP",n="ide/icon/eip-on.png"):(o="Associate Elastic IP to primary IP",n="ide/icon/eip-off.png");if(t.design().modeIsApp()||t.design().modeIsAppView())i=MC.data.resource_list[t.design().region()],r=i[t.get("appId")],s&&r?r.privateIpAddressesSet&&r.privateIpAddressesSet.item&&r.privateIpAddressesSet.item.length?(r=r.privateIpAddressesSet.item[0],r.association&&r.association&&(o=r.association.publicIp||"")):o=r.ipAddress||"":o="";return e.setAttribute("data-tooltip",o),$(e).data("tooltip",o),this.update(e,n,"href"),null},update:function(t,n,r){var i;_.isString(t)&&(t=document.getElementById(t)),t=$(t);if(!r)return t.text(MC.truncate(n,17));if(r!=="href"&&r!=="image")return r==="tooltip"?(t.data("tooltip",n).attr("data-tooltip",n),n?e.addClass(t,"tooltip"):e.removeClass(t,"tooltip")):r==="color"?t.attr("style","fill:"+n):t.attr(r,n);n=MC.IMG_URL+n,i=t[0].getAttributeNS("http://www.w3.org/1999/xlink","href");if(i!==n)return t[0].setAttributeNS("http://www.w3.org/1999/xlink","href",n)},size:function(e,t,n,r,i){var s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E;p=10,t*=MC.canvas.GRID_WIDTH,n*=MC.canvas.GRID_HEIGHT,r*=MC.canvas.GRID_WIDTH,l=t-r,s=$(e),s.children("group").attr("width",t).attr("height",n),o=s.children("path"),v=/translate\(([^)]+)\)/;for(y=0,w=o.length;y<w;y++)a=o[y],d=v.exec(a.getAttribute("class")),d&&d[1]&&(d=d[1].split(","),c=m=parseInt(d[0],10),g=parseInt(d[1],10),h=n/2,m>=r&&(c+=l),(m!==c||g!==h)&&this.position(a,c,h));u=s.children(".resizer-wrap").children();if(u.length){f={};for(b=0,E=u.length;b<E;b++)a=u[b],f[a.getAttribute("class")]=a;a=f["resizer-top"],a&&a.setAttribute("width",t-2*p),a=f["resizer-bottom"],a&&a.setAttribute("width",t-2*p),a=f["resizer-left"],a&&a.setAttribute("height",n-2*p),a=f["resizer-right"],a&&a.setAttribute("height",n-2*p),a=f["resizer-topright"],a&&a.setAttribute("x",t-p),a=f["resizer-bottomleft"],a&&a.setAttribute("y",n-p),a=f["resizer-bot"];if(a)return a.setAttribute("x",t-p),a.setAttribute("y",n-p)}},setPoisition:function(e,t,n){var r,i;return r=e.transform.baseVal,r.numberOfItems===1?r.getItem(0).setTranslate(t*10,n*10):(i=e.ownerSVGElement.createSVGTransform(),i.setTranslate(t*10,n*10),r.appendItem(i)),null},position:function(e,t,n,r){return e.length&&(e=e[0]),MC.canvas.position(e,t,n),null}},e})}).call(this),function(){define("module/design/framework/canvasview/CanvasElement",["CanvasManager","event","constant","i18n!nls/lang.js","MC.canvas.constant"],function(e,t,n,r){var i,s,o;return o=null,s={},i=function(e){return this.id=e.id,this.model=e,this.type=e.type,e.parent?(this.parentId=e.parent(),this.parentId=this.parentId?this.parentId.id:""):this.parentId="",e.node_group===!0?this.nodeType="group":e.node_line===!0?this.nodeType="line":this.nodeType="node",this},i.extend=function(e,t){var n;return n=function(){return null},n.prototype=this.prototype,e.prototype=new n,e.prototype.constructor=e,e["super"]=this.prototype,s[t]=e,null},i.createView=function(e,t){var n,r;return n=s[e],n||(n=i,r={type:"Unknown",id:t}),new n(r||t)},i.prototype.draw=function(){return null},i.prototype.getModel=function(){return this.model},i.prototype.element=function(e){return document.getElementById(e||this.id)},i.prototype.$element=function(e){return $(document.getElementById(e||this.id))},i.prototype.move=function(e,t){if(e===this.model.x()&&t===this.model.y())return;return MC.canvas.move(this.element(),e,t)},i.prototype.position=function(e,t){var n,r,i;r=this.model.x(),i=this.model.y();if(e!==void 0&&e!==null||t!==void 0&&t!==null){if(e===null||e===void 0)e=r;if(t===null||t===void 0)t=i;if(e===r&&t===i)return;return this.model.set({x:e,y:t}),n=this.element(),n&&MC.canvas.position(n,e,t),null}return[r,i]},i.prototype.size=function(e,t){var n,r,i;i=this.model.width(),r=this.model.height();if(e!==void 0&&e!==null||t!==void 0&&t!==null){if(!this.model.node_group)return;if(e===null||e===void 0)e=i;if(t===null||t===void 0)t=r;return(e!==i||t!==r)&&this.model.set({width:e,height:t}),n=this.element(),n&&MC.canvas.groupSize(n,e,t),null}return[i,r]},i.prototype.offset=function(){return this.element().getBoundingClientRect()},i.prototype.port=function(){return this.ports||(this.ports=_.map(this.$element().children(".port"),function(e){return e.getAttribute("data-name")})),this.ports},i.prototype.isConnectable=function(e,t,n){var r,i,s,u,a,f,l;r=o.modelClassForPorts(e,n);if(!r)return!1;i=this.model,s=this.model.design().component(t),l=i.connectionTargets(r.prototype.type);for(a=0,f=l.length;a<f;a++){u=l[a];if(u===s)return!1}return r.isConnectable(i,s)!==!1},i.prototype.isRemovable=function(){var e,t,n,r,i;t=this.model.isRemovable();if(t!==!0)return t;if(this.nodeType==="group"){i=this.children();for(n=0,r=i.length;n<r;n++){e=i[n],t=e.isRemovable();if(t!==!0)break}}return t},i.prototype.remove=function(){var e,n,i,s;if(this.model.isRemoved())return;i=this.isRemovable(),e=this.model,n=e.get("name"),i===!0&&e.children&&e.children().length>0&&(i=sprintf(r.ide.CVS_CFM_DEL_GROUP,n));if(_.isString(i))s=MC.template.canvasOpConfirm({title:sprintf(r.ide.CVS_CFM_DEL,n),content:i}),modal(s,!0),$("#canvas-op-confirm").one("click",function(){return e.isRemoved()||(e.remove(),$canvas.selected_node().length=0,t.trigger(t.OPEN_PROPERTY)),null});else if(i.error)notification("error",i.error);else if(i===!0)return e.remove(),$canvas.selected_node().length=0,t.trigger(t.OPEN_PROPERTY),!0;return!1},i.prototype.reConnect=function(){var e,t,n,r,i;i=this.model.connections();for(n=0,r=i.length;n<r;n++)e=i[n],t=e.getCanvasView(),t&&t.draw();return null},i.prototype.select=function(){if(this.type==="Unknown")return;return this.doSelect(this.type,this.id,this.id),!0},i.prototype.doSelect=function(e,n,r){return t.trigger(t.OPEN_PROPERTY,e,n),MC.canvas.select(r)},i.prototype.connection=function(){var e,t,n,r,i;t=[],i=this.model.connections();for(n=0,r=i.length;n<r;n++)e=i[n],e.get("lineType")&&t.push({line:e.id,target:this.id,port:e.port(this.id,"name")});return t},i.prototype.toggleEip=function(){var e;return void 0,e=!this.model.hasPrimaryEip(),this.model.setPrimaryEip(e),e&&o.modelClassForType(n.AWS_RESOURCE_TYPE.AWS_VPC_InternetGateway).tryCreateIgw(),t.trigger(t.PROPERTY_REFRESH_ENI_IP_LIST),null},i.prototype.clone=function(e,t,n){var r,i,s,o,u;s=this.model.design();if(!s.modeIsStack()&&!s.modeIsAppEdit())return;o=s.component(e);if(!o){void 0;return}if(this.model.clone)return r={parent:o,name:this.model.get("name")+"-copy"},u={x:t,y:n},i={cloneSource:this.model},$canvas.add(this.type,r,u,i)},i.prototype.parent=function(){var e;return e=this.model.parent(),e?e.getCanvasView():null},i.prototype.changeParent=function(e,t){var n,i,s;e==="canvas"&&(e=""),n=this.model.parent(),n=n?n.id:"";if(n===e)return t.call(this),!1;if(this.model.design().modeIsAppEdit()&&this.model.get("appId")){notification("error",r.ide.NOTIFY_MSG_WARN_OPERATE_NOT_SUPPORT_YET);return}i=this.model.design().component(e);if(!i)return void 0,!1;s=this.model.isReparentable(i);if(_.isString(s))notification("error",s);else if(s===!0)return i.addChild(this.model),t.call(this),!0;return!1},i.prototype.children=function(){return this.model.children?_.map(this.model.children()||[],function(e){return e.getCanvasView()}):[]},i.prototype.list=function(){var e,t,r,i,s,o,u,a,f,l,c,h,p;e=this.model,u=this.model.groupMembers();if(u.length===0)return[];t=this.id,a=this.model.get("name"),f=MC.data.resource_list[this.model.design().region()],this.type!==n.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration?(this.type===n.AWS_RESOURCE_TYPE.AWS_EC2_Instance&&(i=f[this.model.get("appId")],l=i?i.instanceState.name:"unknown"),s=[{id:t,name:a,appId:this.model.get("appId"),state:l||"",deleted:f[this.model.get("appId")]?"":" deleted"}],s.id=t,s.name=a):(s=[],s.id=this.model.parent().id,s.name=this.model.parent().get("name")),p=this.model.groupMembers();for(r=c=0,h=p.length;c<h;r=++c){o=p[r],l="";if(this.type===n.AWS_RESOURCE_TYPE.AWS_EC2_Instance||this.type===n.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration)i=f[o.appId],l=i?i.instanceState.name:"unknown";s.push({id:o.id,name:a,appId:o.appId,state:l,deleted:!this.model.design().modeIsStack()&&!f[this.model.get("appId")]?" deleted":""})}return s},i.prototype.getLayer=function(e){return $("#"+e)},i.prototype.portDirection=function(e){return this.portDirMap?this.portDirMap[e]:null},i.prototype.portPosition=function(e){return this.portPosMap?this.portPosMap[e]:null},i.prototype.initNode=function(t,n,r){var i,s,o,u,a,f;e.position(t,n,r),t.length&&(t=t[0]),f=t.children||t.childNodes;for(u=0,a=f.length;u<a;u++){i=f[u];if(i.tagName==="PATH"||i.tagName==="path")s=i.getAttribute("data-alias")||i.getAttribute("data-name"),s&&(o=this.portPosition(s),o&&e.setPoisition(i,o[0]/10,o[1]/10))}return null},i.prototype.createNode=function(e){var t,n,r,i,s,o;return n=this.model,s=n.x(),o=n.y(),i=n.width()*MC.canvas.GRID_WIDTH,t=n.height()*MC.canvas.GRID_HEIGHT,r=Canvon.group().append(Canvon.rectangle(0,0,i,t).attr({"class":"node-background",rx:5,ry:5}),Canvon.image(MC.IMG_URL+e.image,e.imageX,e.imageY,e.imageW,e.imageH)).attr({id:e.id||this.id,"class":"dragable node "+this.type.replace(/\./g,"-"),"data-type":"node","data-class":this.type}),e.labelBg&&r.append(Canvon.rectangle(2,76,86,13).attr({"class":"node-label-name-bg",rx:3,ry:3})),e.label&&r.append(Canvon.text(i/2,t-4,MC.truncate(e.label,17)).attr({"class":"node-label"+(e.labelBg?" node-label-name":"")})),e.sg&&r.append(Canvon.group().append(Canvon.rectangle(10,6,7,5).attr({"class":"node-sg-color-border tooltip"}),Canvon.rectangle(20,6,7,5).attr({"class":"node-sg-color-border tooltip"}),Canvon.rectangle(30,6,7,5).attr({"class":"node-sg-color-border tooltip"}),Canvon.rectangle(40,6,7,5).attr({"class":"node-sg-color-border tooltip"}),Canvon.rectangle(50,6,7,5).attr({"class":"node-sg-color-border tooltip"})).attr({"class":"node-sg-color-group",transform:"translate(8, 62)"})),r},i.prototype.createGroup=function(e){var t,n,r,i,s,o,u;return n=this.model,o=n.x(),u=n.y(),s=n.width()*MC.canvas.GRID_WIDTH,t=n.height()*MC.canvas.GRID_HEIGHT,i=MC.canvas.GROUP_LABEL_COORDINATE[n.type],r=10,Canvon.group().append(Canvon.rectangle(0,0,s,t).attr({"class":"group",rx:5,ry:5}),Canvon.group().append(Canvon.rectangle(r,0,s-2*r,r).attr({"class":"group-resizer resizer-top","data-direction":"top"}),Canvon.rectangle(0,r,r,t-2*r).attr({"class":"group-resizer resizer-left","data-direction":"left"}),Canvon.rectangle(s-r,r,r,t-2*r).attr({"class":"group-resizer resizer-right","data-direction":"right"}),Canvon.rectangle(r,t-r,s-2*r,r).attr({"class":"group-resizer resizer-bottom","data-direction":"bottom"}),Canvon.rectangle(0,0,r,r).attr({"class":"group-resizer resizer-topleft","data-direction":"topleft"}),Canvon.rectangle(s-r,0,r,r).attr({"class":"group-resizer resizer-topright","data-direction":"topright"}),Canvon.rectangle(0,t-r,r,r).attr({"class":"group-resizer resizer-bottomleft","data-direction":"bottomleft"}),Canvon.rectangle(s-r,t-r,r,r).attr({"class":"group-resizer resizer-bottomright","data-direction":"bottomright"})).attr({"class":"resizer-wrap"}),Canvon.text(i[0],i[1],e).attr({"class":"group-label name"})).attr({id:this.id,"class":"dragable "+this.type.replace(/\./g,"-"),"data-type":"group","data-class":this.type})},i.prototype.updateAppState=function(){var t,n;n=this.model,t=n.design();if(t.modeIsStack()||!n.get("appId"))return;return e.removeClass(this.element(),"deleted"),MC.data.resource_list[t.region()][n.get("appId")]||e.addClass(this.element(),"deleted"),null},i.prototype.updatexGWAppState=function(){var t,n,r;r=this.model;if(r.design().modeIsStack()||!r.get("appId"))return;return n=this.element(),e.removeClass(n,"deleted"),t=MC.data.resource_list[r.design().region()][r.get("appId")],t?r.get("appId").indexOf("igw-")===0?(t.attachmentSet===null||t.attachmentSet.item[0].state!=="available"||t.attachmentSet.item[0].vpcId!==r.parent().get("appId"))&&e.addClass(n,"deleted"):r.get("appId").indexOf("vgw-")===0?(t.state!=="available"||t.attachments.item[0].state!=="attached"||t.attachments.item[0].vpcId!==r.parent().get("appId"))&&e.addClass(n,"deleted"):r.get("appId").indexOf("cgw-")===0&&t.state!=="available"&&e.addClass(n,"deleted"):e.addClass(n,"deleted"),null},i.prototype.detach=function(){return MC.canvas.remove(this.element())},i.setDesign=function(e){return o=e,null},i})}.call(this),function(){define("module/design/framework/canvasview/CanvasAdaptor",["./CanvasElement","event","i18n!nls/lang.js","constant"],function(e,t,n,r){var i,s,o,u;return u=null,i=function(t,n){var r,i,s;return r=u.__instance.component(t),r&&(s=r.getCanvasView()),s||(void 0,i=r?r.type:n,s=e.createView(i,r||t)),s},i.platform=function(){return u.instance().type()},i.size=function(e,t){return u.__instance?u.__instance.canvas.size(e,t):[240,240]},i.scale=function(e){return u.__instance.canvas.scale(e)},i.offset=function(){return $(document.getElementById("svg_canvas")).offset()},i.selected_node=function(){return u.__instance?u.__instance.canvas.selectedNode:null},i.lineStyle=function(e){return e===void 0?parseInt(localStorage.getItem("canvas/lineStyle"),10)||2:(localStorage.setItem("canvas/lineStyle",e),u.__instance.shouldDraw()&&_.each(u.modelClassForType("SgRuleLine").allObjects(),function(e){return e.draw()}),null)},i.node=function(){var e,t,n,r;n=[],r=u.__instance.__canvasNodes;for(t in r)e=r[t],(!e.isVisual||e.isVisual())&&n.push(e.getCanvasView());return n},i.group=function(){return _.map(u.__instance.__canvasGroups,function(e){return e.getCanvasView()})},i.clearSelected=function(){return MC.canvas.event.clearSelected(),t.trigger(t.OPEN_PROPERTY),null},i.trigger=function(e){return void 0,o[e]&&o[e].apply(this,Array.prototype.slice.call(arguments,1)),null},i.add=function(e,t,n,s){var o,a,f;t=$.extend({x:n.x,y:n.y},t),f=t.parent,f||(f=u.__instance.component(t.groupUId),t.parent=f,delete t.groupUId);if(f)if(f.type===r.AWS_RESOURCE_TYPE.AWS_AutoScaling_Group)t.x=f.x()+2,t.y=f.y()+3,e=r.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration;else if(f.type==="ExpandedAsg")return!1;return o=u.modelClassForType(e),s=$.extend({createByUser:!0},s||{}),a=new o(t,s),s.selectId?i(s.selectId,!0).select():a.id&&i(a.id,!0).select(),a.id},i.connect=function(e,t,n,r){var s,o,a,f,l,c;s=u.modelClassForPorts(t,r),void 0,f=u.instance().component(e),l=u.instance().component(n),c=s.isConnectable(f,l),o={createByUser:!0};if(_.isString(c))notification("error",c);else{if(c===!0)return a=new s(f,l,void 0,o),a.id&&i(a.id,!0).select(),!0;if(c===!1)return!1;c.confirm&&(modal(MC.template.modalCanvasConfirm(c),!0),$("#canvas-op-confirm").one("click",function(){return a=new s(f,l,void 0,o),a.id&&i(a.id,!0).select(),null}))}return!1},i.connection=function(e){var t,n,r,i,s;e?t={uid:u.__instance.component(e)}:t=u.__instance.__canvasLines,i={};for(s in t)r=t[s],n={type:r.get("lineType"),target:{}},n.target[r.port1Comp().id]=r.port1("name"),n.target[r.port2Comp().id]=r.port2("name"),i[s]=n;return e?i.uid:i},i.hasVPC=function(){return!!u.modelClassForType(r.AWS_RESOURCE_TYPE.AWS_VPC_VPC).theVPC()},o={CANVAS_NODE_SELECTED:function(){return t.trigger(t.OPEN_PROPERTY),null},SHOW_STATE_EDITOR:function(){return t.trigger(t.SHOW_STATE_EDITOR),null},SHOW_PROPERTY_PANEL:function(){return t.trigger(t.FORCE_OPEN_PROPERTY,"property"),null},CANVAS_PLACE_OVERLAP:function(){return notification("warning",n.ide.CVS_MSG_WARN_COMPONENT_OVERLAP,!1),null},CANVAS_ZOOMED_DROP_ERROR:function(){return notification("warning",n.ide.CVS_MSG_ERR_ZOOMED_DROP_ERROR),null},CANVAS_SAVE:function(){return t.trigger(t.CANVAS_SAVE),null},CANVAS_PLACE_NOT_MATCH:function(e){var t,i,s;s=r.AWS_RESOURCE_TYPE,i=n.ide;switch(e.type){case s.AWS_EBS_Volume:t=i.CVS_MSG_WARN_NOTMATCH_VOLUME;break;case s.AWS_VPC_Subnet:t=i.CVS_MSG_WARN_NOTMATCH_SUBNET;break;case s.AWS_EC2_Instance:u.instance().typeIsVpc()?t=i.CVS_MSG_WARN_NOTMATCH_INSTANCE_SUBNET:t=i.CVS_MSG_WARN_NOTMATCH_INSTANCE_AZ;break;case s.AWS_VPC_NetworkInterface:t=i.CVS_MSG_WARN_NOTMATCH_ENI;break;case s.AWS_VPC_RouteTable:t=i.CVS_MSG_WARN_NOTMATCH_RTB;break;case s.AWS_ELB:t=i.CVS_MSG_WARN_NOTMATCH_ELB;break;case s.AWS_VPC_CustomerGateway:t=i.CVS_MSG_WARN_NOTMATCH_CGW;break;case s.AWS_AutoScaling_Group:t="Asg must be dragged to a subnet."}return t&&notification("warning",t,!1),null},STATE_ICON_CLICKED:function(e){return t.trigger(t.OPEN_STATE_EDITOR,e)}},window.$canvas=i,s=function(e){var t;return this.sizeAry=e||[240,240],this.offsetAry=[0,0],this.scaleAry=1,this.selectedNode=[],t={width:this.sizeAry[0]*MC.canvas.GRID_WIDTH,height:this.sizeAry[1]*MC.canvas.GRID_HEIGHT},$("#svg_canvas").attr(t),$("#canvas_container").css(t),this},s.prototype.scale=function(e){return e===void 0?this.scaleAry:(this.scaleAry=e,null)},s.prototype.offset=function(e,t){return e===void 0?this.offsetAry:(this.offsetAry[0]=e,this.offsetAry[1]=t,null)},s.prototype.size=function(e,t){return e===void 0?this.sizeAry:(this.sizeAry[0]=e,this.sizeAry[1]=t,null)},s.setDesign=function(n){return u=n,e.setDesign(n),u.on(u.EVENT.RemoveResource,function(e){var n;n=i.selected_node()[0];if(n&&n.id===e.id)return t.trigger(t.FORCE_OPEN_PROPERTY,"property"),null}),null},s})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define("Design",["constant","module/design/framework/canvasview/CanvasAdaptor"],function(t,n){var r,i,s,o,u,a;return s={policy:{ha:""},lease:{action:"",length:null,due:null},schedule:{stop:{run:null,when:null,during:null},backup:{when:null,day:null},start:{when:null}}},o=function(){return o.o||(o.o={check:function(){}})},r=function(e,t){var r,s;return r=(new i(e,t)).use(),r.canvas=new n(e.layout.size),s=e.layout,s.component&&(e.layout=$.extend({},s.component.node,s.component.group)),r.deserialize(e.component,e.layout),e.layout=s,t.autoFinish!==!1&&r.finishDeserialization(),r},_.extend(r,Backbone.Events),r.__modelClassMap={},r.__resolveFirstMap={},r.__serializeVisitors=[],r.__deserializeVisitors=[],r.__instance=null,i=function(e,t){var n,i;return this.__componentMap={},this.__canvasNodes={},this.__canvasLines={},this.__canvasGroups={},this.__classCache={},this.__backingStore={},this.__usedUidCache={},this.__mode=t.mode,n=e.component,i=e.layout,delete e.component,delete e.layout,this.attributes=$.extend(!0,{agent:{enabled:!1,module:{repo:$.cookie("mod_repo"),tag:$.cookie("mod_tag")}}},e),e.component=n,e.layout=i,(e.version||"").split("-").length<3&&(this.attributes.version="2013-09-13"),this.__shoulddraw=!1,this.save(e),this.on(r.EVENT.AwsResourceUpdated,this.onAwsResourceUpdated),null},a=function(){},r.TYPE={Classic:"ec2-classic",Vpc:"ec2-vpc",DefaultVpc:"default-vpc",CustomVpc:"custom-vpc"},r.MODE={Stack:"stack",App:"app",AppEdit:"appedit",AppView:"appview"},r.EVENT={AddResource:"ADD_RESOURCE",RemoveResource:"REMOVE_RESOURCE",Deserialized:"DESERIALIZED",AwsResourceUpdated:"AWS_RESOURCE_UPDATED"},i.prototype.refreshAppUpdate=function(){var n;return n=[t.AWS_RESOURCE_TYPE.AWS_AutoScaling_Group],this.eachComponent(function(t){var r;if(r=t.type,e.call(n,r)>=0)return t.draw()}),null},i.prototype.deserialize=function(e,t){var n,i,s,u,f,l,c,h,p,d,v,m;void 0,h=this.get("version"),m=r.__deserializeVisitors;for(p=0,d=m.length;p<d;p++)s=m[p],s(e,t,h);r.trigger=a,l=this,f=function(n){var i,s,o;if(!n)return null;o=l.__componentMap[n];if(o)return o;u.check(n),s=e[n];if(!s){void 0;return}i=r.modelClassForType(s.type);if(!i){void 0;return}return i.deserialize(s,t[n],f),r.__instance.__componentMap[n]},v=this.component,this.component=null;for(c in e){i=e[c],this.__usedUidCache[c]=!0;if(r.__resolveFirstMap[i.type]===!0){n=r.modelClassForType(i.type);if(!n){void 0;continue}if(!n.preDeserialize){void 0;continue}n.preDeserialize(i,t[c])}}this.component=f;for(c in e)i=e[c],r.__resolveFirstMap[i.type]===!0?(u=o(c),r.modelClassForType(i.type).deserialize(i,t[c],f)):(u=o(),f(c));this.component=v;for(c in e)i=e[c],n=r.modelClassForType(i.type),n&&n.postDeserialize&&n.postDeserialize(i,t[c]);return null},i.prototype.finishDeserialization=function(){var e,t,n,i,s,o;this.__shoulddraw=!0,t=[],o=this.__componentMap;for(n in o){e=o[n];if(!e.draw)continue;e.node_line?t.push(e):e.draw(!0)}for(i=0,s=t.length;i<s;i++)e=t[i],e.draw(!0);return r.trigger=Backbone.Events.trigger,r.trigger(r.EVENT.Deserialized),this.save(),null},r.registerModelClass=function(e,t,n){return this.__modelClassMap[e]=t,n&&(this.__resolveFirstMap[e]=n),null},i.prototype.classCacheForCid=function(e){var t;return this.__classCache[e]?this.__classCache[e]:(t=this.__classCache[e]=[],t)},i.prototype.cacheComponent=function(e,t){return t?(this.__componentMap[e]=t,t.isVisual&&t.isVisual()&&(t.node_group?this.__canvasGroups[e]=t:t.node_line?this.__canvasLines[e]=t:this.__canvasNodes[e]=t)):(t=this.__componentMap,delete this.__componentMap[e],delete this.__canvasGroups[e],delete this.__canvasNodes[e],this.modeIsAppEdit()&&this.reclaimGuid(e)),null},r.registerSerializeVisitor=function(e){return this.__serializeVisitors.push(e),null},r.registerDeserializeVisitor=function(e){return this.__deserializeVisitors.push(e),null},r.instance=function(){return this.__instance},r.modelClassForType=function(e){return this.__modelClassMap[e]},r.modelClassForPorts=function(e,t){var n;return e<t?n=e+">"+t:n=t+">"+e,this.__modelClassMap[n]},i.prototype.reclaimGuid=function(e){return delete this.__usedUidCache[e]},i.prototype.guid=function(){var e;e=MC.guid();while(this.__usedUidCache[e])void 0,e=MC.guid();return this.__usedUidCache[e]=!0,e},i.prototype.get=function(e){return this.attributes[e]},i.prototype.set=function(e,t){return this.attributes[e]=t,null},i.prototype.region=function(){return this.attributes.region},i.prototype.mode=function(){return void 0,this.__mode},i.prototype.modeIsStack=function(){return this.__mode===r.MODE.Stack},i.prototype.modeIsApp=function(){return this.__mode===r.MODE.App},i.prototype.modeIsAppView=function(){return this.__mode===r.MODE.AppView},i.prototype.modeIsAppEdit=function(){return this.__mode===r.MODE.AppEdit},i.prototype.setMode=function(e){return this.__mode=e,null},i.prototype.type=function(){return this.attributes.platform},i.prototype.typeIsClassic=function(){return this.attributes.platform===r.TYPE.Classic},i.prototype.typeIsDefaultVpc=function(){return this.attributes.platform===r.TYPE.DefaultVpc},i.prototype.typeIsVpc=function(){return this.attributes.platform===r.TYPE.Vpc||this.attributes.platform===r.TYPE.CustomVpc},i.prototype.shouldDraw=function(){return this.__shoulddraw},i.prototype.use=function(){return r.__instance=this,this},i.prototype.component=function(e){return this.__componentMap[e]},i.prototype.eachComponent=function(e,t){var n,r,i;void 0,t=t||this,i=this.__componentMap;for(r in i){n=i[r];if(e.call(t,n)===!1)break}return null},i.prototype.save=function(e){this.__backingStore=e?e:this.serialize()},i.prototype.isModified=function(e){var t,n,i,s,o;if(r.instance().modeIsApp())return!1;this.__backingStore.id=(e||this.attributes).id,o=e||this.attributes;for(n=i=0,s=o.length;i<s;n=++i){t=o[n];if(!_.isEqual(this.__backingStore[t],n))return!1}if(!e){e=this.serialize();if(_.isEqual(this.__backingStore.component,e.component)&&_.isEqual(this.__backingStore.layout,e.layout))return!1}return!0},i.prototype.serialize=function(){var e,t,n,i,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N;o=r.instance(),this.use(),void 0,n={},c={},i=[],h=[];try{T=this.__componentMap;for(v in T){t=T[v];if(t.isRemoved()){void 0;continue}if(t.node_line){i.push(t);continue}l=t.serialize();if(!l)continue;_.isArray(l)||(h[0]=l,l=h);for(y=0,E=l.length;y<E;y++)f=l[y],f.component&&(void 0,void 0,n[f.component.uid]=f.component),f.layout&&(c[f.layout.uid]=f.layout)}for(b=0,S=i.length;b<S;b++)e=i[b],p=e.port1Comp(),d=e.port2Comp(),p&&d&&!p.isRemoved()&&!d.isRemoved()?e.serialize(n,c):void 0}catch(C){a=C,void 0}u=$.extend(!0,{},this.attributes),u.component=n,u.layout=c,m=u.version,N=r.__serializeVisitors;for(w=0,x=N.length;w<x;w++)g=N[w],g(n,c,m);return u.layout.size=this.canvas.sizeAry,u.property=$.extend({stoppable:this.isStoppable()},s),u.version="2014-02-17",o.use(),u},i.prototype.getCost=function(){var e,t,n,r,i,s,o,u,a,f,l,c;r=[],u=0,s=MC.data.config[this.region()];if(s&&s.price){o=s.price,i=s.price.currency||"USD",c=this.__componentMap;for(a in c){t=c[a];if(t.getCost){n=t.getCost(o,i);if(!n)continue;if(n.length)for(f=0,l=n.length;f<l;f++)e=n[f],u+=e.fee,r.push(e);else u+=n.fee,r.push(n)}}r=_.sortBy(r,"resource")}return{costList:r,totalFee:Math.round(u*100)/100}},u=function(e,t,n,i,s){var o,u,a,f;u=e||t,o=r.modelClassForType(u.type);if(o.diffJson){try{f=o.diffJson(e,t,i,s)}catch(l){a=l,void 0,f=null}f&&(f.id?n.push(f):void 0);return}return u={type:u.type,name:u.name,id:u.uid},e?t?_.isEqual(e.resource,t.resource)||(u.change="Update"):u.change="Create":u.change="Delete",u.change&&n.push(u),null},i.prototype.diff=function(){var e,n,r,i,s,o,a,f;r=this.serialize(),i=this.__backingStore,n=!_.isEqual(r.component,i.component),s=[],a=r.component;for(o in a)e=a[o],u(e,i.component[o],s,r.component,i.component);f=i.component;for(o in f){e=f[o];if(r.component[o])continue;u(void 0,e,s,r.component,i.component)}return{result:s,isRunning:r.state===t.APP_STATE.APP_STATE_RUNNING,isModified:n||!_.isEqual(i.layout,r.layout)}},i.prototype.isStoppable=function(){var e,n,i,s,o,u,a;e=r.modelClassForType(t.AWS_RESOURCE_TYPE.AWS_EC2_Instance),n=r.modelClassForType(t.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration),i=e.allObjects().concat(n.allObjects());for(u=0,a=i.length;u<a;u++){o=i[u],s=o.getAmi()||o.get("cachedAmi");if(s&&s.rootDeviceType==="instance-store")return!1}return!0},i.prototype.onAwsResourceUpdated=function(){var e,t,n;if(this.modeIsStack())return;n=this.__componentMap;for(t in n){e=n[t];if(e.node_line||e.node_group)continue;e.draw&&e.draw()}return null},i.prototype.clearResourceInCache=function(){var e,t,n,i;n=MC.data.resource_list[this.region()];if(!n)return;this.eachComponent(function(e){var t,r,i,s,o,u;t=e.get("appId");if(t&&t.indexOf(":autoScalingGroup:")>0&&n[t]){i=n[t].Instances,i.member&&(i=i.member);for(r=o=0,u=i.length;o<u;r=++o)s=i[r],_.isString(s)?delete n[s]:delete n[s.InstanceId]}return delete n[t]}),i=n.Subscriptions,e=0;while(i&&e<i.length)i[e].TopicArn.indexOf(r.instance().get("id"))>0?i.splice(e,1):e++;t=n.NotificationConfigurations,e=0;while(t&&e<t.length)t[e].TopicARN.indexOf(r.instance().get("id"))>0?t.splice(e,1):e++;return void 0,null},_.extend(i.prototype,Backbone.Events),i.prototype.on=function(e){if(e===r.EVENT.AwsResourceUpdated&&this.modeIsStack())return;return Backbone.Events.on.apply(this,arguments)},n.setDesign(r),r})}.call(this),function(){define("module/design/framework/ResourceModel",["Design","event","backbone"],function(e,t){var n,r,i,s;return r=function(e){var t,n,i,s,o,u,a;if(e===null||!_.isObject(e))return e;if(_.isArray(e)){s=[];for(n=u=0,a=e.length;u<a;n=++u)t=e[n],s[n]=r(t);return s}s={};for(i in e)o=e[i],o!==null&&_.isObject(o)?s[i]=r(o):s[i]=o;return s},i=Backbone.Model.extend,s={},n=Backbone.Model.extend({classId:_.uniqueId("dfc_"),type:"Framework_R",constructor:function(t,n){var r;return r=e.instance(),this.__design=r,t||(t={}),t.id||(t.id=r.guid()),t.name||(t.name=this.getNewName(),t.name||delete t.name),r.classCacheForCid(this.classId).push(this),r.cacheComponent(t.id,this),Backbone.Model.call(this,t,n||s),this.attributes.name||(this.attributes.name=""),this.attributes.appId||(this.attributes.appId=""),e.trigger(e.EVENT.AddResource,this),this},getNewName:function(t){var n,r,i;if(!this.newNameTmpl)return i=this.defaults?this.defaults.name:void 0,i||"";t===void 0&&(n=e.modelClassForType(this.type).allObjects(),t=n.length),r={},this.design().eachComponent(function(e){return e.get("name")&&(r[e.get("name")]=!0),null});for(;;){i=this.newNameTmpl+t;if(!r[i])break;t+=1}return i},hasAppResource:function(){return!e.instance().modeIsStack()&&this.get("appId")?!!this.get("appId")&&MC.data.resource_list[e.instance().region()][this.get("appId")]:!0},isDesignAwake:function(){return e.instance()===this.__design},design:function(){return this.__design},getAllObjects:function(e){return e||(e=this.type),this.design().classCacheForCid(this.prototype.classId).slice(0)},markAsRemoved:function(e){return e===void 0?this.__isRemoved=!0:this.__isRemoved=!!e,null},isRemoved:function(){return this.__isRemoved===!0},isRemovable:function(){return!0},isReparentable:function(){return!0},serialize:function(){return void 0,null},destroy:function(){return this.remove()},remove:function(){var t,n;if(this.isRemoved()){void 0;return}return this.__isRemoved=!0,void 0,n=e.instance(),t=n.classCacheForCid(this.classId),t.splice(t.indexOf(this),1),n.cacheComponent(this.id),this.stopListening(),this.trigger("destroy",this),this.trigger("__remove"),this.off(),this.__design=null,e.trigger(e.EVENT.RemoveResource,this),null},createRef:function(e,t,n){return _.isString(t)&&(n=t,t=!0),n=n||this.id,n?t!==!1?MC.aws.aws.genResRef(n,"resource."+e):MC.aws.aws.genResRef(n,""+e):""},listenTo:function(t,n,r){var i,s;return i=e.modelClassForType(t.type),i&&(!this._listeners||!this._listeners[t._listenerId])&&(s=this,t.once("__remove",function(){return s.stopListening(this)})),Backbone.Events.listenTo.call(this,t,n,r)},associate:function(e,t){var r,i,s,o,u,a,f,l,c,h,p,d,v,m;this.__asso||(this.__asso=[]);if(e instanceof n)f=e,this.addToStorage(f),f.addToStorage(this);else if(_.isFunction(e))if(t)f=e(t),this.associate(f);else{m=this.__asso;for(l=0,p=m.length;l<p;l++){s=m[l],u=s.key.split("."),a=u.pop(),i=this.get(u);for(c=0,d=u.length;c<d;c++)o=u[c],i=i[o];_.isString(i)&&(i=[i]);if(_.isArray(i)){for(h=0,v=i.length;h<v;h++)r=i[h],t=MC.extractID(r),f=e(t),f&&this.associate(f);u.length||this.unset(s.key)}}}return null},disassociate:function(e){var t,n,r,i,s;n=this.removeFromStorage(e),s=[];for(r=0,i=n.length;r<i;r++)t=n[r],s.push(t.removeFromStorage(this));return s},clone:null,cloneAttributes:function(t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,m;void 0,n=n||{},u=n.reserve||"",a="id|appId|x|y|width|height|name",o=n.copyConnection||[],v=t.attributes;for(i in v){l=v[i];if(i.indexOf("__")===0||a.indexOf(i)!==-1||u.indexOf(i)!==-1)continue;l!==null&&_.isObject(l)&&(l=this.cloneObjectAttributes(i,l)),this.attributes[i]=l}for(c=0,p=o.length;c<p;c++){s=o[c],r=e.modelClassForType(s),m=t.connectionTargets(s);for(h=0,d=m.length;h<d;h++)f=m[h],new r(f,this)}return null},cloneObjectAttributes:function(e,t){return r(t)},storage:function(){return this.__storage||(this.__storage=new Backbone.Collection),this.__storage},getFromStorage:function(e){var t,n;return n=this.storage(),_.isString(e)?t=_.filter(n.models,function(t){return t.type===e}):_.isFunction(e)?t=_.filter(n.models,e):t=n.models,new Backbone.Collection(t)},removeFromStorage:function(e){var t,r;return r=this.storage(),_.isString(e)?t=_.filter(r.models,function(t){return t.type===e}):_.isFunction(e)?t=_.filter(r.models,e):e instanceof n&&(t=e),t?r.remove(t):r.reset(),t},addToStorage:function(e){var t;return t=this.storage(),t.add(e),null}},{allObjects:function(){return e.instance().classCacheForCid(this.prototype.classId).slice(0)},deserialize:function(){return void 0,null},extend:function(t,n){var r,s,o,u,a,f;void 0,n&&(r=n.handleTypes,s=n.resolveFirst,delete n.handleTypes,delete n.resolveFirst),t.classId=_.uniqueId("dfc_"),o=i.call(this,t,n),r||(r=t.type);if(r){_.isString(r)&&(r=[r]);for(a=0,f=r.length;a<f;a++)u=r[a],e.registerModelClass(u,o,s)}return o}}),e.registerModelClass(n.prototype.type,n),n})}.call(this),function(){define("module/design/framework/ConnectionModel",["./ResourceModel","Design","CanvasManager","./canvasview/CanvasElement"],function(e,t,n,r){var i;return i=e.extend({node_line:!0,type:"Framework_CN",constructor:function(n,r,i,s){var o,u,a,f,l,c;if(!n||!r){void 0;return}if(!s||s.detectDuplicate!==!1){u=t.modelClassForType(this.type).allObjects(),o=t.modelClassForType(this.type).findExisting(n,r);if(o)return void 0,i&&o.set(i),o}if(!this.assignCompsToPorts(n,r)){void 0;return}e.call(this,i,s);if(this.__destroyAfterInit)return this.remove(this),this.id="",this;this.__port1Comp.connect_base(this),this.__port1Comp!==this.__port2Comp&&this.__port2Comp.connect_base(this);if(this.oneToMany){void 0,a=this.getOtherTarget(this.oneToMany),c=a.connections(this.type);for(f=0,l=c.length;f<l;f++)o=c[f],o!==this&&o.remove(this)}return this.draw&&this.draw(),this},setDestroyAfterInit:function(){return this.__destroyAfterInit=!0,null},assignCompsToPorts:function(e,t){var n,r,i,s;if(this.portDefs){s=this.portDefs;for(r=0,i=s.length;r<i;r++){n=s[r];if(n.port1.type===e.type&&n.port2.type===t.type){this.__portDef=n,this.__port1Comp=e,this.__port2Comp=t;break}if(n.port1.type===t.type&&n.port2.type===e.type){this.__portDef=n,this.__port1Comp=t,this.__port2Comp=e;break}}return!!this.__portDef}return this.__port1Comp=e,this.__port2Comp=t,!0},port:function(e,t){return this.__portDef?this.__port1Comp===e||this.__port1Comp.id===e?this.__portDef.port1[t]:this.__port2Comp===e||this.__port2Comp.id===e?this.__portDef.port2[t]:"":""},port1:function(e){return this.__portDef?this.__portDef.port1[e]:""},port2:function(e){return this.__portDef?this.__portDef.port2[e]:""},connectsTo:function(e){return this.__port1Comp&&this.__port1Comp.id===e||this.__port2Comp&&this.__port2Comp.id===e},port1Comp:function(){return this.__port1Comp},port2Comp:function(){return this.__port2Comp},getOtherTarget:function(e){return _.isString(e)?this.__port1Comp.type===e?this.__port2Comp:this.__port1Comp:this.__port1Comp===e?this.__port2Comp:this.__port1Comp},getTarget:function(e){return this.__port1Comp.type===e?this.__port1Comp:this.__port2Comp.type===e?this.__port2Comp:null},remove:function(t){var n,r,i;return void 0,n=!this.__port1Comp.isRemoved(),r=!this.__port2Comp.isRemoved(),n&&this.__port1Comp.attach_connection(this,!0),r&&this.__port2Comp.attach_connection(this,!0),n&&this.__port1Comp.disconnect_base(this,t),r&&this.__port2Comp.disconnect_base(this,t),i=this.__view,i&&i.detach(),e.prototype.remove.call(this),null},serialize:function(){return null},getCanvasView:function(){return this.isVisual()?(this.__view===void 0&&(this.__view=r.createView("Line",this)),this.__view):null},isVisual:function(){return!!this.portDefs},draw:function(e){var n;if(!t.instance().shouldDraw())return;return n=this.getCanvasView(),n&&n.draw(e===!0),null}},{findExisting:function(e,t){var n,r,i,s;s=this.allObjects();for(r=0,i=s.length;r<i;r++){n=s[r];if(n.port1Comp()===e&&n.port2Comp()===t&&!n.isRemoved())return n;if(n.port2Comp()===e&&n.port1Comp()===t&&!n.isRemoved())return n}return null},extend:function(n,r){var i,s,o,u,a,f,l,c,h,p;u=[];if(n.portDefs){_.isArray(n.portDefs)||(n.portDefs=[n.portDefs]),p=n.portDefs;for(f=0,c=p.length;f<c;f++)s=p[f],s.port1.name>s.port2.name&&(a=s.port1,s.port1=s.port2,s.port2=a),u.push(s.port1.name+">"+s.port2.name);n.type||(n.type=u[0])}i=e.extend.call(this,n,r);for(l=0,h=u.length;l<h;l++)o=u[l],t.registerModelClass(o,i);return t.registerModelClass(n.type,i),i},isConnectable:function(e,t){return!0}}),i})}.call(this),function(){define("module/design/framework/connection/EniAttachment",["constant","../ConnectionModel","i18n!nls/lang.js"],function(e,t,n){var r;return r=t.extend({type:"EniAttachment",defaults:{lineType:"attachment",index:1},initialize:function(t){var n;return n=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_EC2_Instance),t&&t.index?this.ensureAttachmentOrder():this.attributes.index=n.connectionTargets("EniAttachment").length+1,null},ensureAttachmentOrder:function(){var t,n,r,i,s,o,u,a,f,l,c,h,p,d;t=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_EC2_Instance),i=t.connections("EniAttachment");for(a=0,c=i.length;a<c;a++){r=i[a];if(r!==this&&r.attributes.index===this.attributes.index){for(o=f=0,h=i.length;f<h;o=++f)r=i[o],r.attributes.index=o+1,r.getOtherTarget(t).updateName();return}}u=i.sort(function(e,t){return e.attributes.index-t.attributes.index});if(i.indexOf(this)!==u.indexOf(this)){n=[],d=t.get("__connections");for(l=0,p=d.length;l<p;l++)s=d[l],s.type!=="EniAttachment"&&n.push(s);t.attributes.__connections=n.concat(u)}return null},remove:function(){var n,r,i,s,o,u;t.prototype.remove.apply(this,arguments),r=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_EC2_Instance),o=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface);if(!r.isRemoved()){s=r.connections("EniAttachment"),u=1;while(u<=s.length)i=s[u-1],i.attributes.index!==u&&(i.attributes.index=u,i.getTarget(e.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface).updateName()),++u}return!r.isRemoved()&&!o.isRemoved()&&(n=Design.modelClassForType(e.AWS_RESOURCE_TYPE.AWS_EC2_SecurityGroup),n.tryDrawLine(r,o)),null},portDefs:{port1:{name:"instance-attach",type:e.AWS_RESOURCE_TYPE.AWS_EC2_Instance},port2:{name:"eni-attach",type:e.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface}}},{isConnectable:function(t,r){var i,s,o,u,a;return u=t.parent(),a=r.parent(),u.type===e.AWS_RESOURCE_TYPE.AWS_VPC_Subnet&&(u=u.parent(),a=a.parent()),u!==a?!1:(t.type===e.AWS_RESOURCE_TYPE.AWS_EC2_Instance?(s=t,i=r):(s=r,i=t),i.connections("EniAttachment").length>0?!1:(o=s.getMaxEniCount(),s.connections("EniAttachment").length+1>=o?sprintf(n.ide.CVS_WARN_EXCEED_ENI_LIMIT,s.get("name"),s.get("instanceType"),o):s.getEmbedEni().get("assoPublicIp")===!0?{confirm:MC.template.modalAttachingEni({host:s.get("name"),eni:i.get("name")}),action:"Attach and Remove Public IP"}:!0))}}),r})}.call(this),function(){define("module/design/framework/connection/VPNConnection",["constant","../ConnectionModel"],function(e,t){var n;return n=t.extend({type:e.AWS_RESOURCE_TYPE.AWS_VPC_VPNConnection,defaults:function(){return{lineType:"vpn",routes:[]}},portDefs:{port1:{name:"vgw-vpn",type:e.AWS_RESOURCE_TYPE.AWS_VPC_VPNGateway},port2:{name:"cgw-vpn",type:e.AWS_RESOURCE_TYPE.AWS_VPC_CustomerGateway}},serialize:function(t){var n,r,i;return i=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_VPC_VPNGateway),n=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_VPC_CustomerGateway),n.isDynamic()?r=[]:r=_.map(this.get("routes"),function(e){return{DestinationCidrBlock:e}}),t[this.id]={name:"vpn:"+n.get("name"),type:this.type,uid:this.id,resource:{CustomerGatewayId:n.createRef("CustomerGatewayId"),Options:{StaticRoutesOnly:!n.isDynamic()},Type:"ipsec.1",Routes:r,VpnConnectionId:this.get("appId"),VpnGatewayId:i.createRef("VpnGatewayId")}},null}},{handleTypes:e.AWS_RESOURCE_TYPE.AWS_VPC_VPNConnection,deserialize:function(e,t,r){var i,s;i=r(MC.extractID(e.resource.CustomerGatewayId)),s=r(MC.extractID(e.resource.VpnGatewayId));if(!i||!s)return;return new n(i,s,{id:e.uid,appId:e.resource.VpnConnectionId,routes:_.map(e.resource.Routes,function(e){return e.DestinationCidrBlock})})}}),n})}.call(this),function(){define("module/design/framework/ComplexResModel",["Design","CanvasManager","./ResourceModel","constant","./canvasview/CanvasElement"],function(e,t,n,r,i){var s,o;return o=[],s=n.extend({type:"Framework_CR",constructor:function(e,t){return e&&e.parent&&(e.__parent=e.parent,delete e.parent),n.call(this,e,t),e&&e.__parent&&(this.attributes.__parent=null,e.__parent.addChild(this)),null},initialize:function(){return this.draw&&e.instance().shouldDraw()&&this.draw(!0),null},setName:function(e){if(this.get("name")===e)return;return this.set("name",e),this.draw&&this.draw(),null},remove:function(){var e,t,r;this.markAsRemoved(),e=this.attributes.__connections;if(e){t=e.length;while(t)--t,e[t].remove()}return r=this.getCanvasView(),r&&r.detach(),this.markAsRemoved(!1),n.prototype.remove.call(this),null},attach_connection:function(e,t){var n,r;return n=this.get("__connections")||[],r=n.indexOf(e),t?r!==-1&&n.splice(r,1):r===-1&&(n.push(e),this.set("__connections",n)),null},connect_base:function(e){return this.attach_connection(e),this.connect&&this.connect(e),null},disconnect_base:function(e,t){return this.attach_connection(e,!0),this.disconnect&&this.disconnect(e,t),null},isVisual:function(){return!0},getCanvasView:function(){return this.__view===void 0&&this.isVisual()&&(this.__view=i.createView(this.type,this)),this.__view},draw:function(t){var n,r;if(!this.isVisual()||!e.instance().shouldDraw())return;r=this.getCanvasView();if(r){n=arguments,n[0]=n[0]===!0,t&&(r.nodeCreated=!0);if(!t&&!r.nodeCreated)return;r.draw.apply(r,n)}return null},connections:function(e){var t;return t=this.get("__connections"),t&&_.isString(e)&&(t=_.filter(t,function(t){return t.type===e})),t||o},connectionTargets:function(e){var t,n,r,i,s;r=[],n=this.get("__connections");if(n)for(i=0,s=n.length;i<s;i++)t=n[i],(!e||t.type===e)&&r.push(t.getOtherTarget(this));return r},getSubnetRef:function(){var t,n;if(e.instance().typeIsClassic())return"";if(e.instance().typeIsDefaultVpc()){n=this;while(n){if(n.type===r.AWS_RESOURCE_TYPE.AWS_EC2_AvailabilityZone)break;n=n.parent()}if(n){t=MC.data.account_attribute[e.instance().region()].default_subnet[n.get("name")];if(t)return t.subnetId||""}return""}n=this;while(n){if(n.type===r.AWS_RESOURCE_TYPE.AWS_VPC_Subnet)break;n=n.parent()}return n?n.createRef("SubnetId"):""},getVpcRef:function(){var t,n,i,s,o,u;if(e.instance().typeIsClassic())return"";if(e.instance().typeIsDefaultVpc()){s=this;while(s){if(s.type===r.AWS_RESOURCE_TYPE.AWS_EC2_AvailabilityZone)break;s=s.parent()}if(s){n=MC.data.account_attribute[e.instance().region()].default_subnet[s.get("name")];if(n)return n.vpcId||""}else{u=MC.data.account_attribute[e.instance().region()].default_subnet;for(o in u){i=u[o];if(i.vpcId)return i.vpcId}}return""}s=this;while(s){if(s.type===r.AWS_RESOURCE_TYPE.AWS_VPC_VPC)break;s=s.parent()}return s||(t=e.modelClassForType(r.AWS_RESOURCE_TYPE.AWS_VPC_VPC),s=t.theVPC()),s?s.createRef("VpcId"):""},generateLayout:function(){var e;return e={coordinate:[this.x(),this.y()],uid:this.id},this.parent()&&(e.groupUId=this.parent().id),e},parent:function(){return this.attributes.__parent||null},x:function(){return this.attributes.x||0},y:function(){return this.attributes.y||0},width:function(){return this.attributes.width||0},height:function(){return this.attributes.height||0}},{extend:function(t,r){return t.draw&&(t.draw=function(){var n;return n=t.draw,function(){if(e.instance().shouldDraw())return n.apply(this,arguments)}}()),n.extend.call(this,t,r)}}),s})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define("module/design/framework/resource/InstanceModel",["../ComplexResModel","Design","constant","i18n!nls/lang.js"],function(t,n,r,i){var s,o;return o=[],s=t.extend({type:r.AWS_RESOURCE_TYPE.AWS_EC2_Instance,newNameTmpl:"host-",defaults:{x:2,y:2,width:9,height:9,count:1,imageId:"",tenancy:"default",ebsOptimized:!1,instanceType:"m1.small",monitoring:!1,userData:"",rdSize:0,rdIops:0,cachedAmi:null,state:void 0},initialize:function(e,t){var i,s,o,u,a,f,l,c,h;return t=t||{},t.createByUser&&!n.instance().typeIsClassic()&&(i=n.modelClassForType(r.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface),this.setEmbedEni(new i({name:"eni0",assoPublicIp:n.instance().typeIsDefaultVpc()},{instance:this}))),t.cloneSource?this.clone(t.cloneSource):t.createByUser&&this.initInstanceType(),this.get("rdSize")||(c=this.getAmiRootDeviceVolumeSize(),c>0&&this.set("rdSize",c)),this.draw(!0),t.createByUser&&!t.cloneSource&&(s=n.modelClassForType(r.AWS_RESOURCE_TYPE.AWS_EC2_KeyPair),a=s.getDefaultKP(),a?a.assignTo(this):void 0,u=n.modelClassForType(r.AWS_RESOURCE_TYPE.AWS_EC2_SecurityGroup),f=u.getDefaultSg(),f?(o=n.modelClassForType("SgAsso"),new o(this,f)):void 0),l=this.get("tenancy"),h=n.modelClassForType(r.AWS_RESOURCE_TYPE.AWS_VPC_VPC).theVPC(),h&&!h.isDefaultTenancy()&&(l="dedicated"),this.setTenancy(l),null},groupMembers:function(){return this.__groupMembers||(this.__groupMembers=[]),this.__groupMembers},getAvailabilityZone:function(){var e;return e=this.parent(),e.type===r.AWS_RESOURCE_TYPE.AWS_VPC_Subnet?e.parent():e},getDetailedOSFamily:function(){var t,n,i,s,o,u,a,f;t=this.getAmi()||this.get("cachedAmi");if(!t||!t.osType||!t.osFamily)return void 0,"linux";u=t.osType,o=t.osFamily,r.OS_TYPE_MAPPING[u]&&(o=r.OS_TYPE_MAPPING[u]);if(e.call(r.WINDOWS,u)>=0){o="mswin",f=/sql.*?web.*?/,a=/sql.*?standard.*?/,s=t.name||"",n=t.description||"",i=t.imageLocation||"";if(s.match(f)||n.match(f)||i.match(f))o="mswinSQLWeb";else if(s.match(a)||n.match(a)||i.match(a))o="mswinSQL"}return o},initInstanceType:function(){var e,t,n,r,i,s;e=this.getAmi();if(e&&e.instance_type){n=e.instance_type.replace(/\s/g,"").split(",");for(i=0,s=n.length;i<s;i++){t=n[i];if(t!=="t1.micro"){r=t;break}}}return this.attributes.instanceType=r||"m1.small",null},getCost:function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v,m;if(!e.instance)return null;n=this.getAmi()||this.get("cachedAmi"),l=n?n.osType:"linux-other",f=this.getDetailedOSFamily(),u=this.get("instanceType").split("."),p=e.instance.unit,s=e.instance[u[0]][u[1]],s=s?s.onDemand:void 0,s&&(s[f]===void 0&&f.indexOf("mswin")===0&&(f="mswin"),s=s[f]),s=s?s[t]:void 0;if(!s)return null;p==="perhr"?(o=s+"/hr",s*=720):o=s+"/mo",r=this.get("count")||1,a=this.get("name"),r>1&&(a+=" (x"+r+")",s*=r),c={resource:a,type:this.get("instanceType"),fee:s,formatedFee:o};if(this.get("monitoring")){m=e.cloudwatch.types;for(d=0,v=m.length;d<v;d++){h=m[d];if(h.ec2Monitoring)return s=h.ec2Monitoring[t],i={resource:this.get("name")+"-monitoring",type:"CloudWatch",fee:s*r,formatedFee:s+"/mo"},[c,i]}}return c},isReparentable:function(e){var t;return e.type===r.AWS_RESOURCE_TYPE.AWS_AutoScaling_Group?!1:(e.type===r.AWS_RESOURCE_TYPE.AWS_VPC_Subnet?e.parent()!==this.parent().parent()&&(t=!0):t=!0,t&&this.connectionTargets("EniAttachment").length>0?i.ide.CVS_MSG_ERR_MOVE_ATTACHED_ENI:!0)},connect:function(e){var t;if(e.type==="EniAttachment"){t=this.getEmbedEni();if(t)return t.set("assoPublicIp",!1)}},setPrimaryEip:function(e){var t;return t=this.getEmbedEni(),t?t.setPrimaryEip(e):(this.set("hasEip",e),e&&(this.attributes.eipData||(this.attributes.eipData={}),this.attributes.eipData.id||(this.attributes.eipData.id=MC.guid()))),this.draw()},hasPrimaryEip:function(){var e;return e=this.getEmbedEni(),e?e.hasPrimaryEip():this.get("hasEip")},hasAutoAssignPublicIp:function(){return this.getEmbedEni().get("assoPublicIp")},setCount:function(e){var t,n,r,i,s,o,u,a,f;this.set("count",e),e>1&&(r=this.connections("RTB_Route")[0],r&&r.remove()),this.draw(),a=this.connectionTargets("EniAttachment");for(i=0,o=a.length;i<o;i++){n=a[i];if(e>1){f=n.connections("RTB_Route");for(s=0,u=f.length;s<u;s++)t=f[s],t.remove()}n.draw()}return null},isDefaultTenancy:function(){var e,t;return e=n.modelClassForType(r.AWS_RESOURCE_TYPE.AWS_VPC_VPC),t=e.allObjects()[0],t&&!t.isDefaultTenancy()?!1:this.get("tenancy")!=="dedicated"},setAmi:function(e){var t,n,r,i;return this.set("imageId",e),t=this.getAmi(),n=this.get("cachedAmi"),t&&n&&(n.osType=t.osType,n.architecture=t.architecture,n.rootDeviceType=t.rootDeviceType),t.blockDeviceMapping&&(i=t.blockDeviceMapping[t.rootDeviceName],r=i?parseInt(i.volumeSize,10):10,this.get("rdSize")<r&&this.set("rdSize",r)),this.draw(),null},getAmi:function(){return MC.data.dict_ami[this.get("imageId")]},getBlockDeviceMapping:function(){var e,t;return e=this.getAmi()||this.get("cachedAmi"),e&&e.rootDeviceType==="ebs"&&e.blockDeviceMapping&&(t=[{DeviceName:e.rootDeviceName,Ebs:{SnapshotId:e.blockDeviceMapping[e.rootDeviceName].snapshotId,VolumeSize:this.get("rdSize")||e.blockDeviceMapping[e.rootDeviceName].volumeSize,VolumeType:"standard"}}],this.get("rdIops")&&parseInt(this.get("rdSize"),10)>=10&&(t[0].Ebs.Iops=this.get("rdIops"),t[0].Ebs.VolumeType="io1")),t||[]},getAmiRootDevice:function(){var e,t,n,r;return e=this.getAmi()||this.get("cachedAmi"),t=null,e&&e.rootDeviceType==="ebs"&&e.blockDeviceMapping&&(r=e.rootDeviceName,n=e.blockDeviceMapping[r],r&&n?(t={DeviceName:r,Ebs:{VolumeSize:Number(n.volumeSize),SnapshotId:n.snapshotId,VolumeType:n.volumeType}},n.volumeType==="io1"&&(t.Ebs.Iops=n.iops)):void 0),t},getAmiRootDeviceVolumeSize:function(){var e,t,n,r;return n=0,e=this.getAmi(),e?(e.osType==="windows"?r=30:r=10,t=this.getAmiRootDevice(),t?n=t.Ebs.VolumeSize:void 0):void 0,n},getAmiRootDeviceName:function(){var e;return e=this.getAmiRootDevice(),e&&e.DeviceName?e.DeviceName:""},getInstanceTypeConfig:function(e){var t,r;r=(e||this.get("instanceType")).split(".");if(r.length>=2){t=MC.data.config[n.instance().region()];if(t&&t.instance_type)return t.instance_type[r[0]][r[1]]}return null},getMaxEniCount:function(){var e;return e=this.getInstanceTypeConfig(),e&&(e=e.eni),e||16},isEbsOptimizedEnabled:function(){var e,t,r,i;return t=this.getAmi()||this.get("cachedAmi"),t&&t.rootDeviceType==="instance-store"?!1:(i=this.get("instanceType").split("."),r=MC.data.config[n.instance().region()].instance_type,r&&(r=r[i[0]]),r&&(r=r[i[1]]),r&&r.ebs_optimized?r.ebs_optimized==="Yes":(e={"m1.large":!0,"m1.xlarge":!0,"m2.2xlarge":!0,"m2.4xlarge":!0,"m3.xlarge":!0,"m3.2xlarge":!0,"c1.xlarge":!0,"c3.xlarge":!0,"c3.2xlarge":!0,"c3.4xlarge":!0,"g2.2xlarge":!0,"i2.xlarge":!0,"i2.2xlarge":!0,"i2.4xlarge":!0},!!e[this.get("instanceType")]))},setInstanceType:function(e){var t,r,i,s;e==="t1.micro"&&!this.isDefaultTenancy()&&(e="m1.small"),this.set("instanceType",e),this.isEbsOptimizedEnabled()||this.set("ebsOptimized",!1);if(this.getEmbedEni&&!n.instance().typeIsClassic()){r=this.connectionTargets("EniAttachment"),r.push(this.getEmbedEni());for(i=0,s=r.length;i<s;i++)t=r[i],t.limitIpAddress()}return null},setTenancy:function(e){return this.set("tenancy",e),e==="dedicated"&&this.get("instanceType")==="t1.micro"&&this.initInstanceType(),null},getInstanceTypeList:function(){var e,t,n;return t=MC.aws.ami.getInstanceType(this.getAmi()),t?(n=this.isDefaultTenancy(),e=this.get("instanceType"),_.map(t,function(t){return{main:r.INSTANCE_TYPE[t][0],ecu:r.INSTANCE_TYPE[t][1],core:r.INSTANCE_TYPE[t][2],mem:r.INSTANCE_TYPE[t][3],name:t,selected:e===t,hide:!n&&t==="t1.micro"}})):[]},remove:function(){var e,r,i,s,u,a,f,l;this.__mainEni&&this.__mainEni.remove(),f=(this.get("volumeList")||o).slice(0);for(i=0,u=f.length;i<u;i++)r=f[i],r.remove();if(n.instance().modeIsAppEdit()){l=this.connectionTargets("EniAttachment");for(s=0,a=l.length;s<a;s++)e=l[s],e.remove()}return t.prototype.remove.call(this),null},isRemovable:function(){var e;return e=this.get("state"),e!==void 0&&e.length>0||$("#state-editor-model").is(":visible")&&$("#state-editor-model .state-list .state-item").length>=1?MC.template.NodeStateRemoveConfirmation({name:this.get("name")}):!0},clone:function(e){var t,i,s,o,u,a,f,l,c;this.cloneAttributes(e,{reserve:"volumeList",copyConnection:["KeypairUsage","SgAsso","ElbAmiAsso"]}),l=this.get("state")||[];for(o=0,a=l.length;o<a;o++)i=l[o],i.id="state-"+this.design().guid();t=n.modelClassForType(r.AWS_RESOURCE_TYPE.AWS_EBS_Volume),c=e.get("volumeList")||[];for(u=0,f=c.length;u<f;u++)s=c[u],new t({owner:this},{cloneSource:s});return this.getEmbedEni().clone(e.getEmbedEni()),null},setEmbedEni:function(e){return this.__mainEni=e,null},getEmbedEni:function(){return this.__mainEni},getRealGroupMemberIds:function(){var e,t,n,r,i,s;this.ensureEnoughMember(),e=this.get("count"),n=[this.id],s=this.groupMembers();for(r=0,i=s.length;r<i;r++){t=s[r];if(n.length>=e)break;n.push(t.id)}return n},ensureEnoughMember:function(){var e;e=this.get("count")-1;while(this.groupMembers().length<e)this.groupMembers().push({id:MC.guid(),appId:"",eipData:{id:MC.guid()}});return null},generateJSON:function(){var e,t,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y;l=this.get("tenancy"),o=this.parent(),o.type===r.AWS_RESOURCE_TYPE.AWS_VPC_Subnet&&(h=o.parent().parent(),h.isDefaultTenancy()||(l="dedicated")),i=this.connectionTargets("KeypairUsage")[0],i=i?i.createRef("KeyName"):"",s=this.get("name"),this.get("count")>1&&(s+="-0"),u=[],a=[];if(n.instance().typeIsClassic()){g=this.connectionTargets("SgAsso");for(p=0,v=g.length;p<v;p++)f=g[p],u.push(f.createRef("GroupName")),a.push(f.createRef("GroupId"))}e=this.getBlockDeviceMapping(),y=this.get("volumeList")||[];for(d=0,m=y.length;d<m;d++)c=y[d],e.push("#"+c.id);return t={type:this.type,uid:this.id,name:s,index:0,number:this.get("count"),serverGroupUid:this.id,serverGroupName:this.get("name"),state:this.get("state"),resource:{UserData:{Base64Encoded:!1,Data:this.get("userData")},BlockDeviceMapping:e,Placement:{Tenancy:l==="dedicated"?"dedicated":"",AvailabilityZone:this.getAvailabilityZone().createRef()},InstanceId:this.get("appId"),ImageId:this.get("imageId"),KeyName:i,EbsOptimized:this.isEbsOptimizedEnabled()?this.get("ebsOptimized"):!1,VpcId:this.getVpcRef(),SubnetId:this.getSubnetRef(),Monitoring:this.get("monitoring")?"enabled":"disabled",NetworkInterface:[],InstanceType:this.get("instanceType"),DisableApiTermination:!1,ShutdownBehavior:"terminate",SecurityGroup:u,SecurityGroupId:a,PrivateIpAddress:""}},t},createEipJson:function(e,t){return t=t||this.id,{uid:e.id,type:r.AWS_RESOURCE_TYPE.AWS_EC2_EIP,index:0,name:"EIP",resource:{Domain:"standard",InstanceId:this.createRef("InstanceId",t),AllocationId:e.allocationId||"",NetworkInterfaceId:"",PrivateIpAddress:"",PublicIp:e.publicIp||""}}},getStateData:function(){return this.get("state")},setStateData:function(e){return this.set("state",e)},serialize:function(){var e,t,r,i,s,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,D,P,H;e=[],t=this.getAmi()||this.get("cachedAmi"),d=this.generateLayout(),t&&(d.osType=t.osType,d.architecture=t.architecture,d.rootDeviceType=t.rootDeviceType),e.push({layout:d}),p=[this.generateJSON()],l=p.length,this.ensureEnoughMember(),this.get("hasEip")&&!n.instance().typeIsVpc()&&e.push({component:this.createEipJson(this.get("eipData"))});while(l<this.get("count"))v=$.extend(!0,{},p[0]),v.name=this.get("name")+"-"+l,v.index=l,m=this.groupMembers()[p.length-1],v.uid=m.id,v.resource.InstanceId=m.appId,this.get("hasEip")&&!n.instance().typeIsVpc()&&(i=this.createEipJson(m.eipData,m.id),i.index=l,e.push({component:i})),++l,p.push(v);d.instanceList=_.map(p,function(e){return e.uid}),y={number:p.length,instanceId:""},E=this.get("volumeList")||o,a=this.getEmbedEni()?[this.getEmbedEni()]:[],P=this.connections("EniAttachment");for(x=0,k=P.length;x<k;x++)r=P[x],a[r.get("index")]=r.getOtherTarget(this);S=[],f=[];for(c=T=0,L=p.length;T<L;c=++T){h=p[c],y.instanceId=h.uid,y.instanceName=h.name+"-";for(N=0,A=E.length;N<A;N++)w=E[N],b=w.generateJSON(c,y),S.push(b);for(u=C=0,O=a.length;C<O;u=++C)s=a[u],f=f.concat(s.generateJSON(c,y,u))}H=p.concat(S).concat(f);for(D=0,M=H.length;D<M;D++)g=H[D],e.push({component:g});return e}},{handleTypes:r.AWS_RESOURCE_TYPE.AWS_EC2_Instance,getEffectiveId:function(e){var t,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S;s=n.instance();if(s.component(e))return{uid:e,mid:null};b=this.allObjects();for(c=0,v=b.length;c<v;c++){u=b[c];if(u.get("appId")===e)return{uid:u.id,mid:""+u.id+"_0"};if(u.groupMembers){w=u.groupMembers();for(o=h=0,m=w.length;h<m;o=++h){a=w[o];if(a&&a.appId===e)return{uid:u.id,mid:""+a.id+"_"+(o+1)}}}}l=MC.data.resource_list[s.region()],E=n.modelClassForType(r.AWS_RESOURCE_TYPE.AWS_AutoScaling_Group).allObjects();for(p=0,g=E.length;p<g;p++){t=E[p],i=l[t.get("appId")];if(!i||!i.Instances)continue;i=i.Instances,S=i.member||i;for(d=0,y=S.length;d<y;d++){f=S[d];if(f===e||f.InstanceId===e)return{uid:t.get("lc").id,mid:e}}}return{uid:null,mid:null}},diffJson:function(e,t){var n,r,i,s;r=e||t;if(r.index!==0)return;return n={id:r.uid,type:r.type,name:r.serverGroupName,changes:[]},e&&t&&!_.isEqual(e.resource,t.resource)&&n.changes.push({name:"Update"}),i=e?e.number:0,s=t?t.number:0,i>s?n.changes.push({name:"Create",count:i-s}):i<s&&(n.change="Terminate",n.changes.push({name:"Terminate",count:i-s})),e&&t&&(e.resource.InstanceType!==t.resource.InstanceType||e.resource.EbsOptimized!==t.resource.EbsOptimized||e.resource.UserData.Data!==t.resource.UserData.Data)&&(n.extra="Need to restart.",n.info="If the instance or instance group has been automatically assigned public IP, the IP will change after restart."),n.changes.length?n:null},deserialize:function(e,t,r){var i,o,u,a,f,l,c,h,p,d,v,m,g;if(e.serverGroupUid&&e.serverGroupUid!==e.uid){l=r(e.serverGroupUid).groupMembers();for(p=0,v=l.length;p<v;p++){f=l[p];if(f&&f.id===e.uid){void 0;return}}e.resource.EipResource&&(u={id:e.resource.EipResource.uid,allocationId:e.resource.EipResource.resource.AllocationId,publicIp:e.resource.EipResource.resource.PublicIp}),l[e.index-1]={id:e.uid,appId:e.resource.InstanceId,eipData:u||{id:MC.guid()}};return}h=e.resource.BlockDeviceMapping[0];if(!h||_.isString(h))h={Ebs:{VolumeSize:0,Iops:""}};o={id:e.uid,name:e.serverGroupName||e.name,appId:e.resource.InstanceId,count:e.number,imageId:e.resource.ImageId,tenancy:e.resource.Placement.Tenancy,ebsOptimized:e.resource.EbsOptimized,instanceType:e.resource.InstanceType,monitoring:e.resource.Monitoring!=="disabled",userData:e.resource.UserData.Data||"",rdSize:h.Ebs.VolumeSize,rdIops:h.Ebs.Iops,parent:r(t.groupUId),x:t.coordinate[0],y:t.coordinate[1],state:e.state},e.resource.EipResource&&(o.hasEip=!0,o.eipData={id:e.resource.EipResource.uid,allocationId:e.resource.EipResource.resource.AllocationId}),t.osType&&t.architecture&&t.rootDeviceType&&(t.osType==="win"&&(t.osType="windows"),o.cachedAmi={osType:t.osType,architecture:t.architecture,rootDeviceType:t.rootDeviceType}),c=new s(o),r(MC.extractID(e.resource.KeyName)).assignTo(c);if(n.instance().typeIsClassic()&&e.resource.SecurityGroup){i=n.modelClassForType("SgAsso"),g=e.resource.SecurityGroup;for(d=0,m=g.length;d<m;d++)a=g[d],new i(c,r(MC.extractID(a)))}return null}}),s})}.call(this),function(){define("module/design/framework/connection/SgAsso",["constant","../ConnectionModel","CanvasManager","Design"],function(e,t,n,r){var i;return i=t.extend({type:"SgAsso",initialize:function(){return r.instance().shouldDraw()&&(this.draw=this.updateLabel),this.listenTo(this.getTarget(e.AWS_RESOURCE_TYPE.AWS_EC2_SecurityGroup),"change:name",this.updateLabel),this.on("destroy",this.updateLabel),null},isVisual:function(){return!1},remove:function(){var n,s;t.prototype.remove.apply(this,arguments),s=this.getOtherTarget(e.AWS_RESOURCE_TYPE.AWS_EC2_SecurityGroup);if(s.isRemoved())return;return s=this.getOtherTarget(e.AWS_RESOURCE_TYPE.AWS_EC2_SecurityGroup),s.connections("SgAsso").length===0&&(n=r.modelClassForType(e.AWS_RESOURCE_TYPE.AWS_EC2_SecurityGroup).getDefaultSg(),n&&new i(s,n)),null},sortedSgList:function(){var t,n,r;return t=this.getOtherTarget(e.AWS_RESOURCE_TYPE.AWS_EC2_SecurityGroup),n=t.connections("SgAsso"),r=_.map(n,function(t){return t.getTarget(e.AWS_RESOURCE_TYPE.AWS_EC2_SecurityGroup)}),r.sort(function(e,t){var n,r;if(e.isDefault())return-1;if(t.isDefault())return 1;n=e.get("name"),r=t.get("name");if(n<r)return-1;if(n===r)return 0;if(n>r)return 1})},updateLabel:function(){var t,i,s,o,u,a,f,l;if(!r.instance().shouldDraw())return;o=this.getOtherTarget(e.AWS_RESOURCE_TYPE.AWS_EC2_SecurityGroup),s=document.getElementById(o.id);if(!s)return;u=this.sortedSgList(),l=$(s).children(".node-sg-color-group").children();for(i=a=0,f=l.length;a<f;i=++a)t=l[i],i<u.length?(n.update(t,u[i].color,"color"),n.update(t,u[i].get("name"),"tooltip")):(n.update(t,"none","color"),n.update(t,"","tooltip"));return null}}),r.on(r.EVENT.Deserialized,function(){var t,n,r,s,o,u;r={},u=i.allObjects();for(s=0,o=u.length;s<o;s++)t=u[s],r[t.getOtherTarget(e.AWS_RESOURCE_TYPE.AWS_EC2_SecurityGroup).id]=t;for(n in r)t=r[n],t.updateLabel();return null}),i})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define("module/design/framework/resource/EniModel",["../ComplexResModel","Design","../connection/SgAsso","../connection/EniAttachment","constant","i18n!nls/lang.js"],function(t,n,r,i,s,o){var u,a;return u=function(e){return e||(e={}),this.hasEip=e.hasEip||!1,this.autoAssign=e.autoAssign!==void 0?e.autoAssign:!0,this.ip=e.ip||"x.x.x.x",this.eipData=e.eipData||{id:MC.guid()},this.fixedIpInApp=e.fixedIpInApp||!1,null},a=t.extend({defaults:function(){return{sourceDestCheck:!0,description:"",ips:[],assoPublicIp:!1,name:"eni",x:0,y:0,width:9,height:9}},type:s.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface,constructor:function(e,n){return n&&n.instance&&(this.__embedInstance=n.instance),e.ips||(e.ips=[]),e.ips.length===0&&e.ips.push(new u),t.call(this,e,n)},initialize:function(e,t){var i;return t=t||{},this.draw(!0),t.createByUser&&!t.instance&&(i=n.modelClassForType(s.AWS_RESOURCE_TYPE.AWS_EC2_SecurityGroup).getDefaultSg(),r=n.modelClassForType("SgAsso"),new r(i,this)),t.cloneSource&&this.clone(t.cloneSource),null},clone:function(e){var t,n,r,i;this.cloneAttributes(e),i=this.get("ips");for(n=0,r=i.length;n<r;n++)t=i[n],t.ip="x.x.x.x",t.autoAssign=!0,t.eipData.id=this.design().guid();return null},groupMembers:function(){return this.__groupMembers||(this.__groupMembers=[]),this.__groupMembers},updateName:function(){var e,t,n;return n=this.attributes.name,t=this.__embedInstance,t?this.attributes.name="eni0":(e=this.connections("EniAttachment")[0],e?this.attributes.name="eni"+e.get("index"):this.attributes.name="eni"),this.attributes.name!==n&&this.draw(),null},isReparentable:function(e){var t;return e.type===s.AWS_RESOURCE_TYPE.AWS_VPC_Subnet?e.parent()!==this.parent().parent()&&(t=!0):t=!0,t&&this.connectionTargets("EniAttachment").length>0?o.ide.CVS_MSG_ERR_MOVE_ATTACHED_ENI:!0},isVisual:function(){return!this.__embedInstance},embedInstance:function(){return this.__embedInstance},attachedInstance:function(){var e,t;return e=this.__embedInstance,e||(t=this.connectionTargets("EniAttachment"),t.length&&(e=t[0])),e},serverGroupCount:function(){var e,t;return t=this.attachedInstance(),t&&(e=t.get("count")),e||1},maxIpCount:function(){var e,t;t=this.attachedInstance();if(t){e=t.getInstanceTypeConfig();if(e)return e.ip_per_eni}return 1},limitIpAddress:function(){var e,t;return e=this.attachedInstance(),e&&e.getInstanceTypeConfig()&&(t=this.maxIpCount(),this.get("ips").length>t&&(this.get("ips").length=t)),null},setPrimaryEip:function(e){if(!this.attachedInstance())return;return this.get("ips")[0].hasEip=e,this.draw(),null},hasPrimaryEip:function(){return this.attachedInstance()?this.get("ips")[0].hasEip:!1},hasEip:function(){return this.get("ips").some(function(e){return e.hasEip})},subnetCidr:function(){var e,t,n;return n=this.parent()||this.__embedInstance.parent(),n.type===s.AWS_RESOURCE_TYPE.AWS_VPC_Subnet?e=n.get("cidr"):(t=n.getSubnetOfDefaultVPC(),t&&(e=t.cidrBlock)),e},getIpArray:function(){var e,t,r,i,o,u,a,f,l,c,h;e=this.subnetCidr(),u=this.serverGroupCount()>1,f=n.modelClassForType(s.AWS_RESOURCE_TYPE.AWS_VPC_Subnet).genCIDRPrefixSuffix(e),o=[],h=this.get("ips");for(t=l=0,c=h.length;l<c;t=++l)r=h[t],a={hasEip:r.hasEip,autoAssign:r.autoAssign,editable:!u&&!r.fixedIpInApp,prefix:f[0]},a.autoAssign||u?a.suffix=f[1]:(i=r.ip.split("."),f[1]==="x.x"?a.suffix=i[2]+"."+i[3]:a.suffix=i[3]),a.ip=a.prefix+a.suffix,o.push(a);return o},getRealIp:function(e,t){var r,i,o;return e==="x.x.x.x"?e:(t||(t=this.subnetCidr()),t?(i=n.modelClassForType(s.AWS_RESOURCE_TYPE.AWS_VPC_Subnet).genCIDRPrefixSuffix(t),r=e.split("."),i[1]==="x.x"?o=i[0]+r[2]+"."+r[3]:o=i[0]+r[3],o):e)},isValidIp:function(e){var t,r,i,o,u,f,l,c,h,p,d;if(e.indexOf("x")!==-1)return!0;t=this.subnetCidr();if(!n.modelClassForType(s.AWS_RESOURCE_TYPE.AWS_VPC_Subnet).isIPInSubnet(e,t))return"This IP address conflicts with subnets IP range";u=this.getRealIp(e,t),p=a.allObjects();for(f=0,c=p.length;f<c;f++){r=p[f];if(!r.attachedInstance())continue;d=r.attributes.ips;for(l=0,h=d.length;l<h;l++){i=d[l];if(i.autoAssign)continue;o=r.getRealIp(i.ip);if(o===u)return r===this?"This IP address conflicts with other IP":"This IP address conflicts with other network interfaces IP"}}return!0},addIp:function(e,t,n,r){var i;return i=this.get("ips"),this.maxIpCount()<=i.length?!1:(t=new u({hasEip:!1,ip:"x.x.x.x",autoAssign:!0}),i=i.slice(0),i.push(t),this.set("ips",i),!0)},setIp:function(e,t,n,r){var i;return i=this.get("ips")[e],t!==void 0&&t!==null&&(i.ip=t),n!==void 0&&n!==null&&(i.autoAssign=n),r!==void 0&&r!==null&&r!==i.hasEip&&(i.hasEip=r,e===0&&(this.__embedInstance?this.__embedInstance.draw():this.draw())),null},removeIp:function(e){var t;t=this.get("ips");if(t.length<=1||e===0)return;return t=t.slice(0),t.splice(e,1),this.set("ips",t),null},canAddIp:function(){var e,t,n,r,i;return e=this.attachedInstance(),e?(n=this.maxIpCount(),t=this.get("ips"),t.length>=n?sprintf(o.ide.PROP_MSG_WARN_ENI_IP_EXTEND,e.get("instanceType"),n):(i=this.__embedInstance?this.__embedInstance.parent():this.parent(),r=!0,t.push({ip:"fake"}),i.isCidrEnoughForIps()||(r="Ip count limit has reached in "+subnet.get("name")),t.length=t.length-1,r)):!1},connect:function(e){var t;if(e.type!=="EniAttachment")return;return this.limitIpAddress(),this.updateName(),this.draw(),t=n.modelClassForType(s.AWS_RESOURCE_TYPE.AWS_EC2_SecurityGroup),t.tryDrawLine(this),null},disconnect:function(e){var t,n,r,i,s;if(e.type!=="EniAttachment")return;this.attributes.name="eni",this.draw(),t={reason:e},s=this.connections("SgRuleLine");for(r=0,i=s.length;r<i;r++)n=s[r],n.remove(t);return null},ensureEnoughMember:function(){var e,t,n,r,i,s,o,u,a,f,l,c;n=this.attachedInstance();if(!n)return;e=n.get("count")-1,i=this.get("ips"),c=this.groupMembers();for(u=0,f=c.length;u<f;u++){o=c[u];while(o.ips.length<i.length)o.ips.push({autoAssign:!0,ip:"x.x.x.x",eipData:{id:MC.guid()}})}while(this.groupMembers().length<e){s=[];for(t=a=0,l=i.length;a<l;t=++a)r=i[t],s.push({autoAssign:!0,ip:"x.x.x.x",eipData:{id:MC.guid()}});this.groupMembers().push({id:MC.guid(),appId:"",forceAutoAssign:!0,ips:s})}return null},generateJSON:function(e,t,r){var i,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x;m=[{}],this.ensureEnoughMember(),p=[],e===0?d={id:this.id,appId:this.get("appId"),ips:this.get("ips"),attachmentId:this.get("attachmentId")}:d=this.groupMembers()[e-1],x=this.get("ips");for(l=E=0,S=x.length;E<S;l=++E)h=x[l],f=h.hasEip,h=d.ips[l],void 0,t.number>1?i=!0:i=h.autoAssign,p.push({PrivateIpAddress:this.getRealIp(h.ip),AutoAssign:i,Primary:!1}),f&&(a=h.eipData,m.push({uid:a.id||MC.guid(),type:s.AWS_RESOURCE_TYPE.AWS_EC2_EIP,name:"EIP",index:e,resource:{Domain:n.instance().typeIsVpc()?"vpc":"standard",InstanceId:"",AllocationId:a.allocationId||"",NetworkInterfaceId:this.createRef("NetworkInterfaceId",d.id),PrivateIpAddress:this.createRef("PrivateIpAddressSet."+l+".PrivateIpAddress",d.id),PublicIp:a.publicIp||""}}));return p[0].Primary=!0,y=this.__embedInstance?this.__embedInstance:this,g=_.map(y.connectionTargets("SgAsso"),function(e){return{GroupName:e.createRef("GroupName"),GroupId:e.createRef("GroupId")}}),t.instanceId?c=this.createRef("InstanceId",t.instanceId):c="",o="",this.__embedInstance?v=this.__embedInstance.parent():v=this.parent(),v.type===s.AWS_RESOURCE_TYPE.AWS_VPC_Subnet?(b=v.createRef("SubnetId"),w=v.parent().parent().createRef("VpcId"),o=v.parent()):o=v,u={index:e,uid:d.id,type:this.type,name:(t.instanceName||"")+this.get("name"),serverGroupUid:this.id,serverGroupName:this.get("name"),number:t.number||1,resource:{SourceDestCheck:this.get("sourceDestCheck"),Description:this.get("description"),NetworkInterfaceId:d.appId,AvailabilityZone:o.createRef(),VpcId:v.getVpcRef(),SubnetId:v.getSubnetRef(),AssociatePublicIpAddress:this.get("assoPublicIp"),PrivateIpAddressSet:p,GroupSet:g,Attachment:{InstanceId:c,DeviceIndex:r===void 0?"1":""+r,AttachmentId:d.attachmentId||""}}},m[0]=u,m},serialize:function(){var e,t,n;return n=null,this.__embedInstance||(t=this.generateLayout(),n===null&&(n={}),n.layout=t),this.attachedInstance()||(n===null&&(n={}),e=this.__embedInstance?0:1,n.component=this.generateJSON(0,{number:1},e)[0]),n}},{handleTypes:[s.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface,s.AWS_RESOURCE_TYPE.AWS_EC2_EIP],getAvailableIPInCIDR:function(t,n,r){var i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S;return o=t.split("/"),u=o[0],b=Number(o[1]),m=32-b,a=u.split("."),f=a.map(function(e){return MC.leftPadString(parseInt(e).toString(2),8,"0")}),c=f.join(""),l=c.slice(0,b),p=c.slice(b).replace(/1/g,"0"),h=p.replace(/0/g,"1"),v=parseInt(p,2),d=parseInt(h,2),i=[],s=0,g=function(){S=[];for(var e=v,t=d+1;v<=t?e<t:e>t;v<=t?e++:e--)S.push(e);return S}.apply(this),y=g.length,$.each(g,function(t,o){var u,a,f,c,h;f=l+MC.leftPadString(o.toString(2),m,"0"),u=!0;if(t===0||t===1||t===2||t===3)u=!1;return t===y-1&&(u=!1),a=_.map([0,8,16,24],function(e){var t;return t=parseInt(f.slice(e,e+8),2),t}),h=a.join("."),e.call(n,h)>=0&&(u=!1),c={ip:h,available:u},i.push(c),u&&s++,s>r?!1:null}),void 0,i},getAvailableIPCountInCIDR:function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p;return n=e.split("/"),r=n[0],p=Number(n[1]),h=32-p,i=r.split("."),s=i.map(function(e){return MC.leftPadString(parseInt(e).toString(2),8,"0")}),u=s.join(""),o=u.slice(0,p),f=u.slice(p).replace(/1/g,"0"),a=f.replace(/0/g,"1"),c=parseInt(f,2),l=parseInt(a,2),t=l-c+1-5,t<0&&(t=0),t},createServerGroupMember:function(e){var t,r,i,s,o,a,f;t=e.resource.Attachment||{},s={id:e.uid,appId:e.resource.NetworkInterfaceId,attachmentId:t.AttachmentId||"",ips:[]},f=e.resource.PrivateIpAddressSet||[];for(o=0,a=f.length;o<a;o++)r=f[o],i=new u({autoAssign:r.AutoAssign,ip:r.PrivateIpAddress,fixedIpInApp:n.instance().modeIsApp()}),r.EipResource&&(i.eipData={id:r.EipResource.uid,allocationId:r.EipResource.resource.AllocationId,publicIp:r.EipResource.resource.PublicIp}),s.ips.push(i);return s},diffEipJson:function(e,t,n,r){var i,s,o;if(_.isEqual(e,t))return;i=e||t,s=MC.extractID(i.resource.NetworkInterfaceId),s=n[s]||r[s];if(!s||s.index!==0)return;if(MC.extractID(s.resource.Attachment.DeviceIndex)!=="0")return{name:s.serverGroupName,id:s.uid,type:s.type,change:"Update"};o=MC.extractID(s.resource.Attachment.InstanceId),o=n[o]||r[o];if(o)return{name:o.serverGroupName,id:o.uid,type:o.type,change:"Update"}},diffJson:function(e,t,n,r){var i,o,u,a,f,l;u=e||t;if(u.type===s.AWS_RESOURCE_TYPE.AWS_EC2_EIP)return this.diffEipJson(e,t,n,r);if(u.index!==0)return;e&&(i=e.resource.Attachment),!i&&t&&(i=t.resource.Attachment);if(!i)return;a=MC.extractID(i.InstanceId),a=n[a]||r[a];if(!a)return;if(i.DeviceIndex==="0"){if(e&&t&&!_.isEqual(e,t))return{name:a.serverGroupName,type:a.type,id:a.uid,change:"Update"};return}return o={id:u.uid,type:s.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface,name:a.serverGroupName+"-"+u.serverGroupName,changes:[]},e&&t&&!_.isEqual(e.resource,t.resource)&&o.changes.push({name:"Update"}),f=e?e.number:0,l=t?t.number:0,f>l?o.changes.push({name:"Create",count:f-l}):f<l&&o.changes.push({name:"Delete",count:f-l}),o.changes.length?o:null},deserialize:function(e,t,o){var f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O;if(e.type===s.AWS_RESOURCE_TYPE.AWS_EC2_EIP)return;if(e.serverGroupUid&&e.serverGroupUid!==e.uid){w=o(e.serverGroupUid).groupMembers();for(x=0,C=w.length;x<C;x++){b=w[x];if(b&&b.id===e.uid){void 0;return}}w[e.index-1]=this.createServerGroupMember(e);return}f=e.resource.Attachment,h=f&&f.DeviceIndex==="0",m=f&&f.InstanceId?o(MC.extractID(f.InstanceId)):null,l={id:e.uid,appId:e.resource.NetworkInterfaceId,description:e.resource.Description,sourceDestCheck:e.resource.SourceDestCheck,assoPublicIp:e.resource.AssociatePublicIpAddress,attachmentId:f?f.AttachmentId:"",ips:[],x:h?0:t.coordinate[0],y:h?0:t.coordinate[1]},A=e.resource.PrivateIpAddressSet||[];for(T=0,k=A.length;T<k;T++)g=A[T],c=n.instance().modeIsStack()?g.AutoAssign:!1,y=new u({autoAssign:c,ip:g.PrivateIpAddress,fixedIpInApp:n.instance().modeIsApp()}),g.EipResource&&(y.hasEip=!0,y.eipData={id:g.EipResource.uid,allocationId:g.EipResource.resource.AllocationId,publicIp:g.EipResource.resource.PublicIp}),l.ips.push(y);h?(l.name="eni0",E={instance:m}):l.parent=o(t.groupUId),p=new a(l,E),S=p.embedInstance()||p,O=e.resource.GroupSet||[];for(N=0,L=O.length;N<L;N++)v=O[N],new r(S,o(MC.extractID(v.GroupId)));return m&&(h?m.setEmbedEni(p):(d=f&&f.DeviceIndex?f.DeviceIndex:1,new i(p,m,{index:d*1}))),null},postDeserialize:function(e,t){var r,i,o,u,a,f,l,c,h,p,d,v,m,g,y,b;r=e.resource.Attachment;if(!r)return;o=r.DeviceIndex==="0";if(!o)return;i=n.instance(),h=MC.extractID(r.InstanceId),c=i.component(h);if(c)return;u=i.component(e.uid);if(!u)return;void 0,u.remove(),a=this.createServerGroupMember(e),y=n.modelClassForType(s.AWS_RESOURCE_TYPE.AWS_EC2_Instance).allObjects();for(d=0,m=y.length;d<m;d++){c=y[d],b=c.groupMembers();for(l=v=0,g=b.length;v<g;l=++v){p=b[l];if(p.id===h){f=!0;break}}}if(!f){void 0;return}return c.getEmbedEni().groupMembers()[l]=a,null}}),a})}.call(this),function(){define("module/design/framework/resource/VolumeModel",["i18n!nls/lang.js","../ComplexResModel","constant"],function(e,t,n){var r;return r=t.extend({defaults:{name:"",owner:null,volumeSize:1,snapshotId:"",appId:"",volumeType:"standard",iops:""},type:n.AWS_RESOURCE_TYPE.AWS_EBS_Volume,constructor:function(e,n){var r;return r=e.owner,delete e.owner,e.name||(e.name=this.getDeviceName(r)),e.name&&(t.call(this,e),this.attachTo(r,n)),n&&n.cloneSource&&this.clone(n.cloneSource),e.iops&&(e.volumeType="io1"),null},clone:function(e){return this.cloneAttributes(e,{reserve:"owner"}),null},isVisual:function(){return!1},isReparentable:function(t){var r;if(this.design().modeIsAppEdit()){r=this.get("owner");if(r.type!==t.type)return!1;if(!this.get("appId"))return!0;if(r.get("count")>1)return e.ide.CVS_MSG_ERR_SERVERGROUP_VOLUME;if(t.get("count")>1)return e.ide.CVS_MSG_ERR_SERVERGROUP_VOLUME2;while(r&&r.type!==n.AWS_RESOURCE_TYPE.AWS_EC2_AvailabilityZone)r=r.parent(),t=t.parent();if(r&&t&&r!==t)return"Cannot move volume across availability zone."}return!0},groupMembers:function(){return this.__groupMembers||(this.__groupMembers=[]),this.__groupMembers},remove:function(){var e;return e=this.attributes.owner.get("volumeList"),e.splice(e.indexOf(this),1),this.attributes.owner.draw(),t.prototype.remove.call(this),null},genFullName:function(e){return this.get("name")[0]!=="/"?"xvd"+e:"/dev/"+e},getCost:function(e,t,r){var i,s,o,u,a,f,l,c,h,p,d,v,m;if(!e.ebs)return;u=this.get("owner");if(!u){void 0;return}if(!r&&this.get("owner").type!==n.AWS_RESOURCE_TYPE.AWS_EC2_Instance)return;f=this.get("volumeType")==="standard",m=e.ebs.types;for(h=0,d=m.length;h<d;h++)l=m[h],f?l.ebsVols&&(c=l.ebsVols):l.ebsPIOPSVols&&(c=l.ebsPIOPSVols);if(!c)return;i=this.get("owner").get("count")||1,o=u.get("name")+" - "+this.get("name"),i>1&&(o+=" (x"+i+")");for(p=0,v=c.length;p<v;p++){a=c[p];if(a.unit==="perGBmoProvStorage")return s=a[t],{resource:o,type:this.get("volumeSize")+"G",fee:s*this.get("volumeSize")*i,formatedFee:s+"/GB/mo"}}return null},attachTo:function(e,t){var n,r;if(!e)return!1;if(e===this.attributes.owner)return!1;n=this.attributes.owner,n&&(r=n.attributes.volumeList,r.splice(r.indexOf(this),1),n.draw()),this.attributes.owner=e;if(!t||!t.noNeedGenName){this.attributes.name=this.getDeviceName(e);if(!this.attributes.name)return!1}return e.attributes.volumeList?e.attributes.volumeList.push(this):e.attributes.volumeList=[this],e.draw(),!0},getDeviceName:function(t){var n,r,i,s;return i=t.get("imageId"),n=MC.data.dict_ami[i],n?(r=null,n.osType!=="windows"?r=["f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"]:r=["f","g","h","i","j","k","l","m","n","o","p"],$.each(n.blockDeviceMapping||[],function(e,t){var n,i;if(e.slice(0,4)==="/dev/"){i=e.slice(-1),n=r.indexOf(i);if(n>=0)return r.splice(n,1)}}),s=t.get("volumeList"),s&&s.length>0&&$.each(s,function(e,t){var n,i;i=t.get("name").slice(-1),n=r.indexOf(i);if(n>=0)return r.splice(n,1)}),r.length===0?(notification("warning",e.ide.NOTIFY_MSG_WARN_ATTACH_VOLUME_REACH_INSTANCE_LIMIT,!1),null):(n.osType!=="windows"?r="/dev/sd"+r[0]:r="xvd"+r[0],r)):(n||notification("warning",sprintf(e.ide.NOTIFY_MSG_WARN_AMI_NOT_EXIST_TRY_USE_OTHER,i),!1),null)},ensureEnoughMember:function(){var e;if(!this.get("owner"))return;e=this.get("owner").get("count");if(!e)return;e-=1;while(this.groupMembers().length<e)this.groupMembers().push({id:MC.guid(),appId:""});return null},generateJSON:function(e,t){var n,r,i,s,o;return void 0,this.ensureEnoughMember(),n="",e>0?(i=this.groupMembers()[e-1],o=i.id,n=i.appId):(o=this.id,n=this.get("appId")),r=this.createRef("InstanceId",t.instanceId),s=this.get("owner"),{uid:o,type:this.type,name:this.get("name"),serverGroupUid:this.id,serverGroupName:this.get("name"),index:e,number:t.number||1,resource:{VolumeId:n,Size:this.get("volumeSize"),SnapshotId:this.get("snapshotId"),Iops:this.get("iops"),VolumeType:this.get("volumeType"),AvailabilityZone:s?s.getAvailabilityZone().createRef():"",AttachmentSet:{InstanceId:r,Device:this.get("name")}}}},serialize:function(){if(this.get("owner"))return;return{component:this.generateJSON(0,{number:1})}}},{handleTypes:n.AWS_RESOURCE_TYPE.AWS_EBS_Volume,diffJson:function(e,t,n,r){var i,s;if(!(e&&t&&_.isEqual(e,t))){i=e||t,s=Design.instance().component(i.resource.AttachmentSet.InstanceId);if(s)return{id:s.id,name:s.get("name"),change:"Update"}}},deserialize:function(e,t,n){var i,s,o,u,a,f,l,c;if(e.serverGroupUid&&e.serverGroupUid!==e.uid){a=n(e.serverGroupUid).groupMembers();for(l=0,c=a.length;l<c;l++){u=a[l];if(u&&u.id===e.uid){void 0;return}}a[e.index-1]={id:e.uid,appId:e.resource.VolumeId};return}return e.resource.AttachmentSet?(i=e.resource.AttachmentSet,o=i&&i.InstanceId?n(MC.extractID(i.InstanceId)):null,s={id:e.uid,name:e.serverGroupName||e.name,owner:o,volumeSize:e.resource.Size,snapshotId:e.resource.SnapshotId,volumeType:e.resource.VolumeType,iops:e.resource.Iops,appId:e.resource.VolumeId},f=new r(s,{noNeedGenName:!0}),null):(void 0,null)}}),r})}.call(this),function(){define("module/design/framework/resource/AclModel",["../ComplexResModel","../ConnectionModel","constant"],function(e,t,n){var r,i,s,o,u;return o={Code:"",Type:""},u={From:"",To:""},r=t.extend({type:"AclAsso",oneToMany:n.AWS_RESOURCE_TYPE.AWS_VPC_NetworkAcl,defaults:{associationId:""},serialize:function(e){var t,r;return r=this.getTarget(n.AWS_RESOURCE_TYPE.AWS_VPC_Subnet),t=this.getTarget(n.AWS_RESOURCE_TYPE.AWS_VPC_NetworkAcl),e[t.id].resource.AssociationSet.push({NetworkAclAssociationId:this.get("associationId"),SubnetId:r.createRef("SubnetId")}),null}}),s=function(e){return!e||!e.length?[]:_.map(e,function(e){var t;return t={id:_.uniqueId("aclrule_"),cidr:e.CidrBlock,egress:e.Egress,protocol:parseInt(e.Protocol,10),number:parseInt(e.RuleNumber,10),action:e.RuleAction,port:""},e.Protocol==="1"&&e.IcmpTypeCode&&e.IcmpTypeCode.Code&&e.IcmpTypeCode.Type?t.port=e.IcmpTypeCode.Type+"/"+e.IcmpTypeCode.Code:e.PortRange.From&&e.PortRange.To&&(e.PortRange.From===e.PortRange.To?t.port=e.PortRange.From+"":t.port=e.PortRange.From+"-"+e.PortRange.To),t})},i=e.extend({type:n.AWS_RESOURCE_TYPE.AWS_VPC_NetworkAcl,newNameTmpl:"CustomACL-",defaults:function(){return{rules:[{action:"deny",cidr:"0.0.0.0/0",egress:!0,id:_.uniqueId("aclrule_"),number:32767,port:"",protocol:-1},{action:"deny",cidr:"0.0.0.0/0",egress:!1,id:_.uniqueId("aclrule_"),number:32767,port:"",protocol:-1}]}},isVisual:function(){return!1},isDefault:function(){return this.attributes.name==="DefaultACL"},remove:function(){var t,n,s,o,u;void 0,t=i.getDefaultAcl(),u=this.connectionTargets();for(s=0,o=u.length;s<o;s++)n=u[s],new r(t,n);return e.prototype.remove.call(this),null},addRule:function(e){var t,n,r,i;void 0,e.protocol=parseInt(e.protocol,10),e.number=parseInt(e.number,10),t=this.get("rules");for(r=0,i=t.length;r<i;r++){n=t[r];if(n.number===e.number)return!1}return e.id=_.uniqueId("aclrule_"),t=t.slice(0),t.push(e),this.set("rules",t),!0},removeRule:function(e){var t,n,r,i,s,o;r=this.get("rules");for(t=s=0,o=r.length;s<o;t=++s){n=r[t];if(n.id===e){i=n;break}}return i.number===32767?!1:this.isDefault()&&i.number===100?!1:(r=r.slice(0),r.splice(t,1),this.set("rules",r),!0)},getRuleCount:function(){return this.get("rules").length},getAssoCount:function(){return this.connections().length},serialize:function(){var e,t,r,i,s,a,f,l,c;a=Design.modelClassForType(n.AWS_RESOURCE_TYPE.AWS_VPC_VPC).theVPC(),s=[],e={name:this.get("name"),type:this.type,uid:this.id,resource:{AssociationSet:[],Default:this.isDefault(),EntrySet:s,NetworkAclId:this.get("appId"),VpcId:a.createRef("VpcId")}},c=this.get("rules");for(f=0,l=c.length;f<l;f++)i=c[f],r={Egress:i.egress,Protocol:i.protocol,RuleAction:i.action,RuleNumber:i.number,CidrBlock:i.cidr,IcmpTypeCode:o,PortRange:u},i.protocol==="1"?(t=i.port.split("/"),r.IcmpTypeCode={Code:t[1],Type:t[0]}):i.port&&(t=(i.port+"-"+i.port).split("-"),r.PortRange={From:t[0],To:t[1]}),s.push(r);return{component:e}}},{handleTypes:n.AWS_RESOURCE_TYPE.AWS_VPC_NetworkAcl,resolveFirst:!0,getDefaultAcl:function(){return _.find(i.allObjects(),function(e){return e.isDefault()})},preDeserialize:function(e,t){return new i({id:e.uid,name:e.name,appId:e.resource.NetworkAclId,rules:s(e.resource.EntrySet)}),null},deserialize:function(e,t,n){var i,s,o,u,a,f;i=n(e.uid),f=e.resource.AssociationSet;for(u=0,a=f.length;u<a;u++)s=f[u],o=new r(i,n(MC.extractID(s.SubnetId))),o.set("associationId",s.NetworkAclAssociationId);return null}}),i})}.call(this),function(){define("module/design/framework/GroupModel",["Design","./ComplexResModel"],function(e,t){var n;return n=t.extend({node_group:!0,type:"Framework_G",remove:function(){var e,n,r,i;if(this.attributes.__children){i=this.attributes.__children.splice(0);for(n=0,r=i.length;n<r;n++)e=i[n],e.off("destroy",this.removeChild,this),e.remove()}return t.prototype.remove.call(this),null},addChild:function(e){var t,n;void 0,n=e.parent();if(n===this)return;n&&n.removeChild(e),t=this.attributes.__children;if(!t)t=[];else if(t.indexOf(e)!==-1)return;return t.push(e),this.set("__children",t),e.set("__parent",this),e.once("destroy",this.removeChild,this),e.onParentChanged&&e.onParentChanged(),null},removeChild:function(e){var t,n;t=this.get("__children");if(!t||t.length===0){void 0;return}n=t.indexOf(e);if(n===-1){void 0;return}return t.splice(n,1),this.set("__children",t),e.off("destroy",this.removeChild,this),null},children:function(){return this.get("__children")||[]},generateLayout:function(){var e;return e=t.prototype.generateLayout.call(this),e.size=[this.width(),this.height()],e}}),n})}.call(this),function(){define("module/design/framework/resource/AsgModel",["../ResourceModel","../ComplexResModel","../GroupModel","Design","constant","i18n!nls/lang.js"],function(e,t,n,r,i,s){var o,u,a;return a=e.extend({type:i.AWS_RESOURCE_TYPE.AWS_AutoScaling_NotificationConfiguration,isUsed:function(){return this.get("instanceLaunch")||this.get("instanceLaunchError")||this.get("instanceTerminate")||this.get("instanceTerminateError")||this.get("test")},initialize:function(){return r.modelClassForType(i.AWS_RESOURCE_TYPE.AWS_SNS_Topic).ensureExistence(),null},serialize:function(){var e,t,n,s,o;if(!this.isUsed()||!this.get("asg"))return;s=r.modelClassForType(i.AWS_RESOURCE_TYPE.AWS_SNS_Topic).ensureExistence(),n=[],o=a.typeMap;for(e in o)t=o[e],this.get(t)&&n.push(e);return{component:{name:"SnsNotification",type:this.type,uid:this.id,resource:{AutoScalingGroupName:this.get("asg").createRef("AutoScalingGroupName"),TopicARN:s.createRef("TopicArn"),NotificationType:n}}}}},{handleTypes:i.AWS_RESOURCE_TYPE.AWS_AutoScaling_NotificationConfiguration,diffJson:function(){},typeMap:{"autoscaling:EC2_INSTANCE_LAUNCH":"instanceLaunch","autoscaling:EC2_INSTANCE_LAUNCH_ERROR":"instanceLaunchError","autoscaling:EC2_INSTANCE_TERMINATE":"instanceTerminate","autoscaling:EC2_INSTANCE_TERMINATE_ERROR":"instanceTerminateError","autoscaling:TEST_NOTIFICATION":"test"},deserialize:function(e,t,n){var r,i,s,o,u,f,l;i={id:e.uid},l=e.resource.NotificationType;for(u=0,f=l.length;u<f;u++)o=l[u],i[a.typeMap[o]]=!0;return s=new a(i),r=n(MC.extractID(e.resource.AutoScalingGroupName)),r&&(r.set("notification",s),s.set("asg",r)),null}}),o=t.extend({type:"ExpandedAsg",node_group:!0,defaults:{x:0,y:0,width:13,height:13,originalAsg:null},constructor:function(e,n){var r,s,o,u;void 0,s=[e.originalAsg].concat(e.originalAsg.get("expandedList"));for(o=0,u=s.length;o<u;o++){r=s[o];if(e.parent.type===i.AWS_RESOURCE_TYPE.AWS_VPC_Subnet){if(e.parent.parent()===r.parent().parent())return}else if(e.parent===r.parent())return}return t.call(this,e,n),null},isReparentable:function(e){var t,n,r,s,o;t=this.attributes.originalAsg,o=[t].concat(t.get("expandedList"));for(r=0,s=o.length;r<s;r++){n=o[r];if(n===this)continue;if(e.type===i.AWS_RESOURCE_TYPE.AWS_VPC_Subnet){if(e.parent()===n.parent().parent())return!1}else if(e.parent===n.parent())return!1}return!0},connections:function(e){var n;return n=e==="SgAsso"?this.getLc():this,t.prototype.connections.call(n,e)},connectionTargets:function(e){var n;return n=e==="SgAsso"?this.getLc():this,t.prototype.connectionTargets.call(n,e)},initialize:function(){return this.draw(!0),this.get("originalAsg").__addExpandedAsg(this),null},getLc:function(){return this.attributes.originalAsg.get("lc")},serialize:function(){var e;return e=this.generateLayout(),e.type="ExpandedAsg",e.originalId=this.get("originalAsg").id,{layout:e}}},{handleTypes:"ExpandedAsg",deserialize:function(e,t,n){return new o({originalAsg:n(t.originalId),parent:n(t.groupUId),x:t.coordinate[0],y:t.coordinate[1]}),null}}),u=n.extend({defaults:function(){return{x:0,y:0,width:13,height:13,cooldown:300,capacity:1,minSize:1,maxSize:2,healthCheckGracePeriod:300,healthCheckType:"EC2",terminationPolicies:["Default"],expandedList:[],policies:[]}},type:i.AWS_RESOURCE_TYPE.AWS_AutoScaling_Group,newNameTmpl:"asg",isReparentable:function(e){var t,n,r,o;o=this.get("expandedList");for(n=0,r=o.length;n<r;n++){t=o[n];if(e.type===i.AWS_RESOURCE_TYPE.AWS_VPC_Subnet){if(e.parent()===t.parent().parent())return sprintf(s.ide.CVS_MSG_ERR_DROP_ASG,this.get("name"),e.parent().get("name"))}else if(e.parent===t.parent())return sprintf(s.ide.CVS_MSG_ERR_DROP_ASG,this.get("name"),e.get("name"))}return!0},getCost:function(e,t){var n,s,o,u,a,f,l,c,h;s=this.get("lc");if(!s)return null;n=r.modelClassForType(i.AWS_RESOURCE_TYPE.AWS_EC2_Instance),u=n.prototype.getCost.call(s,e,t);if(!u)return null;u.length&&(u=u[0]),u.resource=this.get("name"),o=u.fee,f=s.get("volumeList");if(f&&f.length)for(c=0,h=f.length;c<h;c++)a=f[c],l=a.getCost(e,t,!0),l&&(o+=l.fee);return u.fee!==o&&(u.resource+=" (& volumes)",u.fee=o),u.type=parseInt(this.get("capacity")||this.get("minSize"),10),u.fee*=u.type,u.fee=Math.round(u.fee*100)/100,u.formatedFee=u.fee+"/mo",u},addChild:function(e){var t,r,i,s,o,u,a,f;n.prototype.addChild.call(this,e),r=this.get("lc");if(r){this.stopListening(r),a=r.connectionTargets("ElbAmiAsso");for(i=0,o=a.length;i<o;i++)t=a[i],this.updateExpandedAsgAsso(t,!0)}this.set("lc",e),this.listenTo(e,"change:name change:imageId",this.drawExpanedAsg),this.listenTo(e,"destroy",this.removeChild),f=e.connectionTargets("ElbAmiAsso");for(s=0,u=f.length;s<u;s++)t=f[s],this.updateExpandedAsgAsso(t);return this.draw(),this.drawExpanedAsg(!1),null},removeChild:function(e){return n.prototype.removeChild.call(this,e),this.removeExpandedAsso(),this.unset("lc"),this.draw(),null},drawExpanedAsg:function(e){var t,n,r,i,s;n=this.get("lc");if(n){s=this.get("expandedList");for(r=0,i=s.length;r<i;r++)t=s[r],t.draw(e)}return null},getNotification:function(){var e;return e=this.get("notification"),e?e.toJSON():{}},setNotification:function(e){var t;return t=this.get("notification"),t?t.set(e):(e.asg=this,t=new a(e),this.set("notification",t)),null},updateExpandedAsgAsso:function(e,t){var n,i,s,o,u,a;if(this.attributes.expandedList.length===0)return;o=this.attributes.expandedList,this.attributes.expandedList=[],n=r.modelClassForType("ElbAmiAsso");for(u=0,a=o.length;u<a;u++)s=o[u],i=new n(s,e),t&&i.remove();return this.attributes.expandedList=o,null},updateExpandedAsgSgLine:function(e,t){var n,i,s,o,u,a,f,l;if(this.attributes.expandedList.length===0)return;o=this.attributes.expandedList,this.attributes.expandedList=[],n=r.modelClassForType("SgRuleLine"),i={createByUser:!1},u={reason:e};for(f=0,l=o.length;f<l;f++)s=o[f],s!==e&&(a=new n(s,e,i),t&&a.silentRemove());return this.attributes.expandedList=o,null},removeExpandedAsso:function(){var e,t,n,r,i;i=this.get("expandedList");for(n=0,r=i.length;n<r;n++){t=i[n],e=t.connections();while(e.length)_.first(e).remove()}return null},addScalingPolicy:function(e){return e.__asg=this,this.get("policies").push(e),this.listenTo(e,"destroy",this.__removeScalingPolicy),null},__removeScalingPolicy:function(e){return this.stopListening(e),this.get("policies").splice(this.get("policies").indexOf(e),1),null},isEC2HealthCheckType:function(){var e;return e=this.get("lc"),e&&e.connections("ElbAmiAsso").length&&this.get("healthCheckType")==="ELB"?!1:!0},remove:function(){var e,t,r,i,s,o,u,a;u=this.get("expandedList");for(r=0,s=u.length;r<s;r++)e=u[r],e.off(),e.remove();a=this.get("policies");for(i=0,o=a.length;i<o;i++)t=a[i],t.off(),t.remove();return this.get("notification")&&this.get("notification").remove(),n.prototype.remove.call(this),null},__addExpandedAsg:function(e){var t,n,i,s,o,u,a,f,l,c,h;void 0,this.get("expandedList").push(e),e.originalAsg=this,this.listenTo(e,"destroy",this.__onExpandedAsgRemove),s=this.get("lc");if(s){t=r.modelClassForType("ElbAmiAsso"),c=s.connectionTargets("ElbAmiAsso");for(u=0,f=c.length;u<f;u++)i=c[u],new t(i,e);n=r.modelClassForType("SgRuleLine"),h=s.connectionTargets("SgRuleLine");for(a=0,l=h.length;a<l;a++)o=h[a],new n(o,e)}return null},__onExpandedAsgRemove:function(e){return void 0,this.get("expandedList").splice(this.get("expandedList").indexOf(e),1),null},getExpandSubnets:function(){var e,t,n,r,s;if(this.parent().type!==i.AWS_RESOURCE_TYPE.AWS_VPC_Subnet)return[];t=[this.parent()],s=this.get("expandedList");for(n=0,r=s.length;n<r;n++)e=s[n],t.push(e.parent());return _.uniq(t)},getExpandAzs:function(){var e,t,n,r,s,o;n=[this.parent()],o=this.get("expandedList");for(r=0,s=o.length;r<s;r++)t=o[r],n.push(t.parent());return n=_.uniq(n),this.parent().type===i.AWS_RESOURCE_TYPE.AWS_VPC_Subnet?e=_.uniq(_.map(n,function(e){return e.parent()})):e=n,e},serialize:function(){var e,t,n,r,s,o,u,a,f,l,c,h,p,d,v,m;c=[this.parent()],m=this.get("expandedList");for(h=0,d=m.length;h<d;h++)s=m[h],c.push(s.parent());c=_.uniq(c);if(this.parent().type===i.AWS_RESOURCE_TYPE.AWS_VPC_Subnet)e=_.uniq(_.map(c,function(e){return e.parent().createRef()})),c=_.map(c,function(e){return e.createRef("SubnetId")});else{e=_.uniq(_.map(c,function(e){return e.createRef()})),a=[];for(p=0,v=c.length;p<v;p++)f=c[p],l=f.getSubnetRef(),l&&a.push(l);c=a}return this.get("lc")?u=this.get("lc").createRef("LaunchConfigurationName"):u="",o="EC2",this.get("lc")&&(r=this.get("lc").connectionTargets("ElbAmiAsso"),r.length&&(o=this.get("healthCheckType"),n=_.map(r,function(e){return e.createRef("LoadBalancerName")}))),t={uid:this.id,name:this.get("name"),type:this.type,resource:{AvailabilityZones:e,VPCZoneIdentifier:c.join(" , "),LoadBalancerNames:n||[],AutoScalingGroupARN:this.get("appId"),DefaultCooldown:this.get("cooldown"),MinSize:this.get("minSize"),MaxSize:this.get("maxSize"),HealthCheckType:o,HealthCheckGracePeriod:this.get("healthCheckGracePeriod"),TerminationPolicies:this.get("terminationPolicies"),AutoScalingGroupName:this.get("groupName")||this.get("name"),DesiredCapacity:this.get("capacity"),LaunchConfigurationName:u}},{component:t,layout:this.generateLayout()}}},{handleTypes:i.AWS_RESOURCE_TYPE.AWS_AutoScaling_Group,deserialize:function(e,t,n){var i,s,o,a,f,l,c,h;s=new u({id:e.uid,name:e.name,appId:e.resource.AutoScalingGroupARN,parent:n(MC.extractID(t.groupUId)),cooldown:e.resource.DefaultCooldown,capacity:e.resource.DesiredCapacity,minSize:e.resource.MinSize,maxSize:e.resource.MaxSize,healthCheckType:e.resource.HealthCheckType,healthCheckGracePeriod:e.resource.HealthCheckGracePeriod,terminationPolicies:e.resource.TerminationPolicies,groupName:e.resource.AutoScalingGroupName,x:t.coordinate[0],y:t.coordinate[1]});if(e.resource.LaunchConfigurationName){f=n(MC.extractID(e.resource.LaunchConfigurationName)),s.addChild(f),i=r.modelClassForType("ElbAmiAsso"),h=e.resource.LoadBalancerNames||[];for(l=0,c=h.length;l<c;l++)a=h[l],o=n(MC.extractID(a)),new i(f,o)}return null}}),u})}.call(this),function(){define("module/design/framework/resource/DhcpModel",["constant","../ResourceModel","Design"],function(e,t,n){var r,i,s,o;return i={"domain-name":"domainName","domain-name-servers":"domainServers","ntp-servers":"ntpServers","netbios-name-servers":"netbiosServers","netbios-node-type":"netbiosType"},o=function(e){var t,n,r,i;n=[];for(r=0,i=e.length;r<i;r++)t=e[r],n.push({Value:t});return n},s=function(e){var t,n,r,s,o,u,a,f,l;t={amazonDNS:!1};for(o=0,a=e.length;o<a;o++){n=e[o];if(n.Key==="domain-name")t.domainName=n.ValueSet[0].Value;else if(n.Key==="netbios-node-type")t.netbiosType=n.ValueSet[0].Value;else{s=[],l=n.ValueSet;for(u=0,f=l.length;u<f;u++)r=l[u],r.Value==="AmazonProvidedDNS"?t.amazonDNS=!0:s.push(r.Value);t[i[n.Key]]=s}}return t},r=t.extend({type:e.AWS_RESOURCE_TYPE.AWS_VPC_DhcpOptions,defaults:function(){return{dhcpType:"",amazonDNS:!0,domainName:"",netbiosType:0,domainServers:[],ntpServers:[],netbiosServers:[]}},isNone:function(){return this.attributes.dhcpType==="none"},isDefault:function(){return this.attributes.dhcpType==="default"},isCustom:function(){return this.attributes.dhcpType===""},setNone:function(){return this.set("dhcpType","none")},setDefault:function(){return this.set("dhcpType","default")},setCustom:function(){return this.set("dhcpType","")},set:function(){return this.design().modeIsAppEdit()&&!this.__newIdForAppEdit&&(this.__newIdForAppEdit=this.design().guid()),Backbone.Model.prototype.set.apply(this,arguments)},createRef:function(e,n,r){return r||(r=this.__newIdForAppEdit||this.id),t.prototype.createRef.call(this,e,n,r)},serialize:function(){var t,r,i,s,u,a,f;if(!this.isCustom())return;f=n.modelClassForType(e.AWS_RESOURCE_TYPE.AWS_VPC_VPC).theVPC(),s=[],r=this.attributes,this.__newIdForAppEdit?(u=this.__newIdForAppEdit,t=""):(u=this.id,t=this.get("appId")),i={name:"DhcpOption",type:this.type,uid:u,resource:{DhcpOptionsId:t,VpcId:f.createRef("VpcId"),DhcpConfigurationSet:s}},r.domainName&&s.push({Key:"domain-name",ValueSet:[{Value:r.domainName}]}),r.ntpServers.length&&s.push({Key:"ntp-servers",ValueSet:o(r.ntpServers)}),r.netbiosServers.length&&s.push({Key:"netbios-name-servers",ValueSet:o(r.netbiosServers)});if(r.domainServers.length||r.amazonDNS)a=o(r.domainServers),r.amazonDNS&&a.splice(0,0,{Value:"AmazonProvidedDNS"}),s.push({Key:"domain-name-servers",ValueSet:a});return r.netbiosType&&s.push({Key:"netbios-node-type",ValueSet:[{Value:r.netbiosType}]}),{component:i}}},{handleTypes:e.AWS_RESOURCE_TYPE.AWS_VPC_DhcpOptions,deserialize:function(e,t){var n;return n=e.resource.DhcpConfigurationSet?s(e.resource.DhcpConfigurationSet):{},n.id=e.uid,n.appId=e.resource.DhcpOptionsId,new r(n),null}}),r})}.call(this),function(){define("module/design/framework/resource/VpcModel",["constant","../GroupModel","./DhcpModel"],function(e,t,n){var r;return r=t.extend({type:e.AWS_RESOURCE_TYPE.AWS_VPC_VPC,defaults:{dnsSupport:!0,dnsHostnames:!1,tenancy:"default",cidr:"10.0.0.0/16",x:5,y:3,width:60,height:60},initialize:function(){return this.attributes.dhcp||(this.attributes.dhcp=new n),this.draw(!0),null},isRemovable:function(){return!1},isDefaultTenancy:function(){return this.get("tenancy")!=="dedicated"},setTenancy:function(t){var n,r,i,s;this.set("tenancy",t);if(t==="dedicated"){s=Design.modelClassForType(e.AWS_RESOURCE_TYPE.AWS_EC2_Instance).allObjects();for(r=0,i=s.length;r<i;r++)n=s[r],n.setTenancy(t)}return null},setCidr:function(t){var n,r,i,s,o,u,a,f;n=Design.modelClassForType(e.AWS_RESOURCE_TYPE.AWS_VPC_Subnet),u=n.allObjects(),s=!1,o=_.map(u,function(e){var r;return r=e.get("cidr"),n.isInVPCCIDR(t,r)||(s=!0),r});if(s){o=this.generateSubnetCidr(t,o);if(!o)return!1;for(r=a=0,f=u.length;a<f;r=++a)i=u[r],i.setCidr(o[r])}return this.set("cidr",t),this.draw(),!0},generateSubnetCidr:function(t,n){var r,i;return r=Design.modelClassForType(e.AWS_RESOURCE_TYPE.AWS_VPC_Subnet),i=r.allObjects(),n=r.autoAssignSimpleCIDR(t,n,this.get("cidr")),n.length||(n=r.autoAssignAllCIDR(t,i.length)),n.length!==i.length?null:n},serialize:function(){var e,t;return void 0,t=this.get("dhcp"),t.isNone()?t="default":t.isDefault()?t="":t=t.createRef("DhcpOptionsId"),e={name:this.get("name"),type:this.type,uid:this.id,resource:{EnableDnsSupport:this.get("dnsSupport"),InstanceTenancy:this.get("tenancy"),EnableDnsHostnames:this.get("dnsHostnames"),DhcpOptionsId:t,VpcId:this.get("appId"),CidrBlock:this.get("cidr")}},{component:e,layout:this.generateLayout()}}},{handleTypes:e.AWS_RESOURCE_TYPE.AWS_VPC_VPC,resolveFirst:!0,theVPC:function(){return Design.instance().classCacheForCid(this.prototype.classId)[0]},preDeserialize:function(e,t){var n;return n=new r({id:e.uid,name:e.name,appId:e.resource.VpcId,cidr:e.resource.CidrBlock,dnsHostnames:e.resource.EnableDnsHostnames,dnsSupport:e.resource.EnableDnsSupport,tenancy:e.resource.InstanceTenancy,x:t.coordinate[0],y:t.coordinate[1],width:t.size[0],height:t.size[1]}),e.uid=n.id,null},deserialize:function(e,t,n){var r,i,s;return s=n(e.uid),r=e.resource.DhcpOptionsId,r?r==="default"?s.get("dhcp").setNone():(i=s.get("dhcp"),i&&i.remove(),s.set("dhcp",n(MC.extractID(r)))):s.get("dhcp").setDefault(),null}}),r})}.call(this),function(){define("module/design/framework/resource/AzModel",["../GroupModel","./VpcModel","constant","i18n!nls/lang.js"],function(e,t,n,r){var i;return i=e.extend({type:n.AWS_RESOURCE_TYPE.AWS_EC2_AvailabilityZone,defaults:{x:2,y:2,width:21,height:21},initialize:function(e,t){var r,i;return t.createByUser&&Design.instance().typeIsVpc()&&(r=Design.modelClassForType(n.AWS_RESOURCE_TYPE.AWS_VPC_Subnet),i=new r({x:this.x()+2,y:this.y()+2,parent:this}),t.selectId=i.id),this.draw(!0),null},isRemovable:function(){return this.children().length>0?sprintf(r.ide.CVS_CFM_DEL_GROUP,this.get("name")):!0},getSubnetOfDefaultVPC:function(){return i.getSubnetOfDefaultVPC(this.get("name"))},createRef:function(){return i.__super__.createRef("ZoneName",!0,this.id)},isCidrEnoughForIps:function(e){var t,r,i,s,o,u,a,f;if(!e){r=this.getSubnetOfDefaultVPC();if(!r)return!0;e=r.cidrBlock}s=0,f=this.children();for(u=0,a=f.length;u<a;u++){t=f[u];if(t.type===n.AWS_RESOURCE_TYPE.AWS_EC2_Instance)i=t.getEmbedEni();else{if(t.type!==n.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface)continue;i=t}s+=i.get("ips").length}return o=Design.modelClassForType(n.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface).getAvailableIPCountInCIDR(e),o>=s},serialize:function(){var e,t;return t=this.get("name"),e={uid:this.id,name:t,type:this.type,resource:{ZoneName:t,RegionName:t.substring(0,t.length-1)}},{layout:this.generateLayout(),component:e}}},{handleTypes:n.AWS_RESOURCE_TYPE.AWS_EC2_AvailabilityZone,diffJson:function(){},getSubnetOfDefaultVPC:function(e){return MC.data.account_attribute[Design.instance().region()].default_subnet[e]},deserialize:function(e,t,n){return new i({id:e.uid,name:e.name,parent:n(t.groupUId),x:t.coordinate[0],y:t.coordinate[1],width:t.size[0],height:t.size[1]}),null},allPossibleAZ:function(){var e,t,n,r,s,o,u,a,f,l,c,h,p;n={},h=i.allObjects();for(a=0,l=h.length;a<l;a++)e=h[a],n[e.get("name")]=e.id;u=MC.data.config[Design.instance().region()].zone;if(u){p=u.item;for(f=0,c=p.length;f<c;f++)o=p[f],n.hasOwnProperty(o.zoneName)||(n[o.zoneName]="")}t=[];for(r in n)s=n[r],t.push({name:r,id:s});return t},getAzByName:function(e){var t,n,r,s;s=i.allObjects();for(n=0,r=s.length;n<r;n++){t=s[n];if(t.get("name")===e)return t}return null}}),i})}.call(this),function(){define("module/design/framework/resource/CgwModel",["../ComplexResModel","Design","constant"],function(e,t,n){var r;return r=e.extend({defaults:{x:0,y:0,width:17,height:10,bgpAsn:""},newNameTmpl:"customer-gateway-",type:n.AWS_RESOURCE_TYPE.AWS_VPC_CustomerGateway,isDynamic:function(){return!!this.get("bgpAsn")},serialize:function(){var e;return e={name:this.get("name"),type:this.type,uid:this.id,resource:{CustomerGatewayId:this.get("appId"),BgpAsn:this.get("bgpAsn"),Type:"ipsec.1",IpAddress:this.get("ip")}},{component:e,layout:this.generateLayout()}}},{handleTypes:n.AWS_RESOURCE_TYPE.AWS_VPC_CustomerGateway,deserialize:function(e,t,n){return new r({id:e.uid,name:e.name,appId:e.resource.CustomerGatewayId,bgpAsn:e.resource.BgpAsn,ip:e.resource.IpAddress,x:t.coordinate[0],y:t.coordinate[1]})}}),r})}.call(this),function(){define("module/design/framework/connection/SgRuleSet",["constant","../ConnectionModel","Design"],function(e,t,n){var r;return r=t.extend({type:"SgRuleSet","default":{in1:null,out1:null,in2:null,out2:null},initialize:function(){var e;return this.port1Comp().type==="SgIpTarget"&&(e=this.port2Comp(),this.__port2Comp=this.__port1Comp,this.__port1Comp=e),this.attributes.in1=[],this.attributes.out1=[],this.port1Comp()===this.port2Comp()?(this.attributes.in2=this.attributes.in1,this.attributes.out2=this.attributes.out1):(this.attributes.in2=[],this.attributes.out2=[]),null},ruleCount:function(e){return e===this.port1Comp().id||e===this.port1Comp().get("name")?this.attributes.in1.length+this.attributes.out1.length:this.attributes.in2.length+this.attributes.out2.length},toPlainObjects:function(e,t){var n,i,s,o,u,a,f,l,c,h,p;o=[{ary:this.attributes.in1,direction:r.DIRECTION.IN,relation:this.port2Comp(),owner:this.port1Comp()},{ary:this.attributes.out1,direction:r.DIRECTION.OUT,relation:this.port2Comp(),owner:this.port1Comp()}],this.port1Comp()!==this.port2Comp()&&!this.getTarget("SgIpTarget")&&(o.push({ary:this.attributes.in2,direction:r.DIRECTION.IN,relation:this.port1Comp(),owner:this.port2Comp()}),o.push({ary:this.attributes.out2,direction:r.DIRECTION.OUT,relation:this.port1Comp(),owner:this.port2Comp()})),a=[];for(f=0,c=o.length;f<c;f++){s=o[f];if(e)if(_.isString(e)){if(s.owner.id!==e&&s.owner.get("name")!==e)continue}else if(!e(s.owner))continue;p=s.ary;for(l=0,h=p.length;l<h;l++)u=p[l],u.protocol==="icmp"?i=u.fromPort+"/"+u.toPort:u.fromPort===u.toPort||!u.toPort?i=u.fromPort:i=u.fromPort+"-"+u.toPort,n={ruleSetId:this.id,port:i,protocol:u.protocol,direction:s.direction,relation:s.relation.get("name"),color:s.relation.color},t&&(n.relationId=s.relation.id,n.ownerId=s.owner.id),a.push(n)}return a},hasRawRuleTo:function(e){return void 0,e===this.port1Comp()?this.attributes.in1.length>0||this.attributes.out2.length>0:this.attributes.in2.length>0||this.attributes.out1.length>0},addRawRule:function(t,i,s){var o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M;void 0,void 0,void 0;if(n.instance().typeIsClassic()&&i===r.DIRECTION.OUT){void 0;return}E=this.get("in1").length+this.get("in2").length+this.get("out1").length+this.get("out2").length===0,l=this.get("in1").length,h=this.get("in2").length,c=this.get("out1").length,p=this.get("out2").length,w={protocol:s.protocol,fromPort:""+s.fromPort,toPort:""+s.toPort},""+w.protocol=="-1"||w.protocol==="all"?(w.protocol="all",w.fromPort="0",w.toPort="65535"):parseInt(s.protocol,10)+""===s.protocol&&(w.fromPort="",w.toPort=""),w.fromPort===w.toPort&&w.protocol!=="icmp"&&(w.toPort=""),m=t===this.port1Comp().id||t===this.port1Comp().get("name");if(!m&&this.getTarget("SgIpTarget")){void 0;return}switch(i){case r.DIRECTION.IN:b=[m?"in1":"in2"];break;case r.DIRECTION.OUT:b=[m?"out1":"out2"];break;case r.DIRECTION.BIWAY:b=[m?"in1":"in2",m?"out1":"out2"]}for(S=0,C=b.length;S<C;S++){y=b[S],a=!1,g=this.get(y);for(x=0,k=g.length;x<k;x++){f=g[x];if(f.fromPort===w.fromPort&&f.toPort===w.toPort&&f.protocol===w.protocol){a=!0;break}}a||(g=g.slice(0),g.push(w),this.set(y,g))}if(E)d=this.port1Comp(),v=this.port2Comp(),d!==v&&d.type!=="SgIpTarget"&&v.type!=="SgIpTarget"&&d.vlineAddBatch(v);else{o=n.modelClassForType(e.AWS_RESOURCE_TYPE.AWS_EC2_SecurityGroup);if(l+p===0&&this.get("in1").length+this.get("out2").length>0){O=this.port1Comp().connectionTargets("SgAsso");for(T=0,L=O.length;T<L;T++)u=O[T],u.type===e.AWS_RESOURCE_TYPE.AWS_ELB&&o.tryDrawLine(u)}if(h+c===0&&this.get("in2").length+this.get("out1").length>0){M=this.port2Comp().connectionTargets("SgAsso");for(N=0,A=M.length;N<A;N++)u=M[N],u.type===e.AWS_RESOURCE_TYPE.AWS_ELB&&o.tryDrawLine(u)}}return null},addRule:function(e,t,n){var i;void 0,e===this.port1Comp().id||e===this.port1Comp().get("name")?i=this.port2Comp().id:(e=this.port2Comp().id,i=this.port1Comp().id);if(t===r.DIRECTION.IN||t===r.DIRECTION.BIWAY)this.addRawRule(e,r.DIRECTION.IN,n),this.addRawRule(i,r.DIRECTION.OUT,n);if(t===r.DIRECTION.OUT||t===r.DIRECTION.BIWAY)this.addRawRule(e,r.DIRECTION.OUT,n),this.addRawRule(i,r.DIRECTION.IN,n);return null},removeRawRule:function(t,i,s){var o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H;void 0,void 0,void 0;if(n.instance().typeIsClassic()&&i===r.DIRECTION.OUT){void 0;return}c=this.get("in1").length,p=this.get("in2").length,h=this.get("out1").length,d=this.get("out2").length,s.protocol==="-1"&&(s.protocol="all"),s.fromPort===s.toPort&&(s.toPort=""),v=t===this.port1Comp().id||t===this.port1Comp().get("name");switch(i){case r.DIRECTION.IN:y=[v?"in1":"in2"];break;case r.DIRECTION.OUT:y=[v?"out1":"out2"];break;case r.DIRECTION.BIWAY:y=[v?"in1":"in2",v?"out1":"out2"]}f=!1;for(w=0,T=y.length;w<T;w++){g=y[w],m=this.get(g);for(l=E=0,N=m.length;E<N;l=++E){a=m[l];if(a.fromPort===s.fromPort&&a.toPort===s.toPort&&a.protocol===s.protocol){m=m.slice(0),m.splice(l,1),f=!0,this.set(g,m);break}}}if(this.get("in1").length+this.get("in2").length+this.get("out1").length+this.get("out2").length===0)this.remove();else{o=n.modelClassForType(e.AWS_RESOURCE_TYPE.AWS_EC2_SecurityGroup);if(this.get("in1").length+this.get("out2").length===0&&c+d>0){_=this.port1Comp().connectionTargets("SgAsso");for(S=0,C=_.length;S<C;S++){u=_[S];if(u.type===e.AWS_RESOURCE_TYPE.AWS_ELB){D=u.connections("SgRuleLine");for(x=0,k=D.length;x<k;x++)b=D[x],b.validate()}}}if(this.get("in2").length+this.get("out1").length===0&&p+h>0){P=this.port2Comp().connectionTargets("SgAsso");for(O=0,L=P.length;O<L;O++){u=P[O];if(u.type===e.AWS_RESOURCE_TYPE.AWS_ELB){H=u.connections("SgRuleLine");for(M=0,A=H.length;M<A;M++)b=H[M],b.validate()}}}}return void 0,null},removeRuleByPlainObj:function(e){var t,n;return void 0,void 0,void 0,e.relation===this.port1Comp().id||e.relation===this.port1Comp().get("name")?t=this.port2Comp().id:t=this.port1Comp().id,n=""+e.port,n.indexOf("/")>=0?n=n.split("/"):n=n.split("-"),e.fromPort=n[0],e.toPort=n[1]||"",this.removeRawRule(t,e.direction,e),null},serialize:function(e){var t,n,r,i,s,o,u,a,f,l,c,h;i=this.port1Comp(),o=this.port2Comp(),s=i.createRef("GroupId"),u=o.type==="SgIpTarget"?o.get("name"):o.createRef("GroupId"),n=[{ary:this.get("in1"),owner:e[i.id].resource.IpPermissions,target:u},{ary:this.get("out1"),owner:e[i.id].resource.IpPermissionsEgress,target:u}],o.type!=="SgIpTarget"&&i!==o&&(n.push({ary:this.get("in2"),owner:e[o.id].resource.IpPermissions,target:s}),n.push({ary:this.get("out2"),owner:e[o.id].resource.IpPermissionsEgress,target:s}));for(a=0,l=n.length;a<l;a++){t=n[a],h=t.ary;for(f=0,c=h.length;f<c;f++)r=h[f],t.owner.push({FromPort:r.fromPort,ToPort:r.toPort?r.toPort:r.fromPort,IpRanges:t.target,IpProtocol:r.protocol==="all"?"-1":r.protocol})}return null}},{getResourceSgRuleSets:function(e){var t,n,r,i,s,o,u,a,f,l;i={},r=[],f=e.connectionTargets("SgAsso");for(s=0,u=f.length;s<u;s++){n=f[s],l=n.connections("SgRuleSet");for(o=0,a=l.length;o<a;o++){t=l[o];if(i[t.id])continue;i[t.id]=!0,r.push(t)}}return r},getRelatedSgRuleSets:function(t,r){var i,s,o,u,a,f,l,c,h,p,d,v,m,g,y;u={},n.instance().typeIsClassic()&&(r.type===e.AWS_RESOURCE_TYPE.AWS_ELB&&(t=temp,t=r,r=temp),t.type===e.AWS_RESOURCE_TYPE.AWS_ELB&&(i=n.modelClassForType(e.AWS_RESOURCE_TYPE.AWS_EC2_SecurityGroup),s=i.getClassicElbSg(),u[s.id]=!0)),m=t.connectionTargets("SgAsso");for(l=0,p=m.length;l<p;l++)f=m[l],u[f.id]=!0;o=[],g=r.connectionTargets("SgAsso");for(c=0,d=g.length;c<d;c++){f=g[c],y=f.connections("SgRuleSet");for(h=0,v=y.length;h<v;h++)a=y[h],u[a.getOtherTarget(f).id]&&o.push(a)}return _.uniq(o)},getPlainObjFromRuleSets:function(e){var t,n,r,i,s,o;n={},i=[];for(s=0,o=e.length;s<o;s++){t=e[s],r=t.direction+t.target+t.protocol+t.port;if(n[r])continue;n[r]=!0,i.push(t)}return i},getGroupedObjFromRuleSets:function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d;a={};for(l=0,h=e.length;l<h;l++){u=e[l],s=u.getTarget("SgIpTarget");if(s&&!s.isClassicElbSg())continue;n=u.port1Comp(),i=n.id,a[i]||(a[i]={ownerId:i,ownerName:n.get("name"),ownerColor:n.color,rules:[]}),n=u.port2Comp(),i=n.id,a[i]||(a[i]={ownerId:i,ownerName:n.get("name"),ownerColor:n.color,rules:[]}),d=u.toPlainObjects(null,!0);for(c=0,p=d.length;c<p;c++)o=d[c],a[o.ownerId].rules.push(o)}t=[];for(f in a)r=a[f],r.rules.length&&t.push(r);return t.sort(function(e,t){return e.ownerName==="DefaultSG"?-1:t.ownerName==="DefaultSG"?1:e.ownerName<t.ownerName?-1:e.ownerName>t.ownerName?1:0})}}),r.DIRECTION={BIWAY:"biway",IN:"inbound",OUT:"outbound"},r})}.call(this),function(){define("module/design/framework/connection/SgLine",["constant","../ConnectionModel","../ResourceModel","component/sgrule/SGRulePopup"],function(e,t,n,r){var i;return i=t.extend({constructor:function(e,n,i,s){if(s&&s.createByUser){new r(e,n);return}void 0;if(!this.assignCompsToPorts(e,n)||!this.isValid())return;return t.call(this,e,n,i,s)},isValid:function(){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x;l=this.port1Comp(),c=this.port2Comp(),t=e.AWS_RESOURCE_TYPE;if(l.type===c.type&&l.type===t.AWS_ELB)return!1;n=this.getTarget(t.AWS_EC2_Instance),o=this.getTarget(t.AWS_VPC_NetworkInterface);if(o){r=o.connectionTargets("EniAttachment");if(r.length===0)return!1;if(r.indexOf(n)>=0)return!1}u=this.getTarget("ExpandedAsg"),f=this.getTarget(t.AWS_AutoScaling_LaunchConfiguration);if(u&&f&&u.get("originalAsg").get("lc")===f)return!1;i=this.getTarget(t.AWS_ELB);if(i){if(!i.get("internal"))return!1;s={},a=!1,E=i.connectionTargets("SgAsso");for(v=0,y=E.length;v<y;v++)p=E[v],s[p.id]=p;S=this.getOtherTarget(i).connectionTargets("SgAsso");for(m=0,b=S.length;m<b;m++){p=S[m],x=p.connections("SgRuleSet");for(g=0,w=x.length;g<w;g++){h=x[g],d=h.getOtherTarget(p);if(!s[d.id])continue;if(h.hasRawRuleTo(s[d.id])){a=!0;break}}if(a)break}if(!a)return!1}return!0},validate:function(){this.isValid()||this.remove({reason:"Validation Failed"})},isRemovable:function(){var e,t,n,r,i,s;e=Design.modelClassForType("SgRuleSet"),t=e.getRelatedSgRuleSets(this.port1Comp(),this.port2Comp()),r=e.getGroupedObjFromRuleSets(t);for(i=0,s=r.length;i<s;i++)n=r[i],n.content=MC.template.sgRuleList(n.rules);return MC.template.groupedSgRuleListDelConfirm(r)},remove:function(e){var n,r,i,s,o;t.prototype.remove.apply(this,arguments);if(e)return;if(this.port1Comp().isRemoved()||this.port2Comp().isRemoved())return;n=Design.modelClassForType("SgRuleSet"),o=n.getRelatedSgRuleSets(this.port1Comp(),this.port2Comp());for(i=0,s=o.length;i<s;i++)r=o[i],r.remove();return null},silentRemove:function(){var e;return e=this.__view,e&&e.detach(),n.prototype.remove.apply(this,arguments),null},type:"SgRuleLine",defaults:{lineType:"sg",dashLine:!0,name:"Security Group Rule"},portDefs:[{port1:{name:"instance-sg",type:e.AWS_RESOURCE_TYPE.AWS_EC2_Instance},port2:{name:"instance-sg",type:e.AWS_RESOURCE_TYPE.AWS_EC2_Instance}},{port1:{name:"instance-sg",type:e.AWS_RESOURCE_TYPE.AWS_EC2_Instance},port2:{name:"eni-sg",type:e.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface}},{port1:{name:"instance-sg",type:e.AWS_RESOURCE_TYPE.AWS_EC2_Instance},port2:{name:"launchconfig-sg",type:e.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration}},{port1:{name:"instance-sg",type:e.AWS_RESOURCE_TYPE.AWS_EC2_Instance},port2:{name:"launchconfig-sg",type:"ExpandedAsg"}},{port1:{name:"instance-sg",type:e.AWS_RESOURCE_TYPE.AWS_EC2_Instance},port2:{name:"elb-sg-in",type:e.AWS_RESOURCE_TYPE.AWS_ELB}},{port1:{name:"eni-sg",type:e.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface},port2:{name:"eni-sg",type:e.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface}},{port1:{name:"launchconfig-sg",type:e.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration},port2:{name:"eni-sg",type:e.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface}},{port1:{name:"launchconfig-sg",type:"ExpandedAsg"},port2:{name:"eni-sg",type:e.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface}},{port1:{name:"elb-sg-in",type:e.AWS_RESOURCE_TYPE.AWS_ELB},port2:{name:"eni-sg",type:e.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface}},{port1:{name:"launchconfig-sg",type:e.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration},port2:{name:"launchconfig-sg",type:e.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration}},{port1:{name:"launchconfig-sg",type:e.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration},port2:{name:"launchconfig-sg",type:"ExpandedAsg"}},{port1:{name:"launchconfig-sg",type:e.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration},port2:{name:"elb-sg-in",type:e.AWS_RESOURCE_TYPE.AWS_ELB}},{port1:{name:"launchconfig-sg",type:e.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration},port2:{name:"elb-sg-in",type:e.AWS_RESOURCE_TYPE.AWS_ELB}},{port1:{name:"launchconfig-sg",type:"ExpandedAsg"},port2:{name:"elb-sg-in",type:e.AWS_RESOURCE_TYPE.AWS_ELB}}]},{isConnectable:function(t,n){var r,i,s,o,u;i=t.type+">"+n.type;if(i.indexOf(e.AWS_RESOURCE_TYPE.AWS_EC2_Instance)!==-1&&i.indexOf(e.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface)!==-1){u=t.connectionTargets("EniAttachment");for(s=0,o=u.length;s<o;s++){r=u[s];if(r===n)return"The Network Interface is attached to the instance. No need to connect them by security group rule."}}return!0}}),i})}.call(this),function(){define("module/design/framework/resource/SgModel",["../ComplexResModel","../ResourceModel","../connection/SgRuleSet","../connection/SgLine","Design","constant"],function(e,t,n,r,i,s){var o,u;return u=e.extend({type:"SgIpTarget",constructor:function(e){var t,n,r,s;t=i.instance().classCacheForCid(this.classId);for(r=0,s=t.length;r<s;r++){n=t[r];if(n.attributes.name===e)return n}return t.push(this),Backbone.Model.call(this,{id:MC.guid(),name:e}),this},isClassicElbSg:function(){return this.attributes.name==="amazon-elb/amazon-elb-sg"},isVisual:function(){return!1}}),o=e.extend({type:s.AWS_RESOURCE_TYPE.AWS_EC2_SecurityGroup,newNameTmpl:"custom-sg-",color:"#f26c4f",defaults:{description:"Custom Security Group",groupName:""},initialize:function(e,t){var r,i;this.color=this.generateColor();if(!t||!t.isDeserialize)this.isElbSg()?(i=n.DIRECTION.IN,r={fromPort:"22",toPort:"",protocol:"tcp"}):(i=n.DIRECTION.OUT,r={fromPort:"0",toPort:"65535",protocol:"-1"}),(new n(this,this.createIpTarget("0.0.0.0/0"))).addRawRule(this.id,i,r);return null},isElbSg:function(){return this.get("isElbSg")},setAsElbSg:function(){return this.set("isElbSg",!0)},isDefault:function(){return this.attributes.name==="DefaultSG"},isVisual:function(){return!1},createIpTarget:function(e){return new u(e)},getNewName:function(){var e;return e=i.modelClassForType(this.type).allObjects(),t.prototype.getNewName.call(this,e.length-1)},ruleCount:function(){var e,t,n,r,i;e=0,i=this.connections("SgRuleSet");for(n=0,r=i.length;n<r;n++)t=i[n],e+=t.ruleCount(this.id);return e},getMemberList:function(){return _.filter(this.connectionTargets("SgAsso"),function(e){return e.type!=="ExpandedAsg"})},connect:function(e){return e.type==="SgAsso"&&this.vlineAdd(e.getOtherTarget(this)),null},disconnect:function(e){return e.type==="SgAsso"?this.vlineRemove(e.getOtherTarget(this),void 0,e):e.type==="SgRuleSet"&&e.port1Comp()===this&&e.port2Comp().type!=="SgIpTarget"&&this.vlineRemoveBatch(e.port2Comp(),e),null},vlineAdd:function(e){var t,n,s,o,u,a,f,l,c;if(!i.instance().shouldDraw())return;t={},l=this.getVisualConnectedSg();for(o=0,a=l.length;o<a;o++){s=l[o],c=s.connectionTargets("SgAsso");for(u=0,f=c.length;u<f;u++){n=c[u];if(t[n.id])continue;e!==n&&new r(e,n),t[n.id]=!0}}return null},vlineAddBatch:function(e){var t,n,s,o,u,a,f,l;if(!i.instance().shouldDraw())return;if(e===this)return;t=this.connectionTargets("SgAsso"),l=e.connectionTargets("SgAsso");for(o=0,a=l.length;o<a;o++){s=l[o];for(u=0,f=t.length;u<f;u++)n=t[u],n!==s&&new r(n,s)}return null},vlineRemove:function(e,t,n){var s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T;if(!i.instance().shouldDraw())return;if(!t){t=[],E=this.getVisualConnectedSg();for(c=0,v=E.length;c<v;c++)f=E[c],t=t.concat(f.connectionTargets("SgAsso"))}o={},S=e.connectionTargets("SgAsso");for(h=0,m=S.length;h<m;h++){a=S[h],x=a.getVisualConnectedSg();for(p=0,g=x.length;p<g;p++){f=x[p],T=f.connectionTargets("SgAsso");for(d=0,y=T.length;d<y;d++)l=T[d],o[l.id]=!0}}for(w=0,b=t.length;w<b;w++){u=t[w];if(u===e)continue;s=r.findExisting(e,u),s&&(o[u.id]?s.validate():s.remove(n))}return null},vlineRemoveBatch:function(e,t){var n,r,s,o,u;if(!i.instance().shouldDraw())return;n=e.connectionTargets("SgAsso"),u=this.connectionTargets("SgAsso");for(s=0,o=u.length;s<o;s++)r=u[s],this.vlineRemove(r,n,t);return null},getVisualConnectedSg:function(){var e,t,n,r,i;t=[],i=this.get("__connections");for(n=0,r=i.length;n<r;n++)e=i[n],e.type==="SgRuleSet"&&e.port1Comp()!==e.port2Comp()&&!e.getTarget("SgIpTarget")&&t.push(e.getOtherTarget(this));return t},generateColor:function(){var e,t,n,r,i,s,u,a;if(this.isDefault())return"#"+MC.canvas.SG_COLORS[0];i={},a=o.allObjects();for(s=0,u=a.length;s<u;s++)r=a[s],i[r.color]=!0;n=1;while(n<MC.canvas.SG_COLORS.length){e="#"+MC.canvas.SG_COLORS[n];if(!i[e]){t=e;break}++n}if(!t){t=Math.floor(Math.random()*16777215).toString(16);while(t.length<6)t="0"+t;t="#"+t}return t},serialize:function(){var e;return e={name:this.get("name"),type:this.type,uid:this.id,resource:{Default:this.isDefault(),GroupId:this.get("appId"),GroupName:this.get("groupName")||this.get("name"),GroupDescription:this.get("description"),VpcId:this.getVpcRef(),IpPermissions:[],IpPermissionsEgress:[]}},{component:e}}},{getClassicElbSg:function(){return new u("amazon-elb/amazon-elb-sg")},getDefaultSg:function(){return _.find(o.allObjects(),function(e){return e.isDefault()})},tryDrawLine:function(e,t){var n,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T;if(t){s={},w=t.connectionTargets("SgAsso");for(a=0,h=w.length;a<h;a++)u=w[a],s[u.id]=!0;E=e.connectionTargets("SgAsso");for(f=0,p=E.length;f<p;f++){u=E[f],S=u.getVisualConnectedSg();for(l=0,d=S.length;l<d;l++){n=S[l];if(s[n.id]){new r(e,t);return}}}}else{o=[],x=e.connectionTargets("SgAsso");for(c=0,v=x.length;c<v;c++){u=x[c],T=u.getVisualConnectedSg();for(y=0,m=T.length;y<m;y++)i=T[y],o=_.union(o,i.connectionTargets("SgAsso"))}for(b=0,g=o.length;b<g;b++)t=o[b],e!==t&&new r(e,t)}return null},updateSgLines:function(){var e,t,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w;void 0,t={},b=n.allObjects();for(p=0,m=b.length;p<m;p++){l=b[p],c=l.port1Comp(),h=l.port2Comp();if(c===h||c.type==="SgIpTarget"||h.type==="SgIpTarget")continue;o=c.connectionTargets("SgAsso"),w=h.connectionTargets("SgAsso");for(d=0,g=w.length;d<g;d++){a=w[d];for(v=0,y=o.length;v<y;v++){u=o[v];if(u.id===a.id)continue;u.id<a.id?s=u.id+"|"+a.id:s=a.id+"|"+u.id,e=t[s]||[],e[0]=u,e[1]=a,t[s]=e}}}for(i in t)f=t[i],new r(f[0],f[1],void 0,{detectDuplicate:!1});return null},handleTypes:s.AWS_RESOURCE_TYPE.AWS_EC2_SecurityGroup,deserialize:function(e,t,r){var i,s,a,f,l,c,h,p,d,v,m,g,y,b,w;a=new o({name:e.name,id:e.uid,appId:e.resource.GroupId,groupName:e.resource.GroupName,description:e.resource.GroupDescription},{isDeserialize:!0}),h=[];if(e.resource.IpPermissions){b=e.resource.IpPermissions;for(p=0,m=b.length;p<m;p++)f=b[p],h.push({rule:f})}if(e.resource.IpPermissionsEgress){w=e.resource.IpPermissionsEgress;for(d=0,g=w.length;d<g;d++)f=w[d],h.push({rule:f,out:!0})}for(v=0,y=h.length;v<y;v++)l=h[v],f=l.rule,f.IpRanges[0]==="@"?c=r(MC.extractID(f.IpRanges)):c=new u(f.IpRanges),i={fromPort:f.FromPort,toPort:f.ToPort,protocol:f.IpProtocol},s=l.out?n.DIRECTION.OUT:n.DIRECTION.IN,(new n(a,c)).addRawRule(a.id,s,i);return null}}),i.on(i.EVENT.Deserialized,o.updateSgLines),o})}.call(this),function(){define("module/design/framework/resource/SslCertModel",["constant","../ComplexResModel","../ConnectionModel"],function(e,t,n){var r,i;return i=n.extend({type:"SslCertUsage",oneToMany:e.AWS_RESOURCE_TYPE.AWS_IAM_ServerCertificate}),r=t.extend({type:e.AWS_RESOURCE_TYPE.AWS_IAM_ServerCertificate,defaults:{name:"v",body:"",chain:"",key:"",arn:"",certId:""},isVisual:function(){return!1},assignTo:function(e){return new i(this,e)},serialize:function(){return{component:{uid:this.id,type:"AWS.IAM.ServerCertificate",name:this.get("name"),resource:{PrivateKey:this.get("key"),CertificateBody:this.get("body"),CertificateChain:this.get("chain"),ServerCertificateMetadata:{ServerCertificateName:this.get("appName")||this.get("name"),Arn:this.get("arn")||"",ServerCertificateId:this.get("certId")||""}}}}},updateValue:function(e){var t,n;for(t in e)n=e[t],this.set(t,n);return null}},{handleTypes:e.AWS_RESOURCE_TYPE.AWS_IAM_ServerCertificate,deserialize:function(e){return new r({id:e.uid,name:e.name,body:e.resource.CertificateBody,chain:e.resource.CertificateChain,key:e.resource.PrivateKey,arn:e.resource.ServerCertificateMetadata.Arn,certId:e.resource.ServerCertificateMetadata.ServerCertificateId,appName:e.resource.ServerCertificateMetadata.ServerCertificateName}),null}}),r})}.call(this),function(){define("module/design/framework/connection/ElbAsso",["constant","../ConnectionModel","i18n!nls/lang.js","Design","component/sgrule/SGRulePopup"],function(e,t,n,r,i){var s,o;return o=t.extend({type:"ElbSubnetAsso",defaults:{lineType:"association",deserialized:!1},portDefs:[{port1:{name:"elb-assoc",type:e.AWS_RESOURCE_TYPE.AWS_ELB},port2:{name:"subnet-assoc-in",type:e.AWS_RESOURCE_TYPE.AWS_VPC_Subnet}}],initialize:function(){var t,n,r,i,s,o;r=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_VPC_Subnet),t=r.parent(),o=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_ELB).connections("ElbSubnetAsso");for(i=0,s=o.length;i<s;i++)n=o[i],n.getTarget(e.AWS_RESOURCE_TYPE.AWS_VPC_Subnet).parent()===t&&(n.hasAppUpdateRestriction()?this.setDestroyAfterInit():n.remove());return null},hasAppUpdateRestriction:function(){var t,n,r,i,s;n=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_ELB);if(this.design().modeIsAppEdit()){s=n.connections("ElbSubnetAsso");for(r=0,i=s.length;r<i;r++){t=s[r];if(t!==this&&t.get("deserialized"))return!1}return!0}return!1},isRemovable:function(){var t;if(this.design().modeIsAppEdit()){if(this.hasAppUpdateRestriction())return{error:n.ide.CVS_MSG_ERR_DEL_ELB_LINE_2}}else{t=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_ELB);if(t.connections("ElbAmiAsso").length>0&&t.connections("ElbSubnetAsso").length<=1)return{error:n.ide.CVS_MSG_ERR_DEL_ELB_LINE_1}}return!0}},{isConnectable:function(t,r){var i;return i=t.type===e.AWS_RESOURCE_TYPE.AWS_VPC_Subnet?t:r,parseInt(i.get("cidr").split("/")[1],10)<=27?!0:n.ide.CVS_MSG_WARN_CANNOT_CONNECT_SUBNET_TO_ELB}}),s=t.extend({type:"ElbAmiAsso",defaults:function(){return{lineType:"elb-sg"}},portDefs:[{port1:{name:"elb-sg-out",type:e.AWS_RESOURCE_TYPE.AWS_ELB},port2:{name:"instance-sg",type:e.AWS_RESOURCE_TYPE.AWS_EC2_Instance}},{port1:{name:"elb-sg-out",type:e.AWS_RESOURCE_TYPE.AWS_ELB},port2:{name:"launchconfig-sg",type:e.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration}},{port1:{name:"elb-sg-out",type:e.AWS_RESOURCE_TYPE.AWS_ELB},port2:{name:"launchconfig-sg",type:"ExpandedAsg"}}],initialize:function(t,n){var u,a,f,l,c,h,p;if(!r.instance().typeIsVpc())return;n&&n.createByUser&&new i(this.id),u=this.getOtherTarget(e.AWS_RESOURCE_TYPE.AWS_ELB),f=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_ELB);if(f.connections("ElbSubnetAsso").length===0){l=u.parent();while(l.type!==e.AWS_RESOURCE_TYPE.AWS_VPC_Subnet)l=l.parent();l&&new o(f,l)}if(u.type===e.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration){p=u.parent().get("expandedList");for(c=0,h=p.length;c<h;c++)a=p[c],new s(a,f)}return null},remove:function(n){var r,i,o,u,a,f,l,c;if(n&&n.reason.type!==e.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration){t.prototype.remove.apply(this,arguments);return}o=this.getTarget("ExpandedAsg");if(o&&!o.isRemoved()){i=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_ELB),u=o.getLc(),(new s(i,u)).remove();return}u=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration);if(u){i=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_ELB),a={reason:this},c=u.parent().get("expandedList");for(f=0,l=c.length;f<l;f++)r=c[f],(new s(i,r)).remove(a)}return t.prototype.remove.apply(this,arguments),null},serialize:function(t){var n,r,i,s,o,u,a;i=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_EC2_Instance);if(!i)return;n=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_ELB),s=t[n.id].resource.Instances,a=i.getRealGroupMemberIds();for(o=0,u=a.length;o<u;o++)r=a[o],s.push({InstanceId:this.createRef("InstanceId",r)});return null}}),null})}.call(this),function(){define("module/design/framework/resource/ElbModel",["Design","constant","../ResourceModel","../ComplexResModel","./VpcModel","./SgModel","./SslCertModel","../connection/SgAsso","../connection/ElbAsso"],function(e,t,n,r,i,s,o,u){var a;return a=r.extend({defaults:function(){return{x:0,y:0,width:9,height:9,internal:e.instance().typeIsClassic()?!1:!0,crossZone:!0,healthyThreshold:"9",unHealthyThreshold:"4",healthCheckTarget:"HTTP:80/index.html",healthCheckInterval:"30",healthCheckTimeout:"5",listeners:[{port:"80",protocol:"HTTP",instanceProtocol:"HTTP",instancePort:"80"}],AvailabilityZones:[],ConnectionDraining:{Enabled:!0,Timeout:300},otherPoliciesMap:{}}},type:t.AWS_RESOURCE_TYPE.AWS_ELB,newNameTmpl:"load-balancer-",initialize:function(t,n){var r,i;return this.draw(!0),n.createByUser&&!e.instance().typeIsClassic()&&(i=new s({name:this.getElbSgName(),isElbSg:!0,description:"Automatically created SG for load-balancer"}),this.__elbSg=i,r=e.modelClassForType("SgAsso"),new r(this,i)),null},isRemovable:function(){var e;return e=this.getElbSg(),e&&e.connections("SgAsso").length>1?MC.template.ElbRemoveConfirmation({name:this.get("name"),sg:e.get("name")}):!0},remove:function(){return this.getElbSg()&&this.getElbSg().remove(),r.prototype.remove.call(this),null},getElbSg:function(){return this.__elbSg&&this.__elbSg.isRemoved()&&(this.__elbSg=void 0),this.__elbSg},getElbSgName:function(){return"elbsg-"+this.get("name")},setName:function(e){if(this.get("name")===e)return;return this.set("name",e),this.getElbSg()&&this.getElbSg().set("name",this.getElbSgName()),this.draw&&this.draw(),null},setListener:function(e,t){var n;return void 0,n=this.get("listeners"),e>=n.length?n.push(t):n[e]=$.extend({},t),null},removeListener:function(e){var t;if(e===0)return;return t=this.get("listeners"),t.splice(e,1),this.set("listeners",t),null},getHealthCheckTarget:function(){var e,t,n,r,i;return i=this.attributes.healthCheckTarget,r=i.indexOf(":"),n=i.substring(0,r),i=i.substring(r+1),t=parseInt(i,10),isNaN(t)&&(t=80),e=i.replace(/[^\/]+\//,""),[n,t,e]},setHealthCheckTarget:function(e,t,n){var r;return r=this.getHealthCheckTarget(),e&&(r[0]=e),t!==void 0&&(r[1]=t),n!==void 0&&(r[2]=n),this.set("healthCheckTarget",r[0]+":"+r[1]+"/"+r[2]),null},setInternal:function(n){var r,i,o,u;this.set("internal",!!n),this.draw();if(n)s=e.modelClassForType(t.AWS_RESOURCE_TYPE.AWS_EC2_SecurityGroup),s.tryDrawLine(this);else{u=this.connections("SgRuleLine");for(i=0,o=u.length;i<o;i++)r=u[i],r.remove(this)}return null},getCost:function(e,n){var r,i,s,o,u;if(!e.elb||!e.elb.types)return null;u=e.elb.types;for(s=0,o=u.length;s<o;s++){i=u[s];if(i.unit==="perELBHour"){r=parseFloat(i[n],10)||0;break}}if(r)return{resource:this.get("name"),type:t.AWS_RESOURCE_TYPE.AWS_ELB,fee:r*24*30,formatedFee:r+"/hr"}},getAvailabilityZones:function(){var n;return e.instance().typeIsVpc()?(n=_.map(this.connectionTargets("ElbSubnetAsso"),function(e){return e.parent().createRef()}),_.uniq(n)):(n=_.map(this.connectionTargets("ElbAmiAsso"),function(e){return e.parent().type===t.AWS_RESOURCE_TYPE.AWS_EC2_AvailabilityZone?e.parent().get("name"):e.parent().parent().get("name")}),_.uniq(n.concat(this.get("AvailabilityZones"))))},setPolicyProxyProtocol:function(e,t){var n;return n=this.get("otherPoliciesMap"),e?n.EnableProxyProtocol={PolicyName:"EnableProxyProtocol",PolicyTypeName:"ProxyProtocolPolicyType",PolicyAttributes:{ProxyProtocol:!0},InstancePort:t}:delete n.EnableProxyProtocol,this.set("otherPoliciesMap",n)},serialize:function(){var t,n,r,i,s,o,u,a,f,l,c,h,p,d;n=this.get("healthCheckTarget");if(n.indexOf("TCP")!==-1||n.indexOf("SSL")!==-1)n=n.split("/")[0];s=[],f=this.connectionTargets("SslCertUsage")[0],f?l=f.createRef("ServerCertificateMetadata.Arn"):l="",d=this.get("listeners");for(h=0,p=d.length;h<p;h++)i=d[h],i.protocol==="SSL"||i.protocol==="HTTPS"?r=l:r="",s.push({PolicyNames:"",Listener:{LoadBalancerPort:i.port,Protocol:i.protocol,InstanceProtocol:i.instanceProtocol,InstancePort:i.instancePort,SSLCertificateId:r}});return a=_.map(this.connectionTargets("SgAsso"),function(e){return e.createRef("GroupId")}),e.instance().typeIsClassic()?c=[]:e.instance().typeIsDefaultVpc()?(c=_.map(this.connectionTargets("ElbAmiAsso"),function(e){return e.getSubnetRef()}),c=_.uniq(c)):c=_.map(this.connectionTargets("ElbSubnetAsso"),function(e){return e.createRef("SubnetId")}),u=this.get("otherPoliciesMap"),o=_.map(u,function(e){return e}),o||(o=[]),t={type:this.type,uid:this.id,name:this.get("name"),resource:{AvailabilityZones:[],Subnets:c,Instances:[],CrossZoneLoadBalancing:this.get("crossZone"),ConnectionDraining:this.get("ConnectionDraining"),VpcId:this.getVpcRef(),LoadBalancerName:this.get("elbName")||this.get("name"),SecurityGroups:a,Scheme:this.get("internal")?"internal":"internet-facing",ListenerDescriptions:s,HealthCheck:{Interval:this.get("healthCheckInterval"),Target:n,Timeout:this.get("healthCheckTimeout"),HealthyThreshold:this.get("healthyThreshold"),UnhealthyThreshold:this.get("unHealthyThreshold")},DNSName:this.get("dnsName")||"",Policies:{LBCookieStickinessPolicies:[{PolicyName:"",CookieExpirationPeriod:""}],AppCookieStickinessPolicies:[{PolicyName:"",CookieName:""}],OtherPolicies:o},BackendServerDescriptions:[{InstantPort:"",PoliciyNames:""}]}},{component:t,layout:this.generateLayout()}}},{handleTypes:t.AWS_RESOURCE_TYPE.AWS_ELB,deserialize:function(t,n,r){var i,s,o,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k;f={id:t.uid,name:t.name,appId:t.resource.DNSName,parent:r(n.groupUId),internal:t.resource.Scheme==="internal",crossZone:!!t.resource.CrossZoneLoadBalancing,ConnectionDraining:t.resource.ConnectionDraining||{Enabled:!0,Timeout:300},listeners:[],dnsName:t.resource.DNSName,elbName:t.resource.LoadBalancerName,healthyThreshold:t.resource.HealthCheck.HealthyThreshold,unHealthyThreshold:t.resource.HealthCheck.UnhealthyThreshold,healthCheckTarget:t.resource.HealthCheck.Target,healthCheckInterval:t.resource.HealthCheck.Interval,healthCheckTimeout:t.resource.HealthCheck.Timeout,x:n.coordinate[0],y:n.coordinate[1],otherPoliciesMap:{}},t.resource.Policies&&t.resource.Policies.OtherPolicies&&_.each(t.resource.Policies.OtherPolicies,function(e){return f.otherPoliciesMap[e.PolicyName]=e,null}),f.AvailabilityZones=_.map(t.resource.AvailabilityZones||[],function(e){return e[0]==="@"?r(MC.extractID(e)).get("name"):e}),v=null,T=t.resource.ListenerDescriptions||[];for(m=0,w=T.length;m<w;m++)h=T[m],h=h.Listener,f.listeners.push({port:h.LoadBalancerPort,protocol:h.Protocol,instanceProtocol:h.InstanceProtocol,instancePort:h.InstancePort}),h.SSLCertificateId&&!v&&(v=r(MC.extractID(h.SSLCertificateId)));l=new a(f),v&&v.assignTo(l),i=e.modelClassForType("ElbAmiAsso"),s=e.modelClassForType("ElbSubnetAsso"),N=t.resource.SecurityGroups||[];for(g=0,E=N.length;g<E;g++)d=N[g],new u(l,r(MC.extractID(d)));if(e.instance().typeIsVpc()){C=t.resource.Subnets||[];for(y=0,S=C.length;y<S;y++)p=C[y],new s(l,r(MC.extractID(p)),{deserialized:!0})}k=t.resource.Instances||[];for(b=0,x=k.length;b<x;b++)o=k[b],c=r(MC.extractID(o.InstanceId)),c&&new i(l,c);return null},postDeserialize:function(t,n){var r,i,o,u,a,f;r=e.instance().component(t.uid),o=r.getElbSgName(),f=s.allObjects();for(u=0,a=f.length;u<a;u++){i=f[u];if(i.get("name")===o){r.__elbSg=i,i.setAsElbSg();return}}}}),a})}.call(this),function(){define("module/design/framework/resource/LcModel",["../ComplexResModel","./InstanceModel","Design","constant","./VolumeModel","i18n!nls/lang.js"],function(e,t,n,r,i,s){var o,u;return u=[],o=e.extend({defaults:function(){return{x:0,y:0,width:9,height:9,imageId:"",ebsOptimized:!1,instanceType:"m1.small",monitoring:!1,userData:"",publicIp:n.instance().typeIsDefaultVpc(),state:void 0,rdSize:0,rdIops:""}},type:r.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration,newNameTmpl:"launch-config-",constructor:function(t,n){if(n&&n.createByUser&&t.parent.get("lc"))return;return e.call(this,t,n)},initialize:function(e,t){var i,s,o;return this.draw(!0),t&&t.createByUser&&(this.initInstanceType(),i=n.modelClassForType(r.AWS_RESOURCE_TYPE.AWS_EC2_KeyPair),i.getDefaultKP().assignTo(this),o=n.modelClassForType(r.AWS_RESOURCE_TYPE.AWS_EC2_SecurityGroup).getDefaultSg(),s=n.modelClassForType("SgAsso"),new s(o,this)),this.get("rdSize")||this.set("rdSize",this.getAmiRootDeviceVolumeSize()),null},getNewName:function(e){var t,r,i,s,o,u;if(!this.newNameTmpl)return s=this.defaults?this.defaults.name:void 0,s||"";e===void 0&&(r=n.modelClassForType(this.type).allObjects(),e=r.length),i={},this.design().eachComponent(function(e){return e.get("name")&&(i[e.get("name")]=!0),null});if(n.instance().modeIsAppEdit()){o=MC.data.resource_list[n.instance().region()];for(t in o)u=o[t],u.LaunchConfigurationName&&(i[_.first(u.LaunchConfigurationName.split("---"))]=!0)}for(;;){s=this.newNameTmpl+e;if(!i[s])break;e+=1}return s},isRemovable:function(){var e;return this.design().modeIsAppEdit()&&this.get("appId")?{error:s.ide.CVS_MSG_ERR_DEL_LC}:(e=this.get("state"),e!==void 0&&e.length>0?MC.template.NodeStateRemoveConfirmation({name:this.get("name")}):!0)},isDefaultTenancy:function(){return!0},groupMembers:function(){var e,t,r,i,s,o,u;i=MC.data.resource_list[n.instance().region()];if(!i)return[];r=i[this.parent().get("appId")];if(r&&r.Instances&&r.Instances.member){e=[],u=r.Instances.member;for(s=0,o=u.length;s<o;s++)t=u[s],e.push({id:t.InstanceId,appId:t.InstanceId,state:t.HealthStatus})}return e||[]},remove:function(){var t,n,r,i;i=(this.get("volumeList")||u).slice(0);for(n=0,r=i.length;n<r;n++)t=i[n],t.remove();return e.prototype.remove.call(this),null},connect:function(e){return this.parent()&&e.type==="SgRuleLine"&&this.parent().updateExpandedAsgSgLine(e.getOtherTarget(this)),null},disconnect:function(e){return this.parent()&&e.type!=="ElbAmiAsso"&&e.type==="SgRuleLine"&&this.parent().updateExpandedAsgSgLine(e.getOtherTarget(this),!0),null},getStateData:function(){return this.get("state")},setStateData:function(e){return this.set("state",e)},setAmi:t.prototype.setAmi,getAmi:t.prototype.getAmi,getDetailedOSFamily:t.prototype.getDetailedOSFamily,setInstanceType:t.prototype.setInstanceType,initInstanceType:t.prototype.initInstanceType,isEbsOptimizedEnabled:t.prototype.isEbsOptimizedEnabled,getBlockDeviceMapping:t.prototype.getBlockDeviceMapping,getAmiRootDevice:t.prototype.getAmiRootDevice,getAmiRootDeviceName:t.prototype.getAmiRootDeviceName,getAmiRootDeviceVolumeSize:t.prototype.getAmiRootDeviceVolumeSize,serialize:function(){var e,t,n,r,i,s,o,a,f,l;e=this.getAmi()||this.get("cachedAmi"),r=this.generateLayout(),e&&(r.osType=e.osType,r.architecture=e.architecture,r.rootDeviceType=e.rootDeviceType),i=_.map(this.connectionTargets("SgAsso"),function(e){return e.createRef("GroupId")}),t=this.getBlockDeviceMapping(),l=this.get("volumeList")||u;for(a=0,f=l.length;a<f;a++)o=l[a],s={DeviceName:o.get("name"),Ebs:{VolumeSize:o.get("volumeSize"),VolumeType:o.get("volumeType")}},o.get("volumeType")==="io1"&&(s.Ebs.Iops=o.get("iops")),o.get("snapshotId")&&(s.Ebs.SnapshotId=o.get("snapshotId")),t.push(s);return n={type:this.type,uid:this.id,name:this.get("name"),state:this.get("state"),resource:{UserData:this.get("userData"),LaunchConfigurationARN:this.get("appId"),InstanceMonitoring:this.get("monitoring"),ImageId:this.get("imageId"),EbsOptimized:this.isEbsOptimizedEnabled()?this.get("ebsOptimized"):!1,BlockDeviceMapping:t,KeyName:"",SecurityGroups:i,LaunchConfigurationName:this.get("configName")||this.get("name"),InstanceType:this.get("instanceType"),AssociatePublicIpAddress:this.get("publicIp")}},{component:n,layout:r}}},{handleTypes:r.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration,deserialize:function(e,t,r){var s,u,a,f,l,c,h,p,d,v,m,g,y;u={id:e.uid,name:e.name,state:e.state,appId:e.resource.LaunchConfigurationARN,imageId:e.resource.ImageId,ebsOptimized:e.resource.EbsOptimized,instanceType:e.resource.InstanceType,monitoring:e.resource.InstanceMonitoring,userData:e.resource.UserData,publicIp:e.resource.AssociatePublicIpAddress,configName:e.resource.LaunchConfigurationName,x:t.coordinate[0],y:t.coordinate[1]},t.osType&&t.architecture&&t.rootDeviceType&&(u.cachedAmi={osType:t.osType,architecture:t.architecture,rootDeviceType:t.rootDeviceType}),a=new o(u),f=a.getAmiRootDevice(),g=e.resource.BlockDeviceMapping||[];for(p=0,v=g.length;p<v;p++)c=g[p],f&&c.DeviceName===f.DeviceName?(a.set("rdSize",c.Ebs.VolumeSize),a.set("rdIops",c.Ebs.Iops)):(h={name:c.DeviceName,snapshotId:c.Ebs.SnapshotId,volumeSize:c.Ebs.VolumeSize,iops:c.Ebs.Iops,owner:a},new i(h,{noNeedGenName:!0}));s=n.modelClassForType("SgAsso"),y=e.resource.SecurityGroups||[];for(d=0,m=y.length;d<m;d++)l=y[d],new s(a,r(MC.extractID(l)));return r(MC.extractID(e.resource.KeyName)).assignTo(a),null}}),o})}.call(this),function(){define("module/design/framework/resource/KeypairModel",["constant","../ComplexResModel","../ConnectionModel"],function(e,t,n){var r,i;return i=n.extend({type:"KeypairUsage",oneToMany:e.AWS_RESOURCE_TYPE.AWS_EC2_KeyPair,serialize:function(t){var n,r;return n=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_EC2_KeyPair),r=this.getOtherTarget(n),t[r.id].resource.KeyName=n.createRef("KeyName"),null}}),r=t.extend({type:e.AWS_RESOURCE_TYPE.AWS_EC2_KeyPair,defaults:{fingerprint:""},isVisual:function(){return!1},remove:function(){var e,n,s,o,u;e=r.getDefaultKP(),u=this.connectionTargets("KeypairUsage");for(s=0,o=u.length;s<o;s++)n=u[s],new i(e,n);return t.prototype.remove.call(this),null},assignTo:function(e){return new i(this,e)},getKPList:function(){var e,t,n,i,s;t=[],s=r.allObjects();for(n=0,i=s.length;n<i;n++)e=s[n],t.push({id:e.id,name:e.get("name"),selected:e===this,using:e.connections("KeypairUsage").length>1});return _.sortBy(t,function(e,t){if(e.name==="DefaultKP")return-1;if(t.name==="DefaultKP")return 1;if(e.name>t.name)return 1;if(e.name===t.name)return 0;if(e.name<t.name)return-1})},serialize:function(){return{component:{name:this.get("name"),type:this.type,uid:this.id,resource:{KeyFingerprint:this.get("fingerprint"),KeyName:this.get("appId")||this.get("name")}}}}},{getDefaultKP:function(){return _.find(r.allObjects(),function(e){return e.get("name")==="DefaultKP"})},diffJson:function(){},handleTypes:e.AWS_RESOURCE_TYPE.AWS_EC2_KeyPair,deserialize:function(e,t,n){return new r({id:e.uid,name:e.name,appId:e.resource.KeyName,fingerprint:e.resource.KeyFingerprint}),null}}),r})}.call(this),function(){define("module/design/framework/connection/Route",["constant","../ConnectionModel"],function(e,t){var n;return n=t.extend({type:"RTB_Route",defaults:function(){return{lineType:"rtb-target",dashLine:!0,routes:[]}},initialize:function(t,n){var r;return r=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_VPC_InternetGateway),r&&!t.routes&&this.get("routes").push("0.0.0.0/0"),null},addRoute:function(e){var t,n;return n=this.get("routes"),t=_.indexOf(n,e),t!==-1?!1:(n.push(e),this.set("routes",n),!0)},removeRoute:function(e){var t,n;return n=this.get("routes"),t=_.indexOf(n,e),t!==-1?!1:(n.splice(t,1),this.set("routes",n),!0)},setPropagate:function(e){return void 0,this.set("propagate",e)},serialize:function(t){var n,r,i,s,o,u,a,f,l,c;u=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_VPC_RouteTable),i=this.getOtherTarget(u),a=t[u.id],this.get("propagate")&&a.resource.PropagatingVgwSet.push(i.createRef("VpnGatewayId")),o={Origin:"",InstanceId:"",NetworkInterfaceId:"",GatewayId:""},n=e.AWS_RESOURCE_TYPE;switch(i.type){case n.AWS_VPC_NetworkInterface:o.NetworkInterfaceId=i.createRef("NetworkInterfaceId");break;case n.AWS_VPC_InternetGateway:o.GatewayId=i.createRef("InternetGatewayId");break;case n.AWS_VPC_VPNGateway:o.GatewayId=i.createRef("VpnGatewayId");break;case n.AWS_EC2_Instance:o.NetworkInterfaceId=i.getEmbedEni().createRef("NetworkInterfaceId")}c=this.get("routes");for(f=0,l=c.length;f<l;f++)s=c[f],r={DestinationCidrBlock:s},a.resource.RouteSet.push($.extend(r,o));return null},portDefs:[{port1:{name:"igw-tgt",type:e.AWS_RESOURCE_TYPE.AWS_VPC_InternetGateway},port2:{name:"rtb-tgt",type:e.AWS_RESOURCE_TYPE.AWS_VPC_RouteTable}},{port1:{name:"instance-rtb",type:e.AWS_RESOURCE_TYPE.AWS_EC2_Instance},port2:{name:"rtb-tgt",type:e.AWS_RESOURCE_TYPE.AWS_VPC_RouteTable}},{port1:{name:"eni-rtb",type:e.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface},port2:{name:"rtb-tgt",type:e.AWS_RESOURCE_TYPE.AWS_VPC_RouteTable}},{port1:{name:"vgw-tgt",type:e.AWS_RESOURCE_TYPE.AWS_VPC_VPNGateway},port2:{name:"rtb-tgt",type:e.AWS_RESOURCE_TYPE.AWS_VPC_RouteTable}}]}),n})}.call(this),function(){define("module/design/framework/connection/RtbAsso",["constant","../ConnectionModel"],function(e,t){var n;return n=t.extend({type:"RTB_Asso",oneToMany:e.AWS_RESOURCE_TYPE.AWS_VPC_RouteTable,defaults:{lineType:"association",implicit:!1},portDefs:{port1:{name:"subnet-assoc-out",type:e.AWS_RESOURCE_TYPE.AWS_VPC_Subnet},port2:{name:"rtb-src",type:e.AWS_RESOURCE_TYPE.AWS_VPC_RouteTable}},serialize:function(t){var n,r,i;if(this.get("implicit"))return;return i=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_VPC_Subnet),n=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_VPC_RouteTable),r=t[n.id],r.resource.AssociationSet.push({SubnetId:i.createRef("SubnetId"),RouteTableAssociationId:this.get("assoId")||"",Main:!1}),null},remove:function(){var r,i,s,o,u;o=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_VPC_Subnet);if(!o.isRemoved()){u=o.connections("RTB_Asso");if(u.length===0||u.length===1&&u[0]===this){s=this.getTarget(e.AWS_RESOURCE_TYPE.AWS_VPC_RouteTable);if(s.get("main")){this.set("implicit",!0);return}t.prototype.remove.apply(this,arguments),r=Design.modelClassForType(e.AWS_RESOURCE_TYPE.AWS_VPC_RouteTable),i=r.getMainRouteTable(),new n(o,i,{implicit:!0});return}}return t.prototype.remove.apply(this,arguments),null}}),n})}.call(this),function(){define("module/design/framework/resource/RtbModel",["../ComplexResModel","Design","../connection/Route","../connection/RtbAsso","./VpcModel","constant","i18n!nls/lang.js"],function(e,t,n,r,i,s,o){var u;return u=e.extend({defaults:{main:!1,x:50,y:5,width:8,height:8,implicit:!1},type:s.AWS_RESOURCE_TYPE.AWS_VPC_RouteTable,newNameTmpl:"RT-",initialize:function(){return this.draw(!0),null},isRemovable:function(){return this.get("main")?{error:sprintf(o.ide.CVS_MSG_ERR_DEL_MAIN_RT,this.get("name"))}:!0},setMain:function(){var e,n,i,o,a,f,l;if(this.get("main"))return;n=u.getMainRouteTable(),n.set("main",!1),n.draw(),this.set("main",!0),this.draw(),o=t.modelClassForType(s.AWS_RESOURCE_TYPE.AWS_VPC_Subnet).allObjects(),l=[];for(a=0,f=o.length;a<f;a++)i=o[a],e=i.connections("RTB_Asso")[0],void 0,e.get("implicit")?l.push(new r(this,i,{implicit:!0})):l.push(void 0);return l},addRoute:function(e,r,i){var o,u;o=t.instance().component(e);if(!o)return;return o.type===s.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface&&o.embedInstance()&&(o=o.embedInstance()),u=new n(this,o),u.addRoute(r),i!==void 0&&u.setPropagate(i),null},serialize:function(){var e;return e={name:this.get("name"),type:this.type,uid:this.id,resource:{PropagatingVgwSet:[],RouteTableId:this.get("appId"),VpcId:this.parent().createRef("VpcId"),AssociationSet:[],RouteSet:[{Origin:"CreateRouteTable",DestinationCidrBlock:this.parent().get("cidr"),InstanceId:"",NetworkInterfaceId:"",GatewayId:"local"}]}},this.get("main")&&e.resource.AssociationSet.push({Main:"true",RouteTableAssociationId:"",SubnetId:""}),{component:e,layout:this.generateLayout()}}},{getMainRouteTable:function(){return _.find(u.allObjects(),function(e){return e.get("main")})},handleTypes:s.AWS_RESOURCE_TYPE.AWS_VPC_RouteTable,resolveFirst:!0,preDeserialize:function(e,t){var n,r;return e.resource.AssociationSet&&e.resource.AssociationSet[0]&&(n=""+e.resource.AssociationSet[0].Main=="true"),r=new u({id:e.uid,appId:e.resource.RouteTableId,name:e.name,main:!!n,x:t.coordinate[0],y:t.coordinate[1]}),e.uid=r.id,null},deserialize:function(e,t,n){var r,s;return r=n(e.uid),s=n(t.groupUId),s||(s=i.theVPC()),s.addChild(r),null},postDeserialize:function(e,n){var i,s,o,u,a,f,l,c,h,p,d,v,m,g;i=t.instance(),c=i.component(e.uid),m=e.resource.AssociationSet||[];for(h=0,d=m.length;h<d;h++)a=m[h],!a.Main&&a.SubnetId&&new r(c,i.component(MC.extractID(a.SubnetId)),{implicit:!1,assoId:a.RouteTableAssociationId});l=e.resource.RouteSet;if(l&&l.length>1){u={},g=e.resource.PropagatingVgwSet||[];for(p=0,v=g.length;p<v;p++)f=g[p],u[MC.extractID(f)]=!0;s=0;while(s<l.length)a=l[s],a.GatewayId!=="local"&&(o=MC.extractID(a.GatewayId||a.InstanceId||a.NetworkInterfaceId),c.addRoute(o,a.DestinationCidrBlock,u[o])),++s}return null}}),u})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define("module/design/framework/resource/SubnetModel",["constant","Design","../GroupModel","../connection/RtbAsso","i18n!nls/lang.js"],function(t,n,r,i,s){var o,u;return u=function(e){var t,n,r,i,s,o;return t=e.split("/"),n=t[0],o=Number(t[1]),s=32-o,r=n.split("."),i=r.map(function(e){return MC.leftPadString(parseInt(e).toString(2),8,"0")}),i.join("")},o=r.extend({type:t.AWS_RESOURCE_TYPE.AWS_VPC_Subnet,newNameTmpl:"subnet",defaults:{x:2,y:2,width:17,height:17,cidr:""},initialize:function(e,r){var s,o,u,a;return this.attributes.cidr||(this.attributes.cidr=this.generateCidr()),this.draw(!0),u=n.modelClassForType(t.AWS_RESOURCE_TYPE.AWS_VPC_RouteTable),new i(this,u.getMainRouteTable(),{implicit:!0}),s=n.modelClassForType(t.AWS_RESOURCE_TYPE.AWS_VPC_NetworkAcl),a=s.getDefaultAcl(),a&&(o=n.modelClassForType("AclAsso"),new o(this,a)),null},setCidr:function(e){return this.set("cidr",e),this.draw(),null},setAcl:function(e){var t;return t=n.modelClassForType("AclAsso"),new t(this,n.instance().component(e)),null},isReparentable:function(e){var n,r,i,o,u,a,f,l;f=this.children();for(i=0,u=f.length;i<u;i++){r=f[i];if(r.type===t.AWS_RESOURCE_TYPE.AWS_EC2_Instance||r.type===t.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface){l=r.connectionTargets("EniAttachment");for(o=0,a=l.length;o<a;o++){n=l[o];if(n.parent()!==this)return s.ide.CVS_MSG_ERR_MOVE_ATTACHED_ENI}}if(r.type===t.AWS_RESOURCE_TYPE.AWS_AutoScaling_Group||r.type==="ExpandedAsg"){r.type==="ExpandedAsg"&&(r=r.get("originalAsg"));if(r.getExpandAzs().indexOf(e)!==-1)return sprintf(s.ide.CVS_MSG_ERR_DROP_ASG,r.get("name"),e.get("name"))}}return!0},isRemovable:function(){var e,t,n,r,i,o,u,a,f;a=this.connections("ElbSubnetAsso");for(r=0,o=a.length;r<o;r++){t=a[r];if(t.isRemovable()!==!0){n=!0;if(this.design().modeIsStack()){n=!1,f=t.getOtherTarget(this).connectionTargets("ElbAmiAsso");for(i=0,u=f.length;i<u;i++){e=f[i];if(e.parent()!==this&&e.parent().parent()!==this){n=!0;break}}}if(n)return{error:s.ide.CVS_MSG_ERR_DEL_LINKED_ELB}}}return!0},onParentChanged:function(){var e,n,r,i,s;e=this.connections("ElbSubnetAsso")[0];if(!e)return;s=e.getTarget(t.AWS_RESOURCE_TYPE.AWS_ELB).connectionTargets("ElbSubnetAsso");for(r=0,i=s.length;r<i;r++){n=s[r];if(n.parent()===this.parent()){e.remove();return}}return null},isValidCidr:function(e){return o.isInVPCCIDR(this.parent().parent().get("cidr"),e)?this.isCidrConfilctWithSubnets(e)?{error:""+e+" conflicts with other subnet.",detail:"Please choose a CIDR block not conflicting with existing subnet."}:this.isCidrEnoughForIps(e)?this.connections("ElbSubnetAsso").length&&Number(e.split("/")[1])>27?{error:"The subnet is attached with a load balancer. The CIDR mask must be smaller than /27.",shouldRemove:!1}:!0:{error:""+e+" has not enough IP for the ENIs in this subnet."}:{error:""+e+" conflicts with VPC CIDR.",detail:"Subnet CIDR block should be a subset of VPC's."}},isCidrConfilctWithSubnets:function(e){var t,n,r,i,s;e=e||this.get("cidr"),s=o.allObjects();for(r=0,i=s.length;r<i;r++){n=s[r];if(n!==this){t=o.isCidrConflict(n.get("cidr"),e);if(t)return!0}}return!1},isCidrEnoughForIps:function(e){var r,i,s,o,u,a,f;e=e||this.get("cidr"),s=0,f=this.children();for(u=0,a=f.length;u<a;u++){r=f[u];if(r.type===t.AWS_RESOURCE_TYPE.AWS_EC2_Instance)i=r.getEmbedEni();else{if(r.type!==t.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface)continue;i=r}s+=i.get("ips").length}return o=n.modelClassForType(t.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface).getAvailableIPCountInCIDR(e),o>=s},generateCidr:function(){var e,t,n,r,i,s,u,a,f,l,c,h,p,d,v,m,g;n=this.parent().parent().get("cidr"),c=n.split("/"),h=c[0],p=h.split("."),d=Number(c[1]);if(d!==16)return"";r=-1,g=o.allObjects();for(v=0,m=g.length;v<m;v++)e=g[v],s=e.get("cidr"),u=s.split("/"),f=u[0],l=Number(u[1]),a=f.split("."),t=Number(a[2]),r<t&&(r=t);return i=r+1,i>255?"":(p[2]=String(i),p.join(".")+"/24")},serialize:function(){var e;return e={name:this.get("name"),type:this.type,uid:this.id,resource:{AvailabilityZone:this.parent().createRef(),VpcId:this.parent().parent().createRef("VpcId"),SubnetId:this.get("appId"),CidrBlock:this.get("cidr")}},{component:e,layout:this.generateLayout()}}},{handleTypes:t.AWS_RESOURCE_TYPE.AWS_VPC_Subnet,diffJson:function(){},genCIDRPrefixSuffix:function(e){var t,n,r,i,s,o;return t=e.split("/"),n=t[0],o=Number(t[1]),r=n.split("."),i="",s="",o>23?(i=r[0]+"."+r[1]+"."+r[2]+".",s="x"):(i=r[0]+"."+r[1]+".",s="x.x"),[i,s]},isIPInSubnet:function(t,n){var r,i,s,o,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k;return h=n.split("/"),v=Number(h[1]),c=h[0].split("."),p=u(h[0]),d=p.slice(0,v),i=u(t),s=i.slice(0,v),o=i.slice(v),m=32-v,b=_.map(function(){C=[];for(var e=1,t=m+1;1<=t?e<t:e>t;1<=t?e++:e--)C.push(e);return C}.apply(this),function(){return"0"}),w=b.join(""),g=w.replace(/0/g,"1"),E=parseInt(w,2),y=parseInt(g,2),a=function(){k=[];for(var e=E,t=y+1;E<=t?e<t:e>t;E<=t?e++:e--)k.push(e);return k}.apply(this),f=a.length,l=!1,r=[],_.each(a,function(e,t){var n;return n=MC.leftPadString(e.toString(2),m,"0"),(t===0||t===1||t===2||t===3||t===f-1)&&r.push(n),null}),e.call(r,o)>=0?!1:d===s},isCidrConflict:function(e,t){var n,r,i,s,o;return n=u(e),i=u(t),r=Number(e.split("/")[1]),s=Number(t.split("/")[1]),r===0&&r===s?!0:(o=r,r>s&&(o=s),n.slice(0,o)===i.slice(0,o)&&o!==0?!0:!1)},isInVPCCIDR:function(e,t){return this.isCidrConflict(e,t)?Number(t.split("/")[1])>=Number(e.split("/")[1]):!1},isValidSubnetCIDR:function(e){var t,n,r,i;return t=u(e),n=Number(e.split("/")[1]),r=t.slice(n),i=parseInt(r),i===0||r===""?!0:!1},autoAssignAllCIDR:function(e,t){var n,r,i,s,o,a,f,l,c,h,p,d;i=Math.ceil(Math.log(t)/Math.log(2)),d=Number(e.split("/")[1]),p=u(e),h=p.slice(0,d),c=d+i,a=[],r=0;while(r<t)n=MC.leftPadString(r.toString(2),i,"0"),f=MC.rightPadString(h+n,32,"0"),s=_.map([0,8,16,24],function(e){return parseInt(f.slice(e,e+8),2)}),o=s.join("."),l=o+"/"+c,a.push(l),++r;return a},autoAssignSimpleCIDR:function(e,t,n){var r,i,s,o,u,a,f,l,c;r=[],s=e.split("/"),o=s[0],u=Number(s[1]),c=o.split("."),i=Number(n.split("/")[1]);if(u===16||u===24&&i===u)a=c[0],f=c[1],l=c[2],_.each(t,function(e){var t,n,i,s,o;return n=e.split("/"),i=n[0],s=Number(n[1]),o=i.split("."),o[0]=a,o[1]=f,u===24&&(o[2]=l),t=o.join(".")+"/"+s,r.push(t),null});return r},deserialize:function(e,t,n){return new o({id:e.uid,name:e.name,appId:e.resource.SubnetId,cidr:e.resource.CidrBlock,x:t.coordinate[0],y:t.coordinate[1],width:t.size[0],height:t.size[1],parent:n(t.groupUId)}),null}}),o})}.call(this),function(){define("module/design/framework/resource/IgwModel",["../ComplexResModel","./VpcModel","Design","constant","i18n!nls/lang.js"],function(e,t,n,r,i){var s;return s=e.extend({defaults:{x:0,y:0,width:8,height:8,name:"Internet-gateway"},type:r.AWS_RESOURCE_TYPE.AWS_VPC_InternetGateway,initialize:function(){return this.draw(!0),null},isRemovable:function(){var e,t,s,o;return e=n.modelClassForType(r.AWS_RESOURCE_TYPE.AWS_ELB),o=e.allObjects().some(function(e){return!e.get("internal")}),o||(t=n.modelClassForType(r.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface),o=t.allObjects().some(function(e){return e.hasEip()||e.get("assoPublicIp")})),o||(s=n.modelClassForType(r.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration),o=s.allObjects().some(function(e){return e.get("publicIp")})),o?{error:i.ide.CVS_CFM_DEL_IGW}:!0},serialize:function(){var e;return e={name:this.get("name"),type:this.type,uid:this.id,resource:{InternetGatewayId:this.get("appId"),AttachmentSet:[{VpcId:this.parent().createRef("VpcId")}]}},{component:e,layout:this.generateLayout()}}},{tryCreateIgw:function(){var e,t,o,u,a,f,l;if(!n.instance().typeIsVpc())return;if(s.allObjects().length>0)return;return notification("info",i.ide.CVS_CFM_ADD_IGW_MSG),o=r.AWS_RESOURCE_TYPE,u=n.modelClassForType(r.AWS_RESOURCE_TYPE.AWS_VPC_VPC).theVPC(),t=s.prototype.defaults.width,e=s.prototype.defaults.height,f=u.x(),l=u.y(),a=u.height(),new s({x:f-t/2,y:l+(a-e)/2,parent:u}),null},handleTypes:r.AWS_RESOURCE_TYPE.AWS_VPC_InternetGateway,deserialize:function(e,t,n){return new s({id:e.uid,name:e.name,appId:e.resource.InternetGatewayId,parent:n(t.groupUId),x:t.coordinate[0],y:t.coordinate[1]})}}),s})}.call(this),function(){define("module/design/framework/resource/VgwModel",["../ComplexResModel","./VpcModel","Design","constant"],function(e,t,n,r){var i;return i=e.extend({defaults:{x:0,y:0,width:8,height:8,name:"VPN-gateway"},type:r.AWS_RESOURCE_TYPE.AWS_VPC_VPNGateway,initialize:function(){return this.draw(!0),null},serialize:function(){var e;return e={name:this.get("name"),type:this.type,uid:this.id,resource:{Type:"ipsec.1",VpnGatewayId:this.get("appId"),Attachments:[{VpcId:this.parent().createRef("VpcId")}]}},{component:e,layout:this.generateLayout()}}},{handleTypes:r.AWS_RESOURCE_TYPE.AWS_VPC_VPNGateway,deserialize:function(e,t,n){return new i({id:e.uid,name:e.name,appId:e.resource.VpnGatewayId,parent:n(t.groupUId),x:t.coordinate[0],y:t.coordinate[1]}),null}}),i})}.call(this),function(){define("module/design/framework/resource/SnsSubscription",["../ResourceModel","constant"],function(e,t){var n,r;return r=e.extend({type:t.AWS_RESOURCE_TYPE.AWS_SNS_Topic,serialize:function(){var e,t;t=r.isTopicNeeded(),t||(t=n.allObjects().length>0),t||(t=!!this.get("appId"));if(!t){void 0;return}return e="sns-topic",{component:{name:"sns-topic",type:this.type,uid:this.id,resource:{DisplayName:e,Name:e,TopicArn:this.get("appId")}}}}},{handleTypes:t.AWS_RESOURCE_TYPE.AWS_SNS_Topic,resolveFirst:!0,diffJson:function(){},isTopicNeeded:function(){var e,n,r,i,s,o,u,a,f,l;e=Design.modelClassForType(t.AWS_RESOURCE_TYPE.AWS_AutoScaling_ScalingPolicy),f=e.allObjects();for(s=0,u=f.length;s<u;s++){r=f[s];if(r.get("sendNotification")){i=!0;break}}if(!i){l=Design.modelClassForType(t.AWS_RESOURCE_TYPE.AWS_AutoScaling_NotificationConfiguration).allObjects();for(o=0,a=l.length;o<a;o++){n=l[o];if(n.isUsed()){i=!0;break}}}return i},ensureExistence:function(){return this.allObjects().length===0&&new r,this.allObjects()[0]},preDeserialize:function(e,t){return new r({id:e.uid,appId:e.resource.TopicArn,name:e.resource.DisplayName||e.resource.Name}),null},deserialize:function(){return null}}),n=e.extend({type:t.AWS_RESOURCE_TYPE.AWS_SNS_Subscription,initialize:function(){return r.ensureExistence(),null},serialize:function(){var e;return e=r.ensureExistence(),{component:{name:"SnsSubscription",type:this.type,uid:this.id,resource:{Endpoint:this.get("endpoint"),Protocol:this.get("protocol"),SubscriptionArn:this.get("appId"),TopicArn:r.ensureExistence().createRef("TopicArn")}}}}},{handleTypes:t.AWS_RESOURCE_TYPE.AWS_SNS_Subscription,deserialize:function(e,t,r){return new n({id:e.uid,appId:e.resource.SubscriptionArn,endpoint:e.resource.Endpoint,protocol:e.resource.Protocol}),null}}),null})}.call(this),function(){define("module/design/framework/resource/StorageModel",["Design","../ResourceModel"],function(e,t){var n;return n=t.extend({type:"AWS.Tag",serialize:function(){return{component:$.extend(!0,{},this.get("data"))}}},{diffJson:function(){},handleTypes:["AWS.EC2.Tag","AWS.AutoScaling.Tag"],deserialize:function(e){return new n({id:e.uid,data:e}),null}}),n})}.call(this),function(){define("module/design/framework/resource/ScalingPolicyModel",["../ResourceModel","constant"],function(e,t){var n;return n=e.extend({type:t.AWS_RESOURCE_TYPE.AWS_AutoScaling_ScalingPolicy,defaults:function(){return{cooldown:"",minAdjustStep:"",adjustment:"-1",adjustmentType:"ChangeInCapacity",state:"ALARM",sendNotification:!1,alarmData:{id:MC.guid(),alarmName:"",namespace:"AWS/AutoScaling",metricName:"CPUUtilization",comparisonOperator:">=",evaluationPeriods:"2",period:"300",statistic:"Average",threshold:"10",unit:"",appId:""}}},constructor:function(t,n){var r;return r=this.defaults(),t.alarmData=$.extend(r.alarmData,t.alarmData),e.call(this,t,n)},setAlarm:function(e){return this.set("alarmData",$.extend({id:this.attributes.alarmData.id,namespace:"AWS/AutoScaling",unit:"",appId:this.attributes.alarmData.appId,alarmName:this.attributes.alarmData.alarmName},e)),null},getCost:function(e,t){var n,r,i,s,o,u,a,f;n=this.get("alarmData"),o=parseInt(n.period,10);if(o<=300&&n.namespace==="AWS/AutoScaling"){f=e.cloudwatch.types;for(u=0,a=f.length;u<a;u++){s=f[u];if(s.ec2Monitoring){i=parseFloat(s.ec2Monitoring[t],10)||0;break}}return i?(r=Design.instance().modeIsStack()?this.__asg.get("minSize"):this.__asg.get("capacity"),i=Math.round(i/7*1e3)/1e3,{resource:this.get("name")+"-alarm",type:"CloudWatch",fee:i,formatedFee:i+"/mo"}):null}return null},serialize:function(){var e,n,r,i,s,o,u,a;if(!this.__asg){void 0;return}return a={name:this.get("name"),type:this.type,uid:this.id,resource:{ScalingAdjustment:this.get("adjustment"),PolicyName:this.get("name"),PolicyARN:this.get("appId"),MinAdjustmentStep:this.get("minAdjustStep"),Cooldown:Math.round(this.get("cooldown")/60)*60,AutoScalingGroupName:this.__asg.createRef("AutoScalingGroupName"),AdjustmentType:this.get("adjustmentType")}},u=this.get("alarmData"),n=r=i=[],s=[this.createRef("PolicyARN")],this.get("sendNotification")&&(e=Design.modelClassForType(t.AWS_RESOURCE_TYPE.AWS_SNS_Topic),s.push(e.ensureExistence().createRef("TopicArn"))),this.get("state")==="ALARM"?n=s:this.get("state")==="INSUFFICIANT_DATA"?r=s:i=s,o={name:this.get("name")+"-alarm",type:t.AWS_RESOURCE_TYPE.AWS_CloudWatch_CloudWatch,uid:u.id,resource:{AlarmArn:u.appId,AlarmName:u.alarmName||this.get("name")+"-alarm",ComparisonOperator:u.comparisonOperator,EvaluationPeriods:u.evaluationPeriods,MetricName:u.metricName,Namespace:u.namespace,Period:Math.round(u.period/60)*60,Statistic:u.statistic,Threshold:u.threshold,Unit:u.unit,Dimensions:[{name:"AutoScalingGroupName",value:this.__asg.createRef("AutoScalingGroupName")}],AlarmActions:n,InsufficientDataActions:r,OKAction:i}},[{component:a},{component:o}]}},{handleTypes:[t.AWS_RESOURCE_TYPE.AWS_AutoScaling_ScalingPolicy,t.AWS_RESOURCE_TYPE.AWS_CloudWatch_CloudWatch],diffJson:function(e,n){var r,i;if(!(e&&n&&_.isEqual(e,n))){i=(e||n).resource,i=i.AutoScalingGroupName||i.Dimensions[0].value,r=Design.instance().component(MC.extractID(i));if(r)return{id:i,type:t.AWS_RESOURCE_TYPE.AWS_AutoScaling_Group,name:r.get("name"),change:"Update"}}return null},deserialize:function(e,r,i){var s,o,u,a,f,l,c,h,p;if(e.type===t.AWS_RESOURCE_TYPE.AWS_CloudWatch_CloudWatch){s={id:e.uid,name:e.name,alarmName:e.resource.AlarmName,appId:e.resource.AlarmArn,comparisonOperator:e.resource.ComparisonOperator,evaluationPeriods:e.resource.EvaluationPeriods,metricName:e.resource.MetricName,period:e.resource.Period,statistic:e.resource.Statistic,threshold:e.resource.Threshold,namespace:e.resource.Namespace,unit:e.resource.Unit},f=[],e.resource.AlarmActions.length&&(c="ALARM",f.push(e.resource.AlarmActions[0]),f.push(e.resource.AlarmActions[1])),e.resource.OKAction.length&&(c="OK",f.push(e.resource.OKAction[0]),f.push(e.resource.OKAction[1])),e.resource.InsufficientDataActions.length&&(c="INSUFFICIANT_DATA",f.push(e.resource.InsufficientDataActions[0]),f.push(e.resource.InsufficientDataActions[1])),l=!1;for(h=0,p=f.length;h<p;h++){u=f[h];if(!u)continue;u.indexOf("PolicyARN")!==-1?a=i(MC.extractID(u)):u.indexOf("TopicArn")!==-1&&(l=!0)}a.set({alarmData:s,sendNotification:l,state:c})}else a=new n({id:e.uid,name:e.resource.PolicyName||e.name,appId:e.resource.PolicyARN,cooldown:e.resource.Cooldown,minAdjustStep:e.resource.MinAdjustmentStep,adjustment:e.resource.ScalingAdjustment,adjustmentType:e.resource.AdjustmentType}),o=i(MC.extractID(e.resource.AutoScalingGroupName)),o.addScalingPolicy(a);return null}}),n})}.call(this),function(){define("module/design/framework/util/deserializeVisitor/JsonFixer",["Design"],function(e){return e.registerDeserializeVisitor(function(e,t,n){var r,i,s,o,u,a,f,l;if(n>="2014-01-25")return;s={},i=[];for(a in t)u=t[a],u.type==="AWS.EC2.AvailabilityZone"?(u.groupUId==="Canvas"&&delete u.groupUId,i.push({uid:a,type:"AWS.EC2.AvailabilityZone",name:u.name}),s[u.name]=MC.aws.aws.genResRef(a,"name")):u.type==="AWS.AutoScaling.Group"&&u.originalId&&(e[a]={type:"ExpandedAsg",uid:a});o=function(e){var t,n,r,i,u,a;for(t in e){n=e[t];if(_.isString(n))n==="true"?e[t]=!0:n==="false"?e[t]=!1:s[n]&&(e[t]=s[n]);else if(_.isArray(n))for(i=u=0,a=n.length;u<a;i=++u)r=n[i],_.isObject(r)&&o(r),_.isString(r)&&(n==="true"?n[i]=!0:n==="false"?n[i]=!1:s[n]&&(n[i]=s[n]));else _.isObject(n)&&o(n)}return null};for(a in e)u=e[a],o(u);for(f=0,l=i.length;f<l;f++)r=i[f],e[r.uid]=r;return null}),null})}.call(this),function(){define("module/design/framework/util/deserializeVisitor/EipMerge",["Design"],function(e){return e.registerDeserializeVisitor(function(e,t){var n,r,i,s,o,u;for(u in e){n=e[u];if(n.type==="AWS.EC2.EIP")if(n.resource.NetworkInterfaceId){o=n.resource.PrivateIpAddress.split("."),r=e[MC.extractID(o[0])];if(!r)continue;s=r.resource.PrivateIpAddressSet[o[3]*1];if(!s)continue;s.EipResource=n}else i=e[MC.extractID(n.resource.InstanceId)],i&&(i.resource.EipResource=n)}return null}),null})}.call(this),function(){define("module/design/framework/util/deserializeVisitor/FixOldStack",["Design","constant"],function(e,t){return e.registerDeserializeVisitor(function(n,r,i){var s,o,u,a;if(i>="2014-01-15")return;if(!e.instance().modeIsStack())return;for(a in n){s=n[a];if(s.type===t.AWS_RESOURCE_TYPE.AWS_EC2_KeyPair){if(s.name==="DefaultKP"){o=!0;if(u)break}}else if(s.type===t.AWS_RESOURCE_TYPE.AWS_EC2_SecurityGroup&&s.name==="DefaultSG"){u=!0;if(o)break}}return o||(a=MC.guid(),n[a]={uid:a,type:t.AWS_RESOURCE_TYPE.AWS_EC2_KeyPair,name:"DefaultKP",resource:{KeyName:"DefaultKP"}}),u||(a=MC.guid(),n[a]={uid:a,type:t.AWS_RESOURCE_TYPE.AWS_EC2_SecurityGroup,name:"DefaultSG",resource:{IpPermissions:[{IpProtocol:"tcp",IpRanges:"0.0.0.0/0",FromPort:"22",ToPort:"22",Groups:[{GroupId:"",UserId:"",GroupName:""}]}],IpPermissionsEgress:[],Default:"true",GroupName:"DefaultSG",GroupDescription:"Default Security Group"}}),null}),null})}.call(this),function(){define("module/design/framework/util/deserializeVisitor/AsgExpandor",["Design"],function(e){return e.registerDeserializeVisitor(function(e,t,n){var r,i,s;if(n<"2014-01-25")return;s=[];for(i in t)r=t[i],r.type==="ExpandedAsg"?s.push(e[i]={type:"ExpandedAsg",uid:i}):s.push(void 0);return s}),null})}.call(this),function(){define("module/design/framework/util/deserializeVisitor/ElbSgNamePatch",["Design","constant"],function(e,t){return e.registerDeserializeVisitor(function(e,n,r){var i,s,o,u,a,f,l,c,h,p,d,v;if(r>="2014-02-11")return;i=t.AWS_RESOURCE_TYPE,u=[],l=[];for(c in e)s=e[c],s.type===i.AWS_ELB?u.push(s):s.type===i.AWS_EC2_SecurityGroup&&l.push(s);for(h=0,d=u.length;h<d;h++){o=u[h],f=o.name+"-sg";for(p=0,v=l.length;p<v;p++){a=l[p];if(a.name===f){a.name="elbsg-"+o.name,a.resource.GroupName===f&&(a.resource.GroupName=a.name);break}}}return null}),null})}.call(this),function(){define("module/design/framework/util/serializeVisitor/EniIpAssigner",["Design","constant"],function(e,t){var n,r;return r=function(n,r){var i,s,o,u,a,f,l,c,h,p,d,v,m;l=e.instance().component(n),i=e.modelClassForType(t.AWS_RESOURCE_TYPE.AWS_EC2_AvailabilityZone),l?c=l.get("cidr"):(s=i.getSubnetOfDefaultVPC(n),s&&(c=s.cidrBlock));if(!c){void 0;return}a=[],f=[];for(h=0,d=r.length;h<d;h++){o=r[h],m=o.resource.PrivateIpAddressSet;for(p=0,v=m.length;p<v;p++)u=m[p],u.AutoAssign===!0?a.push(u):f.push(u.PrivateIpAddress)}return{subnetCid:c,ipSet:a,reserveIpSet:f}},n=function(n){var r,i,s,o,u,a;s=e.modelClassForType(t.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface).getAvailableIPInCIDR(n.subnetCid,n.reserveIpSet,n.ipSet.length),s=_.filter(s,function(e){return e.available}),a=n.ipSet;for(r=o=0,u=a.length;o<u;r=++o)i=a[r],s[r]?i.PrivateIpAddress=s[r].ip:i.PrivateIpAddress="";return null},e.registerSerializeVisitor(function(i){var s,o,u,a,f,l,c;if(e.instance().modeIsApp())return;l={};for(c in i)o=i[c],o.type===t.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface&&(o.resource.SubnetId&&o.resource.SubnetId[0]==="@"?f=o.resource.SubnetId:f=o.resource.AvailabilityZone,s=l[f],s||(s=l[f]=[]),s.splice(_.sortedIndex(s,o,"name"),0,o));for(c in l)a=l[c],c=MC.extractID(c),u=r(c,a),u&&n(u);return null}),null})}.call(this),function(){define("module/design/framework/canvasview/CeLine",["./CanvasElement","CanvasManager","constant"],function(e,t,n){var r,i;return r=function(){return e.apply(this,arguments)},e.extend(r,"Line"),i=r.prototype,i.portName=function(e){return this.model.port(e,"name")},i.reConnect=function(){return this.draw()},i.select=function(){return this.type==="RTB_Route"?this.doSelect(this.type,this.model.getTarget(n.AWS_RESOURCE_TYPE.AWS_VPC_RouteTable).id,this.id):this.doSelect(this.type,this.id,this.id),!0},i.draw=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m;e=this.model,o=e.port1Comp().getCanvasView(),u=e.port2Comp().getCanvasView();if(!o||!u)return;l={left:e.port1Comp().x()*10,top:e.port1Comp().y()*10},p={left:e.port2Comp().x()*10,top:e.port2Comp().y()*10},s=e.port1("name"),m=e.port2("name"),n=o.portDirection(s),r=u.portDirection(m),n&&r?(l.left>p.left?(s+="-left",m+="-right"):(s+="-right",m+="-left"),c=o.portPosition(s),h=u.portPosition(m),l.left+=c[0],l.top+=c[1],p.left+=h[0],p.top+=h[1]):n?(h=u.portPosition(m),p.left+=h[0],p.top+=h[1],n==="vertical"?s+=p.top>l.top?"-bottom":"-top":n==="horizontal"&&(s+=p.left>l.left?"-right":"-left"),c=o.portPosition(s),l.left+=c[0],l.top+=c[1]):r?(c=o.portPosition(s),l.left+=c[0],l.top+=c[1],r==="vertical"?m+=l.top>p.top?"-bottom":"-top":r==="horizontal"&&(m+=l.left>p.left?"-right":"-left"),h=u.portPosition(m),p.left+=h[0],p.top+=h[1]):(c=o.portPosition(s),h=u.portPosition(m),l.left+=c[0],l.top+=c[1],p.left+=h[0],p.top+=h[1]),d={x:l.left,y:l.top,angle:c[2],type:e.port1Comp().type,name:s},i={x:p.left,y:p.top,angle:h[2],type:e.port2Comp().type,name:m};if(d.x===i.x||d.y===i.y)f="M"+d.x+" "+d.y+" L"+i.x+" "+i.y;else{t=MC.canvas.route2(d,i);if(t){a=e.get("lineType")==="sg"?$canvas.lineStyle():777;switch(a){case 0:f="M"+t[0].x+" "+t[0].y+" L"+t[1].x+" "+t[1].y+" L"+t[t.length-2].x+" "+t[t.length-2].y+" L"+t[t.length-1].x+" "+t[t.length-1].y;break;case 1:f=MC.canvas._round_corner(t);break;case 2:f=MC.canvas._bezier_q_corner(t);break;case 3:f=MC.canvas._bezier_qt_corner(t);break;case 777:f=MC.canvas._round_corner(t)}}}return v=document.getElementById(this.id),v?$(v).children().attr("d",f):(MC.paper.start(),MC.paper.path(f),MC.paper.path(f).attr("class","fill-line"),e.get("dashLine")&&MC.paper.path(f).attr("class","dash-line"),v=$(MC.paper.save()).attr({"class":"line line-"+e.get("lineType"),"data-type":"line",id:this.id}),this.getLayer("line_layer")[0].appendChild(v[0])),null},null})}.call(this),function(){define("module/design/framework/canvasview/CeAz",["./CanvasElement","constant","CanvasManager"],function(e,t,n){var r,i;return r=function(){return e.apply(this,arguments)},e.extend(r,t.AWS_RESOURCE_TYPE.AWS_EC2_AvailabilityZone),i=r.prototype,i.select=function(){return this.model.design().modeIsStack()?this.doSelect(this.model.type,this.model.id,this.model.id):this.doSelect("","",this.model.id)},i.draw=function(e){var t,r,i;return t=this.model,r=t.get("name"),e?(i=this.createGroup(r),this.getLayer("az_layer").append(i),n.position(i,t.x(),t.y())):n.update(this.$element().children("text"),r),null},null})}.call(this),function(){define("module/design/framework/canvasview/CeSubnet",["./CanvasElement","constant","CanvasManager"],function(e,t,n){var r,i;return r=function(){return e.apply(this,arguments)},e.extend(r,t.AWS_RESOURCE_TYPE.AWS_VPC_Subnet),i=r.prototype,i.portPosition=function(e){var t,n;return t=this.model,n=t.height()*MC.canvas.GRID_HEIGHT/2-5,e==="subnet-assoc-in"?[-12,n,MC.canvas.PORT_LEFT_ANGLE]:[t.width()*MC.canvas.GRID_WIDTH+10,n,MC.canvas.PORT_RIGHT_ANGLE]},i.draw=function(e){var t,r,i;return r=this.model,t=""+r.get("name")+" ("+r.get("cidr")+")",e?(i=this.createGroup(t),i.append(Canvon.path(MC.canvas.PATH_PORT_RIGHT).attr({"class":"port port-gray port-subnet-assoc-in","data-name":"subnet-assoc-in","data-position":"left","data-type":"association","data-direction":"in"})),i.append(Canvon.path("M2 0.5l-6 -5.5l-2 0 l0 11 l2 0z").attr({"class":"port port-gray port-subnet-assoc-out","data-name":"subnet-assoc-out","data-position":"right","data-type":"association","data-direction":"out"})),this.getLayer("subnet_layer").append(i),this.initNode(i,r.x(),r.y())):n.update(this.$element().children("text"),t),null},null})}.call(this),function(){define("module/design/framework/canvasview/CeVpc",["./CanvasElement","constant","CanvasManager"],function(e,t,n){var r,i;return r=function(){return e.apply(this,arguments)},e.extend(r,t.AWS_RESOURCE_TYPE.AWS_VPC_VPC),i=r.prototype,i.draw=function(e){var t,r,i;return r=this.model,t=""+r.get("name")+" ("+r.get("cidr")+")",e?(i=this.createGroup(t),this.getLayer("vpc_layer").append(i),n.position(i,r.x(),r.y())):n.update(this.$element().children("text"),t),null},null})}.call(this),function(){define("module/design/framework/canvasview/CeCgw",["./CanvasElement","constant","CanvasManager"],function(e,t,n){var r,i;return r=function(){return e.apply(this,arguments)},e.extend(r,t.AWS_RESOURCE_TYPE.AWS_VPC_CustomerGateway),i=r.prototype,i.portPosMap={"cgw-vpn":[6,45,MC.canvas.PORT_LEFT_ANGLE]},i.draw=function(e){var t,r;return t=this.model,e?(r=this.createNode({image:"ide/icon/cgw-canvas.png",imageX:13,imageY:8,imageW:151,imageH:76}),r.append(Canvon.path(MC.canvas.PATH_PORT_RIGHT).attr({"class":"port port-purple port-cgw-vpn","data-name":"cgw-vpn","data-position":"left","data-type":"vpn","data-direction":"in"}),Canvon.text(100,95,MC.truncate(t.get("name"),17)).attr({"class":"node-label"})),this.getLayer("node_layer").append(r),this.initNode(r,t.x(),t.y())):n.update(this.$element().children(".node-label"),t.get("name")),this.updatexGWAppState(),null},null})}.call(this),function(){define("module/design/framework/canvasview/CeIgw",["./CanvasElement","constant"],function(e,t){var n,r;return n=function(){return e.apply(this,arguments)},e.extend(n,t.AWS_RESOURCE_TYPE.AWS_VPC_InternetGateway),r=n.prototype,r.portPosMap={"igw-tgt":[78,35,MC.canvas.PORT_RIGHT_ANGLE]},r.draw=function(e){var t,n;return t=this.model,e&&(n=this.createNode({image:"ide/icon/igw-canvas.png",imageX:10,imageY:16,imageW:60,imageH:46,label:t.get("name")}),n.append(Canvon.path(MC.canvas.PATH_PORT_LEFT).attr({"class":"port port-blue port-igw-tgt","data-name":"igw-tgt","data-position":"right","data-type":"sg","data-direction":"in"})),this.getLayer("node_layer").append(n),this.initNode(n,t.x(),t.y())),this.updatexGWAppState(),null},null})}.call(this),function(){define("module/design/framework/canvasview/CeVgw",["./CanvasElement","constant"],function(e,t){var n,r;return n=function(){return e.apply(this,arguments)},e.extend(n,t.AWS_RESOURCE_TYPE.AWS_VPC_VPNGateway),r=n.prototype,r.portPosMap={"vgw-tgt":[3,35,MC.canvas.PORT_LEFT_ANGLE],"vgw-vpn":[70,35,MC.canvas.PORT_RIGHT_ANGLE]},r.draw=function(e){var t,n;return t=this.model,e&&(n=this.createNode({image:"ide/icon/vgw-canvas.png",imageX:10,imageY:16,imageW:60,imageH:46,label:t.get("name")}),n.append(Canvon.path(MC.canvas.PATH_PORT_RIGHT).attr({"class":"port port-blue port-vgw-tgt","data-name":"vgw-tgt","data-position":"left","data-type":"sg","data-direction":"in"}),Canvon.path(MC.canvas.PATH_PORT_RIGHT).attr({"class":"port port-purple port-vgw-vpn","data-name":"vgw-vpn","data-position":"right","data-type":"vpn","data-direction":"out"})),this.getLayer("node_layer").append(n),this.initNode(n,t.x(),t.y())),this.updatexGWAppState(),null},null})}.call(this),function(){define("module/design/framework/canvasview/CeRtb",["./CanvasElement","constant","CanvasManager"],function(e,t,n){var r,i;return r=function(){return e.apply(this,arguments)},e.extend(r,t.AWS_RESOURCE_TYPE.AWS_VPC_RouteTable),i=r.prototype,i.portPosMap={"rtb-tgt-left":[10,35,MC.canvas.PORT_LEFT_ANGLE],"rtb-tgt-right":[70,35,MC.canvas.PORT_RIGHT_ANGLE],"rtb-src-top":[40,3,MC.canvas.PORT_UP_ANGLE],"rtb-src-bottom":[40,77,MC.canvas.PORT_DOWN_ANGLE]},i.portDirMap={"rtb-tgt":"horizontal","rtb-src":"vertical"},i.iconUrl=function(){return this.model.get("main")?"ide/icon/rt-main-canvas.png":"ide/icon/rt-canvas.png"},i.draw=function(e){var t,r;return t=this.model,e?(r=this.createNode({image:this.iconUrl(),imageX:10,imageY:13,imageW:60,imageH:57}),r.append(Canvon.path(MC.canvas.PATH_PORT_LEFT).attr({"class":"port port-blue port-rtb-tgt port-rtb-tgt-left","data-name":"rtb-tgt","data-alias":"rtb-tgt-left","data-position":"left","data-type":"sg","data-direction":"out"}),Canvon.path(MC.canvas.PATH_PORT_RIGHT).attr({"class":"port port-blue  port-rtb-tgt port-rtb-tgt-right","data-name":"rtb-tgt","data-alias":"rtb-tgt-right","data-position":"right","data-type":"sg","data-direction":"out"}),Canvon.path(MC.canvas.PATH_PORT_BOTTOM).attr({"class":"port port-gray port-rtb-src port-rtb-src-top","data-name":"rtb-src","data-alias":"rtb-src-top","data-position":"top","data-type":"association","data-direction":"in"}),Canvon.path(MC.canvas.PATH_PORT_TOP).attr({"class":"port port-gray port-rtb-src port-rtb-src-bottom","data-name":"rtb-src","data-alias":"rtb-src-bottom","data-position":"bottom","data-type":"association","data-direction":"in"}),Canvon.text(41,27,t.get("name")).attr({"class":"node-label node-label-rtb-name"})),this.getLayer("node_layer").append(r),this.initNode(r,t.x(),t.y())):(r=this.$element(),n.update(r.children(".node-label"),t.get("name")),n.update(r.children("image"),this.iconUrl(),"href")),this.updateAppState(),null},null})}.call(this),function(){define("module/design/framework/canvasview/CeElb",["./CanvasElement","constant","CanvasManager"],function(e,t,n){var r,i;return r=function(){return e.apply(this,arguments)},e.extend(r,t.AWS_RESOURCE_TYPE.AWS_ELB),i=r.prototype,i.portPosMap={"elb-sg-in":[2,35,MC.canvas.PORT_LEFT_ANGLE],"elb-assoc":[79,50,MC.canvas.PORT_RIGHT_ANGLE],"elb-sg-out":[79,20,MC.canvas.PORT_RIGHT_ANGLE]},i.portPosition=function(e){var t;return t=this.portPosMap[e],e==="elb-sg-out"&&this.model.design().typeIsClassic()&&(t[1]=35),t},i.iconUrl=function(){return this.model.get("internal")?"ide/icon/elb-internal-canvas.png":"ide/icon/elb-internet-canvas.png"},i.draw=function(e){var t,r,i;return r=this.model,t=r.design(),e?(i=this.createNode({image:this.iconUrl(),imageX:9,imageY:11,imageW:70,imageH:53,label:r.get("name"),sg:!t.typeIsClassic()}),t.typeIsClassic()||i.append(Canvon.path(MC.canvas.PATH_PORT_RIGHT).attr({"class":"port port-blue port-elb-sg-in","data-name":"elb-sg-in","data-position":"left","data-type":"sg","data-direction":"in"}),Canvon.path(MC.canvas.PATH_PORT_RIGHT).attr({"class":"port port-gray port-elb-assoc","data-name":"elb-assoc","data-position":"right","data-type":"association","data-direction":"out"})),i.append(Canvon.path(MC.canvas.PATH_PORT_RIGHT).attr({"class":"port port-blue port-elb-sg-out","data-name":"elb-sg-out","data-position":"right","data-type":"sg","data-direction":"out"})),this.getLayer("node_layer").append(i),this.initNode(i,r.x(),r.y())):(i=this.$element(),n.update(i.children(".node-label"),r.get("name")),n.update(i.children("image"),this.iconUrl(),"href")),n.toggle(i.children(".port-elb-sg-in"),r.get("internal")),this.updateAppState(),null},null})}.call(this),function(){define("module/design/framework/canvasview/CeAsg",["./CanvasElement","i18n!nls/lang.js","constant","Design","CanvasManager"],function(e,t,n,r,i){var s,o;return s=function(){return e.apply(this,arguments)},e.extend(s,n.AWS_RESOURCE_TYPE.AWS_AutoScaling_Group),o=s.prototype,o.isRemovable=function(){return this.model.isRemovable()},o.asgExpand=function(e,n,i){var s,o,u,a,f,l;return u=this.model.design(),o=this.model,f=u.component(e),f&&(s=r.modelClassForType("ExpandedAsg"),a=new s({x:n,y:i,originalAsg:o,parent:f})),a&&a.id?!0:(l=f.type==="AWS.EC2.AvailabilityZone"?f.get("name"):f.parent().get("name"),notification("error",sprintf(t.ide.CVS_MSG_ERR_DROP_ASG,o.get("name"),l)),!1)},o.draw=function(e){var t,n,s,o,u,a,f;return s=this.model,e?(a=s.x(),f=s.y(),u=s.width()*MC.canvas.GRID_WIDTH,n=s.height()*MC.canvas.GRID_HEIGHT,o=Canvon.group().append(Canvon.rectangle(1,1,u-1,n-1).attr({"class":"group group-asg",rx:5,ry:5}),Canvon.path(MC.canvas.PATH_ASG_TITLE).attr({"class":"asg-title"})),this.model.design().modeIsAppView()||o.append(Canvon.image(MC.IMG_URL+"ide/icon/asg-resource-dragger.png",u-21,0,22,21).attr({"class":"asg-resource-dragger tooltip","data-tooltip":"Expand the group by drag-and-drop in other availability zone."})),o.append(Canvon.group().append(Canvon.text(25,45,"Drop AMI from"),Canvon.text(20,65,"resource panel to"),Canvon.text(30,85,"create launch"),Canvon.text(30,105,"configuration")).attr({"class":"prompt_text"}),Canvon.text(4,14,MC.truncate(s.get("name"),15)).attr({"class":"group-label"})).attr({id:this.id,"class":"dragable AWS-AutoScaling-Group","data-type":"group","data-class":this.type}),this.getLayer("asg_layer").append(o),i.position(o,s.x(),s.y())):(o=this.$element(),i.update(o.children(".group-label"),MC.truncate(s.get("name"),15)),this.__drawExpandedAsg()),t=!!s.get("lc"),i.toggle(o.children(".prompt_text"),!t),i.toggle(o.children(".asg-resource-dragger"),!r.instance().modeIsApp()),null},o.__drawExpandedAsg=function(){var e,t,n,r;r=this.model.get("expandedList");for(t=0,n=r.length;t<n;t++)e=r[t],e.draw();return null},null})}.call(this),function(){define("module/design/framework/canvasview/CeExpandedAsg",["./CanvasElement","constant","CanvasManager"],function(e,t,n){var r,i;return r=function(){return e.apply(this,arguments),this.type=t.AWS_RESOURCE_TYPE.AWS_AutoScaling_Group,null},e.extend(r,"ExpandedAsg"),i=r.prototype,i.portPosMap={"launchconfig-sg-left":[30,50,MC.canvas.PORT_LEFT_ANGLE],"launchconfig-sg-right":[100,50,MC.canvas.PORT_RIGHT_ANGLE]},i.portDirMap={"launchconfig-sg":"horizontal"},i.select=function(){var e;return e=this.model.get("originalAsg"),this.doSelect(this.type,e.id,this.id),!0},i.amiIconUrl=function(){var e;return e=this.model.get("originalAsg").get("lc"),e&&e.getCanvasView()?e.getCanvasView().iconUrl():"ide/ami/ami-not-available.png"},i.draw=function(e){var t,n,r,i,s,o,u,a,f,l,c;return $("#"+this.id).remove(),s=this.model,a=s.get("originalAsg"),n=a.get("name"),r=a.get("lc"),l=s.x(),c=s.y(),f=s.width()*MC.canvas.GRID_WIDTH,t=s.height()*MC.canvas.GRID_HEIGHT,o=[Canvon.rectangle(1,1,f-1,t-1).attr({"class":"group group-asg",rx:5,ry:5}),Canvon.path(MC.canvas.PATH_ASG_TITLE).attr({"class":"asg-title"}),Canvon.text(4,14,n).attr({"class":"group-label"})],r&&(i=r.get("name"),o=o.concat([Canvon.image(MC.IMG_URL+"ide/icon/instance-canvas.png",35,39,61,62),Canvon.image(MC.IMG_URL+this.amiIconUrl(),50,45,39,27).attr({"class":"ami-icon"}),Canvon.text(65,116,i).attr({"class":"node-label"}),Canvon.path(MC.canvas.PATH_PORT_DIAMOND).attr({"class":"port port-blue port-launchconfig-sg port-launchconfig-sg-left","data-name":"launchconfig-sg","data-alias":"launchconfig-sg-left","data-position":"left","data-type":"sg","data-direction":"in"}),Canvon.path(MC.canvas.PATH_PORT_DIAMOND).attr({"class":"port port-blue port-launchconfig-sg port-launchconfig-sg-right","data-name":"launchconfig-sg","data-alias":"launchconfig-sg-right","data-position":"right","data-type":"sg","data-direction":"out"})])),u=Canvon.group().append.apply(Canvon.group(),o).attr({id:this.id,"class":"dragable AWS-AutoScaling-Group asg-expand","data-type":"group","data-class":this.type}),this.getLayer("asg_layer").append(u),this.initNode(u,s.x(),s.y())},null})}.call(this),function(){define("module/design/framework/canvasview/CeInstance",["i18n!nls/lang.js","./CanvasElement","constant","CanvasManager","Design"],function(e,t,n,r,i){var s,o;return s=function(){return t.apply(this,arguments)},t.extend(s,n.AWS_RESOURCE_TYPE.AWS_EC2_Instance),o=s.prototype,o.portPosMap={"instance-sg-left":[10,20,MC.canvas.PORT_LEFT_ANGLE],"instance-sg-right":[80,20,MC.canvas.PORT_RIGHT_ANGLE],"instance-attach":[78,50,MC.canvas.PORT_RIGHT_ANGLE],"instance-rtb":[45,0,MC.canvas.PORT_UP_ANGLE]},o.portDirMap={"instance-sg":"horizontal"},o.detach=function(){return MC.canvas.nodeAction.remove(this.id),t.prototype.detach.call(this),null},o.iconUrl=function(){var e;return e=this.model.getAmi()||this.model.get("cachedAmi"),e?"ide/ami/"+e.osType+"."+e.architecture+"."+e.rootDeviceType+".png":"ide/ami/ami-not-available.png"},o.draw=function(e){var t,n,i,s,o;return t=this.model,e?(n=this.createNode({image:"ide/icon/instance-canvas.png",imageX:15,imageY:9,imageW:61,imageH:62,label:t.get("name"),labelBg:!0,sg:!0}),n.append(Canvon.image(MC.IMG_URL+this.iconUrl(),30,15,39,27).attr({"class":"ami-image"}),Canvon.image("",21,44,29,24).attr({id:""+this.id+"_volume_status","class":"volume-image"}),Canvon.text(35,56,"").attr({"class":"node-label volume-number"}),Canvon.rectangle(21,44,29,24).attr({"data-target-id":this.id,"class":"instance-volume",fill:"none"}),Canvon.image("",53,47,12,14).attr({"class":"eip-status tooltip"}),Canvon.group().append(Canvon.rectangle(36,1,20,16).attr({"class":"server-number-bg",rx:4,ry:4}),Canvon.text(46,13,"0").attr({"class":"node-label server-number"})).attr({id:""+this.id+"_instance-number-group","class":"instance-number-group",display:"none"}),Canvon.path(MC.canvas.PATH_PORT_DIAMOND).attr({"class":"port port-blue port-instance-sg port-instance-sg-left","data-name":"instance-sg","data-alias":"instance-sg-left","data-position":"left","data-type":"sg","data-direction":"in"}),Canvon.path(MC.canvas.PATH_PORT_DIAMOND).attr({"class":"port port-blue port-instance-sg port-instance-sg-right","data-name":"instance-sg","data-alias":"instance-sg-right","data-position":"right","data-type":"sg","data-direction":"out"})),this.model.design().typeIsClassic()||n.append(Canvon.path(MC.canvas.PATH_PORT_RIGHT).attr({"class":"port port-green port-instance-attach","data-name":"instance-attach","data-position":"right","data-type":"attachment","data-direction":"out"}),Canvon.path(MC.canvas.PATH_PORT_BOTTOM).attr({"class":"port port-blue port-instance-rtb","data-name":"instance-rtb","data-position":"top","data-type":"sg","data-direction":"in"})),!this.model.design().modeIsStack()&&t.get("appId")&&n.append(Canvon.circle(68,15,5,{}).attr({id:""+this.id+"_instance-state","class":"instance-state instance-state-unknown"})),this.getLayer("node_layer").append(n),this.initNode(n,t.x(),t.y())):(n=this.$element(),r.update(n.children(".node-label-name"),t.get("name")),this.updateAppState()),r.update(n.children(".ami-image"),this.iconUrl(),"href"),i=n.children(".instance-number-group"),t.get("count")>1?(r.toggle(n.children(".instance-state"),!1),r.toggle(n.children(".port-instance-rtb"),!1),r.toggle(i,!0),r.update(i.children("text"),t.get("count"))):(r.toggle(n.children(".instance-state"),!0),r.toggle(n.children(".port-instance-rtb"),!0),r.toggle(i,!1)),s=t.get("volumeList")?t.get("volumeList").length:0,s>0?o="ide/icon/instance-volume-attached-normal.png":o="ide/icon/instance-volume-not-attached.png",r.update(n.children(".volume-image"),o,"href"),r.update(n.children(".volume-number"),s),r.updateEip(n.children(".eip-status"),t),null},o.select=function(e){var t,n,r;return n=this.model,r=n.type,t=n.design(),e||(t.modeIsApp()?n.get("count")>1&&(r="component_server_group"):t.modeIsAppEdit()&&n.get("appId")&&(r="component_server_group")),this.doSelect(r,e||this.model.id,this.model.id),!0},o.updateAppState=function(){var e,t,n,i,s,o;i=this.model;if(i.design().modeIsStack()||!i.get("appId"))return;if($("#"+this.id+"_instance-state").length===0)return;return e=this.element(),r.removeClass(e,"deleted"),n=MC.data.resource_list[i.design().region()][i.get("appId")],n?(t=n.instanceState.name,t==="terminated"&&r.addClass(e,"deleted")):(t="unknown",r.addClass(e,"deleted")),s="instance-state tooltip instance-state-"+t+" instance-state-"+i.design().mode(),o=$("#"+this.id+"_instance-state").attr({"class":s}),r.update(o,t,"data-tooltip"),null},o.volume=function(e){var t,n,r,i,s,o,u;n=this.model,t=n.design();if(e)return r=t.component(e),{deleted:r.hasAppResource()?"":"deleted",name:r.get("name"),snapshotId:r.get("snapshotId"),size:r.get("volumeSize"),id:r.id};i=[],u=this.model.get("volumeList")||i;for(s=0,o=u.length;s<o;s++)r=u[s],i.push({deleted:r.hasAppResource()?"":"deleted",name:r.get("name"),snapshotId:r.get("snapshotId"),size:r.get("volumeSize"),id:r.id});return i},o.listVolume=function(e){var t,r,i,s,o,u,a,f,l;o=[],r=this.model.design(),i=MC.data.resource_list[r.region()];if(!i)return o;t=i[e];if(t&&t.blockDeviceMapping&&t.blockDeviceMapping.item){l=t.blockDeviceMapping.item;for(a=0,f=l.length;a<f;a++){s=l[a];if(t.rootDeviceName===s.deviceName)continue;u=i[s.ebs.volumeId],u?o.push({name:s.deviceName,snapshotId:u.snapshotId||"",size:u.size,id:u.volumeId}):this.type===n.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration?o.push({name:s.deviceName,snapshotId:s.ebs.snapshotId||"",size:"",id:s.ebs.volumeId}):o.push({name:s.deviceName,snapshotId:s.ebs.snapshotId||"",size:"",id:s.ebs.volumeId,deleted:"deleted"})}}return o},o.list=function(){var e;return e=t.prototype.list.call(this),e.background=this.iconUrl(),e.volume=(this.model.get("volumeList")||[]).length,e},o.addVolume=function(t){var r,s;return i.instance().modeIsAppEdit()&&this.model.type===n.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration&&this.model.get("appId")?(notification("error",e.ide.NOTIFY_MSG_WARN_OPERATE_NOT_SUPPORT_YET),!1):(t=$.extend({},t),t.owner=this.model,r=i.modelClassForType(n.AWS_RESOURCE_TYPE.AWS_EBS_Volume),s=new r(t),s.id?{id:s.id,deleted:!s.hasAppResource(),name:s.get("name"),snapshotId:s.get("snapshotId"),size:s.get("volumeSize")}:!1)},o.removeVolume=function(e){return this.model.design().component(e).remove(),null},o.moveVolume=function(e){var t,n,r;t=this.model.design(),r=t.component(e),n=r.isReparentable(this.model);if(_.isString(n)){notification("error",n);return}return n===!1?!1:(n=r.attachTo(this.model),n?this.volume(e):!1)},s})}.call(this),function(){define("module/design/framework/canvasview/CeVolume",["i18n!nls/lang.js","./CanvasElement","constant","CanvasManager","event"],function(e,t,n,r,i){var s,o;return s=function(e){return _.isString(e)?(this.id=e,this.nodeType="node",this.type=n.AWS_RESOURCE_TYPE.AWS_EBS_Volume):t.apply(this,arguments),null},t.extend(s,n.AWS_RESOURCE_TYPE.AWS_EBS_Volume),o=s.prototype,o.remove=function(){return this.model.design().modeIsAppEdit()&&(this.model.get("owner")||{}).type===n.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration?(notification("error",e.ide.NOTIFY_MSG_WARN_OPERATE_NOT_SUPPORT_YET),!1):s["super"].remove.call(this)},o.select=function(e){return i.trigger(i.OPEN_PROPERTY,this.type,e||this.id),MC.canvas.volume.select(this.id),!0},null})}.call(this),function(){define("module/design/framework/canvasview/CeEni",["./CanvasElement","constant","CanvasManager"],function(e,t,n){var r,i;return r=function(){return e.apply(this,arguments)},e.extend(r,t.AWS_RESOURCE_TYPE.AWS_VPC_NetworkInterface),i=r.prototype,i.portPosMap={"eni-sg-left":[10,20,MC.canvas.PORT_LEFT_ANGLE],"eni-attach":[8,50,MC.canvas.PORT_LEFT_ANGLE],"eni-sg-right":[80,20,MC.canvas.PORT_RIGHT_ANGLE],"eni-rtb":[45,0,MC.canvas.PORT_UP_ANGLE]},i.portDirMap={"eni-sg":"horizontal"},i.iconUrl=function(){return this.model.connections("EniAttachment").length?"ide/icon/eni-canvas-attached.png":"ide/icon/eni-canvas-unattached.png"},i.draw=function(e){var t,r,i,s;r=this.model;if(r.embedInstance())return;return e?(i=this.createNode({image:this.iconUrl(),imageX:16,imageY:15,imageW:59,imageH:49,label:r.get("name"),labelBg:!0,sg:!0}),i.append(Canvon.image("",44,37,12,14).attr({id:""+this.id+"_eip_status","class":"eip-status tooltip"}),Canvon.path(MC.canvas.PATH_PORT_DIAMOND).attr({"class":"port port-blue port-eni-sg port-eni-sg-left","data-name":"eni-sg","data-alias":"eni-sg-left","data-position":"left","data-type":"sg","data-direction":"in"}),Canvon.path(MC.canvas.PATH_PORT_RIGHT).attr({"class":"port port-green port-eni-attach","data-name":"eni-attach","data-position":"left","data-type":"attachment","data-direction":"in"}),Canvon.path(MC.canvas.PATH_PORT_DIAMOND).attr({"class":"port port-blue port-eni-sg port-eni-sg-right","data-name":"eni-sg","data-alias":"eni-sg-right","data-position":"right","data-type":"sg","data-direction":"out"}),Canvon.path(MC.canvas.PATH_PORT_BOTTOM).attr({"class":"port port-blue port-eni-rtb","data-name":"eni-rtb","data-position":"top","data-type":"sg","data-direction":"in"}),Canvon.group().append(Canvon.rectangle(36,1,20,16).attr({"class":"server-number-bg",rx:4,ry:4}),Canvon.text(46,13,"0").attr({"class":"node-label server-number"})).attr({"class":"eni-number-group",display:"none"})),this.getLayer("node_layer").append(i),this.initNode(i,r.x(),r.y())):(i=this.$element(),n.update(i.children(".node-label"),r.get("name")),n.update(i.children("image:not(.eip-status)"),this.iconUrl(),"href")),t=r.serverGroupCount(),s=i.children(".eni-number-group"),t>1?(n.toggle(i.children(".port-eni-rtb"),!1),n.toggle(s,!0),n.update(s.children("text"),t)):(n.toggle(i.children(".port-eni-rtb"),!0),n.toggle(s,!1)),n.toggle(i.children(".eip-status"),!!r.attachedInstance()),n.updateEip(i.children(".eip-status"),r),this.updateAppState(),null},i.select=function(e){var t,n,r;return n=this.model,r=n.type,t=n.design(),e||(t.modeIsApp()?n.serverGroupCount()>1&&(r="component_eni_group"):t.modeIsAppEdit()&&n.get("appId")&&(r="component_eni_group")),this.doSelect(r,e||this.model.id,this.model.id),!0},null})}.call(this),function(){define("module/design/framework/canvasview/CeLc",["./CanvasElement","./CeInstance","constant","CanvasManager"],function(e,t,n,r){var i,s;return i=function(){return e.apply(this,arguments)},e.extend.call(t,i,n.AWS_RESOURCE_TYPE.AWS_AutoScaling_LaunchConfiguration),s=i.prototype,s.portPosMap={"launchconfig-sg-left":[10,20,MC.canvas.PORT_LEFT_ANGLE],"launchconfig-sg-right":[80,20,MC.canvas.PORT_RIGHT_ANGLE]},s.portDirMap={"launchconfig-sg":"horizontal"},s.detach=function(){return MC.canvas.nodeAction.remove(this.id),e.prototype.detach.call(this),null},s.list=function(){var t,n,r,i;n=e.prototype.list.call(this);for(r=0,i=n.length;r<i;r++)t=n[r],t.background=this.iconUrl(t.appId);return n.volume=(this.model.get("volumeList")||[]).length,n},s.iconUrl=function(e){var t;return e&&(t=MC.data.resource_list[this.model.design().region()][e],t&&(t=MC.data.dict_ami[t.imageId])),t||(t=this.model.getAmi()||this.model.get("cachedAmi")),t?"ide/ami/"+t.osType+"."+t.architecture+"."+t.rootDeviceType+".png":"ide/ami/ami-not-available.png"},s.draw=function(e){var t,n,i,s,o,u;return n=this.model,e?(i=this.createNode({id:n.id,image:"ide/icon/instance-canvas.png",imageX:15,imageY:9,imageW:61,imageH:62,label:MC.truncate(n.get("name"),15),labelBg:!0,sg:!0}),i.append(Canvon.image(MC.IMG_URL+this.iconUrl(),30,15,39,27).attr({"class":"ami-image"}),Canvon.image("",31,44,29,24).attr({id:""+this.id+"_volume_status","class":"volume-image"}),Canvon.text(45,56,"").attr({"class":"node-label volume-number"}),Canvon.rectangle(31,44,29,24).attr({"data-target-id":this.id,"class":"instance-volume",fill:"none"}),Canvon.path(MC.canvas.PATH_PORT_DIAMOND).attr({"class":"port port-blue port-launchconfig-sg port-launchconfig-sg-left","data-name":"launchconfig-sg","data-alias":"launchconfig-sg-left","data-position":"left","data-type":"sg","data-direction":"in"}),Canvon.path(MC.canvas.PATH_PORT_DIAMOND).attr({"class":"port port-blue port-launchconfig-sg port-launchconfig-sg-right","data-name":"launchconfig-sg","data-alias":"launchconfig-sg-right","data-position":"right","data-type":"sg","data-direction":"out"}),Canvon.group().append(Canvon.rectangle(36,1,20,16).attr({"class":"server-number-bg",rx:4,ry:4}),Canvon.text(46,13,"0").attr({"class":"node-label server-number"})).attr({id:""+this.id+"_instance-number-group","class":"instance-number-group",display:"none"})),this.getLayer("node_layer").append(i),this.initNode(i,n.x(),n.y())):(i=this.$element(n.id),r.update(i.children(".node-label-name"),MC.truncate(n.get("name"),15))),r.update(i.children(".ami-image"),this.iconUrl(),"href"),o=(n.get("volumeList")||[]).length,r.update(i.children(".volume-number"),o),o>0?u="ide/icon/instance-volume-attached-normal.png":u="ide/icon/instance-volume-not-attached.png",r.update(i.children(".volume-image"),u,"href"),!n.design().modeIsStack()&&n.parent()&&(t=MC.data.resource_list[n.design().region()][n.parent().get("appId")],s=i.children(".instance-number-group"),t&&t.Instances&&t.Instances.member&&t.Instances.member.length>0?(r.toggle(s,!0),r.update(s.children("text"),t.Instances.member.length)):r.toggle(s,!1)),null},s.select=function(e){var t;return e?t=n.AWS_RESOURCE_TYPE.AWS_EC2_Instance:t=this.model.type,this.doSelect(t,e||this.id,this.id)},null})}.call(this),function(){define("module/design/framework/DesignBundle",["Design","CanvasManager","./connection/EniAttachment","./connection/VPNConnection","./resource/InstanceModel","./resource/EniModel","./resource/VolumeModel","./resource/AclModel","./resource/AsgModel","./resource/AzModel","./resource/AzModel","./resource/CgwModel","./resource/ElbModel","./resource/LcModel","./resource/KeypairModel","./resource/SslCertModel","./resource/RtbModel","./resource/SgModel","./resource/SubnetModel","./resource/VpcModel","./resource/IgwModel","./resource/VgwModel","./resource/SnsSubscription","./resource/StorageModel","./resource/ScalingPolicyModel","./util/deserializeVisitor/JsonFixer","./util/deserializeVisitor/EipMerge","./util/deserializeVisitor/FixOldStack","./util/deserializeVisitor/AsgExpandor","./util/deserializeVisitor/ElbSgNamePatch","./util/serializeVisitor/EniIpAssigner","./canvasview/CeLine","./canvasview/CeAz","./canvasview/CeSubnet","./canvasview/CeVpc","./canvasview/CeCgw","./canvasview/CeIgw","./canvasview/CeVgw","./canvasview/CeRtb","./canvasview/CeElb","./canvasview/CeAsg","./canvasview/CeExpandedAsg","./canvasview/CeInstance","./canvasview/CeVolume","./canvasview/CeEni","./canvasview/CeLc"],function(e){return window.Design=e,e})}.call(this);